# Руководство по автоматизации системы

## Обзор

В системе реализована автоматизация двух ключевых процессов:

1. **Автоматическое обновление статуса просроченных работ**
2. **Автоматическое формирование ежедневных отчетов**

## Компоненты автоматизации

### 1. Планировщик задач (APScheduler)

Система использует библиотеку APScheduler для планирования и выполнения автоматических задач.

**Файл:** `app/utils/scheduler.py`

**Основные функции:**
- `TaskScheduler` - основной класс планировщика
- `update_overdue_works_job()` - задача обновления просроченных работ
- `generate_daily_reports_job()` - задача генерации ежедневных отчетов

### 2. Автоматические задачи

#### Обновление просроченных работ

**Расписание:** 
- Каждый день в 00:05 (полночь + 5 минут)
- Каждый час в :00 (дополнительная проверка)

**Логика работы:**
1. Находит все работы с `planned_date < сегодня` и статусом `planned` или `in_progress`
2. Изменяет их статус на `overdue`
3. Обновляет поле `updated_at`

**Код:** `PlannedWork.update_overdue_works()`

#### Генерация ежедневных отчетов

**Расписание:** Каждый день в 23:55

**Логика работы:**
1. Генерирует отчеты за вчерашний день для всех объектов
2. Подсчитывает статистику:
   - Количество запланированных работ
   - Количество выполненных работ
   - Количество просроченных работ
3. Создает записи в таблице `DailyReport`

## Настройка и запуск

### 1. Установка зависимостей

```bash
pip install APScheduler==3.10.4
```

### 2. Инициализация

Планировщик автоматически инициализируется при запуске приложения в файле `app/__init__.py`:

```python
from .utils.scheduler import scheduler
scheduler.init_app(app)
```

### 3. Конфигурация

**Время:** Московское время (Europe/Moscow)

**Хранилище задач:** SQLAlchemy (та же база данных, что и приложение)

**Исполнители:** ThreadPoolExecutor (20 потоков)

## Ручное управление

### Веб-интерфейс

В разделе "Обзор запланированных работ" добавлены кнопки:

1. **"Обновить просрочки"** - ручное обновление статуса просроченных работ
2. **"Создать отчеты"** - ручная генерация отчетов за сегодня

**URL-адреса:**
- `POST /objects/admin/update-overdue-works`
- `POST /objects/admin/generate-daily-reports`

### Программное управление

```python
from app.utils.scheduler import scheduler

# Обновить просроченные работы
updated_count = scheduler.update_overdue_works()

# Сгенерировать отчеты за сегодня
generated_count = scheduler.generate_report_for_today()
```

## Мониторинг и логирование

### Логи

Все операции автоматизации логируются с уровнем INFO:

```
INFO:app.utils.scheduler:Автоматически обновлено просроченных работ: 5
INFO:app.utils.scheduler:Автоматически сгенерировано отчетов: 3
```

### Статус планировщика

Проверить статус планировщика можно через веб-интерфейс или программно:

```python
if scheduler.scheduler and scheduler.scheduler.running:
    jobs = scheduler.scheduler.get_jobs()
    for job in jobs:
        print(f"{job.name}: {job.next_run_time}")
```

## Тестирование

### Простой тест

```bash
python test_scheduler_simple.py
```

### Полный тест (требует инициализированную БД)

```bash
python test_automation.py
```

## Устранение неполадок

### Планировщик не запускается

1. Проверьте установку APScheduler
2. Убедитесь, что база данных доступна
3. Проверьте логи на ошибки инициализации

### Задачи не выполняются

1. Проверьте статус планировщика
2. Убедитесь, что время сервера корректное
3. Проверьте логи на ошибки выполнения задач

### Ошибки базы данных

1. Убедитесь, что все таблицы созданы
2. Проверьте права доступа к базе данных
3. Выполните миграции при необходимости

## Безопасность

- Все автоматические операции логируются
- Ручные операции требуют авторизации
- Планировщик работает в изолированном контексте приложения

## Производительность

- Планировщик использует фоновые потоки
- Задачи выполняются асинхронно
- Минимальное влияние на основное приложение

## Расширение функциональности

### Добавление новой задачи

1. Создайте функцию-задачу в `app/utils/scheduler.py`
2. Зарегистрируйте задачу в методе `_register_jobs()`
3. Добавьте ручное управление при необходимости

### Изменение расписания

Отредактируйте триггеры в методе `_register_jobs()`:

```python
# Пример: каждые 30 минут
trigger=CronTrigger(minute='*/30')
```

## Контакты

При возникновении проблем с автоматизацией обратитесь к администратору системы.
