{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'profile' %}

{% block title %}Смена PIN-кода{% endblock %}
{% block mobile_title %}Смена PIN-кода{% endblock %}

{% block mobile_header_actions %}
    <a href="{{ url_for('main.profile') }}" class="mobile-header-btn">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
        </svg>
    </a>
{% endblock %}

{% block content %}
<div class="mobile-content">
    <!-- Прогресс-бар -->
    <div class="progress-container mb-4">
        <div class="progress" style="height: 4px;">
            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 33%" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <small class="text-muted">Шаг 1 из 3</small>
            <small class="text-muted" id="stepTitle">Текущий PIN</small>
        </div>
    </div>

    <!-- Иконка и заголовок -->
    <div class="text-center mb-4">
        <div class="pin-icon-large mb-3">
            <svg width="80" height="80" fill="currentColor" viewBox="0 0 16 16" id="pinIcon">
                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
            </svg>
        </div>
        <h4 class="mb-2" id="mainTitle">Введите текущий PIN-код</h4>
        <p class="text-muted mb-0" id="mainSubtitle">Для смены PIN-кода необходимо подтвердить текущий</p>
    </div>

    <!-- Отображение PIN -->
    <div class="pin-display-container mb-4">
        <div class="pin-dots-container">
            <div class="pin-dot" id="dot1"></div>
            <div class="pin-dot" id="dot2"></div>
            <div class="pin-dot" id="dot3"></div>
            <div class="pin-dot" id="dot4"></div>
        </div>
        <div class="pin-status mt-3" id="pinStatus">
            <small class="text-muted">Введите 4 цифры</small>
        </div>
    </div>

    <!-- Цифровая клавиатура -->
    <div class="pin-keypad">
        <div class="keypad-row">
            <button class="keypad-btn" onclick="addDigit('1')">
                <span class="keypad-number">1</span>
            </button>
            <button class="keypad-btn" onclick="addDigit('2')">
                <span class="keypad-number">2</span>
                <span class="keypad-letters">ABC</span>
            </button>
            <button class="keypad-btn" onclick="addDigit('3')">
                <span class="keypad-number">3</span>
                <span class="keypad-letters">DEF</span>
            </button>
        </div>
        <div class="keypad-row">
            <button class="keypad-btn" onclick="addDigit('4')">
                <span class="keypad-number">4</span>
                <span class="keypad-letters">GHI</span>
            </button>
            <button class="keypad-btn" onclick="addDigit('5')">
                <span class="keypad-number">5</span>
                <span class="keypad-letters">JKL</span>
            </button>
            <button class="keypad-btn" onclick="addDigit('6')">
                <span class="keypad-number">6</span>
                <span class="keypad-letters">MNO</span>
            </button>
        </div>
        <div class="keypad-row">
            <button class="keypad-btn" onclick="addDigit('7')">
                <span class="keypad-number">7</span>
                <span class="keypad-letters">PQRS</span>
            </button>
            <button class="keypad-btn" onclick="addDigit('8')">
                <span class="keypad-number">8</span>
                <span class="keypad-letters">TUV</span>
            </button>
            <button class="keypad-btn" onclick="addDigit('9')">
                <span class="keypad-number">9</span>
                <span class="keypad-letters">WXYZ</span>
            </button>
        </div>
        <div class="keypad-row">
            <button class="keypad-btn keypad-btn-secondary" onclick="clearPin()">
                <span class="keypad-text">Очистить</span>
            </button>
            <button class="keypad-btn" onclick="addDigit('0')">
                <span class="keypad-number">0</span>
            </button>
            <button class="keypad-btn keypad-btn-delete" onclick="removeDigit()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Дополнительные действия -->
    <div class="pin-actions mt-4">
        <button type="button" class="btn btn-outline-secondary w-100" onclick="goBack()" id="backBtn" style="display: none;">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Назад
        </button>
    </div>
</div>

<style>
.pin-icon-large {
    color: var(--bs-primary);
    transition: all 0.3s ease;
}

.pin-icon-large.success {
    color: var(--bs-success);
    transform: scale(1.1);
}

.pin-icon-large.error {
    color: var(--bs-danger);
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.progress-container {
    padding: 0 20px;
}

.pin-display-container {
    text-align: center;
    padding: 20px;
}

.pin-dots-container {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-bottom: 16px;
}

.pin-dot {
    width: 20px;
    height: 20px;
    border: 2px solid var(--bs-border-color);
    border-radius: 50%;
    background: transparent;
    transition: all 0.3s ease;
}

.pin-dot.filled {
    background: var(--bs-primary);
    border-color: var(--bs-primary);
}

.pin-dot.success {
    background: var(--bs-success);
    border-color: var(--bs-success);
}

.pin-dot.error {
    background: var(--bs-danger);
    border-color: var(--bs-danger);
    animation: pulse 0.5s ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.pin-keypad {
    padding: 20px;
    max-width: 300px;
    margin: 0 auto;
}

.keypad-row {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 12px;
}

.keypad-btn {
    width: 70px;
    height: 70px;
    border: 2px solid var(--bs-border-color);
    border-radius: 50%;
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 600;
    transition: all 0.2s ease;
    cursor: pointer;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

.keypad-btn:active {
    transform: scale(0.95);
    background: var(--bs-secondary-bg);
}

.keypad-btn.keypad-btn-secondary {
    font-size: 14px;
    font-weight: 500;
}

.keypad-btn.keypad-btn-delete {
    font-size: 16px;
}

.keypad-letters {
    font-size: 10px;
    font-weight: 400;
    opacity: 0.6;
    margin-top: 2px;
}

.pin-actions {
    padding: 0 20px;
}

@media (max-width: 480px) {
    .keypad-btn {
        width: 60px;
        height: 60px;
        font-size: 20px;
    }
    
    .keypad-row {
        gap: 8px;
    }
    
    .pin-keypad {
        padding: 15px;
    }
}
</style>

<script>
// Состояние PIN-кода
let currentPin = '';
let newPin = '';
let confirmPin = '';
let currentStep = 1; // 1 - текущий PIN, 2 - новый PIN, 3 - подтверждение
const maxPinLength = 4;
let lastDigitTime = 0;
const DIGIT_DEBOUNCE_TIME = 150;

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    console.log('PIN Change page loaded');
    updateUI();
});

function addDigit(digit) {
    // Защита от быстрых повторных нажатий
    const currentTime = Date.now();
    if (currentTime - lastDigitTime < DIGIT_DEBOUNCE_TIME) {
        return;
    }
    lastDigitTime = currentTime;
    
    let activePin = getActivePin();
    
    if (activePin.length < maxPinLength) {
        setActivePin(activePin + digit);
        updateDots();
        
        if (getActivePin().length === maxPinLength) {
            setTimeout(() => {
                processCompletePin();
            }, 300);
        }
    }
}

function removeDigit() {
    let activePin = getActivePin();
    if (activePin.length > 0) {
        setActivePin(activePin.slice(0, -1));
        updateDots();
    }
}

function clearPin() {
    setActivePin('');
    updateDots();
}

function getActivePin() {
    switch (currentStep) {
        case 1: return currentPin;
        case 2: return newPin;
        case 3: return confirmPin;
        default: return '';
    }
}

function setActivePin(value) {
    switch (currentStep) {
        case 1: currentPin = value; break;
        case 2: newPin = value; break;
        case 3: confirmPin = value; break;
    }
}

function updateDots() {
    const activePin = getActivePin();
    
    for (let i = 1; i <= maxPinLength; i++) {
        const dot = document.getElementById(`dot${i}`);
        dot.classList.remove('filled', 'success', 'error');
        
        if (i <= activePin.length) {
            dot.classList.add('filled');
        }
    }
}

function updateUI() {
    const progressBar = document.getElementById('progressBar');
    const stepTitle = document.getElementById('stepTitle');
    const mainTitle = document.getElementById('mainTitle');
    const mainSubtitle = document.getElementById('mainSubtitle');
    const backBtn = document.getElementById('backBtn');
    const pinIcon = document.getElementById('pinIcon');
    
    // Сбрасываем стили иконки
    pinIcon.parentElement.classList.remove('success', 'error');
    
    switch (currentStep) {
        case 1:
            progressBar.style.width = '33%';
            stepTitle.textContent = 'Текущий PIN';
            mainTitle.textContent = 'Введите текущий PIN-код';
            mainSubtitle.textContent = 'Для смены PIN-кода необходимо подтвердить текущий';
            backBtn.style.display = 'none';
            break;
        case 2:
            progressBar.style.width = '66%';
            stepTitle.textContent = 'Новый PIN';
            mainTitle.textContent = 'Введите новый PIN-код';
            mainSubtitle.textContent = 'Придумайте новый 4-значный PIN-код';
            backBtn.style.display = 'block';
            break;
        case 3:
            progressBar.style.width = '100%';
            stepTitle.textContent = 'Подтверждение';
            mainTitle.textContent = 'Подтвердите новый PIN-код';
            mainSubtitle.textContent = 'Повторите новый PIN-код для подтверждения';
            backBtn.style.display = 'block';
            break;
    }
}

async function processCompletePin() {
    const activePin = getActivePin();
    
    switch (currentStep) {
        case 1:
            await verifyCurrentPin(activePin);
            break;
        case 2:
            currentStep = 3;
            setActivePin('');
            updateUI();
            updateDots();
            break;
        case 3:
            if (newPin === confirmPin) {
                await saveNewPin();
            } else {
                showError('PIN-коды не совпадают');
                setTimeout(() => {
                    currentStep = 2;
                    newPin = '';
                    confirmPin = '';
                    updateUI();
                    updateDots();
                }, 1500);
            }
            break;
    }
}

async function verifyCurrentPin(pin) {
    try {
        showLoading();
        
        const response = await fetch('/pin/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ pin: pin })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('PIN подтвержден');
            setTimeout(() => {
                currentStep = 2;
                currentPin = pin; // Сохраняем для отправки на сервер
                setActivePin('');
                updateUI();
                updateDots();
            }, 1000);
        } else {
            showError(result.message || 'Неверный PIN-код');
            setTimeout(() => {
                setActivePin('');
                updateDots();
            }, 1500);
        }
    } catch (error) {
        console.error('Error verifying PIN:', error);
        showError('Ошибка при проверке PIN-кода');
        setTimeout(() => {
            setActivePin('');
            updateDots();
        }, 1500);
    }
}

async function saveNewPin() {
    try {
        showLoading();
        
        const response = await fetch('/pin/change', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_pin: currentPin,
                new_pin: newPin,
                confirm_pin: confirmPin
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('PIN-код успешно изменен!');
            setTimeout(() => {
                window.location.href = "{{ url_for('main.profile') }}";
            }, 2000);
        } else {
            showError(result.message || 'Ошибка при смене PIN-кода');
            setTimeout(() => {
                currentStep = 2;
                newPin = '';
                confirmPin = '';
                updateUI();
                updateDots();
            }, 1500);
        }
    } catch (error) {
        console.error('Error saving PIN:', error);
        showError('Ошибка при смене PIN-кода');
        setTimeout(() => {
            currentStep = 2;
            newPin = '';
            confirmPin = '';
            updateUI();
            updateDots();
        }, 1500);
    }
}

function showLoading() {
    const pinIcon = document.getElementById('pinIcon');
    const pinStatus = document.getElementById('pinStatus');
    
    pinIcon.parentElement.classList.remove('success', 'error');
    pinStatus.innerHTML = '<small class="text-muted">Проверка...</small>';
}

function showSuccess(message) {
    const pinIcon = document.getElementById('pinIcon');
    const pinStatus = document.getElementById('pinStatus');
    const dots = document.querySelectorAll('.pin-dot');
    
    pinIcon.parentElement.classList.add('success');
    pinStatus.innerHTML = `<small class="text-success">${message}</small>`;
    
    dots.forEach(dot => {
        dot.classList.remove('filled', 'error');
        dot.classList.add('success');
    });
}

function showError(message) {
    const pinIcon = document.getElementById('pinIcon');
    const pinStatus = document.getElementById('pinStatus');
    const dots = document.querySelectorAll('.pin-dot');
    
    pinIcon.parentElement.classList.add('error');
    pinStatus.innerHTML = `<small class="text-danger">${message}</small>`;
    
    dots.forEach(dot => {
        dot.classList.remove('filled', 'success');
        dot.classList.add('error');
    });
}

function goBack() {
    if (currentStep > 1) {
        currentStep--;
        setActivePin('');
        updateUI();
        updateDots();
    }
}
</script>
{% endblock %}
