{% extends "pin/pin_layout.html" %}

{% block title %}Настройка PIN{% endblock %}
{% block header_title %}Настройка PIN{% endblock %}

{% block content %}
<div class="pin-setup-container">
    <div class="pin-icon-section">
        <div class="pin-icon">
            <svg width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
            </svg>
        </div>
        <h2 class="pin-title">Настройка PIN-кода</h2>
        <p class="pin-subtitle">Создайте 4-значный PIN-код для быстрого входа</p>
    </div>

    <div class="pin-display">
        <div class="pin-dots">
            <div class="pin-dot" id="dot1"></div>
            <div class="pin-dot" id="dot2"></div>
            <div class="pin-dot" id="dot3"></div>
            <div class="pin-dot" id="dot4"></div>
        </div>
        <div class="pin-step" id="pinStep">
            <span class="step-text">Введите новый PIN-код</span>
        </div>
    </div>

    <div class="pin-keypad">
        <div class="pin-row">
            <button class="pin-key" data-key="1">1</button>
            <button class="pin-key" data-key="2">2</button>
            <button class="pin-key" data-key="3">3</button>
        </div>
        <div class="pin-row">
            <button class="pin-key" data-key="4">4</button>
            <button class="pin-key" data-key="5">5</button>
            <button class="pin-key" data-key="6">6</button>
        </div>
        <div class="pin-row">
            <button class="pin-key" data-key="7">7</button>
            <button class="pin-key" data-key="8">8</button>
            <button class="pin-key" data-key="9">9</button>
        </div>
        <div class="pin-row">
            <button class="pin-key pin-key-biometric" id="biometricBtn" style="display: none;">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                </svg>
            </button>
            <button class="pin-key" data-key="0">0</button>
            <button class="pin-key pin-key-delete" id="deleteBtn">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
            </button>
        </div>
    </div>

</div>

<style>
.pin-setup-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
}

.pin-icon-section {
    text-align: center;
    margin-bottom: 40px;
}

.pin-icon {
    color: #007bff;
    margin-bottom: 20px;
}

.pin-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--bs-body-color);
}

.pin-subtitle {
    color: var(--bs-secondary-color);
    font-size: 16px;
}

.pin-display {
    margin-bottom: 40px;
    text-align: center;
}

.pin-dots {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin-bottom: 20px;
}

.pin-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid var(--bs-border-color);
    background: transparent;
    transition: all 0.2s ease;
}

.pin-dot.filled {
    background: #007bff;
    border-color: #007bff;
}

.pin-step {
    margin-top: 20px;
}

.step-text {
    color: var(--bs-secondary-color);
    font-size: 16px;
}

.pin-keypad {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 40px;
}

.pin-row {
    display: flex;
    gap: 20px;
    justify-content: center;
}

.pin-key {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 2px solid var(--bs-border-color);
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
    font-size: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.pin-key:hover {
    background: var(--bs-secondary-bg);
    border-color: #007bff;
}

.pin-key:active {
    transform: scale(0.95);
    background: #007bff;
    color: white;
}

.pin-key-biometric {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-color: #007bff;
}

.pin-key-delete {
    background: var(--bs-danger-bg-subtle);
    color: var(--bs-danger);
    border-color: var(--bs-danger-border-subtle);
}

.pin-footer {
    text-align: center;
}

.pin-skip {
    background: none;
    border: none;
    color: var(--bs-secondary-color);
    text-decoration: underline;
    font-size: 16px;
    cursor: pointer;
}

.pin-skip:hover {
    color: var(--bs-body-color);
}

/* Темная тема */
[data-bs-theme="dark"] .pin-key {
    border-color: #495057;
}

[data-bs-theme="dark"] .pin-key:hover {
    background: #343a40;
    border-color: #007bff;
}

[data-bs-theme="dark"] .pin-dot {
    border-color: #495057;
}

/* Стили для настройки биометрии */
.biometric-setup-section {
    text-align: center;
    width: 100%;
}

.biometric-icon {
    color: #007bff;
    margin-bottom: 20px;
}

.biometric-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--bs-body-color);
}

.biometric-subtitle {
    color: var(--bs-secondary-color);
    font-size: 16px;
    margin-bottom: 30px;
}

.biometric-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
}

.biometric-btn {
    width: 100%;
    max-width: 280px;
    padding: 15px 20px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s ease;
    cursor: pointer;
    border: none;
}

.biometric-btn-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
}

.biometric-btn-primary:hover {
    background: linear-gradient(135deg, #0056b3, #004085);
    transform: translateY(-2px);
}

.biometric-btn-secondary {
    background: var(--bs-secondary-bg);
    color: var(--bs-secondary-color);
    border: 2px solid var(--bs-border-color);
}

.biometric-btn-secondary:hover {
    background: var(--bs-tertiary-bg);
    color: var(--bs-body-color);
}

.biometric-success,
.biometric-error {
    text-align: center;
}

.success-icon,
.error-icon {
    margin-bottom: 20px;
}

.success-title,
.error-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--bs-body-color);
}

.success-subtitle,
.error-subtitle {
    color: var(--bs-secondary-color);
    font-size: 16px;
    margin-bottom: 30px;
}

/* Темная тема для биометрии */
[data-bs-theme="dark"] .biometric-btn-secondary {
    background: #343a40;
    color: #f8f9fa;
    border-color: #495057;
}

[data-bs-theme="dark"] .biometric-btn-secondary:hover {
    background: #495057;
    color: #f8f9fa;
}
</style>

<script>
let currentPin = '';
let confirmPin = '';
let isConfirming = false;
const maxPinLength = 4;

// Проверяем поддержку биометрии (упрощенная версия)
async function checkBiometricSupport() {
    // Просто скрываем кнопку биометрии в клавиатуре, так как теперь у нас есть отдельный экран
    const biometricBtn = document.getElementById('biometricBtn');
    if (biometricBtn) {
        biometricBtn.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    checkBiometricSupport();
    
    const pinKeys = document.querySelectorAll('.pin-key[data-key]');
    const deleteBtn = document.getElementById('deleteBtn');
    
    pinKeys.forEach(key => {
        key.addEventListener('click', () => {
            const digit = key.dataset.key;
            addDigit(digit);
        });
    });
    
    deleteBtn.addEventListener('click', () => {
        removeDigit();
    });
    
    // Вибрация при нажатии
    pinKeys.forEach(key => {
        key.addEventListener('click', () => {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        });
    });
});

function addDigit(digit) {
    if (isConfirming) {
        if (confirmPin.length < maxPinLength) {
            confirmPin += digit;
            updateDots();
            
            if (confirmPin.length === maxPinLength) {
                if (currentPin === confirmPin) {
                    savePin();
                } else {
                    showError('PIN-коды не совпадают');
                    resetPins();
                }
            }
        }
    } else {
        if (currentPin.length < maxPinLength) {
            currentPin += digit;
            updateDots();
            
            if (currentPin.length === maxPinLength) {
                setTimeout(() => {
                    startConfirmation();
                }, 300);
            }
        }
    }
}

function removeDigit() {
    if (isConfirming) {
        if (confirmPin.length > 0) {
            confirmPin = confirmPin.slice(0, -1);
            updateDots();
        }
    } else {
        if (currentPin.length > 0) {
            currentPin = currentPin.slice(0, -1);
            updateDots();
        }
    }
}

function updateDots() {
    const activePin = isConfirming ? confirmPin : currentPin;
    
    for (let i = 1; i <= maxPinLength; i++) {
        const dot = document.getElementById(`dot${i}`);
        if (i <= activePin.length) {
            dot.classList.add('filled');
        } else {
            dot.classList.remove('filled');
        }
    }
}

function startConfirmation() {
    isConfirming = true;
    confirmPin = '';
    updateDots();
    updateStepText('Подтвердите PIN-код');
}

function resetPins() {
    currentPin = '';
    confirmPin = '';
    isConfirming = false;
    updateDots();
    updateStepText('Введите новый PIN-код');
}

function updateStepText(text) {
    document.querySelector('.step-text').textContent = text;
}

async function savePin() {
    try {
        const response = await fetch('/pin/setup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                pin: currentPin, 
                confirm_pin: confirmPin 
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('PIN-код успешно установлен!');
            setTimeout(() => {
                offerBiometricSetup();
            }, 1500);
        } else {
            showError(result.message);
            resetPins();
        }
    } catch (error) {
        console.error('Ошибка при сохранении PIN:', error);
        showError('Произошла ошибка');
        resetPins();
    }
}

function showSuccess(message) {
    document.querySelectorAll('.pin-dot').forEach(dot => {
        dot.style.background = '#28a745';
        dot.style.borderColor = '#28a745';
    });
    
    updateStepText(message);
    
    if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
    }
}

function showError(message) {
    document.querySelectorAll('.pin-dot').forEach(dot => {
        dot.style.background = '#dc3545';
        dot.style.borderColor = '#dc3545';
    });
    
    updateStepText(message);
    
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
    }
}

function offerBiometricSetup() {
    // Скрываем клавиатуру и точки
    document.querySelector('.pin-keypad').style.display = 'none';
    document.querySelector('.pin-display').style.display = 'none';
    
    // Показываем предложение настройки биометрии
    const biometricSection = document.createElement('div');
    biometricSection.className = 'biometric-setup-section';
    biometricSection.innerHTML = `
        <div class="biometric-icon">
            <svg width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
            </svg>
        </div>
        <h3 class="biometric-title">Настроить Face ID?</h3>
        <p class="biometric-subtitle">Используйте Face ID для еще более быстрого входа в приложение</p>
        <div class="biometric-buttons">
            <button class="biometric-btn biometric-btn-primary" id="enableBiometric">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                </svg>
                Включить Face ID
            </button>
            <button class="biometric-btn biometric-btn-secondary" id="skipBiometric">
                Пропустить
            </button>
        </div>
    `;
    
    document.querySelector('.pin-setup-container').appendChild(biometricSection);
    
    // Обработчики кнопок
    document.getElementById('enableBiometric').addEventListener('click', enableBiometric);
    document.getElementById('skipBiometric').addEventListener('click', skipBiometric);
}

async function enableBiometric() {
    try {
        // Показываем индикатор загрузки
        document.getElementById('enableBiometric').innerHTML = `
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Настройка...
        `;
        document.getElementById('enableBiometric').disabled = true;
        
        // Пытаемся создать биометрический ключ
        const credential = await navigator.credentials.create({
            publicKey: {
                challenge: new Uint8Array(32),
                rp: { name: "СтройКомплекс" },
                user: {
                    id: new Uint8Array(16),
                    name: "user",
                    displayName: "Пользователь"
                },
                pubKeyCredParams: [{alg: -7, type: "public-key"}],
                authenticatorSelection: {
                    authenticatorAttachment: "platform",
                    userVerification: "required"
                }
            }
        });
        
        // Включаем биометрическую аутентификацию на сервере
        const response = await fetch('/pin/biometric/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ enabled: true })
        });
        
        if (response.ok) {
            showBiometricSuccess();
        } else {
            throw new Error('Ошибка сервера');
        }
    } catch (error) {
        console.log('Биометрическая аутентификация недоступна:', error);
        showBiometricError();
    }
}

function skipBiometric() {
    // Переходим в приложение без настройки биометрии
    window.location.href = '{{ url_for("objects.object_list") }}';
}

function showBiometricSuccess() {
    document.querySelector('.biometric-setup-section').innerHTML = `
        <div class="biometric-success">
            <div class="success-icon">
                <svg width="64" height="64" fill="#28a745" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                </svg>
            </div>
            <h3 class="success-title">Face ID настроен!</h3>
            <p class="success-subtitle">Теперь вы можете входить в приложение с помощью Face ID</p>
        </div>
    `;
    
    setTimeout(() => {
        window.location.href = '{{ url_for("objects.object_list") }}';
    }, 2000);
}

function showBiometricError() {
    document.querySelector('.biometric-setup-section').innerHTML = `
        <div class="biometric-error">
            <div class="error-icon">
                <svg width="64" height="64" fill="#dc3545" viewBox="0 0 16 16">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                </svg>
            </div>
            <h3 class="error-title">Face ID недоступен</h3>
            <p class="error-subtitle">Ваше устройство не поддерживает Face ID или он не настроен</p>
            <button class="biometric-btn biometric-btn-primary" onclick="skipBiometric()">
                Продолжить без Face ID
            </button>
        </div>
    `;
}
</script>
{% endblock %}
