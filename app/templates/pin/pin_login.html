{% extends "pin/pin_layout.html" %}

{% block title %}–í—Ö–æ–¥ –ø–æ PIN{% endblock %}
{% block header_title %}–í—Ö–æ–¥{% endblock %}

{% block content %}
<div class="pin-login-container">
    <div class="pin-icon-section">
        <div class="pin-icon">
            <svg width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
            </svg>
        </div>
        <h2 class="pin-title">–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥</h2>
        <p class="pin-subtitle">–î–ª—è –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
    </div>

    <div class="pin-display">
        <div class="pin-dots">
            <div class="pin-dot" id="dot1"></div>
            <div class="pin-dot" id="dot2"></div>
            <div class="pin-dot" id="dot3"></div>
            <div class="pin-dot" id="dot4"></div>
        </div>
    </div>

    <div class="pin-keypad">
        <div class="pin-row">
            <button class="pin-key" data-key="1">1</button>
            <button class="pin-key" data-key="2">2</button>
            <button class="pin-key" data-key="3">3</button>
        </div>
        <div class="pin-row">
            <button class="pin-key" data-key="4">4</button>
            <button class="pin-key" data-key="5">5</button>
            <button class="pin-key" data-key="6">6</button>
        </div>
        <div class="pin-row">
            <button class="pin-key" data-key="7">7</button>
            <button class="pin-key" data-key="8">8</button>
            <button class="pin-key" data-key="9">9</button>
        </div>
        <div class="pin-row">
            <button class="pin-key pin-key-biometric" id="biometricBtn" style="display: none;">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                </svg>
            </button>
            <button class="pin-key" data-key="0">0</button>
            <button class="pin-key pin-key-delete" id="deleteBtn">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- –ß–µ–∫–±–æ–∫—Å –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
    <div class="remember-device-section">
        <label class="remember-device-checkbox">
            <input type="checkbox" id="rememberDevice" />
            <span class="checkmark"></span>
            <span class="remember-text">–ó–∞–ø–æ–º–Ω–∏—Ç—å —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</span>
        </label>
        <small class="remember-hint">–í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –≤—Ö–æ–¥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º</small>
    </div>

    <div class="pin-footer">
        <button class="pin-link" onclick="window.location.href='{{ url_for('user.login') }}'">
            –í–æ–π—Ç–∏ –ø–æ –ª–æ–≥–∏–Ω—É
        </button>
    </div>
</div>

<style>
.pin-login-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
}

.pin-icon-section {
    text-align: center;
    margin-bottom: 40px;
}

.pin-icon {
    color: #007bff;
    margin-bottom: 20px;
}

.pin-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--bs-body-color);
}

.pin-subtitle {
    color: var(--bs-secondary-color);
    font-size: 16px;
}

.pin-display {
    margin-bottom: 40px;
}

.pin-dots {
    display: flex;
    gap: 20px;
    justify-content: center;
}

.pin-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid var(--bs-border-color);
    background: transparent;
    transition: all 0.2s ease;
}

.pin-dot.filled {
    background: #007bff;
    border-color: #007bff;
}

.pin-keypad {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 20px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ */
.remember-device-section {
    margin-bottom: 20px;
    text-align: center;
}

.remember-device-checkbox {
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    color: var(--bs-body-color);
}

.remember-device-checkbox input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid var(--bs-border-color);
    border-radius: 4px;
    margin-right: 8px;
    position: relative;
    background: var(--bs-body-bg);
    transition: all 0.2s ease;
}

.remember-device-checkbox input[type="checkbox"]:checked + .checkmark {
    background: var(--bs-primary);
    border-color: var(--bs-primary);
}

.remember-device-checkbox input[type="checkbox"]:checked + .checkmark::after {
    content: '';
    position: absolute;
    left: 6px;
    top: 2px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.remember-text {
    font-weight: 500;
}

.remember-hint {
    display: block;
    margin-top: 4px;
    color: var(--bs-secondary);
    font-size: 12px;
}

.pin-row {
    display: flex;
    gap: 20px;
    justify-content: center;
}

.pin-key {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 2px solid var(--bs-border-color);
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
    font-size: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.pin-key:hover {
    background: var(--bs-secondary-bg);
    border-color: #007bff;
}

.pin-key:active {
    transform: scale(0.95);
    background: #007bff;
    color: white;
}

.pin-key-biometric {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-color: #007bff;
}

.pin-key-delete {
    background: var(--bs-danger-bg-subtle);
    color: var(--bs-danger);
    border-color: var(--bs-danger-border-subtle);
}

.pin-footer {
    text-align: center;
}

.pin-link {
    background: none;
    border: none;
    color: #007bff;
    text-decoration: underline;
    font-size: 16px;
    cursor: pointer;
}

.pin-link:hover {
    color: #0056b3;
}

/* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
[data-bs-theme="dark"] .pin-key {
    border-color: #495057;
}

[data-bs-theme="dark"] .pin-key:hover {
    background: #343a40;
    border-color: #007bff;
}

[data-bs-theme="dark"] .pin-dot {
    border-color: #495057;
}
</style>

<script>
let currentPin = '';
let isAuthenticating = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
const maxPinLength = 4;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –±–∏–æ–º–µ—Ç—Ä–∏–∏
async function checkBiometricSupport() {
    if ('credentials' in navigator && 'create' in navigator.credentials) {
        try {
            const biometricBtn = document.getElementById('biometricBtn');
            biometricBtn.style.display = 'flex';
            
            biometricBtn.addEventListener('click', async () => {
                try {
                    const credential = await navigator.credentials.create({
                        publicKey: {
                            challenge: new Uint8Array(32),
                            rp: { name: "–°—Ç—Ä–æ–π–ö–æ–º–ø–ª–µ–∫—Å" },
                            user: {
                                id: new Uint8Array(16),
                                name: "user",
                                displayName: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
                            },
                            pubKeyCredParams: [{alg: -7, type: "public-key"}],
                            authenticatorSelection: {
                                authenticatorAttachment: "platform",
                                userVerification: "required"
                            }
                        }
                    });
                    
                    // –ï—Å–ª–∏ –±–∏–æ–º–µ—Ç—Ä–∏—è —É—Å–ø–µ—à–Ω–∞, –≤—Ö–æ–¥–∏–º –≤ —Å–∏—Å—Ç–µ–º—É
                    const rememberDevice = document.getElementById('rememberDevice').checked;
                    const response = await fetch('/pin/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            biometric: true,
                            remember_device: rememberDevice
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        isAuthenticating = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ localStorage, –µ—Å–ª–∏ –æ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω
                        if (result.device_token) {
                            localStorage.setItem('device_token', result.device_token);
                        }
                        console.log('‚úÖ –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
                        window.location.href = result.redirect;
                    }
                } catch (error) {
                    console.log('–ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', error);
                }
            });
        } catch (error) {
            console.log('–ë–∏–æ–º–µ—Ç—Ä–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        }
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à
document.addEventListener('DOMContentLoaded', function() {
    checkBiometricSupport();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–æ–º–Ω–µ–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
    if (!document.body.classList.contains('authenticated')) {
        checkRememberedDevice();
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º Face ID, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –µ–≥–æ
    // –ù–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∏–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–º–Ω–µ–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    {% if has_biometric_users %}
    console.log('Users with biometric enabled found, offering Face ID');
    setTimeout(() => {
        if (!isAuthenticating) {
            const biometricBtn = document.getElementById('biometricBtn');
            if (biometricBtn && biometricBtn.style.display !== 'none') {
                console.log('Automatically triggering Face ID');
                biometricBtn.click();
            }
        } else {
            console.log('‚è≥ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Face ID - –∏–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
        }
    }, 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
    {% endif %}
    
    const pinKeys = document.querySelectorAll('.pin-key[data-key]');
    const deleteBtn = document.getElementById('deleteBtn');
    
    pinKeys.forEach(key => {
        key.addEventListener('click', () => {
            const digit = key.dataset.key;
            addDigit(digit);
        });
    });
    
    deleteBtn.addEventListener('click', () => {
        removeDigit();
    });
    
    // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
    pinKeys.forEach(key => {
        key.addEventListener('click', () => {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        });
    });
});

function addDigit(digit) {
    if (currentPin.length < maxPinLength) {
        currentPin += digit;
        updateDots();
        
        if (currentPin.length === maxPinLength) {
            setTimeout(() => {
                verifyPin();
            }, 300);
        }
    }
}

function removeDigit() {
    if (currentPin.length > 0) {
        currentPin = currentPin.slice(0, -1);
        updateDots();
    }
}

function updateDots() {
    for (let i = 1; i <= maxPinLength; i++) {
        const dot = document.getElementById(`dot${i}`);
        if (i <= currentPin.length) {
            dot.classList.add('filled');
        } else {
            dot.classList.remove('filled');
        }
    }
}

async function verifyPin() {
    try {
        const rememberDevice = document.getElementById('rememberDevice').checked;
        
        const response = await fetch('/pin/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                pin: currentPin,
                remember_device: rememberDevice
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            isAuthenticating = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ localStorage, –µ—Å–ª–∏ –æ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω
            if (result.device_token) {
                localStorage.setItem('device_token', result.device_token);
            }
            
            // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
            document.querySelectorAll('.pin-dot').forEach(dot => {
                dot.style.background = '#28a745';
                dot.style.borderColor = '#28a745';
            });
            
            console.log('‚úÖ PIN-–≤—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
            setTimeout(() => {
                window.location.href = result.redirect;
            }, 500);
        } else {
            isAuthenticating = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            // –ù–µ–≤–µ—Ä–Ω—ã–π PIN
            document.querySelectorAll('.pin-dot').forEach(dot => {
                dot.style.background = '#dc3545';
                dot.style.borderColor = '#dc3545';
            });
            
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
            
            setTimeout(() => {
                currentPin = '';
                updateDots();
                document.querySelectorAll('.pin-dot').forEach(dot => {
                    dot.style.background = '';
                    dot.style.borderColor = '';
                });
            }, 1000);
        }
    } catch (error) {
        isAuthenticating = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ PIN:', error);
        currentPin = '';
        updateDots();
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–º–Ω–µ–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
async function checkRememberedDevice() {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –µ—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    if (isAuthenticating) {
        console.log('‚è≥ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
        return;
    }
    
    const deviceToken = localStorage.getItem('device_token');
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–º–Ω–µ–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç–æ–∫–µ–Ω:', deviceToken ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
    
    if (deviceToken) {
        isAuthenticating = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
        try {
            console.log('üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...');
            const response = await fetch('/pin/check-device', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ device_token: deviceToken })
            });
            
            const result = await response.json();
            console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
            
            if (result.success) {
                console.log('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω
                window.location.href = result.redirect;
            } else {
                console.log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, —É–¥–∞–ª—è–µ–º –µ–≥–æ');
                // –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, —É–¥–∞–ª—è–µ–º –µ–≥–æ
                localStorage.removeItem('device_token');
                isAuthenticating = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', error);
            localStorage.removeItem('device_token');
            isAuthenticating = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
        }
    } else {
        console.log('‚ÑπÔ∏è –¢–æ–∫–µ–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞');
    }
}
</script>
{% endblock %}
