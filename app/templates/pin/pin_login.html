{% extends "pin/pin_layout.html" %}

{% block title %}Вход по PIN{% endblock %}
{% block header_title %}Вход{% endblock %}

{% block content %}
<div class="pin-login-container">
    <div class="pin-icon-section">
        <div class="pin-icon">
            <svg width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
            </svg>
        </div>
        <h2 class="pin-title">Введите PIN-код</h2>
        <p class="pin-subtitle">Для входа в приложение</p>
    </div>

    <div class="pin-display">
        <div class="pin-dots">
            <div class="pin-dot" id="dot1"></div>
            <div class="pin-dot" id="dot2"></div>
            <div class="pin-dot" id="dot3"></div>
            <div class="pin-dot" id="dot4"></div>
        </div>
    </div>

    <div class="pin-keypad">
        <div class="pin-row">
            <button class="pin-key" data-key="1">1</button>
            <button class="pin-key" data-key="2">2</button>
            <button class="pin-key" data-key="3">3</button>
        </div>
        <div class="pin-row">
            <button class="pin-key" data-key="4">4</button>
            <button class="pin-key" data-key="5">5</button>
            <button class="pin-key" data-key="6">6</button>
        </div>
        <div class="pin-row">
            <button class="pin-key" data-key="7">7</button>
            <button class="pin-key" data-key="8">8</button>
            <button class="pin-key" data-key="9">9</button>
        </div>
        <div class="pin-row">
            <button class="pin-key pin-key-biometric" id="biometricBtn" style="display: none;">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                </svg>
            </button>
            <button class="pin-key" data-key="0">0</button>
            <button class="pin-key pin-key-delete" id="deleteBtn">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Чекбокс для запоминания устройства -->
    <div class="remember-device-section">
        <label class="remember-device-checkbox">
            <input type="checkbox" id="rememberDevice" />
            <span class="checkmark"></span>
            <span class="remember-text">Запомнить это устройство</span>
        </label>
        <small class="remember-hint">В следующий раз вход будет автоматическим</small>
    </div>

    <div class="pin-footer">
        <button class="pin-link" onclick="window.location.href='{{ url_for('user.login') }}'">
            Войти по логину
        </button>
    </div>
</div>

<style>
.pin-login-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
}

.pin-icon-section {
    text-align: center;
    margin-bottom: 40px;
}

.pin-icon {
    color: #007bff;
    margin-bottom: 20px;
}

.pin-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--bs-body-color);
}

.pin-subtitle {
    color: var(--bs-secondary-color);
    font-size: 16px;
}

.pin-display {
    margin-bottom: 40px;
}

.pin-dots {
    display: flex;
    gap: 20px;
    justify-content: center;
}

.pin-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid var(--bs-border-color);
    background: transparent;
    transition: all 0.2s ease;
}

.pin-dot.filled {
    background: #007bff;
    border-color: #007bff;
}

.pin-keypad {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 20px;
}

/* Стили для чекбокса запоминания устройства */
.remember-device-section {
    margin-bottom: 20px;
    text-align: center;
}

.remember-device-checkbox {
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    color: var(--bs-body-color);
}

.remember-device-checkbox input[type="checkbox"] {
    display: none;
}

.checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid var(--bs-border-color);
    border-radius: 4px;
    margin-right: 8px;
    position: relative;
    background: var(--bs-body-bg);
    transition: all 0.2s ease;
}

.remember-device-checkbox input[type="checkbox"]:checked + .checkmark {
    background: var(--bs-primary);
    border-color: var(--bs-primary);
}

.remember-device-checkbox input[type="checkbox"]:checked + .checkmark::after {
    content: '';
    position: absolute;
    left: 6px;
    top: 2px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.remember-text {
    font-weight: 500;
}

.remember-hint {
    display: block;
    margin-top: 4px;
    color: var(--bs-secondary);
    font-size: 12px;
}

.pin-row {
    display: flex;
    gap: 20px;
    justify-content: center;
}

.pin-key {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 2px solid var(--bs-border-color);
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
    font-size: 24px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.pin-key:hover {
    background: var(--bs-secondary-bg);
    border-color: #007bff;
}

.pin-key:active {
    transform: scale(0.95);
    background: #007bff;
    color: white;
}

.pin-key-biometric {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-color: #007bff;
}

.pin-key-delete {
    background: var(--bs-danger-bg-subtle);
    color: var(--bs-danger);
    border-color: var(--bs-danger-border-subtle);
}

.pin-footer {
    text-align: center;
}

.pin-link {
    background: none;
    border: none;
    color: #007bff;
    text-decoration: underline;
    font-size: 16px;
    cursor: pointer;
}

.pin-link:hover {
    color: #0056b3;
}

/* Темная тема */
[data-bs-theme="dark"] .pin-key {
    border-color: #495057;
}

[data-bs-theme="dark"] .pin-key:hover {
    background: #343a40;
    border-color: #007bff;
}

[data-bs-theme="dark"] .pin-dot {
    border-color: #495057;
}
</style>

<script>
let currentPin = '';
let isAuthenticating = false; // Флаг для предотвращения повторной проверки
const maxPinLength = 4;

// Проверяем поддержку биометрии
async function checkBiometricSupport() {
    if ('credentials' in navigator && 'create' in navigator.credentials) {
        try {
            const biometricBtn = document.getElementById('biometricBtn');
            biometricBtn.style.display = 'flex';
            
            biometricBtn.addEventListener('click', async () => {
                try {
                    const credential = await navigator.credentials.create({
                        publicKey: {
                            challenge: new Uint8Array(32),
                            rp: { name: "СтройКомплекс" },
                            user: {
                                id: new Uint8Array(16),
                                name: "user",
                                displayName: "Пользователь"
                            },
                            pubKeyCredParams: [{alg: -7, type: "public-key"}],
                            authenticatorSelection: {
                                authenticatorAttachment: "platform",
                                userVerification: "required"
                            }
                        }
                    });
                    
                    // Если биометрия успешна, входим в систему
                    const rememberDevice = document.getElementById('rememberDevice').checked;
                    const response = await fetch('/pin/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            biometric: true,
                            remember_device: rememberDevice
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        isAuthenticating = true; // Устанавливаем флаг
                        // Сохраняем токен устройства в localStorage, если он предоставлен
                        if (result.device_token) {
                            localStorage.setItem('device_token', result.device_token);
                        }
                        console.log('✅ Биометрический вход успешен, перенаправление...');
                        window.location.href = result.redirect;
                    }
                } catch (error) {
                    console.log('Биометрическая аутентификация недоступна:', error);
                }
            });
        } catch (error) {
            console.log('Биометрия не поддерживается');
        }
    }
}

// Обработка нажатий клавиш
document.addEventListener('DOMContentLoaded', function() {
    checkBiometricSupport();
    
    // Проверяем запомненное устройство только если пользователь не авторизован
    if (!document.body.classList.contains('authenticated')) {
        checkRememberedDevice();
    }
    
    // Если есть пользователи с настроенным Face ID, автоматически предлагаем его
    // Но только если не идет проверка запомненного устройства
    {% if has_biometric_users %}
    console.log('Users with biometric enabled found, offering Face ID');
    setTimeout(() => {
        if (!isAuthenticating) {
            const biometricBtn = document.getElementById('biometricBtn');
            if (biometricBtn && biometricBtn.style.display !== 'none') {
                console.log('Automatically triggering Face ID');
                biometricBtn.click();
            }
        } else {
            console.log('⏳ Пропускаем автоматический Face ID - идет проверка устройства');
        }
    }, 1000); // Небольшая задержка для лучшего UX
    {% endif %}
    
    const pinKeys = document.querySelectorAll('.pin-key[data-key]');
    const deleteBtn = document.getElementById('deleteBtn');
    
    pinKeys.forEach(key => {
        key.addEventListener('click', () => {
            const digit = key.dataset.key;
            addDigit(digit);
        });
    });
    
    deleteBtn.addEventListener('click', () => {
        removeDigit();
    });
    
    // Вибрация при нажатии
    pinKeys.forEach(key => {
        key.addEventListener('click', () => {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        });
    });
});

function addDigit(digit) {
    if (currentPin.length < maxPinLength) {
        currentPin += digit;
        updateDots();
        
        if (currentPin.length === maxPinLength) {
            setTimeout(() => {
                verifyPin();
            }, 300);
        }
    }
}

function removeDigit() {
    if (currentPin.length > 0) {
        currentPin = currentPin.slice(0, -1);
        updateDots();
    }
}

function updateDots() {
    for (let i = 1; i <= maxPinLength; i++) {
        const dot = document.getElementById(`dot${i}`);
        if (i <= currentPin.length) {
            dot.classList.add('filled');
        } else {
            dot.classList.remove('filled');
        }
    }
}

async function verifyPin() {
    try {
        const rememberDevice = document.getElementById('rememberDevice').checked;
        
        const response = await fetch('/pin/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                pin: currentPin,
                remember_device: rememberDevice
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            isAuthenticating = true; // Устанавливаем флаг
            // Сохраняем токен устройства в localStorage, если он предоставлен
            if (result.device_token) {
                localStorage.setItem('device_token', result.device_token);
            }
            
            // Успешный вход
            document.querySelectorAll('.pin-dot').forEach(dot => {
                dot.style.background = '#28a745';
                dot.style.borderColor = '#28a745';
            });
            
            console.log('✅ PIN-вход успешен, перенаправление...');
            setTimeout(() => {
                window.location.href = result.redirect;
            }, 500);
        } else {
            isAuthenticating = false; // Сбрасываем флаг при ошибке
            // Неверный PIN
            document.querySelectorAll('.pin-dot').forEach(dot => {
                dot.style.background = '#dc3545';
                dot.style.borderColor = '#dc3545';
            });
            
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
            
            setTimeout(() => {
                currentPin = '';
                updateDots();
                document.querySelectorAll('.pin-dot').forEach(dot => {
                    dot.style.background = '';
                    dot.style.borderColor = '';
                });
            }, 1000);
        }
    } catch (error) {
        isAuthenticating = false; // Сбрасываем флаг при ошибке
        console.error('Ошибка при проверке PIN:', error);
        currentPin = '';
        updateDots();
    }
}

// Проверка запомненного устройства
async function checkRememberedDevice() {
    // Предотвращаем повторную проверку если уже идет аутентификация
    if (isAuthenticating) {
        console.log('⏳ Аутентификация уже в процессе, пропускаем проверку устройства');
        return;
    }
    
    const deviceToken = localStorage.getItem('device_token');
    console.log('🔍 Проверка запомненного устройства, токен:', deviceToken ? 'найден' : 'не найден');
    
    if (deviceToken) {
        isAuthenticating = true; // Устанавливаем флаг
        try {
            console.log('📡 Отправка запроса на проверку устройства...');
            const response = await fetch('/pin/check-device', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ device_token: deviceToken })
            });
            
            const result = await response.json();
            console.log('📥 Ответ сервера:', result);
            
            if (result.success) {
                console.log('✅ Автоматический вход выполнен, перенаправление...');
                // Автоматический вход выполнен
                window.location.href = result.redirect;
            } else {
                console.log('❌ Токен недействителен, удаляем его');
                // Токен недействителен, удаляем его
                localStorage.removeItem('device_token');
                isAuthenticating = false; // Сбрасываем флаг
            }
        } catch (error) {
            console.error('❌ Ошибка при проверке устройства:', error);
            localStorage.removeItem('device_token');
            isAuthenticating = false; // Сбрасываем флаг
        }
    } else {
        console.log('ℹ️ Токен устройства не найден, показываем форму входа');
    }
}
</script>
{% endblock %}
