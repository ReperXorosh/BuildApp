{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'objects' %}

{% block title %}Добавить траншею{% endblock %}
{% block mobile_title %}Добавить траншею{% endblock %}

{% block content %}
<div class="mobile-card">
    <div class="mobile-card-title d-flex align-items-center">
        <svg width="18" height="18" class="me-2" fill="currentColor" viewBox="0 0 16 16">
            <path d="M0 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4H0V6z"/>
        </svg>
        Добавить траншею
    </div>
    <div class="mobile-card-text mobile-mb-2">
        Объект: <a href="{{ url_for('objects.object_detail', object_id=object.id) }}">{{ object.name }}</a>
    </div>
    <form method="POST" id="add-trench-form" novalidate>
        <div class="mobile-form-group">
            <label class="mobile-form-label">Запланированная длина (м) *</label>
            <input type="number" step="0.01" min="0" name="planned_length" id="planned_length" class="mobile-form-control" required>
            <div class="invalid-feedback" style="display:none" id="planned-error">Укажите запланированную длину больше 0.</div>
        </div>
        <div class="mobile-form-group">
            <label class="mobile-form-label">Текущая длина (м)</label>
            <input type="number" step="0.01" min="0" name="current_length" id="current_length" class="mobile-form-control">
        </div>
        <div class="mobile-form-group">
            <label class="mobile-form-label">Ширина (м)</label>
            <input type="number" step="0.01" min="0" name="width" id="width" class="mobile-form-control">
        </div>
        <div class="mobile-form-group">
            <label class="mobile-form-label">Глубина (м)</label>
            <input type="number" step="0.01" min="0" name="depth" id="depth" class="mobile-form-control">
        </div>
        <div class="mobile-form-group">
            <label class="mobile-form-label">Тип грунта</label>
            <input type="text" name="soil_type" id="soil_type" class="mobile-form-control" maxlength="80">
        </div>
        <div class="mobile-form-group">
            <label class="mobile-form-label">Дата рытья</label>
            <input type="date" name="excavation_date" id="excavation_date" class="mobile-form-control">
        </div>
        <div class="mobile-form-group">
            <label class="mobile-form-label">Заметки</label>
            <textarea name="notes" id="notes" class="mobile-form-control" rows="3" maxlength="300" placeholder="Дополнительная информация"></textarea>
            <div class="small text-muted" id="notes-counter">0 / 300</div>
        </div>
        <button type="submit" class="mobile-btn mobile-btn-primary" id="submit-btn">Сохранить траншею</button>
        <a href="{{ url_for('objects.trenches_list', object_id=object.id) }}" class="mobile-btn mobile-btn-outline">Назад</a>
    </form>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mobile-mt-2">
        {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-trench-form');
    const submitBtn = document.getElementById('submit-btn');
    const planned = document.getElementById('planned_length');
    const plannedError = document.getElementById('planned-error');
    const current = document.getElementById('current_length');
    const width = document.getElementById('width');
    const depth = document.getElementById('depth');
    const soil = document.getElementById('soil_type');
    const notes = document.getElementById('notes');
    const notesCounter = document.getElementById('notes-counter');

    // Счетчик примечаний
    if (notes && notesCounter) {
        const updateCounter = () => notesCounter.textContent = `${notes.value.length} / 300`;
        notes.addEventListener('input', updateCounter);
        updateCounter();
    }

    // Тримминг текстовых полей
    const trimField = (el) => { if (el) el.value = el.value.trim().replace(/\s{2,}/g, ' '); };
    [soil, notes].forEach(el => el && el.addEventListener('blur', () => trimField(el)));

    // Валидация planned_length
    const validatePlanned = () => {
        const val = parseFloat(planned.value);
        if (isNaN(val) || val <= 0) { plannedError.style.display = 'block'; return false; }
        plannedError.style.display = 'none';
        return true;
    };
    planned.addEventListener('input', validatePlanned);

    form.addEventListener('submit', function(e) {
        trimField(soil); trimField(notes);
        if (!validatePlanned()) { e.preventDefault(); return false; }
        submitBtn.disabled = true;
        const original = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Сохранение...';
        setTimeout(() => { submitBtn.disabled = false; submitBtn.innerHTML = original; }, 4000);
    });
});
</script>
{% endblock %}


