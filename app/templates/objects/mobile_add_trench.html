{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'objects' %}

{% block title %}Добавить траншею{% endblock %}
{% block mobile_title %}Новая траншея{% endblock %}

{% block content %}
<div class="mobile-card add-object-card">
    <div class="mobile-card-title text-center">
        Добавить траншею
    </div>

    <form method="POST" id="add-trench-form" novalidate>
        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="planned_length">Запланированная длина (м) *</label>
            <input type="number" 
                   step="0.01" 
                   min="0" 
                   name="planned_length" 
                   id="planned_length" 
                   class="mobile-form-control mobile-form-control-lg" 
                   placeholder="Введите длину"
                   required>
            <div class="invalid-feedback" style="display:none" id="planned-error">Укажите запланированную длину больше 0.</div>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="current_length">Текущая длина (м)</label>
            <input type="number" 
                   step="0.01" 
                   min="0" 
                   name="current_length" 
                   id="current_length" 
                   class="mobile-form-control" 
                   placeholder="Введите текущую длину">
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="width">Ширина (м)</label>
            <input type="number" 
                   step="0.01" 
                   min="0" 
                   name="width" 
                   id="width" 
                   class="mobile-form-control" 
                   placeholder="Введите ширину">
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="depth">Глубина (м)</label>
            <input type="number" 
                   step="0.01" 
                   min="0" 
                   name="depth" 
                   id="depth" 
                   class="mobile-form-control" 
                   placeholder="Введите глубину">
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="excavation_date">Дата рытья</label>
            <input type="date" 
                   name="excavation_date" 
                   id="excavation_date" 
                   class="mobile-form-control">
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="notes">Заметки</label>
            <textarea name="notes" 
                      id="notes" 
                      class="mobile-form-control" 
                      rows="2" 
                      placeholder="Дополнительная информация"></textarea>
        </div>

        <div class="mobile-mt-4">
            <button type="submit" class="mobile-btn mobile-btn-primary w-100" id="submit-btn">
                Сохранить траншею
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-trench-form');
    const submitBtn = document.getElementById('submit-btn');
    const planned = document.getElementById('planned_length');
    const plannedError = document.getElementById('planned-error');
    const current = document.getElementById('current_length');
    const width = document.getElementById('width');
    const depth = document.getElementById('depth');
    const notes = document.getElementById('notes');
    
    let isDirty = false;
    
    // Помечаем форму как изменённую при вводе в любые поля
    [planned, current, width, depth, notes].forEach(el => {
        if (!el) return;
        el.addEventListener('input', () => { isDirty = true; });
    });
    
    // Обработчик «Назад» с предупреждением
    function confirmLeaveIfDirty(action){
        if (!isDirty) { action(); return; }
        if (confirm('Данные не будут сохранены. Вернуться на предыдущую страницу?')) {
            action();
        }
    }
    
    const backBtn = document.querySelector('.mobile-back-btn');
    if (backBtn) {
        backBtn.onclick = function(e){
            e.preventDefault();
            confirmLeaveIfDirty(() => { window.history.back(); });
        };
    }
    
    // Предупреждение при закрытии страницы
    window.addEventListener('beforeunload', function(e) {
        if (isDirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    // Тримминг текстовых полей
    const trimField = (el) => { if (el) el.value = el.value.trim().replace(/\s{2,}/g, ' '); };
    [notes].forEach(el => el && el.addEventListener('blur', () => trimField(el)));
    
    // Валидация planned_length
    const validatePlanned = () => {
        const val = parseFloat(planned.value);
        if (isNaN(val) || val <= 0) { 
            plannedError.style.display = 'block'; 
            return false; 
        }
        plannedError.style.display = 'none';
        return true;
    };
    planned.addEventListener('input', validatePlanned);
    
    form.addEventListener('submit', function(e) {
        trimField(notes);
        if (!validatePlanned()) { 
            e.preventDefault(); 
            return false; 
        }
        
        submitBtn.disabled = true;
        const original = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Сохранение...';
        
        setTimeout(() => { 
            submitBtn.disabled = false; 
            submitBtn.innerHTML = original; 
        }, 4000);
    });
    
    // Убираем прокрутку и настраиваем отступы
    try {
        const mobileContent = document.querySelector('.mobile-content');
        if (mobileContent) {
            mobileContent.style.paddingBottom = '16px';
            mobileContent.style.overflow = 'hidden';
            mobileContent.style.height = 'auto';
        }
        document.documentElement.style.overscrollBehaviorY = 'contain';
        document.body.style.overflow = 'hidden';
        window.scrollTo(0, 0);
    } catch(e) {}
});
</script>

<style>
/* Локальные правки для лучшей читаемости в светлой теме только на этой странице */
.mobile-app { background: var(--bs-body-bg); }

[data-bs-theme="light"] .add-object-card { 
    background: #ffffff; 
    color: #0f172a; 
}

[data-bs-theme="light"] .mobile-form-label { 
    color: #111827; 
}

[data-bs-theme="light"] .mobile-form-control,
[data-bs-theme="light"] .mobile-form-control-lg {
    background: #ffffff;
    border-color: #d1d5db;
    color: #111827;
}

[data-bs-theme="light"] .mobile-form-control::placeholder,
[data-bs-theme="light"] .mobile-form-control-lg::placeholder { 
    color: #6b7280; 
}

[data-bs-theme="light"] .mobile-btn-outline { 
    border-color: #cbd5e1; 
    color: #334155; 
}

[data-bs-theme="light"] .mobile-card-title { 
    color: #0f172a; 
}

/* Точная поддержка темной темы как на страницах добавления объекта/позиции */
[data-bs-theme="dark"] .add-object-card { 
    background: var(--bs-body-bg); 
    border-color: #2d3748; 
    box-shadow: 0 6px 18px rgba(0,0,0,.2); 
}

[data-bs-theme="dark"] .add-object-card .mobile-form-group { 
    background: #1f2937; 
    border-color: #374151; 
}

[data-bs-theme="dark"] .mobile-form-label { 
    color: #e5e7eb; 
}

[data-bs-theme="dark"] .mobile-card-title { 
    color: #f9fafb; 
}

[data-bs-theme="dark"] .mobile-form-control-lg { 
    background: #1f2937; 
    border-color: #374151; 
    color: #f9fafb; 
    box-shadow: 0 2px 4px rgba(0,0,0,.2); 
}

[data-bs-theme="dark"] .mobile-form-control { 
    background: #1f2937; 
    border-color: #374151; 
    color: #f9fafb; 
    box-shadow: 0 2px 4px rgba(0,0,0,.2); 
}

[data-bs-theme="dark"] .mobile-form-control:focus, 
[data-bs-theme="dark"] .mobile-form-control-lg:focus { 
    border-color: #3b82f6; 
    box-shadow: 0 0 0 4px rgba(59,130,246,.2), 0 4px 12px rgba(0,0,0,.3); 
}

/* Стили для карточки */
.add-object-card { 
    background: #fff; 
    border: 1px solid #e5e7eb; 
    box-shadow: 0 6px 18px rgba(0,0,0,.06); 
    padding: 12px; 
    border-radius: 12px; 
}

.add-object-card .mobile-form-group { 
    background: #f9fafb; 
    border: 1px solid #eef2f7; 
    border-radius: 12px; 
    padding: 12px; 
}

.add-object-card .mobile-form-group + .mobile-form-group { 
    margin-top: 8px; 
}

.mobile-card-title { 
    font-size: 1.5rem; 
    font-weight: 700; 
    margin-bottom: 1rem; 
    color: #111827; 
    letter-spacing: -.025em; 
}

.mobile-form-label { 
    display: block; 
    font-size: .9rem; 
    font-weight: 600; 
    color: #374151; 
    margin-bottom: 6px; 
    letter-spacing: .025em; 
}

.mobile-form-control-lg { 
    font-size: 1.05rem; 
    padding: 12px 16px; 
    border-radius: 12px; 
    border: 2px solid #e1e5e9; 
    background: #fff; 
    color: #111827; 
    transition: all .3s cubic-bezier(.4,0,.2,1); 
    box-shadow: 0 2px 4px rgba(0,0,0,.04); 
    font-weight: 500; 
}

.mobile-form-control { 
    font-size: .95rem; 
    padding: 10px 14px; 
    border-radius: 12px; 
    border: 2px solid #e1e5e9; 
    background: #fff; 
    color: #111827; 
    transition: all .3s cubic-bezier(.4,0,.2,1); 
    box-shadow: 0 2px 4px rgba(0,0,0,.04); 
    font-weight: 500; 
}

.mobile-mt-4 { 
    margin-top: 12px; 
}

.mobile-btn { 
    border-radius: 12px; 
    font-weight: 600; 
    padding: 12px 20px; 
    font-size: .95rem; 
    transition: all .3s cubic-bezier(.4,0,.2,1); 
    letter-spacing: .025em; 
    border: none; 
    position: relative; 
    overflow: hidden; 
}
</style>
{% endblock %}