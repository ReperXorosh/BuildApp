{% extends "main/layout.html" %}
{% block title %}Элемент: {{ element_type }}{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-3">{{ element_type }}</h2>
  <div class="card">
    <div class="card-body">
      <dl class="row mb-0">
        <dt class="col-sm-3">Название</dt>
        <dd class="col-sm-9">{{ element.zdf_name or element.bracket_name or element.luminaire_name or '—' }}</dd>
        <dt class="col-sm-3">Статус</dt>
        <dd class="col-sm-9">{{ element.status or '—' }}</dd>
        <dt class="col-sm-3">Заметки</dt>
        {% set _notes_lines = (element.notes or '').split('\n') %}
        {% set _filtered = [] %}
        {% for _l in _notes_lines %}
          {% set _t = _l|trim %}
          {% if _t and ('Файл:' not in _t) %}{% set _ = _filtered.append(_t) %}{% endif %}
        {% endfor %}
        <dd class="col-sm-9">{{ (_filtered|length > 0) and (_filtered|join('\n')|replace('\n','<br>')|safe) or '—' }}</dd>
        {# Попытка извлечь прикреплённый файл из заметок вида: "Файл: /static/uploads/elements/<name>" #}
        {% set file_url = None %}
        {% for line in (element.notes or '').split('\n') %}
          {% if 'Файл:' in line %}
            {% set file_url = line|replace('Файл:', '')|trim %}
          {% endif %}
        {% endfor %}
        {% set _old_file_url = None %}
        {% for line in (element.notes or '').split('\n') %}
          {% if 'Файл:' in line %}
            {% set _old_file_url = line|replace('Файл:', '')|trim %}
          {% endif %}
        {% endfor %}
        
        {% if attachments or _old_file_url %}
          <dt class="col-sm-3">Файлы</dt>
          <dd class="col-sm-9">
            <!-- Старые файлы из notes -->
            {% if _old_file_url %}
            <div class="mb-2">
              <a href="{{ _old_file_url }}" target="_blank" class="btn btn-sm btn-outline-secondary me-2" title="Просмотреть файл">
                <svg class="bi me-1" width="16" height="16" aria-hidden="true"><use xlink:href="#file-earmark-text"></use></svg>
                Файл
              </a>
            </div>
            {% endif %}
            
            <!-- Новые файлы из ElementAttachment -->
            {% for attachment in attachments %}
            <div class="mb-2">
              <a href="{{ url_for('objects.view_element_attachment', object_id=object.id, element_type=element_type.lower(), element_id=element.id, attachment_id=attachment.id) }}" 
                 target="_blank" class="btn btn-sm btn-outline-secondary me-2" title="Просмотреть файл">
                <svg class="bi me-1" width="16" height="16" aria-hidden="true"><use xlink:href="#file-earmark-text"></use></svg>
                {{ attachment.original_filename }}
              </a>
              <small class="text-muted">({{ attachment.size_bytes // 1024 }} КБ)</small>
            </div>
            {% endfor %}
          </dd>
        {% endif %}
      </dl>
    </div>
  </div>
  <a href="{{ url_for('objects.elements_list', object_id=object.id) }}" class="btn btn-secondary mt-3">Назад к элементам</a>
</div>
{% endblock %}
