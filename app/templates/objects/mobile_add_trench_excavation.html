{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'objects' %}

{% block title %}Добавить запись о копке{% endblock %}
{% block mobile_title %}Новая запись о копке{% endblock %}

{% block content %}
<div class="mobile-card add-object-card">
    <div class="mobile-card-title text-center">
        Добавить запись о копке
    </div>

    <form method="POST" enctype="multipart/form-data" id="add-excavation-form" novalidate>
        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0; min-height: 80px; position: relative; z-index: 10;">
            <label class="mobile-form-label" for="length">Длина выкопанного участка (м) *</label>
            <input type="number" 
                   step="0.01" 
                   min="0.01" 
                   name="length" 
                   id="length" 
                   class="mobile-form-control mobile-form-control-lg" 
                   placeholder="Введите длину"
                   required>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="excavation_date">Дата копки *</label>
            <input type="date" 
                   name="excavation_date" 
                   id="excavation_date" 
                   class="mobile-form-control"
                   required>
        </div>

        <div class="mobile-form-group mobile-form-group-files" style="height: 200px; position: relative; z-index: 5; overflow-y: auto;">
            <label class="mobile-form-label">Файлы (фото/документы) *</label>
            
            <!-- Скрытый input для файлов -->
            <input type="file" 
                   name="files" 
                   id="files" 
                   class="d-none" 
                   multiple 
                   accept="image/*,.pdf,.doc,.docx"
                   required>
            
            <!-- Кнопки для выбора файлов -->
            <div class="d-flex gap-2 mb-2">
                <button type="button" class="mobile-btn mobile-btn-outline-primary" onclick="document.getElementById('files').click()">
                    <i class="bi bi-plus-circle me-1"></i>
                    Выбрать файлы
                </button>
                <button type="button" class="mobile-btn mobile-btn-outline-secondary" onclick="clearAllFiles()">
                    <i class="bi bi-trash me-1"></i>
                    Очистить
                </button>
            </div>
            
            <div class="form-text" style="min-height: 40px;">
                <strong>Требование:</strong> минимум 1 файл на каждые 20 метров.
                <div id="required-files-info"></div>
                <br><strong>Совет:</strong> Удерживайте Ctrl (Cmd на Mac) для выбора нескольких файлов одновременно.
            </div>
            <div id="selected-files-list" class="mt-2" style="max-height: 100px; overflow-y: auto;"></div>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="notes">Заметки</label>
            <textarea name="notes" 
                      id="notes" 
                      class="mobile-form-control" 
                      rows="2" 
                      placeholder="Дополнительная информация"></textarea>
        </div>

        <div class="mobile-mt-4">
            <button type="submit" class="mobile-btn mobile-btn-primary w-100" id="submit-btn">
                Добавить запись
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-excavation-form');
    const submitBtn = document.getElementById('submit-btn');
    const length = document.getElementById('length');
    const files = document.getElementById('files');
    const notes = document.getElementById('notes');
    const requiredFilesInfo = document.getElementById('required-files-info');
    
    let isDirty = false;
    
    // Помечаем форму как изменённую при вводе в любые поля
    [length, files, notes].forEach(el => {
        if (!el) return;
        el.addEventListener('input', () => { isDirty = true; });
    });
    
    // Функция для обновления информации о требуемых файлах
    function updateRequiredFilesInfo() {
        const lengthValue = parseFloat(length.value) || 0;
        const requiredFiles = Math.max(1, Math.ceil(lengthValue / 20));
        requiredFilesInfo.textContent = `Для ${lengthValue}м требуется минимум ${requiredFiles} файл(ов)`;
    }
    
    // Массив для хранения выбранных файлов
    let selectedFiles = [];
    
    // Функция для отображения выбранных файлов
    function updateSelectedFilesList() {
        const filesList = document.getElementById('selected-files-list');
        
        if (selectedFiles.length === 0) {
            filesList.innerHTML = '';
            return;
        }
        
        let html = '<div class="alert alert-info"><strong>Выбранные файлы:</strong><ul class="mb-0 mt-2">';
        for (let i = 0; i < selectedFiles.length; i++) {
            html += `<li class="d-flex justify-content-between align-items-center">
                        <span>${selectedFiles[i].name} (${(selectedFiles[i].size / 1024 / 1024).toFixed(2)} МБ)</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${i})" title="Удалить файл">
                            <svg class="bi" width="16" height="16" aria-hidden="true"><use xlink:href="#trash"></use></svg>
                        </button>
                     </li>`;
        }
        html += '</ul></div>';
        
        filesList.innerHTML = html;
    }
    
    // Функция для проверки дубликатов файлов
    function isDuplicateFile(newFile) {
        return selectedFiles.some(existingFile => 
            existingFile.name === newFile.name && 
            existingFile.size === newFile.size &&
            existingFile.lastModified === newFile.lastModified
        );
    }
    
    // Функция для проверки дубликатов изображений по содержимому (асинхронная)
    async function checkImageDuplicates(newFile) {
        if (!newFile.type.startsWith('image/')) {
            return false;
        }
        
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const newImageData = e.target.result;
                
                // Проверяем каждое существующее изображение
                for (let existingFile of selectedFiles) {
                    if (existingFile.type.startsWith('image/')) {
                        const existingReader = new FileReader();
                        existingReader.onload = function(e2) {
                            if (e2.target.result === newImageData) {
                                resolve(true);
                                return;
                            }
                        };
                        existingReader.readAsDataURL(existingFile);
                    }
                }
                resolve(false);
            };
            reader.readAsDataURL(newFile);
        });
    }
    
    // Функция для добавления файлов
    async function addFiles(newFiles) {
        let addedCount = 0;
        let duplicateCount = 0;
        
        for (let i = 0; i < newFiles.length; i++) {
            const newFile = newFiles[i];
            
            // Проверяем базовые дубликаты (имя, размер, дата изменения)
            if (isDuplicateFile(newFile)) {
                duplicateCount++;
                continue;
            }
            
            // Для изображений проверяем содержимое
            if (newFile.type.startsWith('image/')) {
                const isImageDuplicate = await checkImageDuplicates(newFile);
                if (isImageDuplicate) {
                    duplicateCount++;
                    continue;
                }
            }
            
            // Если файл не дубликат, добавляем его
            selectedFiles.push(newFile);
            addedCount++;
        }
        
        updateSelectedFilesList();
        
        // Показываем уведомление о дубликатах
        if (duplicateCount > 0) {
            alert(`Пропущено ${duplicateCount} дубликат(ов) файлов. Одинаковые файлы не добавляются повторно.`);
        }
        
        if (addedCount > 0) {
            console.log(`Добавлено ${addedCount} новых файл(ов)`);
        }
    }
    
    // Функция для удаления файла
    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateSelectedFilesList();
    }
    
    // Делаем функцию глобальной
    window.removeFile = removeFile;
    
    // Функция для очистки всех файлов
    function clearAllFiles() {
        selectedFiles = [];
        files.value = '';
        updateSelectedFilesList();
    }
    
    // Делаем функцию глобальной
    window.clearAllFiles = clearAllFiles;
    
    // Обновляем информацию при изменении длины
    length.addEventListener('input', updateRequiredFilesInfo);
    
    // Обновляем список файлов при выборе
    files.addEventListener('change', function() {
        const newFiles = Array.from(this.files);
        addFiles(newFiles);
        // Очищаем input для возможности повторного выбора
        this.value = '';
    });
    
    // Обработчик «Назад» с предупреждением
    function confirmLeaveIfDirty(action){
        if (!isDirty) { action(); return; }
        if (confirm('Данные не будут сохранены. Вернуться на предыдущую страницу?')) {
            action();
        }
    }
    
    const backBtn = document.querySelector('.mobile-back-btn');
    if (backBtn) {
        backBtn.onclick = function(e){
            e.preventDefault();
            confirmLeaveIfDirty(() => { window.history.back(); });
        };
    }
    
    // Предупреждение при закрытии страницы
    window.addEventListener('beforeunload', function(e) {
        if (isDirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    // Тримминг текстовых полей
    const trimField = (el) => { if (el) el.value = el.value.trim().replace(/\s{2,}/g, ' '); };
    [notes].forEach(el => el && el.addEventListener('blur', () => trimField(el)));
    
    // Валидация
    const validateForm = () => {
        const lengthValue = parseFloat(length.value);
        const requiredFiles = Math.max(1, Math.ceil(lengthValue / 20));
        
        if (isNaN(lengthValue) || lengthValue <= 0) { 
            alert('Длина должна быть больше 0');
            return false; 
        }
        
        if (selectedFiles.length < requiredFiles) {
            alert(`Необходимо прикрепить минимум ${requiredFiles} файл(ов) для ${lengthValue} метров`);
            return false;
        }
        
        // Создаем DataTransfer для передачи файлов в input
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => dataTransfer.items.add(file));
        files.files = dataTransfer.files;
        
        return true;
    };
    
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Всегда предотвращаем стандартную отправку
        
        trimField(notes);
        if (!validateForm()) { 
            return false; 
        }
        
        submitBtn.disabled = true;
        const original = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Сохранение...';
        
        // Если валидация прошла успешно, отправляем форму
        console.log('Отправляем мобильную форму с', selectedFiles.length, 'файлами');
        form.submit();
        
        setTimeout(() => { 
            submitBtn.disabled = false; 
            submitBtn.innerHTML = original; 
        }, 4000);
    });
    
    // Устанавливаем сегодняшнюю дату по умолчанию
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('excavation_date').value = today;
    
    // Убираем прокрутку и настраиваем отступы
    try {
        const mobileContent = document.querySelector('.mobile-content');
        if (mobileContent) {
            mobileContent.style.paddingBottom = '16px';
            mobileContent.style.overflow = 'hidden';
            mobileContent.style.height = 'auto';
        }
        document.documentElement.style.overscrollBehaviorY = 'contain';
        document.body.style.overflow = 'hidden';
        window.scrollTo(0, 0);
    } catch(e) {}
});
</script>

<style>
/* Локальные правки для лучшей читаемости в светлой теме только на этой странице */
.mobile-app { background: var(--bs-body-bg); }

[data-bs-theme="light"] .add-object-card { 
    background: #ffffff; 
    color: #0f172a; 
}

[data-bs-theme="light"] .mobile-form-label { 
    color: #111827; 
}

[data-bs-theme="light"] .mobile-form-control,
[data-bs-theme="light"] .mobile-form-control-lg {
    background: #ffffff;
    border-color: #d1d5db;
    color: #111827;
}

[data-bs-theme="light"] .mobile-form-control::placeholder,
[data-bs-theme="light"] .mobile-form-control-lg::placeholder { 
    color: #6b7280; 
}

[data-bs-theme="light"] .mobile-btn-outline { 
    border-color: #cbd5e1; 
    color: #334155; 
}

[data-bs-theme="light"] .mobile-card-title { 
    color: #0f172a; 
}

/* Точная поддержка темной темы как на страницах добавления объекта/позиции */
[data-bs-theme="dark"] .add-object-card { 
    background: var(--bs-body-bg); 
    border-color: #2d3748; 
    box-shadow: 0 6px 18px rgba(0,0,0,.2); 
}

[data-bs-theme="dark"] .add-object-card .mobile-form-group { 
    background: #1f2937; 
    border-color: #374151; 
}

[data-bs-theme="dark"] .mobile-form-label { 
    color: #e5e7eb; 
}

[data-bs-theme="dark"] .mobile-card-title { 
    color: #f9fafb; 
}

[data-bs-theme="dark"] .mobile-form-control-lg { 
    background: #1f2937; 
    border-color: #374151; 
    color: #f9fafb; 
    box-shadow: 0 2px 4px rgba(0,0,0,.2); 
}

[data-bs-theme="dark"] .mobile-form-control { 
    background: #1f2937; 
    border-color: #374151; 
    color: #f9fafb; 
    box-shadow: 0 2px 4px rgba(0,0,0,.2); 
}

[data-bs-theme="dark"] .mobile-form-control:focus, 
[data-bs-theme="dark"] .mobile-form-control-lg:focus { 
    border-color: #3b82f6; 
    box-shadow: 0 0 0 4px rgba(59,130,246,.2), 0 4px 12px rgba(0,0,0,.3); 
}

/* Стили для карточки */
.add-object-card { 
    background: #fff; 
    border: 1px solid #e5e7eb; 
    box-shadow: 0 6px 18px rgba(0,0,0,.06); 
    padding: 12px; 
    border-radius: 12px; 
}

.add-object-card .mobile-form-group { 
    background: #f9fafb; 
    border: 1px solid #eef2f7; 
    border-radius: 12px; 
    padding: 12px; 
}

.add-object-card .mobile-form-group + .mobile-form-group { 
    margin-top: 8px; 
}

.mobile-card-title { 
    font-size: 1.5rem; 
    font-weight: 700; 
    margin-bottom: 1rem; 
    color: #111827; 
    letter-spacing: -.025em; 
}

.mobile-form-label { 
    display: block; 
    font-size: .9rem; 
    font-weight: 600; 
    color: #374151; 
    margin-bottom: 6px; 
    letter-spacing: .025em; 
}

.mobile-form-control-lg { 
    font-size: 1.05rem; 
    padding: 12px 16px; 
    border-radius: 12px; 
    border: 2px solid #e1e5e9; 
    background: #fff; 
    color: #111827; 
    transition: all .3s cubic-bezier(.4,0,.2,1); 
    box-shadow: 0 2px 4px rgba(0,0,0,.04); 
    font-weight: 500; 
}

.mobile-form-control { 
    font-size: .95rem; 
    padding: 10px 14px; 
    border-radius: 12px; 
    border: 2px solid #e1e5e9; 
    background: #fff; 
    color: #111827; 
    transition: all .3s cubic-bezier(.4,0,.2,1); 
    box-shadow: 0 2px 4px rgba(0,0,0,.04); 
    font-weight: 500; 
}

.mobile-mt-4 { 
    margin-top: 12px; 
}

.mobile-btn { 
    border-radius: 12px; 
    font-weight: 600; 
    padding: 12px 20px; 
    font-size: .95rem; 
    transition: all .3s cubic-bezier(.4,0,.2,1); 
    letter-spacing: .025em; 
    border: none; 
    position: relative; 
    overflow: hidden; 
}

/* Исправление для файлового поля */
.mobile-form-control[type="file"],
.mobile-form-control-file {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 8px 12px;
}

/* Специальные стили для группы с файлами */
.mobile-form-group-files {
    border: none !important;
    background: transparent !important;
    padding: 0 !important;
    margin: 0 !important;
}

/* Убираем отступы у контейнера формы */
.mobile-form-group {
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 12px !important;
    padding-right: 12px !important;
}

/* Исправление для текста под файловым полем */
.form-text {
    margin-top: 8px;
    font-size: 0.85rem;
    line-height: 1.4;
    word-wrap: break-word;
    overflow-wrap: break-word;
    padding: 0 12px;
}

/* Дополнительные исправления для мобильных устройств */
@media (max-width: 768px) {
    .mobile-form-control-file {
        font-size: 14px;
        padding: 10px 12px;
    }
    
    .mobile-form-group-files {
        margin-bottom: 16px;
    }
}

/* Стабилизация полей формы */
.mobile-form-group {
    transition: none !important;
}

.mobile-form-control {
    transition: none !important;
}

/* Предотвращение смещения при динамическом контенте */
#length {
    position: relative;
    z-index: 10;
}

.form-text {
    position: relative;
    z-index: 1;
    min-height: 40px;
    max-height: 60px;
    overflow: hidden;
}

/* Стабилизация контейнера файлов */
.mobile-form-group[style*="height: 200px"] {
    position: relative;
    z-index: 5;
    height: 200px !important;
    overflow-y: auto;
}

/* Фиксация позиции поля длины */
.mobile-form-group[style*="min-height: 80px"] {
    position: relative;
    z-index: 10;
    isolation: isolate;
}

/* Фиксация списка выбранных файлов */
#selected-files-list {
    max-height: 100px;
    overflow-y: auto;
    position: relative;
}
</style>
{% endblock %}
