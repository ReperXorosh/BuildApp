{% extends "main/layout.html" %}

{% block title %}Траншеи - {{ object.name }}{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top: 80px;">
    <div class="row">
        <div class="col-12">
            <!-- Заголовок -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-tools me-2"></i>
                        Траншеи
                    </h1>
                    <p class="text-muted mb-0">
                        Объект: <a href="{{ url_for('objects.object_detail', object_id=object.id) }}">{{ object.name }}</a>
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('objects.object_detail', object_id=object.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        Назад к объекту
                    </a>
                    <a href="{{ url_for('objects.add_trench', object_id=object.id) }}" class="btn btn-success">
                        <i class="bi bi-plus-lg me-1"></i>
                        Добавить траншею
                    </a>
                </div>
            </div>

            {% if trenches %}
            <!-- Счётчик общей выкопанной длины -->
            <div class="card mb-4 stats-summary-card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="mb-2">
                                <svg class="stats-icon stats-icon-primary" width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Лопата - лезвие (красивое скруглённое) -->
                                    <path d="M12 2.5C11.3 2.5 10.6 2.7 10 3L7.5 5.5C7.2 5.8 7 6.2 7 6.6V10.8C7 11.2 6.8 11.5 6.5 11.8L5 13.3C4.7 13.6 4.5 14 4.5 14.5V18C4.5 18.8 5.2 19.5 6 19.5H8.5L10 21H14L15.5 19.5H18C18.8 19.5 19.5 18.8 19.5 18V14.5C19.5 14 19.3 13.6 19 13.3L17.5 11.8C17.2 11.5 17 11.2 17 10.8V6.6C17 6.2 16.8 5.8 16.5 5.5L14 3C13.4 2.7 12.7 2.5 12 2.5Z" fill="currentColor"/>
                                    <!-- Лопата - внутренняя часть с объёмом -->
                                    <path d="M12 3.5C11.5 3.5 11 3.7 10.6 4L8.5 6.1C8.3 6.3 8.2 6.6 8.2 6.9V10.5L7 11.7V17.2H8.5L10 18.7H14L15.5 17.2H17V11.7L15.8 10.5V6.9C15.8 6.6 15.7 6.3 15.5 6.1L13.4 4C13 3.7 12.5 3.5 12 3.5Z" fill="currentColor" opacity="0.5"/>
                                    <!-- Ручка лопаты (скруглённая) -->
                                    <path d="M12 19.5C11.2 19.5 10.5 20.2 10.5 21V22.5C10.5 23.3 11.2 24 12 24C12.8 24 13.5 23.3 13.5 22.5V21C13.5 20.2 12.8 19.5 12 19.5Z" fill="currentColor"/>
                                    <ellipse cx="12" cy="21.5" rx="1" ry="0.8" fill="currentColor" opacity="0.7"/>
                                    <!-- Детали лезвия для реалистичности -->
                                    <path d="M12 5.5L10 7.5V9.5L9 10.5V16.5H15V10.5L14 9.5V7.5L12 5.5Z" fill="currentColor" opacity="0.3"/>
                                    <!-- Блик на лезвии -->
                                    <path d="M12 4L10.5 5.5V9L9.5 10V15H14.5V10L13.5 9V5.5L12 4Z" fill="currentColor" opacity="0.2"/>
                                </svg>
                            </div>
                            <h4 class="mb-1 stats-value">{{ total_excavated_all|round(2) }} м</h4>
                            <p class="stats-label mb-0 small">Всего выкопано</p>
                        </div>
                        {% if total_length_all > 0 %}
                        <div class="col-md-4">
                            <div class="mb-2">
                                <i class="bi bi-clipboard-data display-6 stats-icon-info"></i>
                            </div>
                            <h4 class="mb-1 stats-value">{{ total_length_all|round(2) }} м</h4>
                            <p class="stats-label mb-0 small">Общий метраж</p>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <i class="bi bi-percent display-6 stats-icon-success"></i>
                            </div>
                            <h4 class="mb-1 stats-value">{{ ((total_excavated_all / total_length_all * 100) if total_length_all > 0 else 0)|round(1) }}%</h4>
                            <p class="stats-label mb-0 small">Выполнено</p>
                        </div>
                        {% else %}
                        <div class="col-md-4">
                            <div class="mb-2">
                                <i class="bi bi-list-ol display-6 stats-icon-secondary"></i>
                            </div>
                            <h4 class="mb-1 stats-value">{{ trenches|length }}</h4>
                            <p class="stats-label mb-0 small">Траншей</p>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <i class="bi bi-check-circle display-6 stats-icon-success"></i>
                            </div>
                            <h4 class="mb-1 stats-value">
                                {{ trenches|selectattr('status', 'equalto', 'completed')|list|length }}
                            </h4>
                            <p class="stats-label mb-0 small">Завершено</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row">
                {% for trench in trenches %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 clickable-card" data-url="{{ url_for('objects.trench_detail', object_id=object.id, trench_id=trench.id) }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-tools me-2"></i>
                                Траншея #{{ trenches|length - loop.index + 1 }}
                            </h6>
                            <span class="badge bg-{{ 'success' if trench.status == 'completed' else 'warning' if trench.status == 'in_progress' else 'secondary' }}">
                                {{ 'Завершено' if trench.status == 'completed' else 'В работе' if trench.status == 'in_progress' else 'Запланировано' }}
                            </span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="mb-3">
                                <strong>Общий метраж:</strong>
                                {% if trench.total_length %}
                                <span class="badge bg-primary">{{ trench.total_length }}м</span>
                                {% else %}
                                <span class="text-muted">Не указан</span>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <strong>Выкопано:</strong>
                                <span class="badge bg-info">{{ trench.total_excavated }}м</span>
                                {% if trench.total_length %}
                                <small class="text-muted">
                                    ({{ (trench.total_excavated / trench.total_length * 100)|round(1) }}%)
                                </small>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <strong>Файлы:</strong>
                                <span class="badge bg-{{ 'success' if trench.files_count >= trench.required_files else 'warning' }}">
                                    {{ trench.files_count }}/{{ trench.required_files }}
                                </span>
                                {% if trench.files_count < trench.required_files %}
                                <small class="text-warning d-block">Недостаточно файлов</small>
                                {% else %}
                                <small class="d-block" style="visibility: hidden;">Недостаточно файлов</small>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <strong>Примечания:</strong>
                                {% if trench.notes %}
                                <p class="text-muted small mb-0">{{ trench.notes[:100] }}{% if trench.notes|length > 100 %}...{% endif %}</p>
                                {% else %}
                                <p class="text-muted small mb-0">—</p>
                                {% endif %}
                            </div>
                            
                            <div class="d-grid gap-2 mt-auto">
                            <a href="{{ url_for('objects.add_trench_excavation', object_id=object.id, trench_id=trench.id) }}" 
                               class="btn btn-success btn-sm" data-ignore-card-click="true">
                                    <i class="bi bi-plus-lg me-1"></i>
                                    Добавить запись о копке
                                </a>
                            </div>
                        </div>
                        <div class="card-footer text-muted small">
                            <i class="bi bi-calendar me-1"></i>
                            Создано: {{ trench.created_at | user_time_short }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-tools display-1 text-muted"></i>
                    <h3 class="mt-3 text-muted">Траншеи не найдены</h3>
                    <p class="text-muted">Создайте первую траншею для объекта</p>
                    <a href="{{ url_for('objects.add_trench', object_id=object.id) }}" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-1"></i>
                        Добавить траншею
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Стили для карточки со счётчиком */
.stats-summary-card {
    background: var(--bs-light) !important;
    border: 1px solid var(--bs-border-color);
}

.stats-icon {
    width: 48px;
    height: 48px;
}

.stats-icon-primary {
    color: var(--bs-primary);
}

.stats-icon-info {
    color: var(--bs-info);
}

.stats-icon-success {
    color: var(--bs-success);
}

.stats-icon-secondary {
    color: var(--bs-secondary);
}

.stats-value {
    color: var(--bs-body-color);
    font-weight: 700;
}

.stats-label {
    color: var(--bs-secondary-color);
}

/* Стили для тёмной темы */
[data-bs-theme="dark"] .stats-summary-card {
    background: var(--bs-dark) !important;
    border: 1px solid var(--bs-border-color);
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
}

[data-bs-theme="dark"] .stats-value {
    color: var(--bs-light);
}

[data-bs-theme="dark"] .stats-label {
    color: var(--bs-secondary);
}

[data-bs-theme="dark"] .stats-icon-primary {
    color: var(--bs-primary);
}

[data-bs-theme="dark"] .stats-icon-info {
    color: var(--bs-info);
}

[data-bs-theme="dark"] .stats-icon-success {
    color: var(--bs-success);
}

[data-bs-theme="dark"] .stats-icon-secondary {
    color: var(--bs-secondary);
}
</style>
{% endblock %}