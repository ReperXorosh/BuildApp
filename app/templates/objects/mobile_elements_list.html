{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'objects' %}

{% block title %}Элементы: {{ object.name }}{% endblock %}
{% block mobile_title %}Элементы{% endblock %}
{% block mobile_header_actions %}
{% if current_user.role in ['Инженер ПТО', 'Ген.Директор'] %}
<a class="mobile-header-btn" href="{{ url_for('objects.add_element', object_id=object.id) }}" title="Добавить элемент" role="button" aria-label="Добавить элемент">
    <svg fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
    </svg>
</a>
{% endif %}
{% endblock %}

{% block content %}
<div class="mobile-card">
    <div class="mobile-card-title">{{ object.name }}</div>
    <div class="mobile-card-text"><strong>Адрес:</strong> {{ object.location or 'Не указан' }}</div>
</div>

<div class="mobile-card">
    <div class="mobile-card-title">Элементы объекта</div>
    <div class="accordion" id="mobileElementsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingZDF">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseZDF" aria-expanded="false" aria-controls="collapseZDF">
                    ЗДФ ({{ object.zdfs|length if object.zdfs else 0 }})
                </button>
            </h2>
            <div id="collapseZDF" class="accordion-collapse collapse" aria-labelledby="headingZDF" data-bs-parent="#mobileElementsAccordion">
                <div class="accordion-body">
                    {% if object.zdfs and object.zdfs|length %}
                    <ul class="list-group list-group-flush">
                            {% for zdf in object.zdfs %}
                            <a class="list-group-item d-flex justify-content-between align-items-center text-decoration-none" href="{{ url_for('objects.element_detail', object_id=object.id, element_type='zdf', element_id=zdf.id) }}">
                                <div>
                                    <div class="fw-semibold">{% if zdf.zdf_name %}{{ zdf.zdf_name }}{% else %}ЗДФ{% endif %}</div>
                                    {% if zdf.notes %}<div class="text-muted small text-truncate" style="max-width:220px;">{{ zdf.notes }}</div>{% endif %}
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    {% set atts = zdf_attachments.get(zdf.id) %}
                                    {% if atts and atts|length %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="event.preventDefault(); event.stopPropagation(); openElementPreviewMobile('zdf','{{ zdf.id }}','{{ atts[0].id }}');" title="Просмотр файла">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                          <path d="M14 2H7C5.89543 2 5 2.89543 5 4V20C5 21.1046 5.89543 22 7 22H17C18.1046 22 19 21.1046 19 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                          <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                          <circle cx="10.5" cy="13.5" r="2.5" stroke="currentColor" stroke-width="2"/>
                                          <path d="M12.2 15.2L14.5 17.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                    {% endif %}
                                    {% if zdf.status %}<span class="badge bg-secondary">{{ zdf.status }}</span>{% endif %}
                                </div>
                            </a>
                            {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-muted">Нет ЗДФ</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingBrackets">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrackets" aria-expanded="false" aria-controls="collapseBrackets">
                    Кронштейны ({{ object.brackets|length if object.brackets else 0 }})
                </button>
            </h2>
            <div id="collapseBrackets" class="accordion-collapse collapse" aria-labelledby="headingBrackets" data-bs-parent="#mobileElementsAccordion">
                <div class="accordion-body">
                    {% if object.brackets and object.brackets|length %}
                    <ul class="list-group list-group-flush">
                            {% for bracket in object.brackets %}
                            <a class="list-group-item d-flex justify-content-between align-items-center text-decoration-none" href="{{ url_for('objects.element_detail', object_id=object.id, element_type='bracket', element_id=bracket.id) }}">
                                <div>
                                    <div class="fw-semibold">{% if bracket.bracket_name %}{{ bracket.bracket_name }}{% else %}Кронштейн{% endif %}</div>
                                    {% if bracket.notes %}<div class="text-muted small text-truncate" style="max-width:220px;">{{ bracket.notes }}</div>{% endif %}
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    {% set atts = bracket_attachments.get(bracket.id) %}
                                    {% if atts and atts|length %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="event.preventDefault(); event.stopPropagation(); openElementPreviewMobile('bracket','{{ bracket.id }}','{{ atts[0].id }}');" title="Просмотр файла">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                          <path d="M14 2H7C5.89543 2 5 2.89543 5 4V20C5 21.1046 5.89543 22 7 22H17C18.1046 22 19 21.1046 19 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                          <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                          <circle cx="10.5" cy="13.5" r="2.5" stroke="currentColor" stroke-width="2"/>
                                          <path d="M12.2 15.2L14.5 17.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                    {% endif %}
                                    {% if bracket.status %}<span class="badge bg-secondary">{{ bracket.status }}</span>{% endif %}
                                </div>
                            </a>
                            {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-muted">Нет кронштейнов</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingLuminaires">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLuminaires" aria-expanded="false" aria-controls="collapseLuminaires">
                    Светильники ({{ object.luminaires|length if object.luminaires else 0 }})
                </button>
            </h2>
            <div id="collapseLuminaires" class="accordion-collapse collapse" aria-labelledby="headingLuminaires" data-bs-parent="#mobileElementsAccordion">
                <div class="accordion-body">
                    {% if object.luminaires and object.luminaires|length %}
                    <ul class="list-group list-group-flush">
                            {% for luminaire in object.luminaires %}
                            <a class="list-group-item d-flex justify-content-between align-items-center text-decoration-none" href="{{ url_for('objects.element_detail', object_id=object.id, element_type='luminaire', element_id=luminaire.id) }}">
                                <div>
                                    <div class="fw-semibold">{% if luminaire.luminaire_name %}{{ luminaire.luminaire_name }}{% else %}Светильник{% endif %}</div>
                                    {% if luminaire.notes %}<div class="text-muted small text-truncate" style="max-width:220px;">{{ luminaire.notes }}</div>{% endif %}
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    {% set atts = luminaire_attachments.get(luminaire.id) %}
                                    {% if atts and atts|length %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="event.preventDefault(); event.stopPropagation(); openElementPreviewMobile('luminaire','{{ luminaire.id }}','{{ atts[0].id }}');" title="Просмотр файла">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                          <path d="M14 2H7C5.89543 2 5 2.89543 5 4V20C5 21.1046 5.89543 22 7 22H17C18.1046 22 19 21.1046 19 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                          <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                          <circle cx="10.5" cy="13.5" r="2.5" stroke="currentColor" stroke-width="2"/>
                                          <path d="M12.2 15.2L14.5 17.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                    {% endif %}
                                    {% if luminaire.status %}<span class="badge bg-secondary">{{ luminaire.status }}</span>{% endif %}
                                </div>
                            </a>
                            {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-muted">Нет светильников</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Дополнительный отступ, чтобы контент не перекрывался нижней панелью навигации -->
<div style="height: 140px"></div>

<script>
function openElementPreviewMobile(type, elementId, attachmentId) {
  const urlTemplate = "{{ url_for('objects.view_element_attachment', object_id=object.id, element_type='__TYPE__', element_id='__EID__', attachment_id='__AID__') }}";
  const url = urlTemplate.replace('__TYPE__', type).replace('__EID__', elementId).replace('__AID__', attachmentId);
  const modalEl = document.getElementById('elementPreviewModal');
  const imgEl = document.getElementById('elementPreviewImg');
  const frameEl = document.getElementById('elementPreviewFrame');
  const linkEl = document.getElementById('elementPreviewDownload');
  if (imgEl) { imgEl.style.display = 'none'; imgEl.src = ''; }
  if (frameEl) { frameEl.style.display = 'none'; frameEl.src = ''; }
  if (linkEl) { linkEl.style.display = 'none'; linkEl.href = url; }
  fetch(url, { method: 'HEAD' }).then(res => {
    if (!res.ok) { window.open(url, '_blank'); return; }
    const typeH = res.headers.get('content-type') || '';
    if (typeH.startsWith('image/')) {
      imgEl.src = url; imgEl.style.display = 'block';
    } else if (typeH === 'application/pdf') {
      frameEl.src = url; frameEl.style.display = 'block';
    } else {
      linkEl.style.display = 'inline-flex';
    }
    bootstrap.Modal.getOrCreateInstance(modalEl).show();
  }).catch(() => { window.open(url, '_blank'); });
}
document.addEventListener('DOMContentLoaded', function() {
    try {
        const content = document.querySelector('.mobile-content');
        if (content) {
            content.style.webkitOverflowScrolling = 'touch';
            content.style.scrollBehavior = 'smooth';
            const currentPaddingBottom = parseInt(window.getComputedStyle(content).paddingBottom || '0', 10);
            if (currentPaddingBottom < 140) {
                content.style.paddingBottom = '140px';
            }
        }
    } catch (e) { /* noop */ }
});
</script>

<style>
/* Стили для аккордеона элементов */
.accordion-button {
    font-weight: 600;
    border-radius: 12px !important;
}

.accordion-item {
    border: 1px solid var(--bs-border-color);
    border-radius: 12px !important;
    margin-bottom: 8px;
}

.accordion-item:not(:first-child) {
    border-top: 1px solid var(--bs-border-color);
}

.accordion-button:not(.collapsed) {
    background-color: var(--bs-primary);
    color: white;
}

.accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
}

.list-group-item {
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    padding: 10px 12px;
    margin-bottom: 6px;
    background: var(--bs-body-bg);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.list-group-item:last-child {
    margin-bottom: 0;
}

[data-bs-theme="dark"] .list-group-item {
    background: var(--bs-body-bg);
    border-color: var(--bs-border-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.badge {
    font-size: 0.75rem;
}

[data-bs-theme="dark"] .accordion-item {
    background-color: var(--bs-body-bg);
    border-color: var(--bs-border-color);
}

[data-bs-theme="dark"] .accordion-button {
    background-color: var(--bs-body-bg);
    color: var(--bs-body-color);
}

[data-bs-theme="dark"] .accordion-button:not(.collapsed) {
    background-color: var(--bs-primary);
    color: white;
}

.accordion-body {
    padding: 12px 16px;
}

.accordion-body .list-group {
    margin: 0;
    padding: 0;
}
</style>

<!-- Модалка предпросмотра файла элемента (мобильная, fullscreen) -->
<div class="modal fade" id="elementPreviewModal" tabindex="-1" aria-labelledby="elementPreviewTitle" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="elementPreviewTitle">Просмотр файла</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <img id="elementPreviewImg" alt="Превью" style="display:none; max-width:100%; max-height:80vh; object-fit:contain; margin:0 auto;" />
        <iframe id="elementPreviewFrame" style="display:none; width:100%; height:80vh; border:none;"></iframe>
        <div class="p-3 text-center">
          <a id="elementPreviewDownload" href="#" class="btn btn-outline-primary" style="display:none;" target="_blank">
            <i class="bi bi-download"></i> Открыть/скачать файл
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
