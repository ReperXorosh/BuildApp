{% extends "main/layout.html" %}

{% block title %}Добавить запланированную работу - {{ object.name }}{% endblock %}

{% block extra_css %}
<style>

.form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top: 80px;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-plus-circle me-2"></i>
                    Добавить запланированную работу
                </h1>
                <a href="{{ url_for('objects.planned_works_list', object_id=object.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    Назад к работам
                </a>
            </div>

            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-calendar-check me-2"></i>
                                Планирование работы для объекта "{{ object.name }}"
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="work_type" class="form-label">
                                                <i class="bi bi-tag me-1"></i>
                                                Тип работы *
                                            </label>
                                            <select class="form-select" id="work_type" name="work_type" required>
                                                <option value="">Выберите тип работы</option>
                                                <option value="support_installation">Установка опоры</option>
                                                <option value="trench_excavation">Рытье траншеи</option>
                                                <option value="cable_laying">Укладка кабеля</option>
                                                <option value="equipment_installation">Монтаж оборудования</option>
                                                <option value="testing">Тестирование</option>
                                                <option value="maintenance">Обслуживание</option>
                                                <option value="repair">Ремонт</option>
                                                <option value="inspection">Осмотр</option>
                                                <option value="other">Другое</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="priority" class="form-label">
                                                <i class="bi bi-flag me-1"></i>
                                                Приоритет
                                            </label>
                                            <select class="form-select" id="priority" name="priority">
                                                <option value="low">Низкий</option>
                                                <option value="medium" selected>Средний</option>
                                                <option value="high">Высокий</option>
                                                <option value="urgent">Срочно</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="work_title" class="form-label">
                                        <i class="bi bi-pencil me-1"></i>
                                        Заголовок работы *
                                    </label>
                                    <!-- Текстовое поле для обычных работ -->
                                    <input type="text" class="form-control" id="work_title" name="work_title" 
                                           placeholder="Например: Установка опоры №5" required>
                                    
                                    <!-- Выпадающий список для установки опор -->
                                    <select class="form-select" id="support_select" name="support_select" style="display: none;">
                                        <option value="">Выберите опору для установки</option>
                                        {% if supports %}
                                            {% for support in supports %}
                                            <option value="{{ support.id }}" data-support-number="{{ support.support_number }}" 
                                                    data-support-type="{{ support.support_type or '' }}">
                                                Опора {{ support.support_number }}{% if support.support_type %} ({{ support.support_type }}){% endif %}
                                            </option>
                                            {% endfor %}
                                        {% else %}
                                            <option value="" disabled>Нет доступных опор для установки</option>
                                        {% endif %}
                                    </select>
                                    
                                    <!-- Скрытое поле для хранения выбранной опоры -->
                                    <input type="hidden" id="selected_support_id" name="selected_support_id">
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">
                                        <i class="bi bi-text-paragraph me-1"></i>
                                        Описание работы
                                    </label>
                                    <textarea class="form-control" id="description" name="description" rows="4" 
                                              placeholder="Подробное описание того, что нужно сделать"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="planned_date" class="form-label">
                                        <i class="bi bi-calendar me-1"></i>
                                        Планируемая дата *
                                    </label>
                                    <input type="date" class="form-control" id="planned_date" name="planned_date" 
                                           value="{{ default_date }}" min="{{ today_date }}" required>
                                </div>

                                <div class="mb-3">
                                    <label for="location_details" class="form-label">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        Детали местоположения
                                    </label>
                                    <input type="text" class="form-control" id="location_details" name="location_details" 
                                           placeholder="Конкретное место на объекте, координаты и т.д.">
                                </div>

                                <div class="mb-3">
                                    <label for="location_files" class="form-label">
                                        <i class="bi bi-paperclip me-1"></i>
                                        Прикрепить файлы к местоположению
                                    </label>
                                    <input type="file" class="form-control" id="location_files" name="location_files" 
                                           multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.dwg,.dxf,.zip,.rar">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Можно прикрепить чертежи, схемы, фотографии или другие документы (PDF, изображения, документы, архивы)
                                    </div>
                                    <div id="file-list" class="mt-2"></div>
                                </div>

                                <div class="mb-3">
                                    <label for="materials_required" class="form-label">
                                        <i class="bi bi-tools me-1"></i>
                                        Требуемые материалы
                                    </label>
                                    <textarea class="form-control" id="materials_required" name="materials_required" rows="3" 
                                              placeholder="Список необходимых материалов, инструментов, оборудования"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="notes" class="form-label">
                                        <i class="bi bi-sticky me-1"></i>
                                        Дополнительные заметки
                                    </label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                                              placeholder="Любая дополнительная информация, особые требования и т.д."></textarea>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{{ url_for('objects.planned_works_list', object_id=object.id) }}" class="btn btn-outline-secondary me-md-2">
                                        <i class="bi bi-x-lg me-1"></i>
                                        Отмена
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg me-1"></i>
                                        Создать запланированную работу
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Устанавливаем минимальную дату как сегодня, а значение по умолчанию - завтра
document.addEventListener('DOMContentLoaded', function() {
    // Получаем текущую дату в московском времени
    const now = new Date();
    const moscowOffset = 3 * 60; // UTC+3 в минутах
    const moscowTime = new Date(now.getTime() + (moscowOffset * 60 * 1000));
    
    const today = moscowTime.toISOString().split('T')[0];
    const tomorrow = new Date(moscowTime);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    const plannedDateInput = document.getElementById('planned_date');
    
    // Устанавливаем минимальную дату как сегодня
    plannedDateInput.min = today;
    
    // Устанавливаем значение по умолчанию только если поле пустое или содержит прошедшую дату
    const currentValue = plannedDateInput.value;
    if (!currentValue || currentValue < today) {
        plannedDateInput.value = tomorrowStr;
    }
    
    console.log('DEBUG: Московское время сейчас:', moscowTime.toISOString());
    console.log('DEBUG: Установлена минимальная дата:', today);
    console.log('DEBUG: Текущее значение поля:', currentValue);
    console.log('DEBUG: Установлено значение поля (завтра):', plannedDateInput.value);
    
    // Добавляем строгую валидацию даты
    plannedDateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const todayDate = new Date(moscowTime);
        todayDate.setHours(0, 0, 0, 0); // Сбрасываем время для корректного сравнения
        
        if (selectedDate < todayDate) {
            // Показываем предупреждение и устанавливаем завтрашнюю дату
            this.classList.add('is-invalid');
            
            alert(`Нельзя планировать работу на прошедшую дату. Сегодня: ${todayDate.toLocaleDateString('ru-RU')}. Устанавливаем завтрашнюю дату.`);
            this.value = tomorrowStr;
            this.focus();
            return false;
        } else {
            // Убираем класс ошибки
            this.classList.remove('is-invalid');
        }
    });
    
    // Дополнительная валидация при отправке формы
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const selectedDate = new Date(plannedDateInput.value);
        const todayDate = new Date(moscowTime);
        todayDate.setHours(0, 0, 0, 0);
        
        if (selectedDate < todayDate) {
            e.preventDefault();
            alert(`Ошибка: Нельзя планировать работу на прошедшую дату. Сегодня: ${todayDate.toLocaleDateString('ru-RU')}. Устанавливаем завтрашнюю дату.`);
            plannedDateInput.value = tomorrowStr;
            plannedDateInput.focus();
            return false;
        }
    });
    
    // Обработка загрузки файлов
    const fileInput = document.getElementById('location_files');
    const fileList = document.getElementById('file-list');
    
    fileInput.addEventListener('change', function() {
        const files = Array.from(this.files);
        fileList.innerHTML = '';
        
        if (files.length > 0) {
            const fileListContainer = document.createElement('div');
            fileListContainer.className = 'list-group';
            
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                
                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `
                    <i class="bi bi-file-earmark me-2"></i>
                    <strong>${file.name}</strong>
                    <small class="text-muted ms-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                `;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger';
                removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                removeBtn.onclick = function() {
                    // Создаем новый FileList без этого файла
                    const dt = new DataTransfer();
                    files.forEach((f, i) => {
                        if (i !== index) dt.items.add(f);
                    });
                    fileInput.files = dt.files;
                    fileInput.dispatchEvent(new Event('change'));
                };
                
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(removeBtn);
                fileListContainer.appendChild(fileItem);
            });
            
            fileList.appendChild(fileListContainer);
        }
    });
    
    // Обработка изменения типа работы
    const workTypeSelect = document.getElementById('work_type');
    const workTitleInput = document.getElementById('work_title');
    const supportSelect = document.getElementById('support_select');
    const selectedSupportId = document.getElementById('selected_support_id');
    
    workTypeSelect.addEventListener('change', function() {
        if (this.value === 'support_installation') {
            // Проверяем, есть ли доступные опоры
            const hasSupports = supportSelect.querySelector('option[value]:not([disabled])');
            if (hasSupports) {
                // Показываем выпадающий список опор, скрываем текстовое поле
                workTitleInput.style.display = 'none';
                workTitleInput.required = false;
                supportSelect.style.display = 'block';
                supportSelect.required = true;
            } else {
                // Если нет опор, показываем текстовое поле с предупреждением
                workTitleInput.style.display = 'block';
                workTitleInput.required = true;
                workTitleInput.placeholder = 'Нет доступных опор. Введите заголовок вручную.';
                supportSelect.style.display = 'none';
                supportSelect.required = false;
            }
        } else {
            // Показываем текстовое поле, скрываем выпадающий список
            workTitleInput.style.display = 'block';
            workTitleInput.required = true;
            workTitleInput.placeholder = 'Например: Установка опоры №5';
            supportSelect.style.display = 'none';
            supportSelect.required = false;
            selectedSupportId.value = '';
        }
    });
    
    // Обработка выбора опоры
    supportSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const supportNumber = selectedOption.dataset.supportNumber;
            const supportType = selectedOption.dataset.supportType;
            
            // Формируем заголовок работы
            let title = `Установка опоры ${supportNumber}`;
            if (supportType) title += ` (${supportType})`;
            
            // Устанавливаем заголовок в скрытое поле
            workTitleInput.value = title;
            selectedSupportId.value = selectedOption.value;
        } else {
            workTitleInput.value = '';
            selectedSupportId.value = '';
        }
    });
});
</script>
{% endblock %}
