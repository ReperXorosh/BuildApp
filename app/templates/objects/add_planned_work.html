{% extends "main/layout.html" %}

{% block title %}Добавить запланированную работу - {{ object.name }}{% endblock %}

{% block extra_css %}
<style>
/* Стили для предупреждения о прошедших датах */
.date-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 8px 12px;
    border-radius: 4px;
    margin-top: 5px;
    font-size: 0.875rem;
    display: none;
}

.date-warning.show {
    display: block;
}

.form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top: 80px;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-plus-circle me-2"></i>
                    Добавить запланированную работу
                </h1>
                <a href="{{ url_for('objects.planned_works_list', object_id=object.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    Назад к работам
                </a>
            </div>

            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-calendar-check me-2"></i>
                                Планирование работы для объекта "{{ object.name }}"
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="work_type" class="form-label">
                                                <i class="bi bi-tag me-1"></i>
                                                Тип работы *
                                            </label>
                                            <select class="form-select" id="work_type" name="work_type" required>
                                                <option value="">Выберите тип работы</option>
                                                <option value="support_installation">Установка опоры</option>
                                                <option value="trench_excavation">Рытье траншеи</option>
                                                <option value="cable_laying">Укладка кабеля</option>
                                                <option value="equipment_installation">Монтаж оборудования</option>
                                                <option value="testing">Тестирование</option>
                                                <option value="maintenance">Обслуживание</option>
                                                <option value="repair">Ремонт</option>
                                                <option value="inspection">Осмотр</option>
                                                <option value="other">Другое</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="priority" class="form-label">
                                                <i class="bi bi-flag me-1"></i>
                                                Приоритет
                                            </label>
                                            <select class="form-select" id="priority" name="priority">
                                                <option value="low">Низкий</option>
                                                <option value="medium" selected>Средний</option>
                                                <option value="high">Высокий</option>
                                                <option value="urgent">Срочно</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="work_title" class="form-label">
                                        <i class="bi bi-pencil me-1"></i>
                                        Заголовок работы *
                                    </label>
                                    <!-- Текстовое поле для обычных работ -->
                                    <input type="text" class="form-control" id="work_title" name="work_title" 
                                           placeholder="Например: Установка опоры №5" required>
                                    
                                    <!-- Выпадающий список для установки опор -->
                                    <select class="form-select" id="support_select" name="support_select" style="display: none;">
                                        <option value="">Выберите опору для установки</option>
                                        {% if supports %}
                                            {% for support in supports %}
                                            <option value="{{ support.id }}" data-support-number="{{ support.support_number }}" 
                                                    data-support-type="{{ support.support_type or '' }}">
                                                Опора {{ support.support_number }}{% if support.support_type %} ({{ support.support_type }}){% endif %}
                                            </option>
                                            {% endfor %}
                                        {% else %}
                                            <option value="" disabled>Нет доступных опор для установки</option>
                                        {% endif %}
                                    </select>
                                    
                                    <!-- Скрытое поле для хранения выбранной опоры -->
                                    <input type="hidden" id="selected_support_id" name="selected_support_id">
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">
                                        <i class="bi bi-text-paragraph me-1"></i>
                                        Описание работы
                                    </label>
                                    <textarea class="form-control" id="description" name="description" rows="4" 
                                              placeholder="Подробное описание того, что нужно сделать"></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="planned_date" class="form-label">
                                                <i class="bi bi-calendar me-1"></i>
                                                Планируемая дата *
                                            </label>
                                            <input type="date" class="form-control" id="planned_date" name="planned_date" 
                                                   value="{{ today_date }}" min="{{ today_date }}" required>
                                            <div class="date-warning" id="date-warning">
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                Нельзя планировать работу на прошедшую дату
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="estimated_hours" class="form-label">
                                                <i class="bi bi-clock me-1"></i>
                                                Планируемые часы
                                            </label>
                                            <input type="number" class="form-control" id="estimated_hours" name="estimated_hours" 
                                                   placeholder="0.0" step="0.5" min="0">
                                            <div class="form-text">Укажите предполагаемое время выполнения в часах</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="location_details" class="form-label">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        Детали местоположения
                                    </label>
                                    <input type="text" class="form-control" id="location_details" name="location_details" 
                                           placeholder="Конкретное место на объекте, координаты и т.д.">
                                </div>

                                <div class="mb-3">
                                    <label for="materials_required" class="form-label">
                                        <i class="bi bi-tools me-1"></i>
                                        Требуемые материалы
                                    </label>
                                    <textarea class="form-control" id="materials_required" name="materials_required" rows="3" 
                                              placeholder="Список необходимых материалов, инструментов, оборудования"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="notes" class="form-label">
                                        <i class="bi bi-sticky me-1"></i>
                                        Дополнительные заметки
                                    </label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                                              placeholder="Любая дополнительная информация, особые требования и т.д."></textarea>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{{ url_for('objects.planned_works_list', object_id=object.id) }}" class="btn btn-outline-secondary me-md-2">
                                        <i class="bi bi-x-lg me-1"></i>
                                        Отмена
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg me-1"></i>
                                        Создать запланированную работу
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Устанавливаем минимальную дату как сегодня
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const plannedDateInput = document.getElementById('planned_date');
    plannedDateInput.min = today;
    
    // Добавляем строгую валидацию даты
    plannedDateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0); // Сбрасываем время для корректного сравнения
        const warningDiv = document.getElementById('date-warning');
        
        if (selectedDate < todayDate) {
            // Показываем визуальное предупреждение
            this.classList.add('is-invalid');
            warningDiv.classList.add('show');
            
            alert(`Нельзя планировать работу на прошедшую дату. Сегодня: ${todayDate.toLocaleDateString('ru-RU')}`);
            this.value = today;
            this.focus();
            return false;
        } else {
            // Скрываем предупреждение
            this.classList.remove('is-invalid');
            warningDiv.classList.remove('show');
        }
    });
    
    // Дополнительная валидация при отправке формы
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const selectedDate = new Date(plannedDateInput.value);
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);
        
        if (selectedDate < todayDate) {
            e.preventDefault();
            alert(`Ошибка: Нельзя планировать работу на прошедшую дату. Сегодня: ${todayDate.toLocaleDateString('ru-RU')}`);
            plannedDateInput.focus();
            return false;
        }
    });
    
    // Обработка изменения типа работы
    const workTypeSelect = document.getElementById('work_type');
    const workTitleInput = document.getElementById('work_title');
    const supportSelect = document.getElementById('support_select');
    const selectedSupportId = document.getElementById('selected_support_id');
    
    workTypeSelect.addEventListener('change', function() {
        if (this.value === 'support_installation') {
            // Проверяем, есть ли доступные опоры
            const hasSupports = supportSelect.querySelector('option[value]:not([disabled])');
            if (hasSupports) {
                // Показываем выпадающий список опор, скрываем текстовое поле
                workTitleInput.style.display = 'none';
                workTitleInput.required = false;
                supportSelect.style.display = 'block';
                supportSelect.required = true;
            } else {
                // Если нет опор, показываем текстовое поле с предупреждением
                workTitleInput.style.display = 'block';
                workTitleInput.required = true;
                workTitleInput.placeholder = 'Нет доступных опор. Введите заголовок вручную.';
                supportSelect.style.display = 'none';
                supportSelect.required = false;
            }
        } else {
            // Показываем текстовое поле, скрываем выпадающий список
            workTitleInput.style.display = 'block';
            workTitleInput.required = true;
            workTitleInput.placeholder = 'Например: Установка опоры №5';
            supportSelect.style.display = 'none';
            supportSelect.required = false;
            selectedSupportId.value = '';
        }
    });
    
    // Обработка выбора опоры
    supportSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const supportNumber = selectedOption.dataset.supportNumber;
            const supportType = selectedOption.dataset.supportType;
            
            // Формируем заголовок работы
            let title = `Установка опоры ${supportNumber}`;
            if (supportType) title += ` (${supportType})`;
            
            // Устанавливаем заголовок в скрытое поле
            workTitleInput.value = title;
            selectedSupportId.value = selectedOption.value;
        } else {
            workTitleInput.value = '';
            selectedSupportId.value = '';
        }
    });
});
</script>
{% endblock %}
