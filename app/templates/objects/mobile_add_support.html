{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'objects' %}

{% block title %}Добавить опору - {{ object.name }}{% endblock %}
{% block mobile_title %}Новая опора{% endblock %}

{% block content %}
<div class="mobile-card">
    <div class="mobile-card-title d-flex align-items-center">
        <svg width="18" height="18" class="me-2" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 1a1 1 0 0 1 1 1v5h5a1 1 0 0 1 0 2H9v5a1 1 0 0 1-2 0V9H2a1 1 0 0 1 0-2h5V2a1 1 0 0 1 1-1z"/>
        </svg>
        Добавить опору по проекту
    </div>
    <p class="mobile-card-text mobile-mb-2">Объект: <a href="{{ url_for('objects.object_detail', object_id=object.id) }}">{{ object.name }}</a></p>

    <form method="POST" id="add-support-form" novalidate>
        <div class="mobile-form-group">
            <label class="mobile-form-label" for="support_number">Номер опоры *</label>
            <input type="text"
                   class="mobile-form-control"
                   id="support_number"
                   name="support_number"
                   placeholder="Например: ОП-001"
                   inputmode="text"
                   maxlength="40"
                   required>
            <div class="invalid-feedback" style="display:none" id="support-number-error">Укажите номер опоры (минимум 1 символ).</div>
        </div>

        <div class="mobile-form-group">
            <label class="mobile-form-label" for="support_type">Название опоры</label>
            <input type="text"
                   class="mobile-form-control"
                   id="support_type"
                   name="support_type"
                   placeholder="Например: Железобетонная опора, Металлическая стойка"
                   maxlength="80">
        </div>

        <div class="alert alert-info">
            Опора будет создана со статусом «Запланировано». Дата установки будет заполнена при подтверждении установки исполнителем.
        </div>

        <div class="mobile-form-group">
            <div class="mobile-card-title" style="font-size: 15px; margin-bottom: 8px;">Выберите элементы для установки</div>

            {% if zdf_list %}
            <div class="mobile-mb-2">
                <div class="fw-semibold mobile-mb-1">ЗДФ</div>
                {% for zdf in zdf_list %}
                <label class="d-flex align-items-start mobile-mb-1" for="zdf-{{ zdf.id }}">
                    <input type="checkbox" class="form-check-input me-2" name="selected_zdf" value="{{ zdf.id }}" id="zdf-{{ zdf.id }}">
                    <div>
                        <div><strong>{{ zdf.zdf_number }}</strong>{% if zdf.zdf_name %} — {{ zdf.zdf_name }}{% endif %}</div>
                        {% if zdf.notes %}<div class="text-muted small">{{ zdf.notes }}</div>{% endif %}
                    </div>
                </label>
                {% endfor %}
            </div>
            {% endif %}

            {% if brackets_list %}
            <div class="mobile-mb-2">
                <div class="fw-semibold mobile-mb-1">Кронштейны</div>
                {% for bracket in brackets_list %}
                <label class="d-flex align-items-start mobile-mb-1" for="bracket-{{ bracket.id }}">
                    <input type="checkbox" class="form-check-input me-2" name="selected_brackets" value="{{ bracket.id }}" id="bracket-{{ bracket.id }}">
                    <div>
                        <div><strong>{{ bracket.bracket_number }}</strong>{% if bracket.bracket_name %} — {{ bracket.bracket_name }}{% endif %}</div>
                        {% if bracket.notes %}<div class="text-muted small">{{ bracket.notes }}</div>{% endif %}
                    </div>
                </label>
                {% endfor %}
            </div>
            {% endif %}

            {% if luminaires_list %}
            <div class="mobile-mb-2">
                <div class="fw-semibold mobile-mb-1">Светильники</div>
                {% for luminaire in luminaires_list %}
                <label class="d-flex align-items-start mobile-mb-1" for="luminaire-{{ luminaire.id }}">
                    <input type="checkbox" class="form-check-input me-2" name="selected_luminaires" value="{{ luminaire.id }}" id="luminaire-{{ luminaire.id }}">
                    <div>
                        <div><strong>{{ luminaire.luminaire_number }}</strong>{% if luminaire.luminaire_name %} — {{ luminaire.luminaire_name }}{% endif %}</div>
                        {% if luminaire.notes %}<div class="text-muted small">{{ luminaire.notes }}</div>{% endif %}
                    </div>
                </label>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="mobile-form-group">
            <label class="mobile-form-label" for="notes">Примечания</label>
            <textarea class="mobile-form-control" id="notes" name="notes" rows="3" maxlength="500" placeholder="Дополнительная информация об опоре"></textarea>
            <div class="small text-muted" id="notes-counter">0 / 500</div>
        </div>

        <button type="submit" class="mobile-btn mobile-btn-primary" id="submit-btn">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M6 2a.5.5 0 0 1 .5.5V6h3.5a.5.5 0 0 1 0 1H6.5v3.5a.5.5 0 0 1-1 0V7H2a.5.5 0 0 1 0-1h3.5V2.5A.5.5 0 0 1 6 2z"/>
            </svg>
            Создать опору
        </button>
        <a class="mobile-btn mobile-btn-outline" href="{{ url_for('objects.supports_list', object_id=object.id) }}">Назад к списку</a>
    </form>
</div>

<!-- Дополнительная "подпорка" от нижней панели -->
<div style="height: 140px"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-support-form');
    const submitBtn = document.getElementById('submit-btn');
    const numberInput = document.getElementById('support_number');
    const numberError = document.getElementById('support-number-error');
    const notes = document.getElementById('notes');
    const notesCounter = document.getElementById('notes-counter');

    // Тема из localStorage (safeguard на случай, если базовый layout ещё не применил)
    try {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || savedTheme === 'light') {
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
        }
    } catch (e) {}

    // Мягкий скролл и нижний padding у контейнера
    const content = document.querySelector('.mobile-content');
    if (content) {
        content.style.webkitOverflowScrolling = 'touch';
        content.style.scrollBehavior = 'smooth';
        const currentPaddingBottom = parseInt(window.getComputedStyle(content).paddingBottom || '0', 10);
        if (currentPaddingBottom < 140) {
            content.style.paddingBottom = '140px';
        }
    }

    // Фокус на номер опоры
    if (numberInput) numberInput.focus();

    // Счетчик примечания
    if (notes && notesCounter) {
        const updateCounter = () => { notesCounter.textContent = `${notes.value.length} / 500`; };
        notes.addEventListener('input', updateCounter);
        updateCounter();
    }

    // Тримминг
    const trimField = (el) => {
        if (!el) return;
        el.value = el.value.trim().replace(/\s{2,}/g, ' ');
    };
    [numberInput, document.getElementById('support_type'), notes].forEach(el => {
        if (!el) return;
        el.addEventListener('blur', () => trimField(el));
    });

    const isNumberValid = () => numberInput.value.trim().length >= 1;

    numberInput.addEventListener('input', () => {
        if (isNumberValid()) numberError.style.display = 'none';
    });

    form.addEventListener('submit', function(e) {
        trimField(numberInput);
        trimField(notes);

        if (!isNumberValid()) {
            e.preventDefault();
            numberError.style.display = 'block';
            numberInput.focus();
            return false;
        }

        submitBtn.disabled = true;
        const original = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Сохранение...';
        setTimeout(() => {
            if (!form.checkValidity()) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = original;
            }
        }, 3000);
    });
});
</script>
{% endblock %}


