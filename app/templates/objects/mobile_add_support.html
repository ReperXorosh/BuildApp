{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'objects' %}

{% block title %}Добавить опору - {{ object.name }}{% endblock %}
{% block mobile_title %}Новая опора{% endblock %}

{% block content %}
<div class="mobile-card add-object-card">
    <div class="mobile-card-title text-center">Добавить опору</div>

    <form method="POST" id="add-support-form" novalidate>
        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="support_number">Номер опоры *</label>
            <input type="text"
                   class="mobile-form-control mobile-form-control-lg"
                   id="support_number"
                   name="support_number"
                   placeholder="Например: ОП-001"
                   inputmode="text"
                   maxlength="40"
                   required>
            <div class="invalid-feedback" style="display:none" id="support-number-error">Укажите номер опоры (минимум 1 символ).</div>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="support_type">Название опоры</label>
            <input type="text"
                   class="mobile-form-control"
                   id="support_type"
                   name="support_type"
                   placeholder="Например: Железобетонная опора, Металлическая стойка"
                   maxlength="80">
        </div>


        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <div class="mobile-card-title" style="font-size: 15px; margin-bottom: 8px;">Выберите элементы для установки</div>
            <div class="accordion" id="supportElementsAccordion">
                {% if zdf_list %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingZdf">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseZdf" aria-expanded="false" aria-controls="collapseZdf">
                            ЗДФ
                        </button>
                    </h2>
                    <div id="collapseZdf" class="accordion-collapse collapse" aria-labelledby="headingZdf" data-bs-parent="#supportElementsAccordion">
                        <div class="accordion-body">
                            {% for zdf in zdf_list %}
                            <label class="d-flex align-items-start mobile-mb-1" for="zdf-{{ zdf.id }}">
                                <input type="checkbox" class="form-check-input me-2" name="selected_zdf" value="{{ zdf.id }}" id="zdf-{{ zdf.id }}">
                                <div>
                                    <div><strong>{{ zdf.zdf_number }}</strong>{% if zdf.zdf_name %} — {{ zdf.zdf_name }}{% endif %}</div>
                                    {% if zdf.notes %}<div class="text-muted small">{{ zdf.notes }}</div>{% endif %}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if brackets_list %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingBr">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBr" aria-expanded="false" aria-controls="collapseBr">
                            Кронштейн
                        </button>
                    </h2>
                    <div id="collapseBr" class="accordion-collapse collapse" aria-labelledby="headingBr" data-bs-parent="#supportElementsAccordion">
                        <div class="accordion-body">
                            {% for bracket in brackets_list %}
                            <label class="d-flex align-items-start mobile-mb-1" for="bracket-{{ bracket.id }}">
                                <input type="checkbox" class="form-check-input me-2" name="selected_brackets" value="{{ bracket.id }}" id="bracket-{{ bracket.id }}">
                                <div>
                                    <div><strong>{{ bracket.bracket_number }}</strong>{% if bracket.bracket_name %} — {{ bracket.bracket_name }}{% endif %}</div>
                                    {% if bracket.notes %}<div class="text-muted small">{{ bracket.notes }}</div>{% endif %}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if luminaires_list %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingLum">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLum" aria-expanded="false" aria-controls="collapseLum">
                            Светильник
                        </button>
                    </h2>
                    <div id="collapseLum" class="accordion-collapse collapse" aria-labelledby="headingLum" data-bs-parent="#supportElementsAccordion">
                        <div class="accordion-body">
                            {% for luminaire in luminaires_list %}
                            <label class="d-flex align-items-start mobile-mb-1" for="luminaire-{{ luminaire.id }}">
                                <input type="checkbox" class="form-check-input me-2" name="selected_luminaires" value="{{ luminaire.id }}" id="luminaire-{{ luminaire.id }}">
                                <div>
                                    <div><strong>{{ luminaire.luminaire_number }}</strong>{% if luminaire.luminaire_name %} — {{ luminaire.luminaire_name }}{% endif %}</div>
                                    {% if luminaire.notes %}<div class="text-muted small">{{ luminaire.notes }}</div>{% endif %}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="notes">Примечания</label>
            <textarea class="mobile-form-control" id="notes" name="notes" rows="2" maxlength="500" placeholder="Дополнительная информация об опоре"></textarea>
            <div class="small text-muted" id="notes-counter">0 / 500</div>
        </div>

        <div class="mobile-mt-4">
            <button type="submit" class="mobile-btn mobile-btn-primary w-100" id="submit-btn">Создать опору</button>
        </div>
    </form>
</div>

<!-- Убираем лишнюю прокрутку/отступ -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-support-form');
    const submitBtn = document.getElementById('submit-btn');
    const numberInput = document.getElementById('support_number');
    const numberError = document.getElementById('support-number-error');
    const notes = document.getElementById('notes');
    const notesCounter = document.getElementById('notes-counter');

    // Тема уже инициализирована в layout

    // Как на других страницах добавления: минимальный отступ снизу и без прокрутки
    try {
        const content = document.querySelector('.mobile-content');
        if (content) {
            // Включаем прокрутку на этой странице
            content.style.paddingBottom = '120px';
            content.style.overflowY = 'auto';
            content.style.height = '';
        }
        document.documentElement.style.overscrollBehaviorY = 'auto';
        document.body.style.overflow = '';
    } catch(e) {}

    // Фокус на номер опоры
    if (numberInput) numberInput.focus();

    // Счетчик примечания
    if (notes && notesCounter) {
        const updateCounter = () => { notesCounter.textContent = `${notes.value.length} / 500`; };
        notes.addEventListener('input', updateCounter);
        updateCounter();
    }

    // Тримминг
    const trimField = (el) => {
        if (!el) return;
        el.value = el.value.trim().replace(/\s{2,}/g, ' ');
    };
    [numberInput, document.getElementById('support_type'), notes].forEach(el => {
        if (!el) return;
        el.addEventListener('blur', () => trimField(el));
    });

    const isNumberValid = () => numberInput.value.trim().length >= 1;

    numberInput.addEventListener('input', () => {
        if (isNumberValid()) numberError.style.display = 'none';
    });

    form.addEventListener('submit', function(e) {
        trimField(numberInput);
        trimField(notes);

        if (!isNumberValid()) {
            e.preventDefault();
            numberError.style.display = 'block';
            numberInput.focus();
            return false;
        }

        submitBtn.disabled = true;
        const original = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Сохранение...';
        setTimeout(() => {
            if (!form.checkValidity()) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = original;
            }
        }, 3000);
    });
});
</script>

<style>
/* Синхронизация дизайна со страницами добавления */
[data-bs-theme="light"] .add-object-card { background:#fff; color:#0f172a; }
[data-bs-theme="light"] .mobile-form-label { color:#111827; }
[data-bs-theme="light"] .mobile-form-control, [data-bs-theme="light"] .mobile-form-control-lg { background:#fff; border-color:#d1d5db; color:#111827; }
[data-bs-theme="light"] .mobile-card-title { color:#0f172a; }

.add-object-card{ background:#fff; border:1px solid #e5e7eb; box-shadow:0 6px 18px rgba(0,0,0,.06); padding:12px; }
.add-object-card .mobile-form-group{ background:#f9fafb; border:1px solid #eef2f7; border-radius:12px; padding:10px; }
.add-object-card .mobile-form-group + .mobile-form-group{ margin-top:8px; }
.mobile-card-title{ font-size:1.5rem; font-weight:700; margin-bottom:.75rem; color:#111827; letter-spacing:-.025em; }
.mobile-form-label{ display:block; font-size:.9rem; font-weight:600; color:#374151; margin-bottom:6px; letter-spacing:.025em; }
.mobile-form-control-lg{ font-size:1.02rem; padding:10px 14px; border-radius:12px; border:2px solid #e1e5e9; background:#fff; color:#111827; transition:all .3s cubic-bezier(.4,0,.2,1); box-shadow:0 2px 4px rgba(0,0,0,.04); font-weight:500; }
.mobile-form-control{ font-size:.93rem; padding:8px 12px; border-radius:12px; border:2px solid #e1e5e9; background:#fff; color:#111827; transition:all .3s cubic-bezier(.4,0,.2,1); box-shadow:0 2px 4px rgba(0,0,0,.04); font-weight:500; }
.mobile-form-control:focus, .mobile-form-control-lg:focus{ border-color:#0d6efd; box-shadow:0 0 0 4px rgba(13,110,253,.1), 0 4px 12px rgba(0,0,0,.1); outline:none; transform:translateY(-1px); }
.mobile-btn{ border-radius:12px; font-weight:600; padding:10px 18px; font-size:.93rem; transition:all .3s cubic-bezier(.4,0,.2,1); letter-spacing:.025em; border:none; position:relative; overflow:hidden; }
.mobile-btn-primary{ background:linear-gradient(135deg,#0d6efd 0%,#0056b3 100%); color:#fff; box-shadow:0 4px 14px rgba(13,110,253,.3); }

@media (prefers-color-scheme: dark){
  .add-object-card{ background: var(--bs-body-bg); border-color:#2d3748; box-shadow:0 6px 18px rgba(0,0,0,.2); }
  .add-object-card .mobile-form-group{ background:#1f2937; border-color:#374151; }
  .mobile-form-label{ color:#e5e7eb; }
  .mobile-card-title{ color:#f9fafb; }
  .mobile-form-control-lg, .mobile-form-control{ background:#1f2937; border-color:#374151; color:#f9fafb; box-shadow:0 2px 4px rgba(0,0,0,.2); }
  .mobile-form-control:focus, .mobile-form-control-lg:focus{ border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.2), 0 4px 12px rgba(0,0,0,.3); }
}
</style>
{% endblock %}


