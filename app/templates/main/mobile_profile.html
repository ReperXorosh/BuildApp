{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'profile' %}

{% block title %}Профиль{% endblock %}
{% block mobile_title %}Профиль{% endblock %}

{% block content %}
<div class="container-fluid py-3">

    <div class="row g-4">

        <!-- Левая колонка: аватар -->
        <div class="col-12 col-md-4 col-lg-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    {% set avatar = (current_user.avatar | default('', true) | trim) %}
                    {% if avatar %}
                    <img src="{{ url_for('static', filename='uploads/avatars/' ~ avatar) }}"
                         alt="Avatar" class="rounded-circle mb-3"
                         style="width:160px;height:160px;object-fit:cover;">
                    {% else %}
                    <img src="{{ url_for('static', filename='img/default-avatar.png') }}"
                         alt="Avatar" class="rounded-circle mb-3"
                         style="width:160px;height:160px;object-fit:cover;">
                    {% endif %}


                    <form method="post" enctype="multipart/form-data" id="avatar-form">
                        <!-- Скрытое поле для отредактированного аватара -->
                        <input type="hidden" id="edited_avatar" name="edited_avatar">
                        
                        <div class="mb-3 text-start">
                            <label class="form-label">Загрузить новое фото</label>
                            <input class="form-control" type="file" id="avatar" name="avatar" accept=".png,.jpg,.jpeg,.webp">
                            <div class="form-text">Поддерживаемые форматы: PNG, JPG, JPEG. Максимальный размер: 5 МБ</div>
                        </div>
                        
                        <!-- Контейнер для редактора аватара (скрыт по умолчанию) -->
                        <div id="avatar-editor-container" class="mt-3" style="display: none;">
                            <!-- Предпросмотр аватара -->
                            <div class="text-center mb-3">
                                <img id="avatar-preview" src="{{ url_for('static', filename='img/default-avatar.png') }}" 
                                     alt="Предпросмотр аватара" class="rounded-circle" 
                                     style="width: 64px; height: 64px; object-fit: cover;">
                            </div>
                            <!-- Редактор будет создан здесь автоматически -->
                        </div>
                        
                        <button class="btn btn-primary w-100" type="submit" id="save-avatar-btn">Сохранить фото</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Правая колонка: данные профиля -->
        <div class="col-12 col-md-8 col-lg-9">
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Личная информация</h5>

                    <form method="post" enctype="multipart/form-data">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Фамилия</label>
                                <input type="text" class="form-control" name="secondname"
                                       value="{{ current_user.secondname or '' }}"
                                       {% if current_user.secondname %}disabled{% endif %}>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Имя</label>
                                <input type="text" class="form-control" name="firstname"
                                       value="{{ current_user.firstname or '' }}"
                                       {% if current_user.firstname %}disabled{% endif %}>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Отчество</label>
                                <input type="text" class="form-control" name="thirdname"
                                       value="{{ current_user.thirdname or '' }}"
                                       {% if current_user.thirdname %}disabled{% endif %}>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Телефон</label>
                                <input type="text" class="form-control" name="phonenumber"
                                       value="{{ current_user.phonenumber or '' }}"
                                       {% if current_user.phonenumber %}disabled{% endif %}>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Роль</label>
                                <input type="text" class="form-control" name="role"
                                       value="{{ current_user.role or '' }}" disabled>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Дата регистрации</label>
                                <input type="text" class="form-control"
                                       value="{{ current_user.registerdate | moscow_time_short if current_user.registerdate else '—' }}"
                                       disabled>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Логин</label>
                                <input type="text" class="form-control" value="{{ current_user.login }}" disabled>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ID пользователя</label>
                                <input type="text" class="form-control" value="{{ current_user.userid }}" disabled>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button class="btn btn-primary" type="submit">Сохранить изменения</button>
                            <a class="btn btn-outline-secondary" href="{{ url_for('main.profile') }}">Отменить</a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Настройки времени</h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Часовой пояс</label>
                            <select class="form-select" id="timezone-select" name="timezone">
                                <option value="Europe/Moscow">Москва (UTC+3)</option>
                                <option value="Europe/Kiev">Киев (UTC+2)</option>
                                <option value="Europe/Minsk">Минск (UTC+3)</option>
                                <option value="Europe/Kaliningrad">Калининград (UTC+2)</option>
                                <option value="Europe/Samara">Самара (UTC+4)</option>
                                <option value="Asia/Yekaterinburg">Екатеринбург (UTC+5)</option>
                                <option value="Asia/Omsk">Омск (UTC+6)</option>
                                <option value="Asia/Novosibirsk">Новосибирск (UTC+7)</option>
                                <option value="Asia/Krasnoyarsk">Красноярск (UTC+7)</option>
                                <option value="Asia/Irkutsk">Иркутск (UTC+8)</option>
                                <option value="Asia/Yakutsk">Якутск (UTC+9)</option>
                                <option value="Asia/Vladivostok">Владивосток (UTC+10)</option>
                                <option value="Asia/Magadan">Магадан (UTC+11)</option>
                                <option value="Asia/Kamchatka">Камчатка (UTC+12)</option>
                                <option value="Europe/London">Лондон (UTC+0/+1)</option>
                                <option value="Europe/Paris">Париж (UTC+1/+2)</option>
                                <option value="Europe/Berlin">Берлин (UTC+1/+2)</option>
                                <option value="America/New_York">Нью-Йорк (UTC-5/-4)</option>
                                <option value="America/Los_Angeles">Лос-Анджелес (UTC-8/-7)</option>
                                <option value="Asia/Tokyo">Токио (UTC+9)</option>
                                <option value="Asia/Shanghai">Шанхай (UTC+8)</option>
                                <option value="Australia/Sydney">Сидней (UTC+10/+11)</option>
                            </select>
                            <div class="form-text">Выберите ваш часовой пояс для корректного отображения времени</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Текущее время</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="current-time" readonly>
                                <span class="input-group-text">
                                    <i class="bi bi-clock"></i>
                                </span>
                            </div>
                            <div class="form-text">Время в выбранном часовом поясе</div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" type="button" id="save-timezone-btn">
                            <i class="bi bi-check-circle me-1"></i>
                            Сохранить часовой пояс
                        </button>
                        <button class="btn btn-outline-secondary ms-2" type="button" id="detect-timezone-btn">
                            <i class="bi bi-geo-alt me-1"></i>
                            Определить автоматически
                        </button>
                    </div>
                </div>
            </div>

            <!-- Дополнительные действия -->
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Дополнительные действия</h5>
                    <div class="d-flex gap-2 flex-wrap">
                        {% if current_user.role in ['Инженер ПТО', 'Зам. директор', 'Ген. директор'] %}
                        <a href="{{ url_for('main.users') }}" class="btn btn-outline-primary">
                            <i class="bi bi-people me-2"></i>
                            Управление пользователями
                        </a>
                        {% endif %}
                        <a href="{{ url_for('activity_log.view_activity_log') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-journal-text me-2"></i>
                            Журнал действий
                        </a>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

<!-- Подключаем простой и надежный редактор аватаров -->
<script src="{{ url_for('static', filename='js/avatar-editor-simple.js') }}"></script>
<!-- Подключаем утилиты для работы с часовыми поясами -->
<script src="{{ url_for('static', filename='js/timezone.js') }}"></script>

<script>
// Обработка отправки формы аватара
document.addEventListener('DOMContentLoaded', function() {
    const avatarForm = document.getElementById('avatar-form');
    if (avatarForm) {
        avatarForm.addEventListener('submit', function(e) {
            console.log('💾 Сохранение аватара...');
            
            // Если есть редактор аватара и изображение было отредактировано
            if (simpleAvatarEditor && simpleAvatarEditor.image) {
                console.log('🎨 Применяем изменения из редактора...');
                try {
                    const editedImage = simpleAvatarEditor.getEditedImage();
                    if (editedImage) {
                        document.getElementById('edited_avatar').value = editedImage;
                        console.log('✅ Отредактированное изображение добавлено в форму');
                    } else {
                        console.log('⚠️ Не удалось получить отредактированное изображение');
                    }
                } catch (error) {
                    console.error('❌ Ошибка при получении отредактированного изображения:', error);
                }
            } else {
                console.log('ℹ️ Редактор не активен, сохраняется оригинальный файл');
            }
        });
    } else {
        console.error('❌ Форма аватара не найдена');
    }
});

console.log('🔍 Скрипт профиля загружен');

// Обработка настроек часового пояса
document.addEventListener('DOMContentLoaded', function() {
    const timezoneSelect = document.getElementById('timezone-select');
    const currentTimeInput = document.getElementById('current-time');
    const saveTimezoneBtn = document.getElementById('save-timezone-btn');
    const detectTimezoneBtn = document.getElementById('detect-timezone-btn');
    
    // Устанавливаем текущий часовой пояс пользователя
    const currentTimezone = '{{ current_user.get_timezone() }}';
    if (timezoneSelect) {
        timezoneSelect.value = currentTimezone;
    }
    
    // Функция обновления времени
    function updateCurrentTime() {
        if (currentTimeInput && timezoneSelect) {
            const selectedTimezone = timezoneSelect.value;
            const now = new Date();
            const timeString = TimezoneUtils.formatTimeInTimezone(now, selectedTimezone, 'short');
            currentTimeInput.value = timeString;
        }
    }
    
    // Обновляем время при изменении часового пояса
    if (timezoneSelect) {
        timezoneSelect.addEventListener('change', updateCurrentTime);
    }
    
    // Обновляем время каждую секунду
    setInterval(updateCurrentTime, 1000);
    
    // Инициализируем время
    updateCurrentTime();
    
    // Обработка сохранения часового пояса
    if (saveTimezoneBtn) {
        saveTimezoneBtn.addEventListener('click', function() {
            const selectedTimezone = timezoneSelect.value;
            
            if (selectedTimezone === currentTimezone) {
                alert('Часовой пояс не изменился');
                return;
            }
            
            // Показываем индикатор загрузки
            saveTimezoneBtn.disabled = true;
            saveTimezoneBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Сохранение...';
            
            // Отправляем запрос на сервер
            TimezoneUtils.sendTimezoneToServer(selectedTimezone);
            
            // Восстанавливаем кнопку через 3 секунды
            setTimeout(() => {
                saveTimezoneBtn.disabled = false;
                saveTimezoneBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Сохранить часовой пояс';
            }, 3000);
        });
    }
    
    // Обработка автоматического определения часового пояса
    if (detectTimezoneBtn) {
        detectTimezoneBtn.addEventListener('click', function() {
            const detectedTimezone = TimezoneUtils.detectTimezone();
            
            if (detectedTimezone && timezoneSelect) {
                timezoneSelect.value = detectedTimezone;
                updateCurrentTime();
                
                // Показываем уведомление
                const alert = document.createElement('div');
                alert.className = 'alert alert-info alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="bi bi-info-circle me-2"></i>
                    Определен часовой пояс: ${detectedTimezone}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Вставляем уведомление перед формой
                const form = timezoneSelect.closest('.card-body');
                form.insertBefore(alert, form.firstChild);
                
                // Автоматически скрываем через 5 секунд
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 5000);
            } else {
                alert('Не удалось определить часовой пояс');
            }
        });
    }
});
</script>
{% endblock %}