{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'profile' %}

{% block title %}Профиль{% endblock %}
{% block mobile_title %}Профиль{% endblock %}

{% block content %}
<div class="container-fluid py-3">

    <div class="row g-4">

        <!-- Левая колонка: аватар -->
        <div class="col-12 col-md-4 col-lg-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    {% set avatar = (current_user.avatar | default('', true) | trim) %}
                    {% if avatar %}
                    <img src="{{ url_for('static', filename='uploads/avatars/' ~ avatar) }}"
                         alt="Avatar" class="rounded-circle mb-3"
                         style="width:160px;height:160px;object-fit:cover;">
                    {% else %}
                    <img src="{{ url_for('static', filename='img/default-avatar.png') }}"
                         alt="Avatar" class="rounded-circle mb-3"
                         style="width:160px;height:160px;object-fit:cover;">
                    {% endif %}


                    <form method="post" enctype="multipart/form-data" id="avatar-form">
                        <!-- Скрытое поле для отредактированного аватара -->
                        <input type="hidden" id="edited_avatar" name="edited_avatar">
                        
                        <div class="mb-3 text-start">
                            <label class="form-label">Загрузить новое фото</label>
                            <input class="form-control" type="file" id="avatar" name="avatar" accept=".png,.jpg,.jpeg,.webp">
                            <div class="form-text">Поддерживаемые форматы: PNG, JPG, JPEG. Максимальный размер: 5 МБ</div>
                        </div>
                        
                        <!-- Контейнер для редактора аватара (скрыт по умолчанию) -->
                        <div id="avatar-editor-container" class="mt-3" style="display: none;">
                            <!-- Предпросмотр аватара -->
                            <div class="text-center mb-3">
                                <img id="avatar-preview" src="{{ url_for('static', filename='img/default-avatar.png') }}" 
                                     alt="Предпросмотр аватара" class="rounded-circle" 
                                     style="width: 64px; height: 64px; object-fit: cover;">
                            </div>
                            <!-- Редактор будет создан здесь автоматически -->
                        </div>
                        
                        <button class="btn btn-primary w-100" type="submit" id="save-avatar-btn">Сохранить фото</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Правая колонка: данные профиля -->
        <div class="col-12 col-md-8 col-lg-9">
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Личная информация</h5>

                    {% if current_user.role == 'Инженер ПТО' %}
                    <form method="post" enctype="multipart/form-data">
                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <label class="form-label">Фамилия</label>
                                <input type="text" class="form-control" name="secondname"
                                       value="{{ current_user.secondname or '' }}"
                                       {% if current_user.secondname %}disabled{% endif %}>
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label">Имя</label>
                                <input type="text" class="form-control" name="firstname"
                                       value="{{ current_user.firstname or '' }}"
                                       {% if current_user.firstname %}disabled{% endif %}>
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label">Отчество</label>
                                <input type="text" class="form-control" name="thirdname"
                                       value="{{ current_user.thirdname or '' }}"
                                       {% if current_user.thirdname %}disabled{% endif %}>
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">Телефон</label>
                                <input type="text" class="form-control" name="phonenumber"
                                       value="{{ current_user.phonenumber or '' }}"
                                       {% if current_user.phonenumber %}disabled{% endif %}>
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">Роль</label>
                                <input type="text" class="form-control" name="role"
                                       value="{{ current_user.role or '' }}" disabled>
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">Дата регистрации</label>
                                <input type="text" class="form-control"
                                       value="{{ current_user.registerdate | moscow_time_short if current_user.registerdate else '—' }}"
                                       disabled>
                            </div>

                            <div class="col-12 col-md-4">
                                <label class="form-label">Логин</label>
                                <input type="text" class="form-control" value="{{ current_user.login }}" disabled>
                            </div>
                            {% if current_user.role == 'Инженер ПТО' %}
                            <div class="col-12 col-md-4">
                                <label class="form-label">ID пользователя</label>
                                <input type="text" class="form-control" value="{{ current_user.userid }}" disabled>
                            </div>
                            {% endif %}
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button class="btn btn-primary" type="submit">Сохранить изменения</button>
                            <a class="btn btn-outline-secondary" href="{{ url_for('main.profile') }}">Отменить</a>
                        </div>
                    </form>
                    {% endif %}
                    {% if current_user.role != 'Инженер ПТО' %}
                    <!-- Read-only блок для обычных пользователей -->
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <label class="form-label">Фамилия</label>
                            <input type="text" class="form-control" value="{{ current_user.secondname or '' }}" disabled>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label">Имя</label>
                            <input type="text" class="form-control" value="{{ current_user.firstname or '' }}" disabled>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label">Отчество</label>
                            <input type="text" class="form-control" value="{{ current_user.thirdname or '' }}" disabled>
                        </div>

                        <div class="col-12 col-md-4">
                            <label class="form-label">Телефон</label>
                            <input type="text" class="form-control" value="{{ current_user.phonenumber or '' }}" disabled>
                        </div>

                        <div class="col-12 col-md-4">
                            <label class="form-label">Роль</label>
                            <input type="text" class="form-control" value="{{ current_user.role or '' }}" disabled>
                        </div>

                        <div class="col-12 col-md-4">
                            <label class="form-label">Дата регистрации</label>
                            <input type="text" class="form-control" value="{{ current_user.registerdate | moscow_time_short if current_user.registerdate else '—' }}" disabled>
                        </div>

                        <div class="col-12 col-md-4">
                            <label class="form-label">Логин</label>
                            <input type="text" class="form-control" value="{{ current_user.login }}" disabled>
                        </div>
                        <!-- ID скрыт для не-админов -->
                    </div>
                    {% endif %}
                </div>
            </div>


            <!-- Дополнительные действия -->
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">Дополнительные действия</h5>
                    <div class="d-flex gap-2 flex-wrap">
                        {% if current_user.role in ['Инженер ПТО', 'Ген.Директор'] %}
                        <a href="{{ url_for('main.users') }}" class="btn btn-outline-primary flex-fill">
                            <i class="bi bi-people me-2"></i>
                            Управление пользователями
                        </a>
                        {% endif %}
                        {% if current_user.role == 'Инженер ПТО' %}
                        <a href="{{ url_for('activity_log.view_activity_log') }}" class="btn btn-outline-secondary flex-fill">
                            <i class="bi bi-journal-text me-2"></i>
                            Журнал действий
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

<!-- Подключаем простой и надежный редактор аватаров -->
<script src="{{ url_for('static', filename='js/avatar-editor-simple.js') }}"></script>
<!-- Подключаем утилиты для работы с часовыми поясами -->

<script>
// Обработка отправки формы аватара
document.addEventListener('DOMContentLoaded', function() {
    const avatarForm = document.getElementById('avatar-form');
    if (avatarForm) {
        avatarForm.addEventListener('submit', function(e) {
            console.log('💾 Сохранение аватара...');
            
            // Если есть редактор аватара и изображение было отредактировано
            if (simpleAvatarEditor && simpleAvatarEditor.image) {
                console.log('🎨 Применяем изменения из редактора...');
                try {
                    const editedImage = simpleAvatarEditor.getEditedImage();
                    if (editedImage) {
                        document.getElementById('edited_avatar').value = editedImage;
                        console.log('✅ Отредактированное изображение добавлено в форму');
                    } else {
                        console.log('⚠️ Не удалось получить отредактированное изображение');
                    }
                } catch (error) {
                    console.error('❌ Ошибка при получении отредактированного изображения:', error);
                }
            } else {
                console.log('ℹ️ Редактор не активен, сохраняется оригинальный файл');
            }
        });
    } else {
        console.error('❌ Форма аватара не найдена');
    }
});

console.log('🔍 Скрипт профиля загружен');

</script>
{% endblock %}