{% extends "main/layout.html" %}

{% block title %}{{ gettext('Журнал действий') }}{% endblock %}

{% block content %}
<div class="container-fluid" style="height: 100vh; overflow-y: auto;" id="activityLogContainer">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">{{ gettext('Журнал действий') }}</h1>
                <div class="btn-toolbar mb-2 mb-md-0" style="margin-right: 8rem !important; padding-right: 2rem;">
                    <div class="btn-group me-3">
                        <a href="{{ url_for('activity_log.export_activity_log') }}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-download"></i> {{ gettext('Экспорт в CSV') }}
                        </a>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearLog()">
                            <i class="bi bi-trash"></i> {{ gettext('Очистить журнал') }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Статистика -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">{{ gettext('Всего действий') }}</h5>
                            <p class="card-text display-6">{{ total_activities }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">{{ gettext('Сегодня') }}</h5>
                            <p class="card-text display-6">{{ today_activities }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Фильтры -->
            <div class="card mb-3">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="user" class="form-label">{{ gettext('Пользователь') }}</label>
                            <input type="text" class="form-control" id="user" name="user" value="{{ user_filter }}" placeholder="{{ gettext('Поиск по пользователю') }}">
                        </div>
                        <div class="col-md-3">
                            <label for="action" class="form-label">{{ gettext('Действие') }}</label>
                            <input type="text" class="form-control" id="action" name="action" value="{{ action_filter }}" placeholder="{{ gettext('Поиск по действию') }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date" class="form-label">{{ gettext('Дата') }}</label>
                            <input type="date" class="form-control" id="date" name="date" value="{{ date_filter }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> {{ gettext('Поиск') }}
                                </button>
                                <a href="{{ url_for('activity_log.view_activity_log') }}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> {{ gettext('Сброс') }}
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Таблица действий -->
            <div class="card" id="activityTableCard">
                <div class="card-body p-0">
                    <div class="table-container" id="activityTableContainer">
                        <table class="table table-striped table-hover mb-0" id="activityTable">
                            <thead class="table-header">
                                <tr>
                                    <th>{{ gettext('Дата') }}</th>
                                    <th>{{ gettext('Пользователь') }}</th>
                                    <th>{{ gettext('Роль') }}</th>
                                    <th>{{ gettext('Действие') }}</th>
                                    <th>{{ gettext('Описание') }}</th>
                                    <th>{{ gettext('IP адрес') }}</th>
                                    <th>{{ gettext('Страница') }}</th>
                                    <th style="width: 50px; text-align: center;">
                                        <button type="button" class="btn btn-sm btn-link p-0 fullscreen-btn" id="fullscreenBtn" onclick="toggleTableFullscreen()" title="{{ gettext('Полный экран') }}">
                                            <i class="bi bi-arrows-fullscreen fullscreen-icon"></i>
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in activities.items %}
                                <tr>
                                    <td>
                                        <small class="text-muted">
                                            {{ format_moscow_time(activity.created_at) }}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ activity.user_login or gettext('Неавторизованный') }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ activity.user_role or gettext('Неизвестно') }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ activity.action }}</span>
                                    </td>
                                    <td>
                                        <small>{{ activity.description[:100] }}{% if activity.description|length > 100 %}...{% endif %}</small>
                                    </td>
                                    <td>
                                        <code class="small">{{ activity.ip_address or gettext('Нет данных') }}</code>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ activity.page_url or gettext('Нет данных') }}</small>
                                    </td>
                                    <td></td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        {{ gettext('Нет данных') }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Пагинация -->
                    {% if activities.pages > 1 %}
                    <nav aria-label="Навигация по страницам">
                        <ul class="pagination justify-content-center">
                            {% if activities.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('activity_log.view_activity_log', page=activities.prev_num, user=user_filter, action=action_filter, date=date_filter) }}">Предыдущая</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in activities.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != activities.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('activity_log.view_activity_log', page=page_num, user=user_filter, action=action_filter, date=date_filter) }}">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if activities.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('activity_log.view_activity_log', page=activities.next_num, user=user_filter, action=action_filter, date=date_filter) }}">Следующая</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Информация о журнале действий -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Информация о журнале действий
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Статистика:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Всего записей:</strong> {{ activities.total }}</li>
                            <li><strong>На текущей странице:</strong> {{ activities.items|length }}</li>
                            <li><strong>Страница:</strong> {{ activities.page }} из {{ activities.pages }}</li>
                            <li><strong>Записей на странице:</strong> {{ activities.per_page }}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Фильтры:</h6>
                        <ul class="list-unstyled">
                            <li><strong>Пользователь:</strong> {{ user_filter or 'Не задан' }}</li>
                            <li><strong>Действие:</strong> {{ action_filter or 'Не задано' }}</li>
                            <li><strong>Дата:</strong> {{ date_filter or 'Не задана' }}</li>
                        </ul>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-12">
                        <h6>Описание журнала:</h6>
                        <p class="text-muted mb-0">
                            Журнал действий отслеживает все операции пользователей в системе, включая входы, 
                            просмотры страниц, изменения данных и другие важные события. Для каждой записи 
                            отображается логин пользователя, его роль, тип действия и подробное описание. 
                            Все записи сохраняются с временными метками в московском времени и содержат 
                            информацию об IP-адресах пользователей.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Отступ внизу страницы -->
<div class="row mt-4 mb-5">
    <div class="col-12">
        <div class="text-center">
            <small class="text-muted">
                Журнал действий системы управления
            </small>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения очистки -->
<div class="modal fade" id="clearLogModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ gettext('Подтвердите удаление') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ gettext('Все записи будут удалены') }}. {{ gettext('Это действие нельзя отменить') }}.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ gettext('Отмена') }}</button>
                <button type="button" class="btn btn-danger" onclick="confirmClearLog()">{{ gettext('Удалить') }}</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Основные стили для прокрутки */
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

/* Контейнер страницы */
.container-fluid {
    min-height: 100vh;
    overflow-y: auto;
    padding: 1rem;
    padding-bottom: 3rem;
    position: relative;
}

/* Контейнер таблицы */
.table-container {
    height: 60vh;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

/* Заголовок таблицы */
.table-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #ffffff;
    border-bottom: 2px solid #dee2e6;
}

.table-header th {
    background-color: #ffffff;
    color: #212529;
    font-weight: 600;
    padding: 12px 8px;
    border-bottom: 2px solid #dee2e6;
    white-space: nowrap;
}

/* Стили для скроллбара таблицы */
.table-container::-webkit-scrollbar {
    width: 10px;
}

.table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 5px;
}

.table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 5px;
    border: 2px solid #f1f1f1;
}

.table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Стили для скроллбара страницы */
.container-fluid::-webkit-scrollbar {
    width: 12px;
}

.container-fluid::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 6px;
}

.container-fluid::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 6px;
    border: 2px solid #f8f9fa;
}

.container-fluid::-webkit-scrollbar-thumb:hover {
    background: #495057;
}

/* Убираем отступы у таблицы */
.table {
    margin-bottom: 0;
}

.table tbody tr:last-child td {
    border-bottom: none;
}

/* Стили для информационной панели */
.card-header h5 {
    color: #495057;
    font-weight: 600;
}

.card-header .bi {
    color: #0d6efd;
}

.list-unstyled li {
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
}

.list-unstyled strong {
    color: #495057;
    font-weight: 600;
}

/* Стили для бейджей ролей */
.badge.bg-info {
    background-color: #17a2b8 !important;
    color: white;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
    color: white;
}

.badge.bg-primary {
    background-color: #0d6efd !important;
    color: white;
}

/* Адаптивность */
@media (max-width: 768px) {
    .table-container {
        height: 50vh;
    }
    
    .container-fluid {
        padding: 0.5rem;
    }
    
    .card-body .row {
        margin-bottom: 1rem;
    }
}

/* Стили для полноэкранного режима таблицы */
.table-fullscreen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999 !important;
    background: white !important;
    overflow: hidden !important;
    padding: 1rem !important;
}

.table-fullscreen .table-container {
    height: calc(100vh - 120px) !important;
    max-height: none !important;
    overflow-y: auto !important;
}

.table-fullscreen .table-header {
    position: sticky !important;
    top: 0 !important;
    background: white !important;
    z-index: 1000 !important;
}

.table-fullscreen .table {
    font-size: 0.9rem !important;
    margin-bottom: 0 !important;
}

.table-fullscreen .table th,
.table-fullscreen .table td {
    padding: 0.75rem 0.5rem !important;
}

.table-fullscreen .table th {
    background: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6 !important;
}

/* Стили для иконки полноэкранного режима */
.fullscreen-icon {
    transition: all 0.3s ease;
    opacity: 0.8;
    font-size: 1.1rem;
    color: #000000;
}

.fullscreen-icon:hover {
    opacity: 1;
    transform: scale(1.15);
}

.table-fullscreen .fullscreen-icon {
    transform: rotate(45deg);
}

/* Темная тема для иконки */
[data-bs-theme="dark"] .fullscreen-icon {
    color: #ffffff !important;
}

[data-bs-theme="dark"] .fullscreen-icon:hover {
    filter: drop-shadow(0 2px 4px rgba(255,255,255,0.3));
}

/* Светлая тема для иконки */
[data-bs-theme="light"] .fullscreen-icon {
    color: #000000 !important;
}

[data-bs-theme="light"] .fullscreen-icon:hover {
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

/* Дополнительные стили для гарантии видимости в темной теме */
body[data-bs-theme="dark"] .fullscreen-icon {
    color: #ffffff !important;
}

body[data-bs-theme="light"] .fullscreen-icon {
    color: #000000 !important;
}

/* Стили для кнопки полноэкранного режима */
.fullscreen-btn {
    border: none !important;
    background: transparent !important;
    padding: 4px !important;
    border-radius: 4px !important;
    transition: all 0.2s ease !important;
}

.fullscreen-btn:hover {
    background: rgba(255, 255, 255, 0.1) !important;
}

[data-bs-theme="dark"] .fullscreen-btn:hover {
    background: rgba(255, 255, 255, 0.1) !important;
}

[data-bs-theme="light"] .fullscreen-btn:hover {
    background: rgba(0, 0, 0, 0.1) !important;
}



/* Темная тема для полноэкранного режима */
[data-bs-theme="dark"] .table-fullscreen {
    background: #212529 !important;
    color: #f8f9fa !important;
}

[data-bs-theme="dark"] .table-fullscreen .table-header {
    background: #343a40 !important;
}

[data-bs-theme="dark"] .table-fullscreen .table th {
    background: #495057 !important;
    border-bottom-color: #6c757d !important;
}


</style>

<script>
// Функция очистки журнала
function clearLog() {
    const modal = new bootstrap.Modal(document.getElementById('clearLogModal'));
    modal.show();
}

// Функция переключения полноэкранного режима таблицы
function toggleTableFullscreen() {
    const tableCard = document.getElementById('activityTableCard');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const isFullscreen = tableCard.classList.contains('table-fullscreen');
    
    if (isFullscreen) {
        // Выход из полноэкранного режима
        tableCard.classList.remove('table-fullscreen');
        
        // Возвращаем иконку полноэкранного режима
        fullscreenBtn.innerHTML = '<i class="bi bi-arrows-fullscreen fullscreen-icon"></i>';
        fullscreenBtn.title = '{{ gettext("Полный экран") }}';
        
        // Восстанавливаем прокрутку страницы
        document.body.style.overflow = '';
        
        // Возвращаемся к нормальному размеру таблицы
        const tableContainer = document.getElementById('activityTableContainer');
        if (tableContainer) {
            const windowHeight = window.innerHeight;
            const tableHeight = Math.max(400, windowHeight * 0.6);
            tableContainer.style.height = tableHeight + 'px';
        }
    } else {
        // Вход в полноэкранный режим
        tableCard.classList.add('table-fullscreen');
        
        // Меняем иконку на "выход из полноэкранного режима"
        fullscreenBtn.innerHTML = '<i class="bi bi-arrows-angle-contract fullscreen-icon"></i>';
        fullscreenBtn.title = '{{ gettext("Выйти из полноэкранного режима") }}';
        
        // Отключаем прокрутку страницы
        document.body.style.overflow = 'hidden';
        
        // Устанавливаем максимальную высоту таблицы
        const tableContainer = document.getElementById('activityTableContainer');
        if (tableContainer) {
            tableContainer.style.height = 'calc(100vh - 120px)';
        }
    }
}

// Обработка клавиши Escape для выхода из полноэкранного режима
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const tableCard = document.getElementById('activityTableCard');
        if (tableCard.classList.contains('table-fullscreen')) {
            toggleTableFullscreen();
        }
    }
});

// Функция для обновления цвета иконки в зависимости от темы
function updateFullscreenIconColor() {
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const icon = fullscreenBtn.querySelector('.fullscreen-icon');
    const isDarkTheme = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    
    if (icon) {
        icon.style.color = isDarkTheme ? '#ffffff' : '#000000';
    }
}

// Обновляем цвет иконки при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    updateFullscreenIconColor();
    
    // Наблюдаем за изменениями атрибута data-bs-theme
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
                updateFullscreenIconColor();
            }
        });
    });
    
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-bs-theme']
    });
});

function confirmClearLog() {
    fetch('{{ url_for("activity_log.clear_activity_log") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при очистке журнала');
    });
}

// Улучшение прокрутки при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Обеспечиваем правильную высоту контейнера
    const container = document.querySelector('.container-fluid');
    const tableContainer = document.querySelector('.table-container');
    
    if (container && tableContainer) {
        // Устанавливаем высоту таблицы в зависимости от размера экрана
        const windowHeight = window.innerHeight;
        const tableHeight = Math.max(400, windowHeight * 0.6);
        tableContainer.style.height = tableHeight + 'px';
        
        // Добавляем плавную прокрутку
        tableContainer.style.scrollBehavior = 'smooth';
    }
    
    // Обработка изменения размера окна
    window.addEventListener('resize', function() {
        if (tableContainer) {
            const windowHeight = window.innerHeight;
            const tableHeight = Math.max(400, windowHeight * 0.6);
            tableContainer.style.height = tableHeight + 'px';
        }
    });
});
</script>
{% endblock %}
