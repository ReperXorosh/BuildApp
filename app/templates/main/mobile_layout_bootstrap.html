<!doctype html>
<html lang="ru" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>{% block title %}СтройКомплекс{% endblock %}</title>
    
    <!-- МГНОВЕННОЕ применение темы до загрузки CSS, чтобы не было вспышки светлой темы -->
    <script>
        (function() {
            try {
                var savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme !== 'dark' && savedTheme !== 'light') { savedTheme = 'light'; }
                document.documentElement.setAttribute('data-bs-theme', savedTheme);
            } catch (e) {
                document.documentElement.setAttribute('data-bs-theme', 'light');
            }
        })();
    </script>
    
    <!-- Bootstrap CSS (используем локальный, убираем дубликат CDN) -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/static/img/apple-touch-icon.svg" sizes="180x180">
    <link rel="icon" href="/static/img/favicon.svg" type="image/svg+xml">
    
    <!-- Preload критических ресурсов -->
    <link rel="preload" href="/static/css/bootstrap.min.css" as="style">
    <link rel="preload" href="/static/css/mobile.css" as="style">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="СтройКомплекс">
    <meta name="theme-color" content="#007bff">
    
    <!-- Fullscreen mobile meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- iOS specific meta tags for fullscreen -->
    <meta name="apple-touch-fullscreen" content="yes">
    
    <!-- Критический CSS для мобильных (inline для быстрой загрузки) -->
    <style>
        /* Мобильный хедер */
        .mobile-header {
            background: #007bff;
            color: white;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100vw;
            left: 0;
            right: 0;
            /* Добавляем отступ для safe area */
            padding-top: calc(16px + env(safe-area-inset-top, 0px));
            padding-top: calc(16px + constant(safe-area-inset-top, 0px));
        }
        .mobile-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            width: 100%;
            padding-right: 56px;
        }
        .mobile-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            flex: 1;
            margin-left: 16px;
        }
        /* Мобильные карточки */
        .mobile-card {
            background: var(--bs-body-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--bs-border-color);
            transition: all 0.2s ease;
        }
        .mobile-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .mobile-card-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--bs-body-color);
        }
        .mobile-card-text {
            font-size: 14px;
            color: var(--bs-secondary-color);
            margin: 0;
            line-height: 1.4;
        }
        /* Мобильная навигация */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bs-body-bg);
            border-top: 1px solid var(--bs-border-color);
            padding: 12px 0 8px 0;
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            min-height: 80px;
            will-change: transform;
            /* Добавляем отступ для safe area */
            padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
            padding-bottom: calc(8px + constant(safe-area-inset-bottom, 0px));
        }
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            text-decoration: none;
            color: var(--bs-secondary-color);
            transition: color 0.2s ease;
            min-width: 60px;
        }
        .mobile-nav-item.active {
            color: var(--bs-primary);
        }
        .mobile-nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        .mobile-nav-text {
            font-size: 10px;
            font-weight: 500;
        }
        /* Мобильный контент */
        .mobile-content {
            flex: 1;
            padding: 16px;
            /* padding-bottom выставляется скриптом по высоте нижней панели */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: calc(100vh - 60px);
        }
        /* Кнопки */
        .mobile-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            min-height: 48px;
        }
        .mobile-btn-primary {
            background: var(--bs-primary);
            color: var(--bs-primary-text);
        }
        .mobile-btn-primary:active {
            background: var(--bs-primary-bg-subtle);
            transform: scale(0.98);
        }
        /* Формы */
        .form-control, .form-select {
            font-size: 16px;
            min-height: 44px;
        }
        .btn {
            min-height: 44px;
            touch-action: manipulation;
        }
        /* Списки */
        .list-group-item {
            border-width: 1px;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 12px 16px;
        }
        .list-group .list-group-item:not(:first-child) {
            border-top-width: 1px !important;
        }
        .list-group-item + .list-group-item {
            border-top-width: 1px !important;
        }
    </style>
    
    <!-- Desktop CSS (сохраняем все стили) -->
    <link href="/static/css/sidebars.css" rel="stylesheet">
    <link href="/static/css/mobile.css" rel="stylesheet">
    <link href="/static/css/fullscreen-mobile.css" rel="stylesheet">
    
    <style>
        /* Все стили из десктопного layout */
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem
            }
        }

        .divider {
            width: 100%;
            height: 3rem;
            background-color: #0000001a;
            border: solid rgba(0, 0, 0, .15);
            border-width: 1px 0;
            box-shadow: inset 0 .5em 1.5em #0000001a, inset 0 .125em .5em #00000026
        }

        .vertical-rule {
            flex-shrink: 0;
            width: 1.5rem;
            height: 100vh
        }

        .bi {
            vertical-align: -.125em;
            fill: currentColor
        }

        .nav-scroller {
            position: relative;
            z-index: 2;
            height: 2.75rem;
            overflow-y: hidden
        }

        .nav-scroller .nav {
            display: flex;
            flex-wrap: nowrap;
            padding-bottom: 1rem;
            margin-top: -1px;
            overflow-x: auto;
            text-align: center;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch
        }

        .btn-bd-primary {
            --bd-violet-bg: #712cf9;
            --bd-violet-rgb: 112.520718, 44.062154, 249.437846;
            --bs-btn-font-weight: 600;
            --bs-btn-color: var(--bs-white);
            --bs-btn-bg: var(--bd-violet-bg);
            --bs-btn-border-color: var(--bd-violet-bg);
            --bs-btn-hover-color: var(--bs-white);
            --bs-btn-hover-bg: #6528e0;
            --bs-btn-hover-border-color: #6528e0;
            --bs-btn-focus-shadow-rgb: var(--bd-violet-rgb);
            --bs-btn-active-color: var(--bs-btn-hover-color);
            --bs-btn-active-bg: #5a23c8;
            --bs-btn-active-border-color: #5a23c8
        }

        .bd-mode-toggle {
            z-index: 1500
        }

        .bd-mode-toggle .bi {
            width: 1em;
            height: 1em
        }

        .bd-mode-toggle .dropdown-menu .active .bi {
            display: block !important
        }
        
        /* Глобальные стили для прокрутки */
        html, body {
            overflow-y: auto !important;
            height: auto !important;
            min-height: 100vh !important;
            /* Полноэкранное отображение */
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height для мобильных */
            overflow: hidden;
        }
        
        /* Скрытие нативных элементов браузера */
        body {
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            /* Предотвращаем зум при двойном тапе */
            touch-action: manipulation;
        }
        
        /* Мобильный контейнер - используем стандартные Bootstrap классы */
        .mobile-app {
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height для мобильных */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Мобильный хедер - унифицированный голубой цвет */
        .mobile-header {
            background: #007bff;
            color: white;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100vw; /* растягиваем хедер на всю ширину окна */
            left: 0;
            right: 0;
        }
        /* Заливка области статус-бара, чтобы не было разреза при pull-to-refresh */
        .mobile-statusbar-fill {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: env(safe-area-inset-top, 0px);
            height: constant(safe-area-inset-top, 0px);
            background: #007bff;
            z-index: 1001;
            pointer-events: none;
        }
        /* Дополнительная заливка для overscroll/pull-to-refresh областей */
        /* Решение «разреза»: у корневого html фон как у шапки (виден только при overscroll),
           у body остаётся обычный фон приложения */
        html { background-color: #007bff; }
        body { background-color: var(--bs-body-bg); }
        
        .mobile-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            width: 100%;
            padding-right: 56px; /* резерв под кнопку, чтобы заголовок не наезжал */
        }
        /* Отступы шапки: 16px + safe area, без лишнего резерва */
        .mobile-header {
            padding-right: calc(16px + env(safe-area-inset-right, 0px));
            padding-right: calc(16px + constant(safe-area-inset-right, 0px)); /* iOS < 13 */
            padding-left: calc(16px + env(safe-area-inset-left, 0px));
            padding-left: calc(16px + constant(safe-area-inset-left, 0px));
        }

        /* Кнопка действий (плюс) у фактического правого края экрана (c учетом safe area) */
        .mobile-header .mobile-header-btn {
            position: absolute;
            right: calc(16px + env(safe-area-inset-right, 0px));
            right: calc(16px + constant(safe-area-inset-right, 0px)); /* iOS < 13 */
            top: 50%;
            transform: translateY(-50%);
            margin-left: 0;
            z-index: 1001;
        }
        
        .mobile-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            flex: 1;
            margin-left: 16px; /* Отступ от гамбургер-меню */
        }
        
        .mobile-header-btn {
            background: none;
            border: none;
            color: white;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: absolute; /* фиксируем около правого края */
            right: calc(16px + env(safe-area-inset-right, 0px));
            right: calc(16px + constant(safe-area-inset-right, 0px));
            top: 50%;
            transform: translateY(-50%);
            z-index: 1001;
        }
        
        .mobile-header-btn:hover {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .mobile-header-btn svg {
            width: 32px;
            height: 32px;
        }
        
        .mobile-menu-btn {
            background: none;
            border: none;
            color: white;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .mobile-menu-btn:hover {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .mobile-menu-btn:active {
            transform: scale(0.95);
        }
        
        /* Мобильный контент */
        .mobile-content {
            flex: 1;
            padding: 16px;
            padding-bottom: 140px; /* Увеличенный отступ для нижней навигации */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: calc(100vh - 60px); /* Высота экрана минус хедер */
            height: calc(100dvh - 60px); /* Dynamic viewport height для мобильных */
            /* Улучшенный скроллинг */
            scroll-behavior: smooth;
            overscroll-behavior: contain;
        }

        /* Нижняя панель всегда закреплена; отступ контента регулируем JS */
        
        /* Мобильные карточки - используем Bootstrap стили */
        .mobile-card {
            background: var(--bs-body-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--bs-border-color);
            transition: all 0.2s ease;
        }
        
        .mobile-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        
        .mobile-card-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--bs-body-color);
        }
        
        .mobile-card-text {
            font-size: 14px;
            color: var(--bs-secondary-color);
            margin: 0;
            line-height: 1.4;
        }
        
        /* Мобильные кнопки - используем Bootstrap стили */
        .mobile-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            transition: all 0.2s ease;
            min-height: 48px;
        }
        
        .mobile-btn-primary {
            background: var(--bs-primary);
            color: var(--bs-primary-text);
        }
        
        .mobile-btn-primary:active {
            background: var(--bs-primary-bg-subtle);
            transform: scale(0.98);
        }
        
        .mobile-btn-secondary {
            background: var(--bs-secondary);
            color: var(--bs-secondary-text);
        }
        
        .mobile-btn-secondary:active {
            background: var(--bs-secondary-bg-subtle);
            transform: scale(0.98);
        }
        
        .mobile-btn-outline {
            background: var(--bs-body-bg);
            color: var(--bs-primary);
            border: 2px solid var(--bs-primary);
        }
        
        .mobile-btn-outline:active {
            background: var(--bs-body-bg);
            transform: scale(0.98);
        }
        
        /* Мобильная навигация */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bs-body-bg);
            border-top: 1px solid var(--bs-border-color);
            padding: 12px 0 8px 0; /* Увеличенный отступ сверху */
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            min-height: 80px; /* Минимальная высота панели */
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            text-decoration: none;
            color: var(--bs-secondary-color);
            transition: color 0.2s ease;
            min-width: 60px;
        }
        
        .mobile-nav-item.active {
            color: var(--bs-primary);
        }
        
        .mobile-nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .mobile-nav-text {
            font-size: 10px;
            font-weight: 500;
        }
        
        /* Мобильное меню */
        .mobile-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: var(--bs-body-bg);
            z-index: 1050;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .mobile-menu.open {
            left: 0;
        }
        
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1045;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .mobile-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .mobile-menu-header {
            background: #007bff;
            color: white;
            padding: 20px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .mobile-menu-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .mobile-menu-close {
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 8px;
            padding: 8px;
            color: white;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .mobile-menu-close:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.05);
        }
        
        .mobile-menu-close:active {
            transform: scale(0.95);
        }
        
        .mobile-menu-close svg {
            width: 18px;
            height: 18px;
            stroke-width: 2;
        }
        
        .mobile-menu-nav {
            padding: 16px 0;
        }
        
        .mobile-menu-item {
            display: block;
            padding: 16px 20px;
            color: var(--bs-body-color);
            text-decoration: none;
            border-bottom: 1px solid var(--bs-border-color);
            transition: background-color 0.2s ease;
        }
        
        .mobile-menu-item:active {
            background-color: var(--bs-secondary-bg);
        }
        
        .mobile-menu-item.active {
            background-color: var(--bs-primary-bg-subtle);
            color: var(--bs-primary);
            border-left: 4px solid var(--bs-primary);
        }
        
        /* Стили для настроек */
        .mobile-menu-settings {
            margin: 8px 0;
        }
        
        .mobile-menu-settings-title {
            font-weight: 600;
            color: var(--bs-secondary-color);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 20px 8px 20px;
            border-bottom: none;
            transition: all 0.2s ease;
        }
        
        .mobile-menu-settings-title:hover {
            background-color: rgba(var(--bs-primary-rgb), 0.1);
        }
        
        .mobile-settings-chevron {
            transition: transform 0.2s ease;
        }
        
        .mobile-menu-settings-title[aria-expanded="true"] .mobile-settings-chevron {
            transform: rotate(180deg);
        }
        
        .mobile-menu-theme-toggle {
            padding: 12px 20px;
            border-bottom: none;
        }
        
        .mobile-theme-switch {
            display: flex;
            align-items: center;
        }
        
        .mobile-theme-btn {
            background: var(--bs-secondary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 8px;
            color: var(--bs-body-color);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .mobile-theme-btn:hover {
            background: var(--bs-tertiary-bg);
            border-color: var(--bs-primary);
        }
        
        .mobile-theme-btn:active {
            transform: scale(0.95);
        }
        
        .mobile-theme-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .mobile-theme-btn svg {
            transition: transform 0.3s ease;
        }
        
        .mobile-theme-btn.active svg {
            transform: rotate(180deg);
        }
        
        /* Утилиты для мобильных */
        .mobile-hidden {
            display: none !important;
        }
        
        .mobile-visible {
            display: block !important;
        }
        
        /* Адаптивная типографика */
        h1 { font-size: 24px; }
        h2 { font-size: 20px; }
        h3 { font-size: 18px; }
        h4 { font-size: 16px; }
        h5 { font-size: 14px; }
        h6 { font-size: 12px; }
        
        /* Улучшенная прокрутка на мобильных */
        .mobile-scroll {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Скрытие элементов на мобильных */
        .d-none.d-md-block {
            display: none !important;
        }
        
        .d-md-none {
            display: block !important;
        }
        
        /* Дополнительные стили для мобильных устройств */
        .mobile-content {
            /* Улучшенный скроллинг */
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* Исправление для форм на мобильных */
        .form-control, .form-select {
            font-size: 16px; /* Предотвращает зум на iOS */
            min-height: 44px; /* Минимальная высота для touch */
        }
        
        /* Исправление для кнопок на мобильных */
        .btn {
            min-height: 44px;
            touch-action: manipulation;
        }
        
        /* Исправление для карточек */
        .card {
            margin-bottom: 16px;
        }
        
        /* Исправление для таблиц на мобильных */
        .table-responsive {
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        /* Исправление для модальных окон */
        .modal-dialog {
            margin: 16px;
            max-width: calc(100% - 32px);
        }
        
        /* Исправление для навигации */
        .mobile-nav-item {
            min-height: 60px;
            padding: 8px 4px;
        }
        
        /* Исправление для контейнера */
        .container-fluid {
            padding-left: 16px;
            padding-right: 16px;
        }
        /* Поверх всех оверлеев приложения показываем модальные окна */
        .modal { z-index: 3000; }
        .modal-backdrop { z-index: 2990; }
        /* Глобальная правка Bootstrap: у всех элементов списка сохраняем верхнюю границу */
        .list-group-item { border-width: 1px; }
        .list-group .list-group-item:not(:first-child) { border-top-width: 1px !important; }
        .list-group-item + .list-group-item { border-top-width: 1px !important; }
        
        /* Стили для свайп-действий */
        .swipeable-item {
            position: relative;
            overflow: hidden;
            touch-action: pan-y;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .swipeable-content {
            position: relative;
            z-index: 2;
            background: var(--bs-body-bg);
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        
        .swipe-actions {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            display: flex;
            align-items: center;
            z-index: 1;
            transform: translateX(100%);
            will-change: transform;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .swipe-actions.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .swipe-action-btn {
            height: 100%;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 14px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .swipe-action-btn:hover {
            filter: brightness(0.9);
        }
        
        .swipe-action-btn:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
        
        .swipe-action-delete {
            background: linear-gradient(135deg, #dc3545, #c82333);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
        }
        
        .swipe-action-delete:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
        }
        
        /* Анимации для плавного свайпа */
        .swipeable-item.swiping .swipeable-content {
            transition: none;
        }
        
        .swipeable-item.swiping .swipe-actions {
            transition: none;
        }
        
        .swipeable-item.animating .swipeable-content {
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .swipeable-item.animating .swipe-actions {
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
    </style>
</head>
<body>
    <!-- Загрузочный экран -->
    <div class="mobile-app">
        <div class="mobile-statusbar-fill"></div>
        <!-- Мобильный хедер -->
        <header class="mobile-header">
            <div class="mobile-header-content">
                <a class="mobile-menu-btn" id="mobileBackBtn" href="javascript:void(0)" aria-label="Назад" title="Назад" style="display:none;">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H3.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L3.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
                    </svg>
                </a>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                </button>
                <h1 class="mobile-title">{% block mobile_title %}{{ gettext('СтройКомплекс') }}{% endblock %}</h1>
                {% block mobile_header_actions %}{% endblock %}
            </div>
        </header>
        
        <!-- Мобильный контент -->
        <main class="mobile-content">
            {% block content %}{% endblock %}
        </main>
        
        <!-- Мобильная навигация -->
        <nav class="mobile-nav">
            <a href="{{ url_for('objects.object_list') }}" class="mobile-nav-item {{ 'active' if active_page == 'objects' else '' }}">
                <svg class="mobile-nav-icon" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                </svg>
                <span class="mobile-nav-text">Объекты</span>
            </a>
            <a href="{{ url_for('main.reports') }}" class="mobile-nav-item {{ 'active' if active_page == 'reports' else '' }}">
                <svg class="mobile-nav-icon" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                </svg>
                <span class="mobile-nav-text">Отчёты</span>
            </a>
            <a href="{{ url_for('objects.planned_works_overview') }}" class="mobile-nav-item {{ 'active' if active_page == 'planned_works' else '' }}">
                <svg class="mobile-nav-icon" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                </svg>
                <span class="mobile-nav-text">Работы</span>
            </a>
            <a href="{{ url_for('main.profile') }}" class="mobile-nav-item {{ 'active' if active_page == 'profile' else '' }}">
                <svg class="mobile-nav-icon" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                </svg>
                <span class="mobile-nav-text">Профиль</span>
            </a>
        </nav>
    </div>
    
    <!-- Мобильное меню -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <h2 class="mobile-menu-title">{{ gettext('Меню') }}</h2>
            <button class="mobile-menu-close" id="mobileMenuClose">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <nav class="mobile-menu-nav">
            {% if current_user.role == 'Инженер ПТО' %}
            <a href="{{ url_for('objects.object_list') }}" class="mobile-menu-item {{ 'active' if active_page == 'objects' else '' }}">
                {{ gettext('Список объектов') }}
            </a>
            <a href="{{ url_for('main.reports') }}" class="mobile-menu-item {{ 'active' if active_page == 'reports' else '' }}">
                {{ gettext('Отчёты') }}
            </a>
            <a href="{{ url_for('objects.planned_works_overview') }}" class="mobile-menu-item {{ 'active' if active_page == 'planned_works' else '' }}">
                {{ gettext('Запланированные работы') }}
            </a>
            {% endif %}
            {% if current_user.role == 'Инженер ПТО' %}
            <a href="{{ url_for('activity_log.view_activity_log') }}" class="mobile-menu-item {{ 'active' if active_page == 'activity_log' else '' }}">
                {{ gettext('Журнал действий') }}
            </a>
            {% endif %}
            {% if current_user.role == 'Инженер ПТО' %}
            <a href="{{ url_for('main.users') }}" class="mobile-menu-item {{ 'active' if active_page == 'users' else '' }}">
                {{ gettext('Пользователи') }}
            </a>
            {% endif %}
            <a href="{{ url_for('supply.supply_dashboard') }}" class="mobile-menu-item {{ 'active' if active_page == 'supply' else '' }}">
                {{ gettext('Снабжение') }}
            </a>
            <a href="{{ url_for('main.profile') }}" class="mobile-menu-item {{ 'active' if active_page == 'profile' else '' }}">
                {{ gettext('Профиль') }}
            </a>
            <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--bs-border-color);">
            
            <!-- Настройки -->
            <div class="mobile-menu-settings">
                <div class="mobile-menu-item mobile-menu-settings-title" data-bs-toggle="collapse" data-bs-target="#mobileSettingsCollapse" aria-expanded="false" aria-controls="mobileSettingsCollapse" style="cursor: pointer;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 12px;">
                                <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                                <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.292-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.292c.415.764-.42 1.6-1.185 1.184l-.292-.159a1.873 1.873 0 0 0-2.692 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.693-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.292A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
                            </svg>
                            <span>{{ gettext('Настройки') }}</span>
                        </div>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="mobile-settings-chevron">
                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Содержимое настроек (аккордеон) -->
                <div class="collapse" id="mobileSettingsCollapse">
                    <!-- Переключатель темы -->
                    <div class="mobile-menu-item mobile-menu-theme-toggle">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 12px;">
                                    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
                                </svg>
                                <span>{{ gettext('Тема') }}</span>
                            </div>
                            <div class="mobile-theme-switch">
                                <button class="mobile-theme-btn" id="mobileThemeToggle" type="button">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" id="mobileThemeIcon">
                                        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Настройка часового пояса -->
                    <a href="{{ url_for('main.timezone_settings') }}" class="mobile-menu-item">
                        <div class="d-flex align-items-center">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 12px;">
                                <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                            </svg>
                            <span>{{ gettext('Часовой пояс') }}</span>
                        </div>
                    </a>
                </div>
            </div>
            
            <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--bs-border-color);">
            <a href="{{ url_for('user.logout') }}" class="mobile-menu-item">
                {{ gettext('Выйти') }}
            </a>
        </nav>
    </div>
    
    <!-- Оверлей для мобильного меню -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
    
    <!-- Bootstrap JS -->
    <script src="/static/js/bootstrap.bundle.min.js" defer></script>
    
    <!-- Fullscreen mobile JS -->
    <script src="/static/js/fullscreen-mobile.js" defer></script>
    
    <!-- Prefetch ссылок и Мобильное меню JavaScript -->
    <script defer>
        // Префетч по первому касанию: ускоряет переходы на мобильных
        document.addEventListener('touchstart', function(e) {
            try {
                const a = e.target.closest('a[href]');
                if (!a) return;
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = a.href;
                document.head.appendChild(link);
            } catch(_) {}
        }, { passive: true });

        // Дополнительный префетч: когда ссылки попадают во вьюпорт
        const io = ('IntersectionObserver' in window) ? new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const a = entry.target;
                    try {
                        const link = document.createElement('link');
                        link.rel = 'prefetch';
                        link.href = a.href;
                        document.head.appendChild(link);
                        io.unobserve(a);
                    } catch(_) {}
                }
            })
        }) : null;

        document.addEventListener('DOMContentLoaded', () => {
            if (io) {
                document.querySelectorAll('a[href^="/"]').forEach(a => io.observe(a));
            }
        });

        function initMobileHeader() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileBackBtn = document.getElementById('mobileBackBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
            const mobileMenuClose = document.getElementById('mobileMenuClose');
            const mobileThemeToggle = document.getElementById('mobileThemeToggle');
            const mobileThemeIcon = document.getElementById('mobileThemeIcon');
            const searchToggle = document.getElementById('searchToggle');

            function openMobileMenu() {
                if (mobileMenu && mobileMenuOverlay) {
                    mobileMenu.classList.add('open');
                    mobileMenuOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeMobileMenu() {
                if (mobileMenu && mobileMenuOverlay) {
                    mobileMenu.classList.remove('open');
                    mobileMenuOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }

            // Показ гамбургера на основных вкладках и кнопки «Назад» на вложенных страницах
            try {
                const path = window.location.pathname || '';
                // Правила показа гамбургера: корни разделов и ключевые страницы
                const isObjectsRoot = /^\/objects\/?$/.test(path);
                const isReports = path.startsWith('/reports');
                const isUsers = path.startsWith('/users');
                const isSupply = path.startsWith('/supply') && !path.includes('/warehouse/add-material') && !path.includes('/warehouse/receipt') && !path.includes('/warehouse/movement');
                const isActivity = path.startsWith('/activity-log') || path.startsWith('/admin/activity-log');
                const isProfile = path.startsWith('/profile');
                const isPlannedWorksOverview = /^\/objects\/planned-works-overview\/?$/.test(path);
                const isAllPlannedWorks = /^\/objects\/all-planned-works\/?$/.test(path);
                const isMainPage = isObjectsRoot || isReports || isUsers || isSupply || isActivity || isProfile || isPlannedWorksOverview || isAllPlannedWorks;
                if (mobileBackBtn && mobileMenuBtn) {
                    if (isMainPage) {
                        // Главные вкладки: показываем гамбургер, скрываем «Назад»
                        mobileBackBtn.style.display = 'none';
                        mobileMenuBtn.style.display = '';
                        mobileBackBtn.onclick = null;
                    } else {
                        // Вложенные страницы: показываем «Назад», скрываем гамбургер
                        mobileBackBtn.style.display = '';
                        mobileMenuBtn.style.display = 'none';
                        mobileBackBtn.onclick = () => window.history.back();
                    }
                }
            } catch(e) {}

            // Привязка обработчиков меню (сначала очистим старые)
            if (mobileMenuBtn) {
                mobileMenuBtn.onclick = openMobileMenu;
            }
            if (mobileMenuClose) {
                mobileMenuClose.onclick = closeMobileMenu;
            }
            if (mobileMenuOverlay) {
                mobileMenuOverlay.onclick = closeMobileMenu;
            }
            if (mobileMenu) {
                const menuItems = mobileMenu.querySelectorAll('.mobile-menu-item:not(.mobile-menu-theme-toggle):not(.mobile-menu-settings-title)');
                menuItems.forEach(item => { item.onclick = closeMobileMenu; });
            }

            // Поиск по объектам (кнопка лупы в шапке) — инициализируем глобально, чтобы работало после PJAX
            if (searchToggle) {
                searchToggle.onclick = function(e) {
                    e.preventDefault();
                    const searchContainer = document.getElementById('searchContainer');
                    const objectSearch = document.getElementById('objectSearch');
                    if (!searchContainer) return; // страница без поиска
                    const isHidden = (searchContainer.style.display === 'none' || !searchContainer.style.display);
                    searchContainer.style.display = isHidden ? 'block' : 'none';
                    if (isHidden && objectSearch) {
                        setTimeout(() => objectSearch.focus(), 0);
                    }
                    if (!isHidden && objectSearch) {
                        objectSearch.value = '';
                        try {
                            const clearBtn = document.getElementById('clearSearch');
                            if (clearBtn) clearBtn.click();
                        } catch(_) {}
                    }
                };
            }
            // Резерв: делегирование клика по лупе на документ (на случай переинициализаций)
            document.addEventListener('click', function onSearchToggleClick(ev) {
                const a = ev.target && ev.target.closest && ev.target.closest('#searchToggle');
                if (!a) return;
                ev.preventDefault();
                const searchContainer = document.getElementById('searchContainer');
                const objectSearch = document.getElementById('objectSearch');
                if (!searchContainer) return;
                const isHidden = (searchContainer.style.display === 'none' || !searchContainer.style.display);
                searchContainer.style.display = isHidden ? 'block' : 'none';
                if (isHidden && objectSearch) {
                    setTimeout(() => objectSearch.focus(), 0);
                }
                if (!isHidden && objectSearch) {
                    objectSearch.value = '';
                    try {
                        const clearBtn = document.getElementById('clearSearch');
                        if (clearBtn) clearBtn.click();
                    } catch(_) {}
                }
            }, { passive: false });

            // Переключение темы с агрессивной защитой
            let isThemeChanging = false;
            let themeChangeTimeout = null;
            let lastClickTime = 0;

            function toggleTheme() {
                const now = Date.now();
                
                // Агрессивная защита от спама - блокируем клики чаще чем раз в 100мс
                if (now - lastClickTime < 100) {
                    return;
                }
                lastClickTime = now;
                
                // Множественная защита от спама
                if (isThemeChanging || !mobileThemeToggle || mobileThemeToggle.disabled) {
                    return;
                }
                
                // Немедленная блокировка
                isThemeChanging = true;
                mobileThemeToggle.disabled = true;
                mobileThemeToggle.style.pointerEvents = 'none';
                
                // Очищаем предыдущий таймаут если есть
                if (themeChangeTimeout) {
                    clearTimeout(themeChangeTimeout);
                }
                
                try {
                    const currentTheme = document.documentElement.getAttribute('data-bs-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    
                    // Применяем новую тему
                    document.documentElement.setAttribute('data-bs-theme', newTheme);
                    
                    // Сохраняем в localStorage с обработкой ошибок
                    try {
                        localStorage.setItem('theme', newTheme);
                    } catch (e) {
                        console.warn('Не удалось сохранить тему в localStorage:', e);
                    }
                    
                    // Обновляем иконку
                    updateThemeIcon(newTheme);
                    
                    // Добавляем анимацию
                    mobileThemeToggle.classList.add('active');
                    
                    // Устанавливаем таймаут для разблокировки (сохраняем скорость анимации)
                    themeChangeTimeout = setTimeout(() => {
                        mobileThemeToggle.classList.remove('active');
                        mobileThemeToggle.disabled = false;
                        mobileThemeToggle.style.pointerEvents = 'auto';
                        isThemeChanging = false;
                        themeChangeTimeout = null;
                    }, 300); // Возвращаем к оригинальной скорости анимации
                    
                } catch (e) {
                    console.error('Ошибка при переключении темы:', e);
                    // Принудительная разблокировка при ошибке
                    mobileThemeToggle.disabled = false;
                    mobileThemeToggle.style.pointerEvents = 'auto';
                    mobileThemeToggle.classList.remove('active');
                    isThemeChanging = false;
                    if (themeChangeTimeout) {
                        clearTimeout(themeChangeTimeout);
                        themeChangeTimeout = null;
                    }
                }
            }
            
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    mobileThemeIcon.innerHTML = '<path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>';
                } else {
                    mobileThemeIcon.innerHTML = '<path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>';
                }
            }
            
            // Инициализация темы с обработкой ошибок
            let savedTheme = 'light';
            try {
                savedTheme = localStorage.getItem('theme') || 'light';
            } catch (e) {
                console.warn('Не удалось прочитать тему из localStorage:', e);
            }
            
            // Убеждаемся, что тема валидна
            if (savedTheme !== 'dark' && savedTheme !== 'light') {
                savedTheme = 'light';
            }
            
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // Обработчик переключения темы с максимальной защитой
            if (mobileThemeToggle) {
                mobileThemeToggle.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleTheme();
                };
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация шапки после загрузки
            initMobileHeader();
            // Выставляем активную кнопку нижней навигации по текущему адресу
            try { updateActiveNav(); } catch(_) {}
            // Выставляем активный пункт в гамбургер-меню по текущему адресу
            try { updateActiveMenu(); } catch(_) {}
            // Строго фиксируем нижнюю панель: выставляем отступ контента по фактической высоте панели
            try {
                const mobileNav = document.querySelector('.mobile-nav');
                const mobileContent = document.querySelector('main.mobile-content');
                function applyBottomPadding() {
                    if (!mobileNav || !mobileContent) return;
                    const navRect = mobileNav.getBoundingClientRect();
                    const height = Math.max(80, navRect.height || 0);
                    mobileContent.style.paddingBottom = (height + 32) + 'px';
                }
                applyBottomPadding();
                window.addEventListener('resize', applyBottomPadding);
                window.addEventListener('orientationchange', applyBottomPadding);
            } catch(_) {}
            
            // Принудительное полноэкранное отображение
            try {
                // Скрываем адресную строку на iOS Safari
                if (window.navigator.standalone !== undefined) {
                    // PWA режим
                    document.body.style.height = '100vh';
                    document.body.style.height = '100dvh';
                } else {
                    // Обычный браузер - пытаемся скрыть UI
                    const hideUI = () => {
                        window.scrollTo(0, 1);
                        setTimeout(() => window.scrollTo(0, 0), 100);
                    };
                    hideUI();
                    window.addEventListener('orientationchange', hideUI);
                    window.addEventListener('resize', hideUI);
                }
                
                // Предотвращаем зум при двойном тапе
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                // Предотвращаем контекстное меню
                document.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                });
                
            } catch(_) {}
        });

        // Лёгкая PJAX-навигация: подменяем контент <main> без перезагрузки
        (function() {
            const mainEl = document.querySelector('main.mobile-content');
            if (!mainEl || !window.history || !window.fetch) return;

            async function navigate(url, push = true) {
                try {
                    const res = await fetch(url, { headers: { 'X-PJAX': 'true' } });
                    if (!res.ok) { window.location.href = url; return; }
                    const html = await res.text();
                    // Парсим только <main> содержимое
                    const tmp = document.createElement('div');
                    tmp.innerHTML = html;
                    const newMain = tmp.querySelector('main.mobile-content');
                    const newTitleEl = tmp.querySelector('h1.mobile-title');
                    const newHeaderContent = tmp.querySelector('.mobile-header .mobile-header-content');
                    const newTitle = tmp.querySelector('title');
                    if (newMain) {
                        mainEl.innerHTML = newMain.innerHTML;
                        // Полностью обновляем содержимое шапки (заголовок и кнопки)
                        const currentHeaderContent = document.querySelector('.mobile-header .mobile-header-content');
                        if (newHeaderContent && currentHeaderContent) {
                            currentHeaderContent.innerHTML = newHeaderContent.innerHTML;
                        } else if (newTitleEl) {
                            const currentTitleEl = document.querySelector('h1.mobile-title');
                            if (currentTitleEl) currentTitleEl.innerHTML = newTitleEl.innerHTML;
                        }
                        if (push) history.pushState({ url }, '', url);
                        if (newTitle) document.title = newTitle.textContent || document.title;
                        // Сбрасываем скролл и перезапускаем скрипты страницы, если есть inline в блоках
                        window.scrollTo(0, 0);
                        // Переинициализируем шапку после подмены
                        initMobileHeader();
                        // Обновляем активную кнопку нижней навигации и гамбургер-меню
                        try { updateActiveNav(); } catch(_) {}
                        try { updateActiveMenu(); } catch(_) {}
                    } else {
                        window.location.href = url; // fallback
                    }
                } catch (_) {
                    window.location.href = url;
                }
            }

            function shouldHandleLink(a) {
                if (!a) return false;
                const href = a.getAttribute('href') || '';
                if (a.target && a.target !== '_self') return false;
                if (href.startsWith('#') || href.startsWith('javascript:')) return false;
                // Внутренние ссылки
                return href.startsWith('/') && !a.hasAttribute('data-no-pjax');
            }

            document.addEventListener('click', (e) => {
                const a = e.target.closest('a[href]');
                if (!shouldHandleLink(a)) return;
                e.preventDefault();
                navigate(a.href, true);
            });

            window.addEventListener('popstate', (e) => {
                const url = (e.state && e.state.url) ? e.state.url : window.location.href;
                navigate(url, false);
            });
        })();

        // Обновление активной вкладки нижней навигации по текущему пути
        function updateActiveNav() {
            const currentPath = window.location.pathname || '/';
            const nav = document.querySelector('.mobile-nav');
            if (!nav) return;
            const links = Array.from(nav.querySelectorAll('a.mobile-nav-item'));
            if (!links.length) return;
            // Сбрасываем активные
            links.forEach(a => a.classList.remove('active'));
            // Ищем лучшее совпадение по префиксу пути
            let best = null;
            let bestLen = -1;
            links.forEach(a => {
                try {
                    const hrefPath = new URL(a.getAttribute('href'), window.location.origin).pathname || '/';
                    if (currentPath === hrefPath || currentPath.startsWith(hrefPath + (hrefPath.endsWith('/') ? '' : '/')) || (hrefPath !== '/' && currentPath.startsWith(hrefPath))) {
                        const len = hrefPath.length;
                        if (len > bestLen) { best = a; bestLen = len; }
                    }
                } catch(_) {}
            });
            // Если ничего не выбрали, пробуем подобрать по ключевым словам
            if (!best) {
                const fallbackMap = [
                    { test: /reports/, sel: 'a[href*="/reports"]' },
                    { test: /planned-works/, sel: 'a[href*="/planned-works"]' },
                    { test: /profile/, sel: 'a[href*="/profile"]' },
                    { test: /objects/, sel: 'a[href*="/objects"]' }
                ];
                for (const m of fallbackMap) {
                    if (m.test.test(currentPath)) { best = nav.querySelector(m.sel); break; }
                }
            }
            if (best) best.classList.add('active');
        }

        // Обновление активного пункта гамбургер-меню по текущему пути
        function updateActiveMenu() {
            const currentPath = window.location.pathname || '/';
            const menu = document.getElementById('mobileMenu');
            if (!menu) return;
            const links = Array.from(menu.querySelectorAll('a.mobile-menu-item'));
            if (!links.length) return;
            // Сброс активных
            links.forEach(a => a.classList.remove('active'));
            // Правила сопоставления путей
            const matchers = [
                { test: (p) => /^\/objects\/?$/.test(p), sel: 'a[href="/objects"], a[href="/objects/"]' },
                { test: (p) => p.startsWith('/reports'), sel: 'a[href^="/reports"]' },
                { test: (p) => /^\/objects\/planned-works-overview\/?$/.test(p), sel: 'a[href*="/planned-works-overview"]' },
                { test: (p) => /^\/objects\/all-planned-works\/?$/.test(p), sel: 'a[href*="/all-planned-works"]' },
                { test: (p) => p.startsWith('/admin/activity-log') || p.startsWith('/activity-log'), sel: 'a[href*="/activity-log"]' },
                { test: (p) => p.startsWith('/users'), sel: 'a[href^="/users"]' },
                { test: (p) => p.startsWith('/supply'), sel: 'a[href^="/supply"]' },
                { test: (p) => p.startsWith('/profile'), sel: 'a[href^="/profile"]' }
            ];
            for (const m of matchers) {
                if (m.test(currentPath)) {
                    const a = menu.querySelector(m.sel);
                    if (a) a.classList.add('active');
                    break;
                }
            }
        }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
