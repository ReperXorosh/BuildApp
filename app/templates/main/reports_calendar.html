{% extends "main/layout.html" %}
{% set active_page = 'reports' %}

{% block title %}Календарь отчётов{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top: 80px;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 mb-2">
                        <i class="bi bi-calendar3 me-2"></i>
                            Календарь отчётов
                        </h1>
                    <p class="text-muted mb-0">Выберите дату для просмотра отчётов по объектам</p>
                    </div>
                    <div>
                        <a href="{{ url_for('main.reports') }}" class="btn btn-outline-primary">
                        <i class="bi bi-building me-1"></i>
                            Список объектов
                        </a>
                    </div>
                </div>
            </div>
        </div>

<style>
    .cal-month,
    .cal-days,
    .cal-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        align-items: center;
    }

    .cal-month-name {
        grid-column-start: 2;
        grid-column-end: 7;
        text-align: center;
    }

    .cal-weekday,
    .cal-btn {
        display: flex;
        flex-shrink: 0;
        align-items: center;
        justify-content: center;
        height: 3rem;
        padding: 0;
    }

    .cal-btn:not([disabled]) {
        font-weight: 500;
        color: var(--bs-emphasis-color);
    }

    .cal-btn:hover,
    .cal-btn:focus {
        background-color: var(--bs-secondary-bg);
    }

    .cal-btn[disabled] {
        border: 0;
        opacity: .5;
    }

    .w-340px {
        width: 340px;
    }

    .cal-toolbar {
        display: grid;
        grid-template-columns:auto 1fr auto;
        align-items: center;
        gap: .5rem;
        margin-bottom: .5rem;
    }

    .cal-pickers {
        justify-self: center;
        display: inline-flex;
        gap: .5rem;
    }

    .cal-btn {
        width: 2.25rem;
        height: 2.25rem;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: .375rem;
    }

    .cal-btn i {
        font-size: 1rem;
        line-height: 1;
    }

    .cal-btn.is-today {
        background-color: var(--bs-primary-bg-subtle);
        color: var(--bs-primary-text-emphasis);
        box-shadow: inset 0 0 0 2px var(--bs-primary);
        font-weight: 700;
    }

    .cal-btn.has-reports {
        position: relative;
    }

    .cal-btn.has-reports::after {
        content: '';
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 6px;
        height: 6px;
        background-color: var(--bs-success);
        border-radius: 50%;
        border: 1px solid var(--bs-body-bg);
    }

    .cal-btn.is-today.has-reports::after {
        background-color: var(--bs-warning);
    }
</style>

<div class="d-flex flex-column flex-md-row p-4 gap-4 py-md-5 align-items-center justify-content-center">
    <div id="reports-data" data-dates="{{ objects_by_date.keys() | list | join(',') }}" class="d-none"></div>
    <div class="dropdown-menu d-block position-static p-2 mx-0 shadow rounded-3 w-340px">
        <div class="d-grid gap-1">
            <div class="cal">
                <div class="cal-toolbar">
                    <button class="btn cal-btn" type="button" id="cal-prev" aria-label="Предыдущий месяц">
                        <i class="bi bi-chevron-left"></i>
                    </button>

                    <div class="cal-pickers">
                        <select id="cal-month" class="form-select form-select-sm"></select>
                        <select id="cal-year" class="form-select form-select-sm"></select>
    </div>

                    <button class="btn cal-btn" type="button" id="cal-next" aria-label="Следующий месяц">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                            </div>
                <div class="cal-weekdays text-body-secondary">
                    <div class="cal-weekday">Пн</div>
                    <div class="cal-weekday">Вт</div>
                    <div class="cal-weekday">Ср</div>
                    <div class="cal-weekday">Чт</div>
                    <div class="cal-weekday">Пт</div>
                    <div class="cal-weekday">Сб</div>
                    <div class="cal-weekday">Вс</div>
                        </div>
                <div class="cal-days">
                    <!-- Дни будут генерироваться JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

<script>
(function () {
    const monthNames = [
        'Январь','Февраль','Март','Апрель','Май','Июнь',
        'Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'
    ];

    // DOM-узлы
    const root = document.querySelector('.cal');
    const monthSel = document.getElementById('cal-month');
    const yearSel = document.getElementById('cal-year');
    const daysBox = root.querySelector('.cal-days');
    const prevBtn = document.getElementById('cal-prev');
    const nextBtn = document.getElementById('cal-next');

    // Инициализация селектов
    const today = new Date();
    const currentYear = today.getFullYear();
    const yearFrom = 2024;
    const yearTo = currentYear + 2;

    monthNames.forEach((name, i) => {
        const o = document.createElement('option');
        o.value = i; o.textContent = name;
        monthSel.appendChild(o);
    });

    for (let y = yearFrom; y <= yearTo; y++) {
        const o = document.createElement('option');
        o.value = y; o.textContent = y;
        yearSel.appendChild(o);
    }

    // Текущее состояние
    let state = { m: today.getMonth(), y: today.getFullYear() };

    // Рендер месяца в .cal-days
    function render(m, y) {
        daysBox.innerHTML = '';

        // День недели 1-го числа (0=вс, 1=пн, ...)
        const firstWeekday = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        const daysInPrev = new Date(y, m, 0).getDate();

        // Сколько «хвостиков» предыдущего месяца показать слева
        const leading = firstWeekday === 0 ? 6 : firstWeekday - 1; // Понедельник = 0
        const frag = document.createDocumentFragment();

        // Предыдущий месяц (disabled)
        for (let i = leading - 1; i >= 0; i--) {
            const b = makeDayButton(daysInPrev - i, true);
            frag.appendChild(b);
        }
        // Текущий месяц
        for (let d = 1; d <= daysInMonth; d++) {
            const b = makeDayButton(d, false);
            frag.appendChild(b);
        }
        // Хвост следующего месяца
        const total = leading + daysInMonth;
        const trailing = (Math.ceil(total / 7) * 7) - total;
        for (let d = 1; d <= trailing; d++) {
            const b = makeDayButton(d, true);
            frag.appendChild(b);
        }

        daysBox.appendChild(frag);

        // Выставляем селекты
        monthSel.value = m;
        yearSel.value = y;
    }

    function makeDayButton(text, disabled) {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'btn cal-btn';
        if (disabled) {
            b.setAttribute('disabled', '');
        } else {
            // Добавляем обработчик клика для активных дней
            b.addEventListener('click', function() {
                const day = parseInt(text);
                const month = state.m + 1; // JavaScript месяцы начинаются с 0
                const year = state.y;
                
                // Форматируем дату как YYYY-MM-DD
                const dateStr = year + '-' + month.toString().padStart(2, '0') + '-' + day.toString().padStart(2, '0');
                
                // Переходим на страницу с отчётами по этой дате
                window.location.href = '/reports/date/' + dateStr;
            });
            
            // Проверяем, является ли это сегодняшним днем
            const today = new Date();
            if (state.m === today.getMonth() && state.y === today.getFullYear() && parseInt(text) === today.getDate()) {
                b.classList.add('is-today');
            }
            
            // Проверяем, есть ли отчёты в этот день
            const day = parseInt(text);
            const month = state.m;
            const year = state.y;
            const dateStr = year + '-' + (month + 1).toString().padStart(2, '0') + '-' + day.toString().padStart(2, '0');
            
            const dataEl = document.getElementById('reports-data');
            const csv = dataEl ? (dataEl.getAttribute('data-dates') || '') : '';
            const reportsDates = csv ? csv.split(',') : [];
            if (reportsDates.includes(dateStr)) {
                b.classList.add('has-reports');
                b.title = 'Есть отчёты в этот день';
            }
        }
        b.textContent = text;
        return b;
    }

    // Обработчики
    monthSel.addEventListener('change', function() {
        state.m = parseInt(monthSel.value);
        render(state.m, state.y);
    });
    yearSel.addEventListener('change', function() {
        state.y = parseInt(yearSel.value);
        render(state.m, state.y);
    });
    prevBtn.addEventListener('click', function() {
        state.m--;
        if (state.m < 0) { state.m = 11; state.y--; }
        render(state.m, state.y);
    });
    nextBtn.addEventListener('click', function() {
        state.m++;
        if (state.m > 11) { state.m = 0; state.y++; }
        render(state.m, state.y);
    });

    // Первый рендер
    render(state.m, state.y);
})();
</script>

{% endblock %}
