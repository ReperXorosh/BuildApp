{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'reports' %}

{% block title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—á—ë—Ç–æ–≤{% endblock %}
{% block mobile_title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—á—ë—Ç–æ–≤{% endblock %}

{% block content %}
<div class="mobile-mb-3">
    <h2 class="mobile-card-title mobile-text-center">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—á—ë—Ç–æ–≤</h2>
    <p class="mobile-text-muted mobile-text-center">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç—á—ë—Ç–æ–≤</p>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º -->
<div class="mobile-card">
    <div class="mobile-card-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
    <div class="row text-center">
        <div class="col-4">
            <button class="mobile-btn mobile-btn-outline" onclick="changeMonth(-1)">
                <i class="bi bi-chevron-left me-1"></i>
                –ü—Ä–µ–¥—ã–¥—É—â–∏–π
            </button>
        </div>
        <div class="col-4">
            <div class="mobile-card-text">
                <strong>{{ current_month|month_name }} {{ current_year }}</strong>
            </div>
        </div>
        <div class="col-4">
            <button class="mobile-btn mobile-btn-outline" onclick="changeMonth(1)">
                –°–ª–µ–¥—É—é—â–∏–π
                <i class="bi bi-chevron-right ms-1"></i>
            </button>
        </div>
    </div>
</div>

<!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
<div class="mobile-card">
    <div class="mobile-card-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
    <div id="reports-data" data-dates="{{ objects_by_date.keys() | list | join(',') }}" class="d-none"></div>
    
    <!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
    <div class="row text-center mobile-mb-2">
        <div class="col"><small class="text-muted">–ü–Ω</small></div>
        <div class="col"><small class="text-muted">–í—Ç</small></div>
        <div class="col"><small class="text-muted">–°—Ä</small></div>
        <div class="col"><small class="text-muted">–ß—Ç</small></div>
        <div class="col"><small class="text-muted">–ü—Ç</small></div>
        <div class="col"><small class="text-muted">–°–±</small></div>
        <div class="col"><small class="text-muted">–í—Å</small></div>
    </div>
    
    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è —Å–µ—Ç–∫–∞ -->
    <div id="calendar-grid">
        <!-- –î–Ω–∏ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è JavaScript -->
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ –æ—Ç—á—ë—Ç–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É -->
<div id="selected-date-reports" class="mobile-card" style="display: none;">
    <div class="mobile-card-title">–û—Ç—á—ë—Ç—ã –∑–∞ <span id="selected-date-text"></span></div>
    <div id="reports-list">
        <!-- –û—Ç—á—ë—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="mobile-mt-3">
    <div class="mobile-card">
        <div class="mobile-card-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
        <div class="mobile-mt-2">
            <button class="mobile-btn mobile-btn-outline" onclick="window.location.href='{{ url_for('main.reports') }}'">
                <i class="bi bi-building me-2"></i>
                –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤
            </button>
        </div>
    </div>
</div>

<script>
(function () {
    const monthNames = [
        '–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å',
        '–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'
    ];

    // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    let state = { 
        m: {{ current_month - 1 }}, 
        y: {{ current_year }} 
    };

    // –†–µ–Ω–¥–µ—Ä –º–µ—Å—è—Ü–∞
    function render(m, y) {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ 1-–≥–æ —á–∏—Å–ª–∞ (0=–≤—Å, 1=–ø–Ω, ...)
        const firstWeekday = new Date(y, m, 1).getDay();
        const daysInMonth = new Date(y, m + 1, 0).getDate();
        const daysInPrev = new Date(y, m, 0).getDate();

        // –°–∫–æ–ª—å–∫–æ ¬´—Ö–≤–æ—Å—Ç–∏–∫–æ–≤¬ª –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–≤–∞
        const leading = firstWeekday === 0 ? 6 : firstWeekday - 1; // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0
        const frag = document.createDocumentFragment();

        // –ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü (disabled)
        for (let i = leading - 1; i >= 0; i--) {
            const day = makeDayElement(daysInPrev - i, true);
            frag.appendChild(day);
        }
        
        // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        for (let d = 1; d <= daysInMonth; d++) {
            const day = makeDayElement(d, false);
            frag.appendChild(day);
        }
        
        // –•–≤–æ—Å—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const total = leading + daysInMonth;
        const trailing = (Math.ceil(total / 7) * 7) - total;
        for (let d = 1; d <= trailing; d++) {
            const day = makeDayElement(d, true);
            frag.appendChild(day);
        }

        grid.appendChild(frag);
    }

    function makeDayElement(text, disabled) {
        const day = document.createElement('div');
        day.className = 'col text-center p-2';
        
        if (disabled) {
            day.innerHTML = `<small class="text-muted">${text}</small>`;
        } else {
            const dayNum = parseInt(text);
            const month = state.m + 1;
            const year = state.y;
            const dateStr = year + '-' + month.toString().padStart(2, '0') + '-' + dayNum.toString().padStart(2, '0');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—Ç—á—ë—Ç—ã –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
            const dataEl = document.getElementById('reports-data');
            const csv = dataEl ? (dataEl.getAttribute('data-dates') || '') : '';
            const reportsDates = csv ? csv.split(',') : [];
            const hasReports = reportsDates.includes(dateStr);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º –¥–Ω–µ–º
            const today = new Date();
            const isToday = state.m === today.getMonth() && state.y === today.getFullYear() && dayNum === today.getDate();
            
            let dayClass = 'btn btn-sm w-100';
            if (isToday) {
                dayClass += ' btn-primary';
            } else if (hasReports) {
                dayClass += ' btn-success';
            } else {
                dayClass += ' btn-outline-secondary';
            }
            
            day.innerHTML = `
                <button class="${dayClass}" onclick="selectDate('${dateStr}', ${dayNum})">
                    ${text}
                    ${hasReports ? '<br><small>üìä</small>' : ''}
                </button>
            `;
        }
        
        return day;
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
    window.selectDate = function(dateStr, dayNum) {
        const selectedDateText = document.getElementById('selected-date-text');
        const selectedDateReports = document.getElementById('selected-date-reports');
        const reportsList = document.getElementById('reports-list');
        
        selectedDateText.textContent = dayNum + ' ' + monthNames[state.m] + ' ' + state.y;
        selectedDateReports.style.display = 'block';
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –æ—Ç—á—ë—Ç–∞–º–∏ –ø–æ —ç—Ç–æ–π –¥–∞—Ç–µ
        window.location.href = '/reports/date/' + dateStr;
    };

    // –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ—Å—è—Ü–∞
    window.changeMonth = function(delta) {
        state.m += delta;
        if (state.m < 0) { 
            state.m = 11; 
            state.y--; 
        } else if (state.m > 11) { 
            state.m = 0; 
            state.y++; 
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º URL
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('year', state.y);
        newUrl.searchParams.set('month', state.m + 1);
        window.location.href = newUrl.toString();
    };

    // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
    render(state.m, state.y);
})();
</script>
{% endblock %}
