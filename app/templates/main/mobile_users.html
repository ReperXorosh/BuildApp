{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'users' %}

{% block title %}Пользователи{% endblock %}

{% block mobile_title %}
    <i class="bi bi-people me-2"></i>
    Пользователи
{% endblock %}

{% block mobile_header_actions %}
    {% if current_user.role == 'Инженер ПТО' %}
    <a href="{{ url_for('main.add_user') }}" class="mobile-header-btn">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
    </a>
    {% endif %}
{% endblock %}

{% block content %}
<div class="mobile-content">
    <!-- Поисковая панель -->
    <div class="mobile-card users-card p-2" style="margin-bottom:8px;">
        <form method="GET" action="{{ url_for('main.users') }}" class="m-0">
            <div class="input-group">
                <input type="text" class="form-control" id="search" name="search" value="{{ search_query or '' }}" placeholder="Поиск: логин, имя, фамилия">
                {% if search_query %}
                <a class="btn btn-outline-secondary" href="{{ url_for('main.users') }}">Сброс</a>
                {% endif %}
                <button type="submit" class="btn btn-primary">Найти</button>
            </div>
            <div class="mt-2">
                <select id="roleFilter" class="form-select">
                    <option value="">Все роли</option>
                    <option>Ген. директор</option>
                    <option>Зам. директор</option>
                    <option>Инженер ПТО</option>
                    <option>Снабженец</option>
                    <option>Сотрудник</option>
                </select>
            </div>
        </form>
    </div>

    {% if search_query %}
    <div class="alert alert-info mb-2" style="border-radius:12px;">
        Найдено {{ users|length }} пользователей по запросу "{{ search_query }}"
    </div>
    {% endif %}

    <!-- Список пользователей как компактные карточки -->
    <div class="mobile-card users-card p-2" style="margin-bottom:8px;">
        {% if users %}
        <div id="usersList" style="border:none; margin:0; padding:0;">
            {% for user in users %}
            <a href="{{ url_for('main.view_user_profile', user_id=user.userid) }}" class="users-item d-flex align-items-center" data-role="{{ user.role }}">
                <div class="users-avatar">
                    {% if user.avatar %}
                        <img src="{{ url_for('static', filename='uploads/avatars/' ~ user.avatar) }}" alt="Аватар">
                    {% else %}
                        <img src="{{ url_for('static', filename='img/default-avatar.png') }}" alt="Аватар">
                    {% endif %}
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2">
                        <div class="fw-semibold text-truncate">{{ user.login }}</div>
                        {% if user.userid == current_user.userid %}
                            <span class="badge bg-primary">Вы</span>
                        {% endif %}
                    </div>
                    <div class="text-muted small text-truncate">
                        {% if user.secondname or user.firstname %}
                            {{ (user.secondname or '') + ' ' + (user.firstname or '') + ' ' + (user.thirdname or '') }}
                        {% else %}
                            ФИО не указано
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <span class="badge bg-{{ 'success' if user.role == 'Ген. директор' else 'warning' if user.role == 'Зам. директор' else 'info' if user.role == 'Инженер ПТО' else 'secondary' }}">{{ user.role }}</span>
                        <small class="text-muted">{{ user.registration_date | moscow_date }}</small>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
            <h5 class="text-muted mt-3">Пользователи не найдены</h5>
            {% if search_query %}
                <p class="text-muted">Попробуйте изменить поисковый запрос</p>
            {% else %}
                <p class="text-muted">В системе пока нет пользователей</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleFilter = document.getElementById('roleFilter');
    const usersList = document.getElementById('usersList');
    if (roleFilter && usersList) {
        roleFilter.addEventListener('change', function() {
            const val = this.value.trim();
            usersList.querySelectorAll('.list-group-item').forEach(item => {
                const role = (item.getAttribute('data-role') || '').trim();
                item.style.display = (!val || role === val) ? '' : 'none';
            });
        });
    }
});
</script>
<style>
.users-card{ border:1px solid var(--bs-border-color); border-radius:12px; }
.users-item{ border:1px solid var(--bs-border-color); border-radius:12px; margin-bottom:6px; padding:10px; text-decoration:none; overflow:hidden; gap:10px; }
.users-avatar{ width:36px; height:36px; border-radius:50%; overflow:hidden; flex:0 0 36px; margin-right:8px; }
.users-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
.input-group>.form-control{ border-top-left-radius:10px; border-bottom-left-radius:10px; }
.input-group .btn{ min-height:40px; }
.form-select{ min-height:40px; }
</style>
{% endblock %}
