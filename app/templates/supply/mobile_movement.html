{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'supply' %}

{% block title %}Перемещение материалов{% endblock %}
{% block mobile_title %}Новое перемещение{% endblock %}

{% block content %}
<div class="mobile-card add-object-card">
    <div class="mobile-card-title text-center">
        Перемещение материалов
    </div>

    <form id="form-movement" enctype="multipart/form-data" novalidate>
        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="movement_type">Тип операции *</label>
            <select name="movement_type" id="movement_type" class="mobile-form-control mobile-form-control-lg" required onchange="onMovementTypeChange()">
                <option value="">Выберите тип операции</option>
                <option value="move">Выдача</option>
                <option value="return">Возврат</option>
                <option value="writeoff">Списание</option>
            </select>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="material_id">Материал *</label>
            <select name="material_id" id="material_id" class="mobile-form-control mobile-form-control-lg" required onchange="onMaterialChange()">
                <option value="">Сначала выберите тип операции</option>
            </select>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="movement_quantity">Количество *</label>
            <div class="quantity-input-group">
                <input type="number" 
                       name="quantity" 
                       id="movement_quantity" 
                       step="0.01" 
                       min="0" 
                       class="mobile-form-control mobile-form-control-lg" 
                       placeholder="0.00"
                       required>
                <span class="quantity-unit" id="movement_unit">шт</span>
            </div>
            <div class="quantity-info">
                <small class="text-muted">Доступно: <span id="available_quantity" class="text-primary fw-bold">0</span></small>
                <small class="text-warning" id="quantity_warning" style="display: none;">Количество ограничено доступным</small>
            </div>
        </div>

        <div class="mobile-form-group" id="user-selection-container" style="border:none; background:transparent; padding-left:0; padding-right:0; display: none;">
            <label class="mobile-form-label" id="user-label">Пользователь</label>
            <select name="to_user_id" id="to_user_id" class="mobile-form-control mobile-form-control-lg">
                <option value="">Выберите пользователя...</option>
            </select>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="note">Примечание</label>
            <textarea name="note" id="note" class="mobile-form-control" rows="3" placeholder="Дополнительная информация о движении"></textarea>
        </div>

        <div class="mobile-form-group mobile-form-group-files">
            <label class="mobile-form-label" for="movement-file">Вложение (файл) *</label>
            <input type="file" 
                   name="file" 
                   id="movement-file" 
                   class="mobile-form-control mobile-form-control-file"
                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                   required>
            <div class="form-text">
                Прикрепите документ к движению (обязательно)
            </div>
        </div>

        <div class="mobile-mt-4">
            <button type="submit" class="mobile-btn mobile-btn-primary w-100" id="submit-btn">
                Сохранить перемещение
            </button>
        </div>
    </form>
</div>

<script>
// Глобальные переменные
let materials = [];
let users = [];

// Загрузка материалов для движения
async function loadMaterialsForMovement() {
    try {
        const response = await fetch('{{ url_for("supply.api_materials") }}');
        if (response.ok) {
            materials = await response.json();
        }
    } catch (error) {
        console.error('Ошибка загрузки материалов:', error);
    }
}

// Загрузка пользователей
async function loadUsers() {
    try {
        const response = await fetch('{{ url_for("supply.api_get_all_users") }}');
        if (response.ok) {
            users = await response.json();
        }
    } catch (error) {
        console.error('Ошибка загрузки пользователей:', error);
    }
}

// Обработка изменения типа операции
function onMovementTypeChange() {
    const movementType = document.getElementById('movement_type').value;
    const materialSelect = document.getElementById('material_id');
    const userContainer = document.getElementById('user-selection-container');
    const userLabel = document.getElementById('user-label');
    const fileLabel = document.getElementById('file-label');
    const fileHelp = document.getElementById('file-help');

    // Очищаем выбор материала
    materialSelect.innerHTML = '<option value="">Сначала выберите тип операции</option>';

    if (movementType === 'move') {
        // Выдача - показываем пользователей
        userContainer.style.display = 'block';
        userLabel.textContent = 'Получатель *';
        fileLabel.textContent = 'Документ выдачи (файл) *';
        fileHelp.textContent = 'Прикрепите документ о выдаче (обязательно)';
        
        // Загружаем пользователей
        loadUsers().then(() => {
            const userSelect = document.getElementById('to_user_id');
            userSelect.innerHTML = '<option value="">Выберите получателя...</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userSelect.appendChild(option);
            });
        });
    } else if (movementType === 'return') {
        // Возврат - показываем пользователей
        userContainer.style.display = 'block';
        userLabel.textContent = 'Возвращающий *';
        fileLabel.textContent = 'Документ возврата (файл) *';
        fileHelp.textContent = 'Прикрепите документ о возврате (обязательно)';
        
        // Загружаем пользователей
        loadUsers().then(() => {
            const userSelect = document.getElementById('to_user_id');
            userSelect.innerHTML = '<option value="">Выберите возвращающего...</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userSelect.appendChild(option);
            });
        });
    } else if (movementType === 'writeoff') {
        // Списание - скрываем пользователей
        userContainer.style.display = 'none';
        fileLabel.textContent = 'Документ списания (файл) *';
        fileHelp.textContent = 'Прикрепите документ о списании (обязательно)';
    }

    // Загружаем материалы в зависимости от типа операции
    if (movementType) {
        loadMaterialsForMovement().then(() => {
            materialSelect.innerHTML = '<option value="">Выберите материал...</option>';
            materials.forEach(material => {
                const option = document.createElement('option');
                option.value = material.id;
                option.textContent = `${material.name} (${material.current_quantity} ${material.unit})`;
                option.dataset.quantity = material.current_quantity;
                option.dataset.unit = material.unit;
                materialSelect.appendChild(option);
            });
        });
    }
}

// Обработка изменения материала
function onMaterialChange() {
    const materialSelect = document.getElementById('material_id');
    const selectedOption = materialSelect.options[materialSelect.selectedIndex];
    const quantityInput = document.getElementById('movement_quantity');
    const unitSpan = document.getElementById('movement_unit');
    const availableSpan = document.getElementById('available_quantity');
    const warningSpan = document.getElementById('quantity_warning');

    if (selectedOption.value) {
        const availableQuantity = parseFloat(selectedOption.dataset.quantity);
        const unit = selectedOption.dataset.unit;
        
        unitSpan.textContent = unit;
        availableSpan.textContent = availableQuantity;
        
        // Устанавливаем максимальное значение
        quantityInput.max = availableQuantity;
        
        // Показываем предупреждение если количество большое
        if (availableQuantity < 10) {
            warningSpan.style.display = 'block';
        } else {
            warningSpan.style.display = 'none';
        }
    } else {
        unitSpan.textContent = 'шт';
        availableSpan.textContent = '0';
        quantityInput.max = '';
        warningSpan.style.display = 'none';
    }
}

// Отправка формы перемещения
async function submitMovement() {
    const form = document.getElementById('form-movement');
    const formData = new FormData(form);
    const submitBtn = document.getElementById('submit-btn');

    // Валидация формы
    if (!validateMovementForm()) {
        return;
    }

    submitBtn.disabled = true;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Отправка...';

    try {
        const response = await fetch('{{ url_for("supply.api_create_movement") }}', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert('Перемещение успешно проведено');
            window.location.href = '{{ url_for("supply.mobile_warehouse_view") }}';
        } else {
            const error = await response.json();
            alert('Ошибка проведения перемещения: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка проведения перемещения');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Валидация формы
function validateMovementForm() {
    const movementType = document.getElementById('movement_type').value;
    const materialId = document.getElementById('material_id').value;
    const quantity = parseFloat(document.getElementById('movement_quantity').value);
    const file = document.getElementById('movement-file').files[0];
    const userContainer = document.getElementById('user-selection-container');
    const toUserId = document.getElementById('to_user_id').value;

    if (!movementType) {
        alert('Выберите тип операции');
        return false;
    }

    if (!materialId) {
        alert('Выберите материал');
        return false;
    }

    if (!quantity || quantity <= 0) {
        alert('Введите корректное количество');
        return false;
    }

    if (userContainer.style.display !== 'none' && !toUserId) {
        alert('Выберите пользователя');
        return false;
    }

    if (!file) {
        alert('Прикрепите файл');
        return false;
    }

    // Проверка доступного количества
    const selectedOption = document.getElementById('material_id').options[document.getElementById('material_id').selectedIndex];
    const availableQuantity = parseFloat(selectedOption.dataset.quantity);
    
    if (quantity > availableQuantity) {
        alert(`Количество не может превышать доступное (${availableQuantity})`);
        return false;
    }

    return true;
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-movement');
    const submitBtn = document.getElementById('submit-btn');
    const movementTypeSelect = document.getElementById('movement_type');
    const backBtn = document.getElementById('mobileBackBtn');
    let isDirty = false;

    // На этой странице уменьшаем нижний отступ контента, чтобы не было лишней прокрутки
    try {
        const mobileContent = document.querySelector('.mobile-content');
        if (mobileContent) {
            mobileContent.style.paddingBottom = '16px';
            mobileContent.style.overflow = 'hidden';
            mobileContent.style.height = 'auto';
        }
        // Отключаем прокрутку страницы
        document.documentElement.style.overscrollBehaviorY = 'contain';
        document.body.style.overflow = 'hidden';
        window.scrollTo(0, 0);
    } catch(e) {}

    // Фокус на первом поле
    if (movementTypeSelect) movementTypeSelect.focus();

    // Тримминг пробелов
    const trimField = (el) => {
        if (!el) return;
        el.value = el.value.trim().replace(/\s{2,}/g, ' ');
    };

    // Помечаем форму как изменённую при вводе в любые поля
    const allInputs = [movementTypeSelect, document.getElementById('material_id'), document.getElementById('movement_quantity'), document.getElementById('user_id'), document.getElementById('movement_note'), document.getElementById('movement_file')];
    allInputs.forEach(el => {
        if (!el) return;
        el.addEventListener('input', () => { isDirty = true; });
        el.addEventListener('change', () => { isDirty = true; });
        if (el.type === 'text' || el.tagName === 'TEXTAREA') {
            el.addEventListener('blur', () => trimField(el));
        }
    });

    // Обработчик «Назад» с предупреждением
    function confirmLeaveIfDirty(action){
        if (!isDirty) { action(); return; }
        if (confirm('Данные не будут сохранены. Вернуться на предыдущую страницу?')) {
            action();
        }
    }

    if (backBtn) {
        backBtn.onclick = function(e){
            e.preventDefault();
            confirmLeaveIfDirty(() => { window.history.back(); });
        };
    }

    // Обработчик отправки формы
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Тримминг полей
        allInputs.forEach(el => {
            if (el.type === 'text' || el.tagName === 'TEXTAREA') {
                trimField(el);
            }
        });

        if (!validateMovementForm()) {
            return false;
        }

        // Индикатор отправки
        submitBtn.disabled = true;
        const original = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Сохранение...';
        isDirty = false; // считаем, что уходим со страницы по сохранению

        submitMovement().finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = original;
        });
    });
});
</script>

<style>
/* Локальные правки для лучшей читаемости в светлой теме только на этой странице */
.mobile-app { background: var(--bs-body-bg); }
[data-bs-theme="light"] .add-object-card { background:#fff; color:#0f172a; }
[data-bs-theme="light"] .mobile-form-label { color:#111827; }
[data-bs-theme="light"] .mobile-form-control, [data-bs-theme="light"] .mobile-form-control-lg { background:#fff; border-color:#d1d5db; color:#111827; }
[data-bs-theme="light"] .mobile-card-title { color:#0f172a; }

.add-object-card{ background:#fff; border:1px solid #e5e7eb; box-shadow:0 6px 18px rgba(0,0,0,.06); padding:12px; }
.add-object-card .mobile-form-group{ background:#f9fafb; border:1px solid #eef2f7; border-radius:12px; padding:10px; }
.add-object-card .mobile-form-group + .mobile-form-group{ margin-top:8px; }
.mobile-card-title{ font-size:1.5rem; font-weight:700; margin-bottom:.75rem; color:#111827; letter-spacing:-.025em; }
.mobile-form-label{ display:block; font-size:.9rem; font-weight:600; color:#374151; margin-bottom:6px; letter-spacing:.025em; }
.mobile-form-control-lg{ font-size:1.02rem; padding:10px 14px; border-radius:12px; border:2px solid #e1e5e9; background:#fff; color:#111827; transition:all .3s cubic-bezier(.4,0,.2,1); box-shadow:0 2px 4px rgba(0,0,0,.04); font-weight:500; }
.mobile-form-control{ font-size:.93rem; padding:8px 12px; border-radius:12px; border:2px solid #e1e5e9; background:#fff; color:#111827; transition:all .3s cubic-bezier(.4,0,.2,1); box-shadow:0 2px 4px rgba(0,0,0,.04); font-weight:500; }
.mobile-form-control:focus, .mobile-form-control-lg:focus{ border-color:#0d6efd; box-shadow:0 0 0 4px rgba(13,110,253,.1), 0 4px 12px rgba(0,0,0,.1); outline:none; transform:translateY(-1px); }
.mobile-btn{ border-radius:12px; font-weight:600; padding:10px 18px; font-size:.93rem; transition:all .3s cubic-bezier(.4,0,.2,1); letter-spacing:.025em; border:none; position:relative; overflow:hidden; }
.mobile-btn-primary{ background:linear-gradient(135deg,#0d6efd 0%,#0056b3 100%); color:#fff; box-shadow:0 4px 14px rgba(13,110,253,.3); }

/* Стили для файлового поля */
.mobile-form-control-file{ font-size:.93rem; padding:8px 12px; border-radius:12px; border:2px solid #e1e5e9; background:#fff; color:#111827; transition:all .3s cubic-bezier(.4,0,.2,1); box-shadow:0 2px 4px rgba(0,0,0,.04); font-weight:500; }
.mobile-form-control-file:focus{ border-color:#0d6efd; box-shadow:0 0 0 4px rgba(13,110,253,.1), 0 4px 12px rgba(0,0,0,.1); outline:none; transform:translateY(-1px); }
.mobile-form-control-file::-webkit-file-upload-button{ background:var(--bs-primary); color:white; border:none; padding:6px 12px; border-radius:6px; margin-right:8px; font-weight:500; cursor:pointer; transition:background-color .2s ease; }

/* Исправление для файлового поля - предотвращение выхода за пределы */
.mobile-form-control[type="file"],
.mobile-form-control-file {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 8px 12px;
}

/* Специальные стили для группы с файлами */
.mobile-form-group-files {
    margin-bottom: 16px;
}

/* Дополнительные исправления для мобильных устройств */
@media (max-width: 768px) {
    .mobile-form-control-file {
        font-size: 14px;
        padding: 10px 12px;
    }
    
    .mobile-form-group-files {
        margin-bottom: 16px;
    }
}

@media (prefers-color-scheme: dark){
  .add-object-card{ background: var(--bs-body-bg); border-color:#2d3748; box-shadow:0 6px 18px rgba(0,0,0,.2); }
  .add-object-card .mobile-form-group{ background:#1f2937; border-color:#374151; }
  .mobile-form-label{ color:#e5e7eb; }
  .mobile-card-title{ color:#f9fafb; }
  .mobile-form-control-lg, .mobile-form-control, .mobile-form-control-file{ background:#1f2937; border-color:#374151; color:#f9fafb; box-shadow:0 2px 4px rgba(0,0,0,.2); }
  .mobile-form-control:focus, .mobile-form-control-lg:focus, .mobile-form-control-file:focus{ border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.2), 0 4px 12px rgba(0,0,0,.3); }
}

/* Специальные стили для группы количества */
.quantity-input-group {
    position: relative;
    display: flex;
    align-items: center;
}

.quantity-input-group .mobile-form-control {
    padding-right: 60px;
}

.quantity-unit {
    position: absolute;
    right: 12px;
    color: var(--bs-secondary);
    font-weight: 500;
    font-size: 0.875rem;
    pointer-events: none;
}

.quantity-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

/* Темная тема */
[data-bs-theme="dark"] .mobile-form-control {
    color: var(--bs-body-color);
    background-color: var(--bs-body-bg);
    border-color: var(--bs-border-color);
}

[data-bs-theme="dark"] .mobile-form-control:focus {
    color: var(--bs-body-color);
    background-color: var(--bs-body-bg);
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

[data-bs-theme="dark"] .mobile-form-control-file {
    color: var(--bs-body-color);
    background-color: var(--bs-body-bg);
    border-color: var(--bs-border-color);
}

[data-bs-theme="dark"] .quantity-unit {
    color: var(--bs-secondary);
}
</style>
{% endblock %}
