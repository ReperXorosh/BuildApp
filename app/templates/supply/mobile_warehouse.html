{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'supply' %}

{% block title %}Склад{% endblock %}
{% block mobile_title %}Склад{% endblock %}

{% block content %}
<!-- Собственное затемнение для модальных окон -->
<div class="custom-modal-backdrop" id="customBackdrop"></div>

<!-- Статистика склада -->
<div class="mobile-card">
    <div class="mobile-card-title">Статистика склада</div>
    <div class="row g-2">
        <div class="col-6">
            <div class="mobile-card-text">
                <strong>{{ materials_count or 0 }}</strong><br>
                <small class="text-muted">Позиций</small>
            </div>
        </div>
        <div class="col-6">
            <div class="mobile-card-text">
                <strong>{{ low_stock_count or 0 }}</strong><br>
                <small class="text-muted">Низкий запас</small>
            </div>
        </div>
    </div>
</div>

<!-- Действия -->
<div class="mobile-card">
    <div class="mobile-card-title">Действия</div>
    <div class="mobile-sections">
        <a href="{{ url_for('supply.mobile_warehouse_add_material') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Добавить позицию
        </a>
        <a href="{{ url_for('supply.mobile_warehouse_receipt') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                <path d="M2 17L12 22L22 17"/>
                <path d="M2 12L12 17L22 12"/>
            </svg>
            Поступление
        </a>
        <a href="{{ url_for('supply.mobile_warehouse_movement') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 17L4 21L0 17"/>
                <path d="M4 21V9"/>
                <path d="M16 7L20 3L24 7"/>
                <path d="M20 3V15"/>
            </svg>
            Перемещение
        </a>
        <a href="{{ url_for('supply.mobile_warehouse_materials') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
            </svg>
            Просмотр материалов
        </a>
        <a href="{{ url_for('supply.mobile_warehouse_movements') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
            </svg>
            История движений
        </a>
        <a href="{{ url_for('supply.mobile_warehouse_allocations') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
                <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
            </svg>
            Распределение
        </a>
    </div>
</div>

{% if low_stock_materials %}
<!-- Материалы с низким запасом -->
<div class="mobile-card">
    <div class="mobile-card-title">⚠️ Низкий запас</div>
    {% for material in low_stock_materials[:3] %}
    <div class="mobile-card-text mobile-mb-1">
        <strong>{{ material.name }}</strong><br>
        <small class="text-muted">Остаток: {{ material.current_quantity }} / {{ material.min_quantity }} {{ material.unit }}</small>
    </div>
    {% endfor %}
    {% if low_stock_materials|length > 3 %}
    <div class="mobile-card-text mobile-mb-1">
        <small class="text-muted">И еще {{ low_stock_materials|length - 3 }} позиций</small>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Модальное окно для поступления -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">Поступление на склад</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-receipt">
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Наименование</label>
                            <input class="form-control" name="name" id="receipt-name-input" required>
                            <div id="receipt-exists-info" class="form-text text-info" style="display: none;">
                                <i class="bi bi-info-circle"></i> Материал уже существует на складе
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Ед. изм.</label>
                            <input class="form-control" name="unit" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Накладная (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted">Прикрепите накладную к поступлению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitReceipt()">Провести поступление</button>
            </div>
        </div>
    </div>
</div>


<!-- Дополнительный отступ для нижней панели -->
<div style="height: 140px"></div>

<style>
/* Исправление расположения кнопок в разделе "Действия" */
.mobile-sections {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.mobile-sections .mobile-btn {
    margin-bottom: 0;
}

/* АГРЕССИВНОЕ УБИРАНИЕ ВСЕХ ЗАЗОРОВ ПОД ФАЙЛОВЫМ ПОЛЕМ */
#receiptModal .file-input-container {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
    margin-top: 0 !important;
    padding-top: 0 !important;
}

#receiptModal .file-input-no-gap {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
    margin-top: 0 !important;
    padding-top: 0 !important;
    border-bottom: none !important;
    box-shadow: none !important;
}

#receiptModal .file-text-no-gap {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    line-height: 1.2 !important;
    font-size: 0.8rem !important;
}

/* Убираем ТОЛЬКО зазор под файловым полем */
#receiptModal .file-input-container {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}

#receiptModal .file-input-no-gap {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}

#receiptModal .file-text-no-gap {
    margin-top: 4px !important;
    margin-bottom: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    line-height: 1.3 !important;
}

/* Улучшаем кнопку "Выбрать файл" */
#receiptModal .file-input-no-gap {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
    margin-top: 0 !important;
    padding-top: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    height: 48px !important;
    min-height: 48px !important;
    padding: 12px 16px !important;
    font-size: 16px !important;
    line-height: 1.5 !important;
    background: transparent !important;
    color: #495057 !important;
    transition: all 0.2s ease !important;
    box-shadow: none !important;
}

#receiptModal .file-input-no-gap:hover {
    background: transparent !important;
}

#receiptModal .file-input-no-gap:focus {
    background: transparent !important;
    box-shadow: none !important;
}

/* Закругляем углы у внутренней рамки файлового поля */
#receiptModal .file-input-no-gap::-webkit-file-upload-button {
    border-radius: 8px !important;
    border: 1px solid #dee2e6 !important;
    background: #f8f9fa !important;
    color: #495057 !important;
    padding: 8px 16px !important;
    margin-right: 12px !important;
    font-size: 14px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
}

#receiptModal .file-input-no-gap::-webkit-file-upload-button:hover {
    background: #e9ecef !important;
    border-color: #adb5bd !important;
}

/* Стили для темной темы */
[data-bs-theme="dark"] #receiptModal .file-input-no-gap {
    background: transparent !important;
    color: #e2e8f0 !important;
    border: none !important;
}

[data-bs-theme="dark"] #receiptModal .file-input-no-gap::-webkit-file-upload-button {
    background: #2d3748 !important;
    color: #e2e8f0 !important;
    border: 1px solid #4a5568 !important;
}

[data-bs-theme="dark"] #receiptModal .file-input-no-gap::-webkit-file-upload-button:hover {
    background: #4a5568 !important;
    border-color: #718096 !important;
}

/* Исправление z-index для модального окна */
.modal {
    z-index: 1055 !important;
}

.modal-backdrop {
    z-index: 1050 !important;
}

/* Собственное затемнение для модального окна */
.custom-modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1050;
    display: none;
}

.modal.show .custom-modal-backdrop {
    display: block;
}
</style>

<script>
// Отправка формы поступления (скопировано из десктопной версии)
async function submitReceipt() {
  console.log('=== submitReceipt вызвана в мобильной версии ===');
  alert('Функция submitReceipt вызвана!'); // Временный тест
  
  const form = document.getElementById('form-receipt');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('{{ url_for("supply.api_create_receipt") }}', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      const result = await response.json();
      
      // Проверяем, есть ли предупреждение о восстановлении
      if (result.warning) {
        // Показываем предупреждение пользователю
        alert(result.warning);
      } else {
        alert('Поступление успешно проведено');
      }
      
      bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
      form.reset();
      hideReceiptExistsInfo(); // Скрываем информацию о существующем материале
      // Перезагружаем страницу для обновления данных
      window.location.reload();
    } else {
      const error = await response.json();
      alert('Ошибка проведения поступления: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка проведения поступления');
  }
}

// Функция проверки существующего материала для поступления
async function checkExistingMaterialForReceipt(name) {
  if (!name || name.length < 2) {
    hideReceiptExistsInfo();
    return;
  }
  
  try {
    const response = await fetch('{{ url_for("supply.api_materials_check") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name })
    });
    
    if (response.ok) {
      const result = await response.json();
      
      if (result.exists) {
        // Если есть точное совпадение или исправление регистра
        if (result.exact_match || result.case_corrected) {
          showReceiptExistsInfo(result.material, result.corrected_name);
        }
      } else if (result.similar_found) {
        // Если найдены похожие материалы
        showSimilarMaterialsForReceipt(result.similar_materials, name);
      } else {
        hideReceiptExistsInfo();
      }
    }
  } catch (error) {
    console.error('Ошибка проверки материала для поступления:', error);
  }
}

// Показать информацию о существующем материале для поступления
function showReceiptExistsInfo(material, correctedName = null) {
  const infoDiv = document.getElementById('receipt-exists-info');
  const unitInput = document.querySelector('#form-receipt input[name="unit"]');
  const nameInput = document.getElementById('receipt-name-input');
  
  // Заполняем поле единицы измерения автоматически
  unitInput.value = material.unit;
  
  // Если есть исправление регистра, обновляем поле названия
  if (correctedName) {
    nameInput.value = correctedName;
  }
  
  // Блокируем поле для редактирования (используем readonly вместо disabled)
  unitInput.readOnly = true;
  
  // Показываем информацию
  let message = `Материал уже существует на складе (${material.current_quantity} ${material.unit}). При поступлении количество будет пополнено. Ед. изм. заблокирована.`;
  
  if (correctedName) {
    message = `Исправлен регистр: "${correctedName}". Материал уже существует на складе (${material.current_quantity} ${material.unit}). При поступлении количество будет пополнено. Ед. изм. заблокирована.`;
  }
  
  infoDiv.innerHTML = `
    <i class="bi bi-info-circle"></i> 
    ${message}
  `;
  infoDiv.style.display = 'block';
  infoDiv.className = 'form-text text-warning';
}

// Показать похожие материалы для поступления
function showSimilarMaterialsForReceipt(similarMaterials, originalName) {
  const infoDiv = document.getElementById('receipt-exists-info');
  
  let similarList = '';
  similarMaterials.forEach((material, index) => {
    similarList += `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span>${material.name} (${material.current_quantity} ${material.unit})</span>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectSimilarMaterialForReceipt('${material.name}', '${material.unit}')">
          Выбрать
        </button>
      </div>
    `;
  });
  
  infoDiv.innerHTML = `
    <div class="alert alert-info">
      <i class="bi bi-question-circle"></i> 
      <strong>Не найдено точного совпадения для "${originalName}"</strong>
      <br>Возможно, вы имели в виду один из этих материалов:
      <div class="mt-2">
        ${similarList}
      </div>
      <div class="mt-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideReceiptExistsInfo()">
          Создать новый материал
        </button>
      </div>
    </div>
  `;
  infoDiv.style.display = 'block';
  infoDiv.className = 'form-text';
}

// Выбрать похожий материал для поступления
function selectSimilarMaterialForReceipt(name, unit) {
  const nameInput = document.getElementById('receipt-name-input');
  const unitInput = document.querySelector('#form-receipt input[name="unit"]');
  
  // Заполняем поля
  nameInput.value = name;
  unitInput.value = unit;
  
  // Блокируем поле
  unitInput.readOnly = true;
  
  // Показываем информацию о выбранном материале
  showReceiptExistsInfo({
    name: name,
    unit: unit,
    current_quantity: 0 // Будет получено из API
  });
}

// Скрыть информацию о существующем материале для поступления
function hideReceiptExistsInfo() {
  const infoDiv = document.getElementById('receipt-exists-info');
  const unitInput = document.querySelector('#form-receipt input[name="unit"]');
  
  // Разблокируем поле
  if (unitInput) {
    unitInput.readOnly = false;
  }
  
  infoDiv.style.display = 'none';
}

// Управление собственным затемнением
function showCustomBackdrop() {
  const backdrop = document.getElementById('customBackdrop');
  if (backdrop) {
    backdrop.style.display = 'block';
  }
}

function hideCustomBackdrop() {
  const backdrop = document.getElementById('customBackdrop');
  if (backdrop) {
    backdrop.style.display = 'none';
  }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== DOM ЗАГРУЖЕН, НАЧИНАЕМ ИНИЦИАЛИЗАЦИЮ ===');
  
  // Управление затемнением для модального окна поступления
  const receiptModal = document.getElementById('receiptModal');
  if (receiptModal) {
    receiptModal.addEventListener('show.bs.modal', function() {
      showCustomBackdrop();
    });
    
    receiptModal.addEventListener('hide.bs.modal', function() {
      hideCustomBackdrop();
    });
  }
  
  // Проверка существующего материала при вводе названия в поступлении
  const receiptNameInput = document.getElementById('receipt-name-input');
  if (receiptNameInput) {
    let receiptTimeoutId;
    receiptNameInput.addEventListener('input', function() {
      clearTimeout(receiptTimeoutId);
      receiptTimeoutId = setTimeout(() => {
        checkExistingMaterialForReceipt(this.value);
      }, 500); // Задержка 500мс для избежания частых запросов
    });
  }
});

</script>


{% endblock %}

