{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'supply' %}

{% block title %}Склад{% endblock %}
{% block mobile_title %}Склад{% endblock %}

{% block content %}
<!-- Статистика склада -->
<div class="mobile-card">
    <div class="mobile-card-title">Статистика склада</div>
    <div class="row g-2">
        <div class="col-6">
            <div class="mobile-card-text">
                <strong>{{ materials_count or 0 }}</strong><br>
                <small class="text-muted">Позиций</small>
            </div>
        </div>
        <div class="col-6">
            <div class="mobile-card-text">
                <strong>{{ low_stock_count or 0 }}</strong><br>
                <small class="text-muted">Низкий запас</small>
            </div>
        </div>
    </div>
</div>

<!-- Действия -->
<div class="mobile-card">
    <div class="mobile-card-title">Действия</div>
    <div class="mobile-sections">
        <button class="mobile-btn mobile-btn-outline" data-bs-toggle="modal" data-bs-target="#receiptModal">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                <path d="M2 17L12 22L22 17"/>
                <path d="M2 12L12 17L22 12"/>
            </svg>
            Поступление
        </button>
        <button class="mobile-btn mobile-btn-outline" data-bs-toggle="modal" data-bs-target="#movementModal">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 17L4 21L0 17"/>
                <path d="M4 21V9"/>
                <path d="M16 7L20 3L24 7"/>
                <path d="M20 3V15"/>
            </svg>
            Перемещение
        </button>
        <a href="{{ url_for('supply.warehouse_view') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
            </svg>
            Просмотр материалов
        </a>
        <a href="{{ url_for('supply.mobile_warehouse_movements') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
            </svg>
            История движений
        </a>
        <a href="{{ url_for('supply.mobile_warehouse_allocations') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
                <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
            </svg>
            Распределение
        </a>
    </div>
</div>

{% if low_stock_materials %}
<!-- Материалы с низким запасом -->
<div class="mobile-card">
    <div class="mobile-card-title">⚠️ Низкий запас</div>
    {% for material in low_stock_materials[:3] %}
    <div class="mobile-card-text mobile-mb-1">
        <strong>{{ material.name }}</strong><br>
        <small class="text-muted">Остаток: {{ material.current_quantity }} / {{ material.min_quantity }} {{ material.unit }}</small>
    </div>
    {% endfor %}
    {% if low_stock_materials|length > 3 %}
    <div class="mobile-card-text mobile-mb-1">
        <small class="text-muted">И еще {{ low_stock_materials|length - 3 }} позиций</small>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Модальное окно для поступления -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">Поступление на склад</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-receipt">
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Наименование</label>
                            <input class="form-control" name="name" id="receipt-name-input" required>
                            <div id="receipt-exists-info" class="form-text text-info" style="display: none;">
                                <i class="bi bi-info-circle"></i> Материал уже существует на складе
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Ед. изм.</label>
                            <input class="form-control" name="unit" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Накладная (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted">Прикрепите накладную к поступлению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitReceipt()">Провести поступление</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для перемещения -->
<div class="modal fade" id="movementModal" tabindex="-1" aria-labelledby="movementModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="movementModalLabel">Перемещение материала</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-movement">
                    <div class="mb-3">
                        <label class="form-label">Материал</label>
                        <select class="form-select" name="material_id" id="movement-material-select" required>
                            <option value="">Выберите материал</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Количество</label>
                        <input type="number" class="form-control" name="quantity" step="0.01" min="0" required>
                        <div class="form-text">Доступно: <span id="available-quantity">-</span></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Получатель</label>
                        <select class="form-select" name="to_user_id" id="to_user_id" required>
                            <option value="">Выберите получателя</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Примечание</label>
                        <textarea class="form-control" name="note" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="submitMovement()">Провести перемещение</button>
            </div>
        </div>
    </div>
</div>

<!-- Дополнительный отступ для нижней панели -->
<div style="height: 140px"></div>

<style>
/* Исправление расположения кнопок в разделе "Действия" */
.mobile-sections {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.mobile-sections .mobile-btn {
    margin-bottom: 0;
}
</style>

<script>
// Загрузка материалов для перемещения
async function loadMaterialsForMovement() {
    const select = document.getElementById('movement-material-select');
    
    try {
        const response = await fetch('{{ url_for("supply.api_materials") }}');
        const materials = await response.json();
        
        select.innerHTML = '<option value="">Выберите материал</option>';
        materials.forEach(material => {
            if (material.current_quantity > 0) {
                const option = document.createElement('option');
                option.value = material.id;
                option.textContent = `${material.name} (${material.current_quantity} ${material.unit})`;
                option.dataset.quantity = material.current_quantity;
                select.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Ошибка загрузки материалов:', error);
    }
}

// Загрузка пользователей
async function loadUsers() {
    const select = document.getElementById('to_user_id');
    
    try {
        const response = await fetch('{{ url_for("supply.api_get_all_users") }}');
        const users = await response.json();
        
        select.innerHTML = '<option value="">Выберите получателя</option>';
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.userid;
            option.textContent = `${user.secondname || ''} ${user.firstname || ''} (${user.login})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Ошибка загрузки пользователей:', error);
    }
}

// Обновление доступного количества при выборе материала
document.getElementById('movement-material-select').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const availableQuantity = document.getElementById('available-quantity');
    
    if (selectedOption.dataset.quantity) {
        availableQuantity.textContent = selectedOption.dataset.quantity;
    } else {
        availableQuantity.textContent = '-';
    }
});

// Отправка формы поступления
async function submitReceipt() {
    const form = document.getElementById('form-receipt');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('{{ url_for("supply.api_materials_create") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Поступление успешно проведено');
            bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
            form.reset();
        } else {
            const error = await response.json();
            alert('Ошибка проведения поступления: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка проведения поступления');
    }
}

// Отправка формы перемещения
async function submitMovement() {
    const form = document.getElementById('form-movement');
    const formData = new FormData(form);
    formData.append('movement_type', 'move');
    
    try {
        const response = await fetch('{{ url_for("supply.api_create_movement") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Перемещение успешно проведено');
            bootstrap.Modal.getInstance(document.getElementById('movementModal')).hide();
            form.reset();
        } else {
            const error = await response.json();
            alert('Ошибка проведения перемещения: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка проведения перемещения');
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем данные при открытии модальных окон
    document.getElementById('receiptModal').addEventListener('show.bs.modal', function() {
        // Можно добавить дополнительную логику при открытии
    });
    
    document.getElementById('movementModal').addEventListener('show.bs.modal', function() {
        loadMaterialsForMovement();
        loadUsers();
    });
});
</script>
{% endblock %}
