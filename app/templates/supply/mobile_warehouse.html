{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'supply' %}

{% block title %}Склад{% endblock %}
{% block mobile_title %}Склад{% endblock %}

{% block content %}
<!-- Статистика склада -->
<div class="mobile-card">
    <div class="mobile-card-title">Статистика склада</div>
    <div class="row g-2">
        <div class="col-6">
            <div class="mobile-card-text">
                <strong>{{ materials_count or 0 }}</strong><br>
                <small class="text-muted">Позиций</small>
            </div>
        </div>
        <div class="col-6">
            <div class="mobile-card-text">
                <strong>{{ low_stock_count or 0 }}</strong><br>
                <small class="text-muted">Низкий запас</small>
            </div>
        </div>
    </div>
</div>

<!-- Действия -->
<div class="mobile-card">
    <div class="mobile-card-title">Действия</div>
    <div class="mobile-sections">
        <button class="mobile-btn mobile-btn-outline" data-bs-toggle="modal" data-bs-target="#receiptModal">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
                <path d="M2 17L12 22L22 17"/>
                <path d="M2 12L12 17L22 12"/>
            </svg>
            Поступление
        </button>
        <button class="mobile-btn mobile-btn-outline" data-bs-toggle="modal" data-bs-target="#movementModal">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 17L4 21L0 17"/>
                <path d="M4 21V9"/>
                <path d="M16 7L20 3L24 7"/>
                <path d="M20 3V15"/>
            </svg>
            Перемещение
        </button>
        <a href="{{ url_for('supply.warehouse_view') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
            </svg>
            Просмотр материалов
        </a>
        <a href="{{ url_for('supply.mobile_warehouse_movements') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
            </svg>
            История движений
        </a>
        <a href="{{ url_for('supply.mobile_warehouse_allocations') }}" class="mobile-btn mobile-btn-outline">
            <svg width="16" height="16" class="me-2" fill="currentColor" viewBox="0 0 16 16">
                <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
                <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
            </svg>
            Распределение
        </a>
    </div>
</div>

{% if low_stock_materials %}
<!-- Материалы с низким запасом -->
<div class="mobile-card">
    <div class="mobile-card-title">⚠️ Низкий запас</div>
    {% for material in low_stock_materials[:3] %}
    <div class="mobile-card-text mobile-mb-1">
        <strong>{{ material.name }}</strong><br>
        <small class="text-muted">Остаток: {{ material.current_quantity }} / {{ material.min_quantity }} {{ material.unit }}</small>
    </div>
    {% endfor %}
    {% if low_stock_materials|length > 3 %}
    <div class="mobile-card-text mobile-mb-1">
        <small class="text-muted">И еще {{ low_stock_materials|length - 3 }} позиций</small>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Модальное окно для поступления -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">Поступление на склад</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-receipt">
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Наименование</label>
                            <input class="form-control" name="name" id="receipt-name-input" required>
                            <div id="receipt-exists-info" class="form-text text-info" style="display: none;">
                                <i class="bi bi-info-circle"></i> Материал уже существует на складе
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Ед. изм.</label>
                            <input class="form-control" name="unit" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-12 file-input-container">
                            <label class="form-label">Накладная (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control file-input-no-gap" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted file-text-no-gap">Прикрепите накладную к поступлению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" id="submit-receipt-btn">Провести поступление</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для перемещения -->
<div class="modal fade" id="movementModal" tabindex="-1" aria-labelledby="movementModalLabel" aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="movementModalLabel">Движение по складу</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-movement">
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Тип операции <span class="text-danger">*</span></label>
                            <select class="form-select" name="movement_type" id="movement_type" required onchange="onMovementTypeChange()">
                                <option value="">Выберите тип операции</option>
                                <option value="move">Выдача</option>
                                <option value="return">Возврат</option>
                                <option value="writeoff">Списание</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Материал <span class="text-danger">*</span></label>
                            <select class="form-select" name="material_id" id="material_id" required onchange="onMaterialChange()">
                                <option value="">Сначала выберите тип операции</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="quantity" id="movement_quantity" step="0.01" min="0" required>
                                <span class="input-group-text" id="movement_unit">шт</span>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">Доступно: <span id="available_quantity" class="text-primary fw-bold">0</span></small>
                                <small class="text-warning" id="quantity_warning" style="display: none;">Количество ограничено доступным</small>
                            </div>
                        </div>
                        <div class="col-6" id="user-selection-container" style="display: none;">
                            <label class="form-label" id="user-label">Пользователь</label>
                            <select class="form-select" name="to_user_id" id="to_user_id">
                                <option value="">Выберите пользователя...</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Примечание</label>
                            <input class="form-control" name="note">
                        </div>
                        <div class="col-12">
                            <label class="form-label" id="file-label">Вложение (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file" id="movement-file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted" id="file-help">Прикрепите документ к движению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitMovement()">Провести</button>
            </div>
        </div>
    </div>
</div>

<!-- Дополнительный отступ для нижней панели -->
<div style="height: 140px"></div>

<style>
/* Исправление расположения кнопок в разделе "Действия" */
.mobile-sections {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.mobile-sections .mobile-btn {
    margin-bottom: 0;
}

/* АГРЕССИВНОЕ УБИРАНИЕ ВСЕХ ЗАЗОРОВ ПОД ФАЙЛОВЫМ ПОЛЕМ */
#receiptModal .file-input-container {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
    margin-top: 0 !important;
    padding-top: 0 !important;
}

#receiptModal .file-input-no-gap {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
    margin-top: 0 !important;
    padding-top: 0 !important;
    border-bottom: none !important;
    box-shadow: none !important;
}

#receiptModal .file-text-no-gap {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    line-height: 1.2 !important;
    font-size: 0.8rem !important;
}

/* Убираем ТОЛЬКО зазор под файловым полем */
#receiptModal .file-input-container {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}

#receiptModal .file-input-no-gap {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}

#receiptModal .file-text-no-gap {
    margin-top: 4px !important;
    margin-bottom: 0 !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    line-height: 1.3 !important;
}

/* Улучшаем кнопку "Выбрать файл" */
#receiptModal .file-input-no-gap {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
    margin-top: 0 !important;
    padding-top: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    height: 48px !important;
    min-height: 48px !important;
    padding: 12px 16px !important;
    font-size: 16px !important;
    line-height: 1.5 !important;
    background: transparent !important;
    color: #495057 !important;
    transition: all 0.2s ease !important;
    box-shadow: none !important;
}

#receiptModal .file-input-no-gap:hover {
    background: transparent !important;
}

#receiptModal .file-input-no-gap:focus {
    background: transparent !important;
    box-shadow: none !important;
}

/* Закругляем углы у внутренней рамки файлового поля */
#receiptModal .file-input-no-gap::-webkit-file-upload-button {
    border-radius: 8px !important;
    border: 1px solid #dee2e6 !important;
    background: #f8f9fa !important;
    color: #495057 !important;
    padding: 8px 16px !important;
    margin-right: 12px !important;
    font-size: 14px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
}

#receiptModal .file-input-no-gap::-webkit-file-upload-button:hover {
    background: #e9ecef !important;
    border-color: #adb5bd !important;
}

/* Стили для темной темы */
[data-bs-theme="dark"] #receiptModal .file-input-no-gap {
    background: transparent !important;
    color: #e2e8f0 !important;
    border: none !important;
}

[data-bs-theme="dark"] #receiptModal .file-input-no-gap::-webkit-file-upload-button {
    background: #2d3748 !important;
    color: #e2e8f0 !important;
    border: 1px solid #4a5568 !important;
}

[data-bs-theme="dark"] #receiptModal .file-input-no-gap::-webkit-file-upload-button:hover {
    background: #4a5568 !important;
    border-color: #718096 !important;
}
</style>

{% endblock %}

{% block scripts %}
<script>
console.log('=== JavaScript в блоке scripts загружен ===');

// Функции для работы с модальным окном перемещения (как в десктопной версии)

// Загрузка материалов в зависимости от типа операции
async function loadMaterialsForMovementType(movementType) {
    const materialSelect = document.getElementById('material_id');
    
    try {
        let url = '';
        if (movementType === 'move') {
            url = '{{ url_for("supply.api_materials") }}';
        } else if (movementType === 'return') {
            url = '{{ url_for("supply.api_materials_for_return") }}';
        } else if (movementType === 'writeoff') {
            url = '{{ url_for("supply.api_materials") }}';
        }
        
        const response = await fetch(url);
        const materials = await response.json();
        
        materialSelect.innerHTML = '<option value="">Выберите материал</option>';
        materials.forEach(material => {
            const option = document.createElement('option');
            option.value = material.id;
            option.textContent = `${material.name} (${material.current_quantity || material.quantity} ${material.unit})`;
            option.dataset.quantity = material.current_quantity || material.quantity;
            option.dataset.unit = material.unit;
            materialSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Ошибка загрузки материалов:', error);
    }
}

// Загрузка пользователей
async function loadUsers() {
    const select = document.getElementById('to_user_id');
    
    try {
        const response = await fetch('{{ url_for("supply.api_get_all_users") }}');
        const users = await response.json();
        
        select.innerHTML = '<option value="">Выберите пользователя...</option>';
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.userid;
            option.textContent = `${user.secondname || ''} ${user.firstname || ''} (${user.login})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Ошибка загрузки пользователей:', error);
    }
}

// Обработка изменения типа операции
function onMovementTypeChange() {
    const movementType = document.getElementById('movement_type').value;
    const materialSelect = document.getElementById('material_id');
    const userContainer = document.getElementById('user-selection-container');
    const userLabel = document.getElementById('user-label');
    const fileLabel = document.getElementById('file-label');
    const fileHelp = document.getElementById('file-help');
    
    // Сбрасываем форму
    materialSelect.innerHTML = '<option value="">Сначала выберите тип операции</option>';
    document.getElementById('movement_quantity').value = '';
    document.getElementById('available_quantity').textContent = '0';
    document.getElementById('movement_unit').textContent = 'шт';
    
    if (movementType) {
        loadMaterialsForMovementType(movementType);
        
        // Показываем/скрываем выбор пользователя в зависимости от типа операции
        if (movementType === 'move' || movementType === 'return') {
            userContainer.style.display = 'block';
            userLabel.textContent = movementType === 'move' ? 'Получатель' : 'Возвращающий';
            document.getElementById('to_user_id').required = true;
        } else {
            userContainer.style.display = 'none';
            document.getElementById('to_user_id').required = false;
        }
        
        // Обновляем текст для файла
        if (movementType === 'writeoff') {
            fileLabel.innerHTML = 'Документ списания (файл) <span class="text-danger">*</span>';
            fileHelp.textContent = 'Прикрепите документ списания (обязательно)';
        } else {
            fileLabel.innerHTML = 'Вложение (файл) <span class="text-danger">*</span>';
            fileHelp.textContent = 'Прикрепите документ к движению (обязательно)';
        }
    } else {
        userContainer.style.display = 'none';
        document.getElementById('to_user_id').required = false;
    }
}

// Обработка изменения материала
function onMaterialChange() {
    const materialSelect = document.getElementById('material_id');
    const selectedOption = materialSelect.options[materialSelect.selectedIndex];
    const availableQuantity = document.getElementById('available_quantity');
    const movementUnit = document.getElementById('movement_unit');
    
    if (selectedOption.dataset.quantity) {
        availableQuantity.textContent = selectedOption.dataset.quantity;
        movementUnit.textContent = selectedOption.dataset.unit || 'шт';
    } else {
        availableQuantity.textContent = '0';
        movementUnit.textContent = 'шт';
    }
}

// Отправка формы поступления
async function submitReceipt() {
    console.log('=== submitReceipt вызвана ===');
    
    const form = document.getElementById('form-receipt');
    
    if (!form) {
        console.error('Форма form-receipt не найдена');
        alert('Ошибка: форма не найдена');
        return;
    }
    
    // Проверяем валидность формы
    if (!form.checkValidity()) {
        console.log('Форма не валидна');
        form.reportValidity();
        return;
    }
    
    const formData = new FormData(form);
    console.log('Отправляем данные:', formData);
    
    // Показываем индикатор загрузки
    const submitBtn = document.getElementById('submit-receipt-btn');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Отправка...';
    
    try {
        const response = await fetch('{{ url_for("supply.api_materials_create") }}', {
            method: 'POST',
            body: formData
        });
        
        console.log('Ответ сервера:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Результат:', result);
            alert('Поступление успешно проведено');
            bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
            form.reset();
            // Перезагружаем страницу для обновления данных
            window.location.reload();
        } else {
            const error = await response.json();
            console.error('Ошибка сервера:', error);
            alert('Ошибка проведения поступления: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка проведения поступления: ' + error.message);
    } finally {
        // Восстанавливаем кнопку
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

// Отправка формы движения
async function submitMovement() {
    const form = document.getElementById('form-movement');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('{{ url_for("supply.api_create_movement") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.warning) {
                alert(result.warning);
            }
            alert('Движение успешно проведено');
            bootstrap.Modal.getInstance(document.getElementById('movementModal')).hide();
            form.reset();
            // Сбрасываем состояние формы
            document.getElementById('user-selection-container').style.display = 'none';
            document.getElementById('material_id').innerHTML = '<option value="">Сначала выберите тип операции</option>';
        } else {
            const error = await response.json();
            alert('Ошибка проведения движения: ' + (error.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка проведения движения');
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOMContentLoaded выполнен ===');
    
    // Загружаем пользователей при открытии модального окна движения
    const movementModal = document.getElementById('movementModal');
    if (movementModal) {
        movementModal.addEventListener('show.bs.modal', function() {
            loadUsers();
        });
    }
    
    // Добавляем обработчик для кнопки поступления
    const submitReceiptBtn = document.getElementById('submit-receipt-btn');
    console.log('Кнопка submit-receipt-btn найдена:', submitReceiptBtn);
    
    if (submitReceiptBtn) {
        submitReceiptBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('=== Кнопка поступления нажата ===');
            submitReceipt();
        });
        console.log('Обработчик события добавлен к кнопке');
    } else {
        console.error('Кнопка submit-receipt-btn не найдена');
    }
    
    // Делаем функции глобальными для onclick
    window.submitReceipt = submitReceipt;
    window.submitMovement = submitMovement;
    console.log('Функции добавлены в window объект');
});
</script>
{% endblock %}
