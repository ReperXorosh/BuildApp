{% extends "main/layout.html" %}
{% set active_page = 'supply' %}

{% block title %}{{ user.secondname or '' }} {{ user.firstname or '' }} - {{ material.name }}{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top: 80px;">
    <!-- Заголовок -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        <i class="bi bi-clock-history me-2"></i>
                        История движений
                    </h2>
                    <p class="text-muted mb-0">
                        <strong>Пользователь:</strong> {{ user.secondname or '' }} {{ user.firstname or '' }} ({{ user.login }}) • 
                        <strong>Материал:</strong> {{ material.name }}
                    </p>
                </div>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('supply.warehouse_user_detail', user_id=user.userid) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Назад к пользователю
                    </a>
                    <a href="{{ url_for('supply.warehouse_allocations') }}" class="btn btn-outline-primary">
                        <i class="bi bi-people me-1"></i>Распределение
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Информация о материале -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="card-title">{{ material.name }}</h5>
                            <p class="text-muted mb-0">{{ material.description or 'Описание не указано' }}</p>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-2">
                                        <label class="form-label fw-semibold">Единица измерения</label>
                                        <p class="mb-0">{{ material.unit or 'Не указана' }}</p>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-2">
                                        <label class="form-label fw-semibold">Текущее количество</label>
                                        <p class="mb-0">{{ material.current_quantity or 0 }} {{ material.unit or '' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица движений -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="card-title mb-0">История движений</h5>
                        </div>
                        <div class="col-md-6 text-end">
                            <span class="badge bg-info" id="totalCount">Всего записей: 0</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Дата</th>
                                    <th>Тип</th>
                                    <th>Количество</th>
                                    <th>Примечание</th>
                                    <th>Файлы</th>
                                </tr>
                            </thead>
                            <tbody id="movements-table">
                                <!-- Данные будут загружены через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Загрузка истории движений
async function loadMovements() {
  try {
    const response = await fetch('{{ url_for("supply.api_user_material_movements", user_id=user.userid, material_id=material.id) }}');
    const movements = await response.json();
    
    displayMovements(movements);
  } catch (error) {
    console.error('Ошибка загрузки истории движений:', error);
  }
}

// Отображение движений
function displayMovements(movements) {
  const tbody = document.getElementById('movements-table');
  tbody.innerHTML = '';
  
  document.getElementById('totalCount').textContent = `Всего записей: ${movements.length}`;
  
  movements.forEach(movement => {
    const row = document.createElement('tr');
    
    // Определяем тип движения
    let typeBadge = '';
    switch(movement.movement_type) {
      case 'add':
        typeBadge = '<span class="badge bg-info">Поступление</span>';
        break;
      case 'move':
        typeBadge = '<span class="badge bg-primary">Выдача</span>';
        break;
      case 'return':
        typeBadge = '<span class="badge bg-success">Возврат</span>';
        break;
      case 'writeoff':
        typeBadge = '<span class="badge bg-danger">Списание</span>';
        break;
      case 'replenishment':
        typeBadge = '<span class="badge bg-info">Пополнение</span>';
        break;
      case 'creation':
        typeBadge = '<span class="badge bg-warning">Создание</span>';
        break;
      default:
        typeBadge = '<span class="badge bg-secondary">Неизвестно</span>';
    }
    
    // Форматируем дату
    const date = new Date(movement.created_at);
    const formattedDate = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    
    // Файлы
    let filesHtml = '';
    if (movement.attachments && movement.attachments.length > 0) {
      movement.attachments.forEach(attachment => {
        filesHtml += `<a href="/supply/api/supply/movements/${movement.id}/attachments/${attachment.id}/view" class="btn btn-sm btn-outline-secondary me-1" title="${attachment.original_filename}" target="_blank">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>`;
      });
    } else {
      filesHtml = '<span class="text-muted">-</span>';
    }
    
    row.innerHTML = `
      <td>${formattedDate}</td>
      <td>${typeBadge}</td>
      <td>
        <span class="fw-semibold">${movement.quantity} {{ material.unit or '' }}</span>
      </td>
      <td>${movement.note || '-'}</td>
      <td>${filesHtml}</td>
    `;
    
    tbody.appendChild(row);
  });
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  loadMovements();
});
</script>
{% endblock %}
