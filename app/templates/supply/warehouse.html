{% extends "main/layout.html" %}

{% block title %}Склад{% endblock %}

{% block content %}
<div class="container-fluid py-3" style="margin-top: 80px;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <svg class="bi me-2" width="24" height="24" fill="currentColor">
                        <use xlink:href="#box-seam"></use>
                    </svg>
                    Склад
                </h1>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-xl-5">
            <div class="card">
                <div class="card-header"><h6 class="mb-0">Добавить/обновить материал</h6></div>
                <div class="card-body">
                    <form id="form-create-material">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">Название</label>
                                <input class="form-control" name="name" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Ед.</label>
                                <input class="form-control" name="unit" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Количество</label>
                                <input type="number" step="0.001" class="form-control" name="current_quantity" value="0" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Мин. запас</label>
                                <input type="number" step="0.001" class="form-control" name="min_quantity" value="0">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Описание</label>
                                <textarea class="form-control" name="description"></textarea>
                            </div>
                            <div class="col-12 text-end">
                                <button class="btn btn-primary" type="submit">Сохранить</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header"><h6 class="mb-0">Движение по складу</h6></div>
                <div class="card-body">
                    <form id="form-movement" enctype="multipart/form-data">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">Материал</label>
                                <select class="form-select" name="material_id">
                                    {% for m in materials %}
                                    <option value="{{ m.id }}">{{ m.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Количество</label>
                                <input type="number" step="0.001" class="form-control" name="quantity" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Тип</label>
                                <select class="form-select" name="movement_type">
                                    <option value="add">Поступление</option>
                                    <option value="move">Выдача</option>
                                    <option value="return">Возврат</option>
                                    <option value="writeoff">Списание</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Кому выдать</label>
                                <div class="accordion" id="userAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#userCollapse" aria-expanded="false" aria-controls="userCollapse">
                                                <span id="selected_user_display">Выберите пользователя</span>
                                            </button>
                                        </h2>
                                        <div id="userCollapse" class="accordion-collapse collapse" data-bs-parent="#userAccordion">
                                            <div class="accordion-body">
                                                <div class="mb-3">
                                                    <input type="text" class="form-control" id="user_search" placeholder="Поиск по имени или фамилии..." autocomplete="off">
                                                </div>
                                                <div id="users_list" style="max-height: 300px; overflow-y: auto;">
                                                    <!-- Список пользователей будет загружен здесь -->
                                                </div>
                                                <input type="hidden" name="to_user_id" id="to_user_id">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Примечание</label>
                                <input class="form-control" name="note">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Вложение (файл)</label>
                                <input type="file" class="form-control" name="file">
                            </div>
                            <div class="col-12 text-end">
                                <button class="btn btn-success" type="submit">Провести</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-7">
            <div class="card">
                <div class="card-header"><h6 class="mb-0">Материалы на складе</h6></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Ед.</th>
                                    <th class="text-end">Кол-во</th>
                                    <th class="text-end">Мин.</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in materials %}
                                <tr>
                                    <td>{{ m.name }}</td>
                                    <td>{{ m.unit }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-{{ 'danger' if m.current_quantity <= m.min_quantity else 'success' }}">{{ m.current_quantity }}</span>
                                    </td>
                                    <td class="text-end">{{ m.min_quantity }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header"><h6 class="mb-0">Последние движения</h6></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Материал</th>
                                    <th>Тип</th>
                                    <th class="text-end">Кол-во</th>
                                    <th>Файл</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mv in recent_movements %}
                                <tr>
                                    <td>{{ mv.created_at }}</td>
                                    <td>{{ mv.material.name }}</td>
                                    <td>{{ mv.movement_type }}</td>
                                    <td class="text-end">{{ mv.quantity }}</td>
                                    <td>
                                        {% if mv.attachments and mv.attachments|length > 0 %}
                                            <a href="{{ url_for('supply.api_download_attachment', movement_id=mv.id, attachment_id=mv.attachments[0].id) }}" class="btn btn-sm btn-outline-secondary">Скачать</a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Стили для аккордеона пользователей */
#userAccordion .accordion-button {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

#userAccordion .accordion-button:not(.collapsed) {
    background-color: #e9ecef;
    border-color: #dee2e6;
}

#userAccordion .accordion-button:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

#users_list .list-group-item {
    border: 1px solid #dee2e6;
    margin-bottom: 2px;
    border-radius: 0.375rem;
}

#users_list .list-group-item:hover {
    background-color: #f8f9fa;
    border-color: #0d6efd;
}

#users_list .list-group-item:active {
    background-color: #e9ecef;
}

/* Стили для поиска */
#user_search:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
</style>

<script>
document.getElementById('form-create-material').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    name: form.name.value,
    unit: form.unit.value,
    description: form.description.value,
    current_quantity: form.current_quantity.value,
    min_quantity: form.min_quantity.value
  };
  const resp = await fetch('{{ url_for('supply.api_materials_create') }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (resp.ok) location.reload(); else alert('Ошибка сохранения материала');
});

document.getElementById('form-movement').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);
  const resp = await fetch('{{ url_for('supply.api_create_movement') }}', {
    method: 'POST',
    body: fd
  });
  if (resp.ok) location.reload(); else alert('Ошибка проведения движения');
});

// Функция для создания аккордеона пользователей
function createUserAccordion() {
  const searchInput = document.getElementById('user_search');
  const usersList = document.getElementById('users_list');
  const hiddenInput = document.getElementById('to_user_id');
  const displaySpan = document.getElementById('selected_user_display');
  const accordionButton = document.querySelector('#userAccordion .accordion-button');
  let allUsers = [];
  let filteredUsers = [];

  // Загрузка всех пользователей
  async function loadAllUsers() {
    try {
      const response = await fetch('{{ url_for('supply.api_get_all_users') }}');
      allUsers = await response.json();
      filteredUsers = [...allUsers];
      renderUsers();
    } catch (error) {
      console.error('Ошибка загрузки пользователей:', error);
      usersList.innerHTML = '<div class="text-danger">Ошибка загрузки пользователей</div>';
    }
  }

  // Отображение пользователей
  function renderUsers() {
    usersList.innerHTML = '';
    
    if (filteredUsers.length === 0) {
      usersList.innerHTML = '<div class="text-muted text-center py-3">Пользователи не найдены</div>';
      return;
    }

    // Группировка по ролям
    const groupedUsers = {};
    filteredUsers.forEach(user => {
      const role = user.role || 'Не указана';
      if (!groupedUsers[role]) {
        groupedUsers[role] = [];
      }
      groupedUsers[role].push(user);
    });

    // Отображение по группам
    Object.keys(groupedUsers).sort().forEach(role => {
      const roleDiv = document.createElement('div');
      roleDiv.className = 'mb-3';
      
      const roleHeader = document.createElement('h6');
      roleHeader.className = 'text-muted mb-2';
      roleHeader.textContent = role;
      roleDiv.appendChild(roleHeader);

      const usersDiv = document.createElement('div');
      usersDiv.className = 'list-group list-group-flush';
      
      groupedUsers[role].forEach(user => {
        const userItem = document.createElement('div');
        userItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        userItem.style.cursor = 'pointer';
        
        const userInfo = document.createElement('div');
        userInfo.innerHTML = `
          <div class="fw-medium">${user.name}</div>
          <small class="text-muted">${user.login}</small>
        `;
        
        const roleBadge = document.createElement('span');
        roleBadge.className = 'badge bg-secondary';
        roleBadge.textContent = user.role || 'Не указана';
        
        userItem.appendChild(userInfo);
        userItem.appendChild(roleBadge);
        
        userItem.addEventListener('click', () => {
          selectUser(user);
        });
        
        usersDiv.appendChild(userItem);
      });
      
      roleDiv.appendChild(usersDiv);
      usersList.appendChild(roleDiv);
    });
  }

  // Выбор пользователя
  function selectUser(user) {
    hiddenInput.value = user.id;
    displaySpan.textContent = user.display;
    // Закрываем аккордеон после выбора
    accordionButton.classList.add('collapsed');
    accordionButton.setAttribute('aria-expanded', 'false');
    document.getElementById('userCollapse').classList.remove('show');
  }

  // Поиск пользователей
  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    
    if (query === '') {
      filteredUsers = [...allUsers];
    } else {
      filteredUsers = allUsers.filter(user => 
        user.name.toLowerCase().includes(query) ||
        user.login.toLowerCase().includes(query) ||
        (user.role && user.role.toLowerCase().includes(query))
      );
    }
    
    renderUsers();
  });

  // Очистка выбора при двойном клике на кнопку аккордеона
  accordionButton.addEventListener('dblclick', function(e) {
    e.preventDefault();
    e.stopPropagation();
    hiddenInput.value = '';
    displaySpan.textContent = 'Выберите пользователя';
    searchInput.value = '';
    filteredUsers = [...allUsers];
    renderUsers();
  });

  // Инициализация
  loadAllUsers();
}

// Инициализация аккордеона пользователей
createUserAccordion();
</script>
{% endblock %}


