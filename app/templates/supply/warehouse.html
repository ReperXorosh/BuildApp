{% extends "main/layout.html" %}

{% block title %}Склад{% endblock %}

{% block content %}
<div class="container-fluid py-3" style="margin-top: 80px;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <svg class="bi me-2" width="24" height="24" fill="currentColor">
                        <use xlink:href="#box-seam"></use>
                    </svg>
                    Склад
                </h1>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-xl-5">
            <div class="card">
                <div class="card-header"><h6 class="mb-0">Добавить/обновить материал</h6></div>
                <div class="card-body">
                    <form id="form-create-material">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">Название</label>
                                <input class="form-control" name="name" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Ед.</label>
                                <input class="form-control" name="unit" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Количество</label>
                                <input type="number" step="0.001" class="form-control" name="current_quantity" value="0" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Мин. запас</label>
                                <input type="number" step="0.001" class="form-control" name="min_quantity" value="0">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Описание</label>
                                <textarea class="form-control" name="description"></textarea>
                            </div>
                            <div class="col-12 text-end">
                                <button class="btn btn-primary" type="submit">Сохранить</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header"><h6 class="mb-0">Движение по складу</h6></div>
                <div class="card-body">
                    <form id="form-movement" enctype="multipart/form-data">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">Материал</label>
                                <select class="form-select" name="material_id">
                                    {% for m in materials %}
                                    <option value="{{ m.id }}">{{ m.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Количество</label>
                                <input type="number" step="0.001" class="form-control" name="quantity" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Тип</label>
                                <select class="form-select" name="movement_type">
                                    <option value="add">Поступление</option>
                                    <option value="move">Выдача</option>
                                    <option value="return">Возврат</option>
                                    <option value="writeoff">Списание</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Кому выдать</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="user_search" placeholder="Начните вводить имя или фамилию..." autocomplete="off">
                                    <input type="hidden" name="to_user_id" id="to_user_id">
                                    <div class="user-dropdown" id="user_dropdown" style="display: none;">
                                        <div class="user-dropdown-header">
                                            <small class="text-muted">Выберите пользователя:</small>
                                        </div>
                                        <div class="user-dropdown-list" id="users_list">
                                            <!-- Список пользователей будет загружен здесь -->
                                        </div>
                                    </div>
                                </div>
                                <div class="selected-user-display mt-2" id="selected_user_display" style="display: none;">
                                    <span class="badge bg-primary">
                                        <i class="bi bi-person-check me-1"></i>
                                        <span id="selected_user_name"></span>
                                        <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7em;" onclick="clearUserSelection()"></button>
                                      </span>
                                  </div>
                             </div>
                              <div class="col-12">
                                <label class="form-label">Примечание</label>
                                <input class="form-control" name="note">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Вложение (файл)</label>
                                <input type="file" class="form-control" name="file">
                            </div>
                            <div class="col-12 text-end">
                                <button class="btn btn-success" type="submit">Провести</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-7">
            <div class="card">
                <div class="card-header"><h6 class="mb-0">Материалы на складе</h6></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Ед.</th>
                                    <th class="text-end">Кол-во</th>
                                    <th class="text-end">Мин.</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in materials %}
                                <tr>
                                    <td>{{ m.name }}</td>
                                    <td>{{ m.unit }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-{{ 'danger' if m.current_quantity <= m.min_quantity else 'success' }}">{{ m.current_quantity }}</span>
                                    </td>
                                    <td class="text-end">{{ m.min_quantity }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header"><h6 class="mb-0">Последние движения</h6></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Материал</th>
                                    <th>Тип</th>
                                    <th class="text-end">Кол-во</th>
                                    <th>Файл</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mv in recent_movements %}
                                <tr>
                                    <td>{{ mv.created_at }}</td>
                                    <td>{{ mv.material.name }}</td>
                                    <td>{{ mv.movement_type }}</td>
                                    <td class="text-end">{{ mv.quantity }}</td>
                                    <td>
                                        {% if mv.attachments and mv.attachments|length > 0 %}
                                            <a href="{{ url_for('supply.api_download_attachment', movement_id=mv.id, attachment_id=mv.attachments[0].id) }}" class="btn btn-sm btn-outline-secondary">Скачать</a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Стили для компактного выбора пользователей */
.user-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    max-height: 300px;
    overflow: hidden;
}

.user-dropdown-header {
    padding: 0.5rem 0.75rem;
    background: var(--bs-light);
    border-bottom: 1px solid var(--bs-border-color);
}

.user-dropdown-list {
    max-height: 250px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid var(--bs-border-color);
    transition: background-color 0.15s ease;
}

.user-item:last-child {
    border-bottom: none;
}

.user-item:hover {
    background-color: var(--bs-primary);
    color: white;
}

.user-item:hover .user-role {
    background-color: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 500;
    font-size: 0.9rem;
}

.user-login {
    font-size: 0.8rem;
    opacity: 0.7;
}

.user-role {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    background-color: var(--bs-secondary);
    color: var(--bs-body-color);
}

.selected-user-display .badge {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
}

/* Поддержка темной темы */
[data-bs-theme="dark"] .user-dropdown {
    background: var(--bs-dark);
    border-color: var(--bs-border-color);
}

[data-bs-theme="dark"] .user-dropdown-header {
    background: var(--bs-dark);
    border-color: var(--bs-border-color);
}

[data-bs-theme="dark"] .user-item {
    border-color: var(--bs-border-color);
}

[data-bs-theme="dark"] .user-item:hover {
    background-color: var(--bs-primary);
}

/* Стили для поиска */
#user_search:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Анимации */
.user-dropdown {
    animation: fadeIn 0.15s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<script>
document.getElementById('form-create-material').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    name: form.name.value,
    unit: form.unit.value,
    description: form.description.value,
    current_quantity: form.current_quantity.value,
    min_quantity: form.min_quantity.value
  };
  const resp = await fetch('{{ url_for('supply.api_materials_create') }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (resp.ok) location.reload(); else alert('Ошибка сохранения материала');
});

document.getElementById('form-movement').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);
  const resp = await fetch('{{ url_for('supply.api_create_movement') }}', {
    method: 'POST',
    body: fd
  });
  if (resp.ok) location.reload(); else alert('Ошибка проведения движения');
});

// Функция для компактного выбора пользователей
function createUserSelector() {
  const searchInput = document.getElementById('user_search');
  const usersList = document.getElementById('users_list');
  const hiddenInput = document.getElementById('to_user_id');
  const dropdown = document.getElementById('user_dropdown');
  const selectedDisplay = document.getElementById('selected_user_display');
  const selectedName = document.getElementById('selected_user_name');
  let allUsers = [];
  let filteredUsers = [];
  let searchTimeout;

  // Загрузка всех пользователей
  async function loadAllUsers() {
    try {
      const response = await fetch('{{ url_for('supply.api_get_all_users') }}');
      
      if (response.status === 403) {
        usersList.innerHTML = '<div class="text-warning p-3">Недостаточно прав для просмотра пользователей</div>';
        return;
      }
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      allUsers = await response.json();
      filteredUsers = [...allUsers];
      
      // Показываем сообщение если пользователей нет
      if (allUsers.length === 0) {
        usersList.innerHTML = '<div class="text-muted text-center py-3">Пользователи не найдены в системе</div>';
      }
    } catch (error) {
      console.error('Ошибка загрузки пользователей:', error);
      usersList.innerHTML = '<div class="text-danger p-3">Ошибка загрузки пользователей: ' + error.message + '</div>';
    }
  }

  // Отображение пользователей
  function renderUsers() {
    usersList.innerHTML = '';
    
    if (filteredUsers.length === 0) {
      usersList.innerHTML = '<div class="text-muted text-center py-3">Пользователи не найдены</div>';
      return;
    }

    // Показываем только первые 20 результатов для производительности
    const displayUsers = filteredUsers.slice(0, 20);
    
    displayUsers.forEach(user => {
      const userItem = document.createElement('div');
      userItem.className = 'user-item';
      
      const userInfo = document.createElement('div');
      userInfo.className = 'user-info';
      userInfo.innerHTML = `
        <div class="user-name">${user.name}</div>
        <div class="user-login">${user.login}</div>
      `;
      
      const roleBadge = document.createElement('span');
      roleBadge.className = 'user-role';
      roleBadge.textContent = user.role || 'Не указана';
      
      userItem.appendChild(userInfo);
      userItem.appendChild(roleBadge);
      
      userItem.addEventListener('click', () => {
        selectUser(user);
      });
      
      usersList.appendChild(userItem);
    });

    // Показываем информацию о количестве результатов
    if (filteredUsers.length > 20) {
      const moreInfo = document.createElement('div');
      moreInfo.className = 'text-muted text-center py-2';
      moreInfo.style.fontSize = '0.8rem';
      moreInfo.textContent = `Показано 20 из ${filteredUsers.length} результатов`;
      usersList.appendChild(moreInfo);
    }
  }

  // Выбор пользователя
  function selectUser(user) {
    hiddenInput.value = user.id;
    selectedName.textContent = user.display;
    selectedDisplay.style.display = 'block';
    searchInput.value = '';
    dropdown.style.display = 'none';
  }

  // Очистка выбора
  window.clearUserSelection = function() {
    hiddenInput.value = '';
    selectedDisplay.style.display = 'none';
    searchInput.value = '';
    dropdown.style.display = 'none';
  };

  // Поиск пользователей
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.toLowerCase().trim();
    
    if (query.length < 2) {
      dropdown.style.display = 'none';
      return;
    }

    searchTimeout = setTimeout(() => {
      filteredUsers = allUsers.filter(user => {
        const nameMatch = user.name.toLowerCase().includes(query);
        const loginMatch = user.login.toLowerCase().includes(query);
        const roleMatch = user.role && user.role.toLowerCase().includes(query);
        
        return nameMatch || loginMatch || roleMatch;
      });
      
      renderUsers();
      dropdown.style.display = 'block';
    }, 200);
  });

  // Показать всех пользователей при фокусе
  searchInput.addEventListener('focus', function() {
    if (this.value.length < 2 && allUsers.length > 0) {
      filteredUsers = [...allUsers];
      renderUsers();
      dropdown.style.display = 'block';
    }
  });

  // Скрыть dropdown при клике вне его
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });

  // Инициализация
  loadAllUsers();
}

// Инициализация выбора пользователей
createUserSelector();
</script>
{% endblock %}


