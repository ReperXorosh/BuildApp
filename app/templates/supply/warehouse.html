{% extends "main/layout.html" %}
{% set active_page = 'supply' %}

{% block title %}Склад{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top: 80px;">
    <!-- Заголовок с кнопками -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-boxes me-2"></i>Склад</h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#movementModal">
                        <i class="bi bi-arrow-left-right me-1"></i>Перемещение
                    </button>
                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#receiptModal">
                        <i class="bi bi-plus-circle me-1"></i>Поступление
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMaterialModal">
                        <i class="bi bi-plus me-1"></i>Добавить позицию
                    </button>
                </div>
                <div class="btn-group ms-2" role="group">
                    <a href="{{ url_for('supply.warehouse_movements') }}" class="btn btn-outline-info">
                        <i class="bi bi-clock-history me-1"></i>История
                    </a>
                    <a href="{{ url_for('supply.warehouse_allocations') }}" class="btn btn-outline-warning">
                        <i class="bi bi-people me-1"></i>Распределение
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Поиск и таблица позиций -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="card-title mb-0">Позиции на складе</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Поиск по названию позиции...">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Название</th>
                                    <th>Ед. изм.</th>
                                    <th>Количество</th>
                                    <th>Мин. запас</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="materials-table">
                                <!-- Данные будут загружены через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления позиции -->
<div class="modal fade" id="addMaterialModal" tabindex="-1" aria-labelledby="addMaterialModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMaterialModalLabel">Добавить позицию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-create-material">
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Название</label>
                            <input class="form-control" name="name" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Ед. изм.</label>
                            <input class="form-control" name="unit" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="current_quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Мин. запас</label>
                            <input type="number" class="form-control" name="min_quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="submitAddMaterial()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для перемещения -->
<div class="modal fade" id="movementModal" tabindex="-1" aria-labelledby="movementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="movementModalLabel">Движение по складу</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-movement">
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Тип операции <span class="text-danger">*</span></label>
                            <select class="form-select" name="movement_type" id="movement_type" required onchange="onMovementTypeChange()">
                                <option value="">Выберите тип операции</option>
                                <option value="move">Выдача</option>
                                <option value="return">Возврат</option>
                                <option value="writeoff">Списание</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Материал <span class="text-danger">*</span></label>
                            <select class="form-select" name="material_id" id="material_id" required onchange="onMaterialChange()">
                                <option value="">Сначала выберите тип операции</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-6" id="user-selection-container" style="display: none;">
                            <label class="form-label" id="user-label">Пользователь</label>
                            <select class="form-select" name="to_user_id" id="to_user_id">
                                <option value="">Выберите пользователя...</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Примечание</label>
                            <input class="form-control" name="note">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Вложение (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted">Прикрепите документ к движению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitMovement()">Провести</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для поступления -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">Поступление на склад</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-receipt">
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Наименование</label>
                            <input class="form-control" name="name" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Ед. изм.</label>
                            <input class="form-control" name="unit" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Накладная (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted">Прикрепите накладную к поступлению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitReceipt()">Провести поступление</button>
            </div>
        </div>
    </div>
</div>

<script>
// Загрузка материалов в таблицу
async function loadMaterials() {
  try {
    const response = await fetch('{{ url_for("supply.api_materials") }}');
    const materials = await response.json();
    
    const tbody = document.getElementById('materials-table');
    tbody.innerHTML = '';
    
    materials.forEach(material => {
      const row = document.createElement('tr');
      
      // Определяем статус
      let statusBadge = '';
      if (material.current_quantity <= 0) {
        statusBadge = '<span class="badge bg-danger">Нет в наличии</span>';
      } else if (material.current_quantity <= material.min_quantity) {
        statusBadge = '<span class="badge bg-warning">Низкий запас</span>';
      } else {
        statusBadge = '<span class="badge bg-success">В наличии</span>';
      }
      
      row.innerHTML = `
        <td>${material.name}</td>
        <td>${material.unit}</td>
        <td>${material.current_quantity || 0}</td>
        <td>${material.min_quantity || 0}</td>
        <td>${statusBadge}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editMaterial('${material.id}')">
            <i class="bi bi-pencil"></i>
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Ошибка загрузки материалов:', error);
  }
}

// Обработка изменения типа операции
async function onMovementTypeChange() {
  const movementType = document.getElementById('movement_type').value;
  const materialSelect = document.getElementById('material_id');
  const userContainer = document.getElementById('user-selection-container');
  const userLabel = document.getElementById('user-label');
  const userSelect = document.getElementById('to_user_id');
  
  // Очищаем предыдущие выборы
  materialSelect.innerHTML = '<option value="">Загрузка материалов...</option>';
  userSelect.innerHTML = '<option value="">Выберите пользователя...</option>';
  
  if (!movementType) {
    materialSelect.innerHTML = '<option value="">Сначала выберите тип операции</option>';
    userContainer.style.display = 'none';
    return;
  }
  
  // Показываем/скрываем выбор пользователя в зависимости от типа операции
  if (movementType === 'writeoff') {
    userContainer.style.display = 'none';
    userSelect.required = false;
  } else {
    userContainer.style.display = 'block';
    userSelect.required = true;
    
    // Обновляем лейбл в зависимости от типа операции
    if (movementType === 'move') {
      userLabel.textContent = 'Кому выдать';
    } else if (movementType === 'return') {
      userLabel.textContent = 'От кого возврат';
    }
  }
  
  // Загружаем материалы
  await loadMaterialsForMovementType(movementType);
}

// Загрузка материалов в зависимости от типа операции
async function loadMaterialsForMovementType(movementType) {
  try {
    const response = await fetch('{{ url_for("supply.api_materials") }}');
    const materials = await response.json();
    
    const select = document.getElementById('material_id');
    select.innerHTML = '<option value="">Выберите материал</option>';
    
    materials.forEach(material => {
      const option = document.createElement('option');
      option.value = material.id;
      
      if (movementType === 'move' || movementType === 'writeoff') {
        // Для выдачи и списания показываем доступное количество на складе
        option.textContent = `${material.name} (${material.current_quantity || 0} ${material.unit})`;
      } else if (movementType === 'return') {
        // Для возврата показываем, что материал есть на складе
        option.textContent = `${material.name} (${material.unit})`;
      }
      
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Ошибка загрузки материалов:', error);
    document.getElementById('material_id').innerHTML = '<option value="">Ошибка загрузки материалов</option>';
  }
}

// Обработка изменения материала
async function onMaterialChange() {
  const materialId = document.getElementById('material_id').value;
  const movementType = document.getElementById('movement_type').value;
  const userSelect = document.getElementById('to_user_id');
  
  if (!materialId || !movementType) {
    userSelect.innerHTML = '<option value="">Сначала выберите материал</option>';
    return;
  }
  
  // Загружаем пользователей в зависимости от типа операции и материала
  await loadUsersForMovement(movementType, materialId);
}

// Загрузка пользователей для движения
async function loadUsersForMovement(movementType, materialId) {
  const userSelect = document.getElementById('to_user_id');
  userSelect.innerHTML = '<option value="">Загрузка пользователей...</option>';
  
  try {
    let response;
    
    if (movementType === 'move') {
      // Для выдачи загружаем всех пользователей
      response = await fetch('{{ url_for("supply.api_get_all_users") }}');
    } else if (movementType === 'return') {
      // Для возврата загружаем только пользователей, у которых есть этот материал
      response = await fetch(`{{ url_for("supply.api_material_allocations") }}?material_id=${materialId}`);
    }
    
    if (!response || !response.ok) {
      throw new Error('Ошибка загрузки пользователей');
    }
    
    const users = await response.json();
    userSelect.innerHTML = '<option value="">Выберите пользователя...</option>';
    
    if (users.length === 0) {
      if (movementType === 'return') {
        userSelect.innerHTML = '<option value="">У пользователей нет этого материала</option>';
      } else {
        userSelect.innerHTML = '<option value="">Пользователи не найдены</option>';
      }
      return;
    }
    
    users.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      
      if (movementType === 'return' && user.quantity !== undefined) {
        // Для возврата показываем количество у пользователя
        option.textContent = `${user.name || user.login} (${user.quantity} ${user.material_unit || ''})`;
      } else {
        // Для выдачи показываем только имя
        option.textContent = user.name || user.login;
      }
      
      userSelect.appendChild(option);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки пользователей:', error);
    userSelect.innerHTML = '<option value="">Ошибка загрузки пользователей</option>';
  }
}

// Поиск по материалам
function filterMaterials() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const rows = document.querySelectorAll('#materials-table tr');
  
  rows.forEach(row => {
    const name = row.cells[0]?.textContent.toLowerCase() || '';
    if (name.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// Очистка поиска
function clearSearch() {
  document.getElementById('searchInput').value = '';
  filterMaterials();
}

// Отправка формы добавления материала
async function submitAddMaterial() {
  const form = document.getElementById('form-create-material');
  const formData = new FormData(form);
  
  const payload = {
    name: formData.get('name'),
    unit: formData.get('unit'),
    description: formData.get('description'),
    current_quantity: formData.get('current_quantity'),
    min_quantity: formData.get('min_quantity')
  };
  
  try {
    const response = await fetch('{{ url_for("supply.api_materials_create") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      bootstrap.Modal.getInstance(document.getElementById('addMaterialModal')).hide();
      form.reset();
      loadMaterials();
      // Материалы теперь загружаются динамически при выборе типа операции
    } else {
      alert('Ошибка сохранения материала');
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка сохранения материала');
  }
}

// Отправка формы перемещения
async function submitMovement() {
  const form = document.getElementById('form-movement');
  const formData = new FormData(form);
  
  // Определяем правильные поля в зависимости от типа операции
  const movementType = formData.get('movement_type');
  const userId = formData.get('to_user_id');
  
  if (movementType === 'return' && userId) {
    // Для возврата используем from_user_id вместо to_user_id
    formData.delete('to_user_id');
    formData.set('from_user_id', userId);
  } else if (movementType === 'writeoff') {
    // Для списания убираем пользователя
    formData.delete('to_user_id');
  }
  
  try {
    const response = await fetch('{{ url_for("supply.api_create_movement") }}', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      bootstrap.Modal.getInstance(document.getElementById('movementModal')).hide();
      form.reset();
      // Сбрасываем состояние формы
      document.getElementById('user-selection-container').style.display = 'none';
      document.getElementById('material_id').innerHTML = '<option value="">Сначала выберите тип операции</option>';
      loadMaterials();
    } else {
      const error = await response.json();
      alert('Ошибка проведения движения: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка проведения движения');
  }
}

// Отправка формы поступления
async function submitReceipt() {
  const form = document.getElementById('form-receipt');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('{{ url_for("supply.api_create_receipt") }}', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
      form.reset();
      loadMaterials();
      // Материалы теперь загружаются динамически при выборе типа операции
      alert('Поступление успешно проведено');
    } else {
      const error = await response.json();
      alert('Ошибка проведения поступления: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка проведения поступления');
  }
}

// Простая загрузка пользователей в select
async function loadUsersToSelect() {
  const select = document.getElementById('to_user_id');
  
  try {
    const response = await fetch('{{ url_for("supply.api_get_all_users") }}');
    
    if (response.status === 403) {
      select.innerHTML = '<option value="">Недостаточно прав для просмотра пользователей</option>';
      return;
    }
    
    if (!response.ok) {
      select.innerHTML = '<option value="">Ошибка загрузки пользователей (HTTP ' + response.status + ')</option>';
      return;
    }
    
    const users = await response.json();
    
    if (users.length === 0) {
      select.innerHTML = '<option value="">Пользователи не найдены в системе</option>';
      return;
    }
    
    select.innerHTML = '<option value="">Выберите пользователя...</option>';
    
    users.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = `${user.name} (${user.login}) - ${user.role}`;
      select.appendChild(option);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки пользователей:', error);
    select.innerHTML = '<option value="">Ошибка загрузки пользователей: ' + error.message + '</option>';
  }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  loadMaterials();
  
  // Поиск
  document.getElementById('searchInput').addEventListener('input', filterMaterials);
});
</script>
{% endblock %}