{% extends "main/layout.html" %}
{% set active_page = 'supply' %}

{% block title %}Склад{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top: 80px;">
    <!-- Заголовок с кнопками -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4" 
                 data-user-role="{{ current_user.role }}" 
                 data-can-delete="{% if current_user.role in ['Инженер ПТО', 'Ген.Директор'] %}true{% else %}false{% endif %}">
                <h2><i class="bi bi-boxes me-2"></i>Склад</h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#movementModal">
                        <i class="bi bi-arrow-left-right me-1"></i>Перемещение
                    </button>
                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#receiptModal">
                        <i class="bi bi-plus-circle me-1"></i>Поступление
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMaterialModal">
                        <i class="bi bi-plus me-1"></i>Добавить позицию
                    </button>
                </div>
                <div class="btn-group ms-2" role="group">
                    <a href="{{ url_for('supply.warehouse_movements') }}" class="btn btn-outline-info">
                        <i class="bi bi-clock-history me-1"></i>История
                    </a>
                    <a href="{{ url_for('supply.warehouse_allocations') }}" class="btn btn-outline-warning">
                        <i class="bi bi-people me-1"></i>Распределение
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Поиск и таблица позиций -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="card-title mb-0">Позиции на складе</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Поиск по названию позиции...">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Название</th>
                                    <th>Ед. изм.</th>
                                    <th>Количество</th>
                                    <th>Мин. запас</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="materials-table">
                                <!-- Данные будут загружены через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления позиции -->
<div class="modal fade" id="addMaterialModal" tabindex="-1" aria-labelledby="addMaterialModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMaterialModalLabel">Добавить позицию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-create-material">
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Название</label>
                            <input class="form-control" name="name" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Ед. изм.</label>
                            <input class="form-control" name="unit" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="current_quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Мин. запас</label>
                            <input type="number" class="form-control" name="min_quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="submitAddMaterial()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для перемещения -->
<div class="modal fade" id="movementModal" tabindex="-1" aria-labelledby="movementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="movementModalLabel">Движение по складу</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-movement">
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Тип операции <span class="text-danger">*</span></label>
                            <select class="form-select" name="movement_type" id="movement_type" required onchange="onMovementTypeChange()">
                                <option value="">Выберите тип операции</option>
                                <option value="move">Выдача</option>
                                <option value="return">Возврат</option>
                                <option value="writeoff">Списание</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Материал <span class="text-danger">*</span></label>
                            <select class="form-select" name="material_id" id="material_id" required onchange="onMaterialChange()">
                                <option value="">Сначала выберите тип операции</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="quantity" id="movement_quantity" step="0.01" min="0" required>
                                <span class="input-group-text" id="movement_unit">шт</span>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">Доступно: <span id="available_quantity" class="text-primary fw-bold">0</span></small>
                                <small class="text-warning" id="quantity_warning" style="display: none;">Количество ограничено доступным</small>
                            </div>
                        </div>
                        <div class="col-6" id="user-selection-container" style="display: none;">
                            <label class="form-label" id="user-label">Пользователь</label>
                            <select class="form-select" name="to_user_id" id="to_user_id">
                                <option value="">Выберите пользователя...</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Примечание</label>
                            <input class="form-control" name="note">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Вложение (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted">Прикрепите документ к движению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitMovement()">Провести</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для поступления -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">Поступление на склад</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-receipt">
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Наименование</label>
                            <input class="form-control" name="name" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Ед. изм.</label>
                            <input class="form-control" name="unit" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Накладная (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted">Прикрепите накладную к поступлению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitReceipt()">Провести поступление</button>
            </div>
        </div>
    </div>
</div>

<script>
console.log('=== СКРИПТ ЗАГРУЖЕН ===');

// Загрузка материалов в таблицу
async function loadMaterials() {
  console.log('=== НАЧИНАЕМ ЗАГРУЗКУ МАТЕРИАЛОВ ===');
  try {
    const response = await fetch('{{ url_for("supply.api_materials") }}');
    const materials = await response.json();
    console.log('=== МАТЕРИАЛЫ ЗАГРУЖЕНЫ ===', materials);
    
    const tbody = document.getElementById('materials-table');
    tbody.innerHTML = '';
    
    materials.forEach(material => {
      const row = document.createElement('tr');
      row.className = 'clickable-row';
      row.style.cursor = 'pointer';
      row.setAttribute('data-material-id', material.id);
      row.setAttribute('data-no-pjax', 'true');
      console.log('Создана строка для материала:', material.id, material.name); // Для отладки
      
      // Добавляем обработчик клика прямо к строке
      row.addEventListener('click', function(e) {
        // Проверяем, не кликнули ли в ячейке с кнопками
        if (e.target.closest('.no-click')) {
          console.log('=== КЛИК В ОБЛАСТИ КНОПОК, ИГНОРИРУЕМ ===');
          return; // Не обрабатываем клик в области кнопок
        }
        
        console.log('=== КЛИК ПО СТРОКЕ ===', material.id);
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        setTimeout(() => {
          console.log('=== ПЕРЕХОД К МАТЕРИАЛУ ===', material.id);
          window.location.href = `/supply/warehouse/material/${material.id}`;
        }, 100);
      });
      
      // Определяем статус
      let statusBadge = '';
      if (material.current_quantity <= 0) {
        statusBadge = '<span class="badge bg-danger">Нет в наличии</span>';
      } else if (material.current_quantity <= material.min_quantity) {
        statusBadge = '<span class="badge bg-warning">Низкий запас</span>';
      } else {
        statusBadge = '<span class="badge bg-success">В наличии</span>';
      }
      
      // Определяем, может ли пользователь удалять материалы (только админы)
      const canDelete = document.querySelector('[data-can-delete]').getAttribute('data-can-delete') === 'true';
      
      let actionsHtml = `
        <button class="btn btn-sm btn-outline-primary action-button" onclick="event.stopPropagation(); event.stopImmediatePropagation(); editMaterial('${material.id}'); return false;" title="Редактировать" data-no-pjax>
          <i class="bi bi-pencil"></i>
        </button>
      `;
      
      if (canDelete) {
        actionsHtml += `
          <button class="btn btn-sm btn-outline-danger ms-1 action-button" onclick="event.stopPropagation(); event.stopImmediatePropagation(); deleteMaterial('${material.id}'); return false;" title="Удалить" data-no-pjax>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M10 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M14 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        `;
      }
      
      row.innerHTML = `
        <td>${material.name}</td>
        <td>${material.unit}</td>
        <td>${material.current_quantity || 0}</td>
        <td>${material.min_quantity || 0}</td>
        <td>${statusBadge}</td>
        <td class="no-click">
          ${actionsHtml}
        </td>
      `;
      
      // Добавляем обработчики событий к кнопкам после создания
      const editBtn = row.querySelector('.btn-outline-primary');
      const deleteBtn = row.querySelector('.btn-outline-danger');
      
      if (editBtn) {
        editBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          e.stopImmediatePropagation();
          console.log('=== КЛИК ПО КНОПКЕ РЕДАКТИРОВАНИЯ ===');
          editMaterial(material.id);
          return false;
        });
      }
      
      if (deleteBtn) {
        deleteBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          e.stopImmediatePropagation();
          console.log('=== КЛИК ПО КНОПКЕ УДАЛЕНИЯ ===');
          deleteMaterial(material.id);
          return false;
        });
      }
      
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Ошибка загрузки материалов:', error);
  }
}

// Обработка изменения типа операции
async function onMovementTypeChange() {
  const movementType = document.getElementById('movement_type').value;
  const materialSelect = document.getElementById('material_id');
  const userContainer = document.getElementById('user-selection-container');
  const userLabel = document.getElementById('user-label');
  const userSelect = document.getElementById('to_user_id');
  
  // Очищаем предыдущие выборы
  materialSelect.innerHTML = '<option value="">Загрузка материалов...</option>';
  userSelect.innerHTML = '<option value="">Выберите пользователя...</option>';
  
  // Сбрасываем поля количества
  const quantityInput = document.getElementById('movement_quantity');
  const unitSpan = document.getElementById('movement_unit');
  const availableQuantitySpan = document.getElementById('available_quantity');
  const warningSpan = document.getElementById('quantity_warning');
  
  if (quantityInput) {
    quantityInput.value = '';
    quantityInput.max = '';
  }
  if (unitSpan) unitSpan.textContent = 'шт';
  if (availableQuantitySpan) availableQuantitySpan.textContent = '0';
  if (warningSpan) warningSpan.style.display = 'none';
  
  if (!movementType) {
    materialSelect.innerHTML = '<option value="">Сначала выберите тип операции</option>';
    userContainer.style.display = 'none';
    return;
  }
  
  // Показываем/скрываем выбор пользователя в зависимости от типа операции
  if (movementType === 'writeoff') {
    userContainer.style.display = 'none';
    userSelect.required = false;
  } else {
    userContainer.style.display = 'block';
    userSelect.required = true;
    
    // Обновляем лейбл в зависимости от типа операции
    if (movementType === 'move') {
      userLabel.textContent = 'Кому выдать';
    } else if (movementType === 'return') {
      userLabel.textContent = 'От кого возврат';
    }
  }
  
  // Загружаем материалы
  await loadMaterialsForMovementType(movementType);
}

// Загрузка материалов в зависимости от типа операции
async function loadMaterialsForMovementType(movementType) {
  try {
    const response = await fetch('{{ url_for("supply.api_materials") }}');
    const materials = await response.json();
    
    const select = document.getElementById('material_id');
    select.innerHTML = '<option value="">Выберите материал</option>';
    
    materials.forEach(material => {
      const option = document.createElement('option');
      option.value = material.id;
      
      if (movementType === 'move' || movementType === 'writeoff') {
        // Для выдачи и списания показываем доступное количество на складе
        option.textContent = `${material.name} (${material.current_quantity || 0} ${material.unit})`;
      } else if (movementType === 'return') {
        // Для возврата показываем, что материал есть на складе
        option.textContent = `${material.name} (${material.unit})`;
      }
      
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Ошибка загрузки материалов:', error);
    document.getElementById('material_id').innerHTML = '<option value="">Ошибка загрузки материалов</option>';
  }
}

// Обработка изменения материала
async function onMaterialChange() {
  const materialId = document.getElementById('material_id').value;
  const movementType = document.getElementById('movement_type').value;
  const userSelect = document.getElementById('to_user_id');
  const quantityInput = document.getElementById('movement_quantity');
  const unitSpan = document.getElementById('movement_unit');
  const availableQuantitySpan = document.getElementById('available_quantity');
  const warningSpan = document.getElementById('quantity_warning');
  
  // Сбрасываем поля
  quantityInput.value = '';
  quantityInput.max = '';
  warningSpan.style.display = 'none';
  
  if (!materialId || !movementType) {
    userSelect.innerHTML = '<option value="">Сначала выберите материал</option>';
    availableQuantitySpan.textContent = '0';
    unitSpan.textContent = 'шт';
    return;
  }
  
  // Получаем информацию о материале
  try {
    const response = await fetch('{{ url_for("supply.api_materials") }}');
    const materials = await response.json();
    const material = materials.find(m => m.id === materialId);
    
    if (material) {
      unitSpan.textContent = material.unit;
      
      // Определяем доступное количество в зависимости от типа операции
      let availableQuantity = 0;
      if (movementType === 'move' || movementType === 'writeoff') {
        // Для выдачи и списания - количество на складе
        availableQuantity = material.current_quantity || 0;
      } else if (movementType === 'return') {
        // Для возврата - количество у выбранного пользователя
        const userId = userSelect.value;
        if (userId) {
          // Будет обновлено при выборе пользователя
          availableQuantity = 0;
        } else {
          availableQuantity = 0;
        }
      }
      
      availableQuantitySpan.textContent = availableQuantity;
      
      // Устанавливаем максимальное значение для поля ввода
      if (movementType === 'move' || movementType === 'writeoff') {
        quantityInput.max = availableQuantity;
      }
    }
  } catch (error) {
    console.error('Ошибка загрузки информации о материале:', error);
  }
  
  // Загружаем пользователей в зависимости от типа операции и материала
  await loadUsersForMovement(movementType, materialId);
}

// Загрузка пользователей для движения
async function loadUsersForMovement(movementType, materialId) {
  const userSelect = document.getElementById('to_user_id');
  userSelect.innerHTML = '<option value="">Загрузка пользователей...</option>';
  
  try {
    let response;
    
    if (movementType === 'move') {
      // Для выдачи загружаем всех пользователей
      response = await fetch('{{ url_for("supply.api_get_all_users") }}');
    } else if (movementType === 'return') {
      // Для возврата загружаем только пользователей, у которых есть этот материал
      response = await fetch(`{{ url_for("supply.api_material_allocations") }}?material_id=${materialId}`);
    }
    
    if (!response || !response.ok) {
      throw new Error('Ошибка загрузки пользователей');
    }
    
    const users = await response.json();
    userSelect.innerHTML = '<option value="">Выберите пользователя...</option>';
    
    if (users.length === 0) {
      if (movementType === 'return') {
        userSelect.innerHTML = '<option value="">У пользователей нет этого материала</option>';
      } else {
        userSelect.innerHTML = '<option value="">Пользователи не найдены</option>';
      }
      return;
    }
    
    users.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      
      if (movementType === 'return' && user.quantity !== undefined) {
        // Для возврата показываем количество у пользователя
        option.textContent = `${user.name || user.login} (${user.quantity} ${user.material_unit || ''})`;
        option.dataset.quantity = user.quantity; // Сохраняем количество для использования
      } else {
        // Для выдачи показываем только имя
        option.textContent = user.name || user.login;
      }
      
      userSelect.appendChild(option);
    });
    
    // Добавляем обработчик изменения пользователя для возврата
    if (movementType === 'return') {
      userSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const quantityInput = document.getElementById('movement_quantity');
        const availableQuantitySpan = document.getElementById('available_quantity');
        
        if (selectedOption && selectedOption.dataset.quantity) {
          const userQuantity = parseFloat(selectedOption.dataset.quantity);
          availableQuantitySpan.textContent = userQuantity;
          quantityInput.max = userQuantity;
        } else {
          availableQuantitySpan.textContent = '0';
          quantityInput.max = '0';
        }
      });
    }
    
  } catch (error) {
    console.error('Ошибка загрузки пользователей:', error);
    userSelect.innerHTML = '<option value="">Ошибка загрузки пользователей</option>';
  }
}

// Поиск по материалам
function filterMaterials() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const rows = document.querySelectorAll('#materials-table tr');
  
  rows.forEach(row => {
    const name = row.cells[0]?.textContent.toLowerCase() || '';
    if (name.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// Очистка поиска
function clearSearch() {
  document.getElementById('searchInput').value = '';
  filterMaterials();
}

// Отправка формы добавления материала
async function submitAddMaterial() {
  const form = document.getElementById('form-create-material');
  const formData = new FormData(form);
  
  const payload = {
    name: formData.get('name'),
    unit: formData.get('unit'),
    description: formData.get('description'),
    current_quantity: formData.get('current_quantity'),
    min_quantity: formData.get('min_quantity')
  };
  
  try {
    const response = await fetch('{{ url_for("supply.api_materials_create") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      bootstrap.Modal.getInstance(document.getElementById('addMaterialModal')).hide();
      form.reset();
      loadMaterials();
      // Материалы теперь загружаются динамически при выборе типа операции
    } else {
      alert('Ошибка сохранения материала');
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка сохранения материала');
  }
}

// Отправка формы перемещения
async function submitMovement() {
  const form = document.getElementById('form-movement');
  const formData = new FormData(form);
  
  // Определяем правильные поля в зависимости от типа операции
  const movementType = formData.get('movement_type');
  const userId = formData.get('to_user_id');
  
  if (movementType === 'return' && userId) {
    // Для возврата используем from_user_id вместо to_user_id
    formData.delete('to_user_id');
    formData.set('from_user_id', userId);
  } else if (movementType === 'writeoff') {
    // Для списания убираем пользователя
    formData.delete('to_user_id');
  }
  
  try {
    const response = await fetch('{{ url_for("supply.api_create_movement") }}', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      bootstrap.Modal.getInstance(document.getElementById('movementModal')).hide();
      form.reset();
      // Сбрасываем состояние формы
      document.getElementById('user-selection-container').style.display = 'none';
      document.getElementById('material_id').innerHTML = '<option value="">Сначала выберите тип операции</option>';
      loadMaterials();
    } else {
      const error = await response.json();
      alert('Ошибка проведения движения: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка проведения движения');
  }
}

// Отправка формы поступления
async function submitReceipt() {
  const form = document.getElementById('form-receipt');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('{{ url_for("supply.api_create_receipt") }}', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
      form.reset();
      loadMaterials();
      // Материалы теперь загружаются динамически при выборе типа операции
      alert('Поступление успешно проведено');
    } else {
      const error = await response.json();
      alert('Ошибка проведения поступления: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка проведения поступления');
  }
}

// Простая загрузка пользователей в select
async function loadUsersToSelect() {
  const select = document.getElementById('to_user_id');
  
  try {
    const response = await fetch('{{ url_for("supply.api_get_all_users") }}');
    
    if (response.status === 403) {
      select.innerHTML = '<option value="">Недостаточно прав для просмотра пользователей</option>';
      return;
    }
    
    if (!response.ok) {
      select.innerHTML = '<option value="">Ошибка загрузки пользователей (HTTP ' + response.status + ')</option>';
      return;
    }
    
    const users = await response.json();
    
    if (users.length === 0) {
      select.innerHTML = '<option value="">Пользователи не найдены в системе</option>';
      return;
    }
    
    select.innerHTML = '<option value="">Выберите пользователя...</option>';
    
    users.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = `${user.name} (${user.login}) - ${user.role}`;
      select.appendChild(option);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки пользователей:', error);
    select.innerHTML = '<option value="">Ошибка загрузки пользователей: ' + error.message + '</option>';
  }
}

// Удаление материала
async function deleteMaterial(materialId) {
  if (!confirm('Вы уверены, что хотите удалить эту позицию? Это действие нельзя отменить.')) {
    return;
  }
  
  try {
    const response = await fetch(`{{ url_for("supply.api_materials") }}/${materialId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      loadMaterials(); // Перезагружаем таблицу
      alert('Позиция успешно удалена');
    } else {
      const error = await response.json();
      alert('Ошибка удаления позиции: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка удаления позиции');
  }
}

// Обработчик изменения количества
function setupQuantityValidation() {
  const quantityInput = document.getElementById('movement_quantity');
  const warningSpan = document.getElementById('quantity_warning');
  
  if (quantityInput) {
    quantityInput.addEventListener('input', function() {
      const value = parseFloat(this.value) || 0;
      const max = parseFloat(this.max) || 0;
      
      if (max > 0 && value > max) {
        // Ограничиваем ввод максимальным значением
        this.value = max;
        warningSpan.style.display = 'block';
        warningSpan.textContent = `Количество ограничено доступным (${max})`;
      } else {
        warningSpan.style.display = 'none';
      }
    });
    
    quantityInput.addEventListener('blur', function() {
      const value = parseFloat(this.value) || 0;
      const max = parseFloat(this.max) || 0;
      
      if (max > 0 && value > max) {
        this.value = max;
        warningSpan.style.display = 'block';
        warningSpan.textContent = `Количество ограничено доступным (${max})`;
      }
    });
  }
}

// Функция редактирования материала
function editMaterial(materialId) {
  // Пока что просто показываем сообщение
  alert('Функция редактирования материала будет добавлена позже');
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== DOM ЗАГРУЖЕН, НАЧИНАЕМ ИНИЦИАЛИЗАЦИЮ ===');
  loadMaterials();
  setupQuantityValidation();
  
  // Поиск
  document.getElementById('searchInput').addEventListener('input', filterMaterials);
  
  // Обработчик клика по строкам таблицы (добавляем после загрузки DOM)
  // Используем capture: true для перехвата события раньше других обработчиков
  document.addEventListener('click', function(e) {
    console.log('=== КЛИК ОБНАРУЖЕН ===');
    console.log('Клик по элементу:', e.target);
    console.log('Класс элемента:', e.target.className);
    
    const clickableRow = e.target.closest('.clickable-row');
    console.log('Найденная строка:', clickableRow);
    
    if (clickableRow) {
      console.log('=== НАЙДЕНА КЛИКАБЕЛЬНАЯ СТРОКА ===');
      const materialId = clickableRow.getAttribute('data-material-id');
      console.log('ID материала:', materialId);
      
      if (materialId) {
        console.log('=== ПЕРЕХОД К МАТЕРИАЛУ ===');
        console.log('URL:', `/supply/warehouse/material/${materialId}`);
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        // Используем setTimeout для задержки перехода
        setTimeout(() => {
          console.log('=== ВЫПОЛНЯЕМ ПЕРЕХОД ===');
          window.location.replace(`/supply/warehouse/material/${materialId}`);
        }, 100);
        
        return false;
      }
    }
    console.log('=== КЛИК НЕ ОБРАБОТАН ===');
  }, true); // Используем capture: true
  
  // Дополнительный простой обработчик для отладки
  document.addEventListener('click', function(e) {
    console.log('=== ПРОСТОЙ КЛИК ===', e.target.tagName, e.target.className);
  });
});
</script>

<style>
.clickable-row {
  transition: background-color 0.2s ease, transform 0.1s ease;
}

.action-button {
  cursor: pointer !important;
}

.clickable-row svg,
.clickable-row path {
  cursor: pointer !important;
}

.no-click {
  cursor: default !important;
}

.no-click * {
  cursor: pointer !important;
}

.clickable-row:hover {
  background-color: rgba(0, 123, 255, 0.1) !important;
  transform: scale(1.01);
}

.clickable-row:active {
  transform: scale(0.99);
}

/* Адаптивные стили для мобильных устройств */
@media (max-width: 768px) {
  .table-responsive {
    font-size: 0.875rem;
  }
  
  .clickable-row td {
    padding: 0.5rem 0.25rem;
  }
  
  .btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }
  
  .badge {
    font-size: 0.7rem;
  }
}

@media (max-width: 576px) {
  .table-responsive {
    font-size: 0.8rem;
  }
  
  .clickable-row td {
    padding: 0.375rem 0.125rem;
  }
  
  .btn-group-sm .btn {
    padding: 0.2rem 0.4rem;
    font-size: 0.7rem;
  }
  
  .badge {
    font-size: 0.65rem;
  }
}
</style>
{% endblock %}