{% extends "main/layout.html" %}
{% set active_page = 'supply' %}

{% block title %}Склад{% endblock %}

{% block content %}
<div class="container-fluid" style="margin-top: 80px;">
    <!-- Заголовок с кнопками -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4" 
                 data-user-role="{{ current_user.role }}" 
                 data-can-delete="{% if current_user.role == 'Инженер ПТО' %}true{% else %}false{% endif %}">
                
                <!-- Заголовок -->
                <div class="mb-3 mb-lg-0">
                    <h2 class="mb-0">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-2">
                            <path d="M20 7L4 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 12H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M8 16H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Склад
                    </h2>
                </div>
                
                <!-- Кнопки действий: только для Снабженец и Инженер ПТО -->
                {% if current_user.role in ['Инженер ПТО', 'Снабженец'] %}
                <div class="d-flex flex-wrap gap-1">
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMaterialModal">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-1" style="vertical-align: middle;">
                            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="d-none d-sm-inline">Добавить позицию</span>
                        <span class="d-inline d-sm-none">Добавить</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#receiptModal">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-1" style="vertical-align: middle;">
                            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="d-none d-sm-inline">Поступление</span>
                        <span class="d-inline d-sm-none">Поступление</span>
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#movementModal">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-1" style="vertical-align: middle;">
                            <path d="M8 17L4 21L0 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M4 21V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16 7L20 3L24 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="d-none d-sm-inline">Перемещение</span>
                        <span class="d-inline d-sm-none">Перемещение</span>
                    </button>
                    <a href="{{ url_for('supply.warehouse_allocations') }}" class="btn btn-outline-primary btn-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-1" style="vertical-align: middle;">
                            <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89317 18.7122 8.75608 18.1676 9.45768C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="d-none d-sm-inline">Распределение</span>
                        <span class="d-inline d-sm-none">Люди</span>
                    </a>
                    <a href="{{ url_for('supply.warehouse_movements') }}" class="btn btn-outline-primary btn-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-1" style="vertical-align: middle;">
                            <path d="M3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="d-none d-sm-inline">История</span>
                        <span class="d-inline d-sm-none">История</span>
                    </a>
                    {% if current_user.role == 'Инженер ПТО' %}
                    <button type="button" class="btn btn-outline-primary btn-sm" id="toggleHiddenMaterials" title="Показать/скрыть удаленные материалы">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-1" style="vertical-align: middle;">
                            <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="d-none d-sm-inline">Скрытые</span>
                        <span class="d-inline d-sm-none">Скрытые</span>
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Поиск/таблица и боковая панель групп -->
    <div class="row">
        <div class="col-12 col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="card-title mb-0">Позиции на складе</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Поиск по названию позиции...">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Название</th>
                                    <th class="text-center">Ед. изм.</th>
                                    <th class="text-center">Количество</th>
                                    <th class="text-center">Мин. запас</th>
                                    <th>Статус</th>
                            {% if current_user.role in ['Инженер ПТО', 'Снабженец'] %}
                            <th>Действия</th>
                            {% endif %}
                                </tr>
                            </thead>
                            <tbody id="materials-table">
                                <!-- Данные будут загружены через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% if True %}
        <div class="col-12 col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Группы</h5>
                    {% if current_user.role in ['Инженер ПТО', 'Снабженец'] %}
                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">Новая группа</button>
                    {% endif %}
                </div>
                <div class="card-body" style="max-height: 70vh; overflow:auto;">
                    <div id="groupsList" class="list-group mb-3">
                        <!-- группы загружаются через JS -->
                    </div>
                    <div id="groupItems" style="display:none;">
                        <div id="groupItemsList" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if current_user.role in ['Инженер ПТО', 'Снабженец'] %}
<!-- Модалка добавления позиции в группу -->
<div class="modal fade" id="addToGroupModal" tabindex="-1" aria-labelledby="addToGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addToGroupModalLabel">Добавить в группу</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="addToGroupMaterialId">
        <div class="mb-3">
          <label class="form-label">Группа <span class="text-danger">*</span></label>
          <select id="addToGroupSelect" class="form-select">
            <option value="">Выберите группу...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" onclick="submitAddMaterialToGroup()">Добавить</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Модалка создания группы -->
{% if current_user.role in ['Инженер ПТО', 'Снабженец'] %}
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createGroupModalLabel">Новая группа</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Название группы <span class="text-danger">*</span></label>
          <input id="groupNameInput" class="form-control" maxlength="120" placeholder="Введите название группы">
        </div>
        <div class="mb-3">
          <label class="form-label">Описание</label>
          <textarea id="groupDescriptionInput" class="form-control" rows="3" placeholder="Необязательно"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" onclick="submitCreateGroup()">Создать</button>
      </div>
    </div>
  </div>
 </div>
{% endif %}

<!-- Модальное окно для добавления позиции -->
<div class="modal fade" id="addMaterialModal" tabindex="-1" aria-labelledby="addMaterialModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMaterialModalLabel">Добавить позицию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-create-material">
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Название</label>
                            <input class="form-control" name="name" id="material-name-input" required>
                            <div id="material-exists-info" class="form-text text-info" style="display: none;">
                                <i class="bi bi-info-circle"></i> Материал уже существует на складе
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Ед. изм.</label>
                            <input class="form-control" name="unit" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="current_quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Мин. запас</label>
                            <input type="number" class="form-control" name="min_quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="col-12" id="reason-field" style="display: none;">
                            <label class="form-label">Причина добавления существующей позиции? <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="addition_reason" rows="2" placeholder="Укажите причину пополнения существующего материала..."></textarea>
                            <small class="form-text text-muted">Обязательно укажите причину пополнения существующего материала</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="submitAddMaterial()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для перемещения -->
<div class="modal fade" id="movementModal" tabindex="-1" aria-labelledby="movementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="movementModalLabel">Движение по складу</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-movement">
                    <div class="row">
                        <div class="col-6">
                            <label class="form-label">Тип операции <span class="text-danger">*</span></label>
                            <select class="form-select" name="movement_type" id="movement_type" required onchange="onMovementTypeChange()">
                                <option value="">Выберите тип операции</option>
                                <option value="move">Выдача</option>
                                <option value="return">Возврат</option>
                                <option value="writeoff">Списание</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Материал <span class="text-danger">*</span></label>
                            <!-- Сам "аккордеон" выступает поиском: input с datalist стилизован под select -->
                            <input class="form-select" id="material_picker" list="materials_list" placeholder="Начните вводить название..." onchange="onMaterialPicked()" oninput="onMaterialTyped()">
                            <datalist id="materials_list"></datalist>
                            <input type="hidden" name="material_id" id="material_id">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="quantity" id="movement_quantity" step="0.01" min="0" required>
                                <span class="input-group-text" id="movement_unit">шт</span>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">Доступно: <span id="available_quantity" class="text-primary fw-bold">0</span></small>
                                <small class="text-warning" id="quantity_warning" style="display: none;">Количество ограничено доступным</small>
                            </div>
                        </div>
                        <div class="col-6" id="user-selection-container" style="display: none;">
                            <label class="form-label" id="user-label">Пользователь</label>
                            <select class="form-select" name="to_user_id" id="to_user_id">
                                <option value="">Выберите пользователя...</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Примечание</label>
                            <input class="form-control" name="note">
                        </div>
                        <div class="col-12">
                            <label class="form-label" id="file-label">Вложение (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file" id="movement-file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted" id="file-help">Прикрепите документ к движению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitMovement()">Провести</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для поступления -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receiptModalLabel">Поступление на склад</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-receipt">
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Наименование</label>
                            <input class="form-control" name="name" id="receipt-name-input" required>
                            <div id="receipt-exists-info" class="form-text text-info" style="display: none;">
                                <i class="bi bi-info-circle"></i> Материал уже существует на складе
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Ед. изм.</label>
                            <input class="form-control" name="unit" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Количество</label>
                            <input type="number" class="form-control" name="quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Накладная (файл) <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                            <small class="form-text text-muted">Прикрепите накладную к поступлению (обязательно)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="submitReceipt()">Провести поступление</button>
            </div>
        </div>
    </div>
</div>

<!-- Определяем права пользователя для управления материалами -->
<script>
window.userCanManageMaterials = /*{% if current_user.role in ['Инженер ПТО', 'Снабженец'] %}*/true/*{% else %}false{% endif %}*/;
</script>

<script>
console.log('=== СКРИПТ ЗАГРУЖЕН ===');

// Переменная для отслеживания режима просмотра
let showHiddenMaterials = false;
let materialsCache = [];
let groupsCache = [];
// Материалы, которые уже состоят в каких-либо группах (для скрытия кнопки "+")
let materialsInGroups = new Set();
// ---------------- ГРУППЫ МАТЕРИАЛОВ ----------------
async function refreshMaterialsInGroups() {
  // Не блокируем UI: ограничиваем таймаутом и выполняем запросы параллельно
  const withTimeout = (p, ms = 5000) => Promise.race([
    p,
    new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), ms))
  ]);
  try {
    const resGroups = await withTimeout(fetch('/supply/api/supply/groups'));
    const groups = await resGroups.json();
    if (!Array.isArray(groups) || groups.length === 0) {
      materialsInGroups = new Set();
      return;
    }
    const itemPromises = groups.map(g =>
      withTimeout(fetch(`/supply/api/supply/groups/${g.id}/items`).then(r => r.json()).catch(() => []), 5000)
        .catch(() => [])
    );
    const results = await Promise.allSettled(itemPromises);
    const agg = new Set();
    results.forEach(r => {
      if (r.status === 'fulfilled' && Array.isArray(r.value)) {
        r.value.forEach(it => it && it.material_id && agg.add(it.material_id));
      }
    });
    materialsInGroups = agg;
  } catch (e) {
    console.warn('refreshMaterialsInGroups failed', e);
    materialsInGroups = new Set();
  }
}
async function submitCreateGroup() {
  const nameEl = document.getElementById('groupNameInput');
  const descEl = document.getElementById('groupDescriptionInput');
  const name = (nameEl?.value || '').trim();
  const description = (descEl?.value || '').trim();
  if (!name) { alert('Введите название группы'); return; }
  try {
    const res = await fetch('/supply/api/supply/groups', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, description }) });
    const data = await res.json();
    if (!res.ok) { alert(data.error || 'Ошибка'); return; }
    const modalEl = document.getElementById('createGroupModal');
    if (modalEl) {
      const m = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      m.hide();
    }
    if (nameEl) nameEl.value = '';
    if (descEl) descEl.value = '';
    loadGroups();
  } catch (e) { console.error(e); alert('Ошибка связи с сервером'); }
}
async function loadGroups() {
  try {
    const res = await fetch('/supply/api/supply/groups');
    if (!res.ok) return;
    const groups = await res.json();
    const list = document.getElementById('groupsList');
    if (!list) return;
    list.innerHTML = '';
    if (!Array.isArray(groups) || groups.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'text-muted';
      empty.textContent = 'Группы не созданы';
      list.appendChild(empty);
      return;
    }
    groupsCache = groups;
    console.log('GROUPS LOADED', groupsCache);
    groups.forEach(g => {
      const a = document.createElement('a');
      a.href = 'javascript:void(0)';
      a.className = 'list-group-item list-group-item-action';
    a.innerHTML = `<span>${g.name}</span>` +
      `{% if current_user.role in ['Инженер ПТО', 'Снабженец'] %}` +
      `<button class="btn btn-sm btn-outline-danger float-end" title="Удалить группу" onclick="event.stopPropagation(); deleteGroup('${g.id}')">×</button>` +
      `{% endif %}`;
      a.dataset.groupId = g.id;
      list.appendChild(a);
    });
    // Делегирование кликов по списку групп
    list.onclick = function(e) {
      const item = e.target.closest('.list-group-item');
      if (!item) return;
      const gid = item.dataset.groupId;
      const g = (groupsCache || []).find(x => String(x.id) === String(gid));
      console.log('GROUP CLICK', gid, g);
      if (g) toggleGroup(g, item);
    };
  } catch (e) { console.error(e); }
}

function closeGroup() {
  const panel = document.getElementById('groupItems');
  if (panel) panel.style.display = 'none';
}

async function openGroup(container, group) {
  container.dataset.groupId = group.id;
  await reloadGroupItemsInto(container, group.id);
}

function toggleGroup(group, anchorEl) {
  const next = anchorEl.nextElementSibling;
  if (next && next.classList.contains('group-items')) {
    next.remove();
    return;
  }
  document.querySelectorAll('#groupsList .group-items').forEach(el => el.remove());
  const container = document.createElement('div');
  container.className = 'group-items';
  container.innerHTML = '<div class="py-2 text-muted">Загрузка...</div>';
  anchorEl.after(container);
  console.log('TOGGLE -> OPEN', group);
  openGroup(container, group);
}

async function reloadGroupItemsInto(container, groupId) {
  try {
    container.innerHTML = '<div class="py-2 text-muted">Загрузка...</div>';
    const res = await fetch(`/supply/api/supply/groups/${groupId}/items`);
    const items = await res.json();
    // Обновляем множество материалов в группах (по всем группам)
    await refreshMaterialsInGroups();
    container.innerHTML = '';
    // Контейнер списка
    const listEl = document.createElement('div');
    listEl.className = 'list-group';
    // Убираем закругления у контейнера аккордеона
    listEl.style.borderRadius = '0';
    listEl.style.borderTop = 'none';
    container.appendChild(listEl);
    if (!Array.isArray(items) || items.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'text-muted py-2';
      empty.textContent = 'В группе пока нет материалов';
      listEl.appendChild(empty);
      return;
    }
    items.forEach(i => {
      const row = document.createElement('div');
      row.className = 'list-group-item d-flex justify-content-between align-items-center group-item-row';
      // Убираем закругления у элементов списка
      row.style.borderRadius = '0';
      row.style.borderTop = 'none';
      const mat = (materialsCache || []).find(m => m.id === i.material_id);
      const label = mat ? mat.name : i.material_id;
      row.innerHTML = `<span class=\"group-item-link\" onclick=\"viewMaterial('${i.material_id}')\" style=\"cursor:pointer;\">${label}</span>` +
        `{% if current_user.role in ['Инженер ПТО', 'Снабженец'] %}` +
        `<button class=\"btn btn-sm btn-outline-danger\" onclick=\"removeFromGroup('${i.material_id}','${groupId}')\">Убрать</button>` +
        `{% endif %}`;
      listEl.appendChild(row);
      // dataset.label использовался для поиска, временно не нужен
    });
    // Поиск временно отключён по запросу — без обработчиков
  } catch (e) {
    console.error(e);
    container.innerHTML = '<div class="py-2 text-danger">Ошибка загрузки состава группы</div>';
  }
}

// Удаление группы
async function deleteGroup(groupId) {
  if (!groupId) return;
  if (!confirm('Удалить группу и все связи? Действие необратимо для связей (материалы останутся на складе).')) return;
  try {
    const res = await fetch(`/supply/api/supply/groups/${groupId}`, { method: 'DELETE' });
    let data = {};
    try { data = await res.json(); } catch {}
    if (!res.ok) { alert((data && data.error) || 'Ошибка удаления группы'); return; }
    // Обновляем список групп и множество материалов в группах
    await loadGroups();
    await refreshMaterialsInGroups();
    // Если был открыт аккордеон этой группы — закроем его
    document.querySelectorAll('#groupsList .group-items').forEach(el => el.remove());
    // Обновим таблицу материалов, чтобы пересчитать иконку "+"
    loadMaterials();
  } catch (e) {
    console.error(e);
    alert('Ошибка связи с сервером');
  }
}

// Удалили функцию добавления по ID — панель групп теперь только для просмотра

async function removeFromGroup(materialId, groupIdFromBtn) {
  if (!confirm('Удалить позицию из этой группы? Действие обратимо (позиция останется на складе).')) {
    return;
  }
  const groupId = groupIdFromBtn || document.getElementById('groupItems')?.dataset?.groupId || document.querySelector('#groupsList .group-items')?.dataset?.groupId;
  try {
    const res = await fetch(`/supply/api/supply/groups/${groupId}/items`, {method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({material_id: materialId})});
    let data = {};
    try { data = await res.json(); } catch {}
    if (!res.ok) { alert((data && data.error) || 'Ошибка удаления'); return; }
    // Обновить текущий аккордеон
    const container = document.querySelector(`#groupsList .group-items[data-group-id="${groupId}"]`) || document.querySelector('#groupsList .group-items');
    if (container) { await reloadGroupItemsInto(container, groupId); }
  } catch (e) { console.error(e); }
}

// Открыть модалку добавления в группу
function openAddToGroupModal(materialId) {
  const sel = document.getElementById('addToGroupSelect');
  const hid = document.getElementById('addToGroupMaterialId');
  if (hid) hid.value = materialId;
  if (sel) {
    sel.innerHTML = '<option value="">Загрузка...</option>';
    fetch('/supply/api/supply/groups').then(r => r.json()).then(groups => {
      sel.innerHTML = '<option value="">Выберите группу...</option>';
      groups.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        sel.appendChild(opt);
      });
    }).catch(() => { sel.innerHTML = '<option value="">Ошибка загрузки групп</option>'; });
  }
  const el = document.getElementById('addToGroupModal');
  if (el) (bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el)).show();
}

// Подтвердить добавление материала в выбранную группу
async function submitAddMaterialToGroup() {
  const materialId = document.getElementById('addToGroupMaterialId').value;
  const groupId = document.getElementById('addToGroupSelect').value;
  if (!groupId) { alert('Выберите группу'); return; }
  try {
    const res = await fetch(`/supply/api/supply/groups/${groupId}/items`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({material_id: materialId})
    });
    // Сервер может вернуть 204 No Content — обрабатываем безопасно
    let data = null;
    try {
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        data = await res.json();
      } else {
        await res.text();
      }
    } catch (_) { /* ignore parse errors for empty body */ }
    if (!res.ok) { alert((data && data.error) || 'Ошибка'); return; }
    // Обновить множество, скрыть плюс для этой строки, перезагрузить состав группы
    materialsInGroups.add(materialId);
    loadMaterials();
    // Перезагружаем раскрытую группу, если она открыта
    try {
      const container = document.querySelector(`#groupsList .group-items[data-group-id="${groupId}"]`) || document.querySelector('#groupsList .group-items');
      if (container) { await reloadGroupItemsInto(container, groupId); }
    } catch (_) {}
    const el = document.getElementById('addToGroupModal');
    if (el) (bootstrap.Modal.getInstance(el) || new bootstrap.Modal(el)).hide();
  } catch (e) { console.error(e); alert('Ошибка связи с сервером'); }
}

// Загрузка материалов в таблицу
async function loadMaterials() {
  console.log('=== НАЧИНАЕМ ЗАГРУЗКУ МАТЕРИАЛОВ ===');
  
  // Определяем права пользователя для управления материалами
  const userCanManageMaterials = window.userCanManageMaterials || false;
  
  try {
    const url = showHiddenMaterials ? '{{ url_for("supply.api_materials_all") }}' : '{{ url_for("supply.api_materials") }}';
    const response = await fetch(url);
    const tbody = document.getElementById('materials-table');
    if (!response.ok) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Ошибка загрузки списка (HTTP ' + response.status + ')</td></tr>';
      return;
    }
    let materials = await response.json();
    materialsCache = Array.isArray(materials) ? materials : [];
    console.log('=== МАТЕРИАЛЫ ЗАГРУЖЕНЫ ===', materials);
    
    tbody.innerHTML = '';
    
    if (!Array.isArray(materials)) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Данные материалов в неверном формате</td></tr>';
      return;
    }
    if (materials.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Позиции отсутствуют</td></tr>';
      return;
    }
    materials.forEach(material => {
      const row = document.createElement('tr');
      row.setAttribute('data-material-id', material.id);
      
      // Добавляем класс для скрытых материалов
      if (!material.is_active) {
        row.classList.add('hidden-material');
      }
      
      console.log('Создана строка для материала:', material.id, material.name, 'активен:', material.is_active); // Для отладки
      
      // Определяем статус
      let statusBadge = '';
      if (material.current_quantity <= 0) {
        statusBadge = '<span class="badge bg-danger">Нет в наличии</span>';
      } else if (material.current_quantity <= material.min_quantity) {
        statusBadge = '<span class="badge bg-warning">Низкий запас</span>';
      } else {
        statusBadge = '<span class="badge bg-success">В наличии</span>';
      }
      
      // Определяем, может ли пользователь удалять материалы (только Инженер ПТО)
      const canDelete = document.querySelector('[data-can-delete]')?.getAttribute('data-can-delete') === 'true';
      
      let actionsHtml = `
        <button class="btn btn-sm btn-outline-primary action-button" onclick="event.stopPropagation(); event.stopImmediatePropagation(); editMaterial('${material.id}'); return false;" title="Редактировать" data-no-pjax>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M18.5 2.50023C18.8978 2.10297 19.4374 1.8789 20 1.8789C20.5626 1.8789 21.1022 2.10297 21.5 2.50023C21.8978 2.89749 22.1219 3.43708 22.1219 4.00023C22.1219 4.56338 21.8978 5.10297 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      `;
      
      if (canDelete) {
        if (material.is_active) {
          // Кнопка скрытия для активных материалов
          actionsHtml += `
            <button class="btn btn-sm btn-outline-warning ms-1 action-button" onclick="event.stopPropagation(); event.stopImmediatePropagation(); deleteMaterial('${material.id}'); return false;" title="Скрыть материал" data-no-pjax>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          `;
          
          // Кнопка полного удаления для активных материалов (только для админов)
          actionsHtml += `
            <button class="btn btn-sm btn-outline-danger ms-1 action-button" onclick="event.stopPropagation(); event.stopImmediatePropagation(); hardDeleteMaterial('${material.id}'); return false;" title="Полное удаление (необратимо)" data-no-pjax>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M14 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          `;
        } else {
          // Кнопка восстановления для скрытых материалов
          actionsHtml += `
            <button class="btn btn-sm btn-outline-success ms-1 action-button" onclick="event.stopPropagation(); event.stopImmediatePropagation(); restoreMaterial('${material.id}'); return false;" title="Восстановить" data-no-pjax>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M2 2L22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          `;
          
          // Кнопка полного удаления для скрытых материалов (только для админов)
          actionsHtml += `
            <button class="btn btn-sm btn-outline-danger ms-1 action-button" onclick="event.stopPropagation(); event.stopImmediatePropagation(); hardDeleteMaterial('${material.id}'); return false;" title="Полное удаление (необратимо)" data-no-pjax>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M14 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          `;
        }
      }
      // Плюс "добавить в группу" если материал не в группе (только для определенных ролей)
      if (userCanManageMaterials && !materialsInGroups.has(material.id)) {
        actionsHtml += `
          <button class="btn btn-sm btn-outline-success ms-1 action-button" title="Добавить в группу" onclick="event.stopPropagation(); event.stopImmediatePropagation(); openAddToGroupModal('${material.id}')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>`;
      }
      
      row.innerHTML = `
        <td>
          <span class="material-name-clickable" 
                data-material-id="${material.id}"
                onclick="viewMaterial('${material.id}')" 
                title="Нажмите для просмотра подробной информации"
                style="cursor: pointer; color: #0d6efd; text-decoration: underline;">
            ${material.name}
          </span>
        </td>
        <td class="text-center">${material.unit}</td>
        <td class="text-center">${material.current_quantity || 0}</td>
        <td class="text-center">${material.min_quantity || 0}</td>
        <td>${statusBadge}</td>
        ${userCanManageMaterials ? `<td>${actionsHtml}</td>` : ''}
      `;
      
      
      // Вставляем собранные действия (только для определенных ролей)
      if (userCanManageMaterials) {
        const cells = row.querySelectorAll('td');
        if (cells && cells.length) {
          cells[cells.length - 1].innerHTML = actionsHtml;
        }
      }
      tbody.appendChild(row);
    });
    // Применяем фильтр только если в поле есть текст
    const q = (document.getElementById('searchInput')?.value || '').trim();
    if (q.length > 0) { filterMaterials(); }
  } catch (error) {
    console.error('Ошибка загрузки материалов:', error);
  }
}

function copyMaterialId(fullId) {
  if (!fullId) return;
  navigator.clipboard?.writeText(fullId).catch(() => {});
}

// Обработка изменения типа операции
async function onMovementTypeChange() {
  const movementType = document.getElementById('movement_type').value;
  const materialSelect = document.getElementById('material_id');
  const userContainer = document.getElementById('user-selection-container');
  const userLabel = document.getElementById('user-label');
  const userSelect = document.getElementById('to_user_id');
  
  // Очищаем предыдущие выборы
  materialSelect.innerHTML = '<option value="">Загрузка материалов...</option>';
  userSelect.innerHTML = '<option value="">Выберите пользователя...</option>';
  
  // Сбрасываем поля количества
  const quantityInput = document.getElementById('movement_quantity');
  const unitSpan = document.getElementById('movement_unit');
  const availableQuantitySpan = document.getElementById('available_quantity');
  const warningSpan = document.getElementById('quantity_warning');
  
  if (quantityInput) {
    quantityInput.value = '';
    quantityInput.max = '';
  }
  if (unitSpan) unitSpan.textContent = 'шт';
  if (availableQuantitySpan) availableQuantitySpan.textContent = '0';
  if (warningSpan) warningSpan.style.display = 'none';
  
  if (!movementType) {
    materialSelect.innerHTML = '<option value="">Сначала выберите тип операции</option>';
    userContainer.style.display = 'none';
    return;
  }
  
  // Показываем/скрываем выбор пользователя в зависимости от типа операции
  if (movementType === 'writeoff') {
    userContainer.style.display = 'none';
    userSelect.required = false;
  } else {
    userContainer.style.display = 'block';
    userSelect.required = true;
    
    // Обновляем лейбл в зависимости от типа операции
    if (movementType === 'move') {
      userLabel.textContent = 'Кому выдать';
    } else if (movementType === 'return') {
      userLabel.textContent = 'От кого возврат';
    }
  }
  
  // Управляем обязательностью файла
  const fileInput = document.getElementById('movement-file');
  const fileLabel = document.getElementById('file-label');
  const fileHelp = document.getElementById('file-help');
  
  if (movementType === 'writeoff') {
    // Только для списания файл не обязателен
    fileInput.required = false;
    fileLabel.innerHTML = 'Вложение (файл)';
    fileHelp.textContent = 'Прикрепите документ к движению (необязательно)';
  } else {
    // Для выдачи и возврата файл обязателен (по умолчанию)
    fileInput.required = true;
    fileLabel.innerHTML = 'Вложение (файл) <span class="text-danger">*</span>';
    fileHelp.textContent = 'Прикрепите документ к движению (обязательно)';
  }
  
  // Загружаем материалы
  await loadMaterialsForMovementType(movementType);
}

// Загрузка материалов в зависимости от типа операции
async function loadMaterialsForMovementType(movementType) {
  try {
    let response;
    let materials;
    
    if (movementType === 'return') {
      // Для возврата загружаем все материалы, которые есть у пользователей
      response = await fetch('{{ url_for("supply.api_materials_for_return") }}');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      materials = await response.json();
      console.log('DEBUG: Материалы для возврата:', materials);
      
      if (materials.error) {
        console.error('DEBUG: Ошибка API:', materials.error);
        throw new Error(materials.error);
      }
    } else {
      // Для выдачи и списания загружаем только материалы на складе
      response = await fetch('{{ url_for("supply.api_materials") }}');
      materials = await response.json();
    }
    
    const datalist = document.getElementById('materials_list');
    const picker = document.getElementById('material_picker');
    const hiddenId = document.getElementById('material_id');
    if (datalist) datalist.innerHTML = '';
    
    // сохраним для локального поиска
    window._movementMaterials = materials.map(m => ({
      id: m.id,
      name: m.name,
      unit: m.unit,
      current_quantity: m.current_quantity,
      total_allocated: m.total_allocated
    }));
    // заполним datalist вариантами для автодополнения
    if (datalist) {
      window._movementMaterials.forEach(m => {
        const opt = document.createElement('option');
        if (movementType === 'move' || movementType === 'writeoff') {
          opt.value = `${m.name} (${m.current_quantity || 0} ${m.unit})`;
        } else if (movementType === 'return') {
          opt.value = `${m.name} (у пользователей: ${m.total_allocated || 0} ${m.unit})`;
        } else {
          opt.value = m.name;
        }
        opt.dataset.id = m.id;
        datalist.appendChild(opt);
      });
    }
    if (picker) picker.value = '';
    if (hiddenId) hiddenId.value = '';
  } catch (error) {
    console.error('Ошибка загрузки материалов:', error);
  }
}

// Обработка изменения материала
async function onMaterialChange() {
  const materialId = document.getElementById('material_id').value;
  const movementType = document.getElementById('movement_type').value;
  const userSelect = document.getElementById('to_user_id');
  const quantityInput = document.getElementById('movement_quantity');
  const unitSpan = document.getElementById('movement_unit');
  const availableQuantitySpan = document.getElementById('available_quantity');
  const warningSpan = document.getElementById('quantity_warning');
  
  // Сбрасываем поля
  quantityInput.value = '';
  quantityInput.max = '';
  warningSpan.style.display = 'none';
  
  if (!materialId || !movementType) {
    userSelect.innerHTML = '<option value="">Сначала выберите материал</option>';
    availableQuantitySpan.textContent = '0';
    unitSpan.textContent = 'шт';
    return;
  }
  
  // Получаем информацию о материале
  try {
    const response = await fetch('{{ url_for("supply.api_materials") }}');
    const materials = await response.json();
    const material = materials.find(m => m.id === materialId);
    
    if (material) {
      unitSpan.textContent = material.unit;
      
      // Определяем доступное количество в зависимости от типа операции
      let availableQuantity = 0;
      if (movementType === 'move' || movementType === 'writeoff') {
        // Для выдачи и списания - количество на складе
        availableQuantity = material.current_quantity || 0;
      } else if (movementType === 'return') {
        // Для возврата - количество у выбранного пользователя
        const userId = userSelect.value;
        if (userId) {
          // Будет обновлено при выборе пользователя
          availableQuantity = 0;
        } else {
          availableQuantity = 0;
        }
      }
      
      availableQuantitySpan.textContent = availableQuantity;
      
      // Устанавливаем максимальное значение для поля ввода
      if (movementType === 'move' || movementType === 'writeoff') {
        quantityInput.max = availableQuantity;
      }
    }
  } catch (error) {
    console.error('Ошибка загрузки информации о материале:', error);
  }
  
  // Загружаем пользователей в зависимости от типа операции и материала
  await loadUsersForMovement(movementType, materialId);
}

// Обработка выбора/ввода в "аккордеоне-поиске"
function onMaterialPicked() {
  const picker = document.getElementById('material_picker');
  const hiddenId = document.getElementById('material_id');
  const list = Array.isArray(window._movementMaterials) ? window._movementMaterials : [];
  const value = (picker?.value || '').split('(')[0].trim().toLowerCase();
  const match = list.find(m => (m.name || '').toLowerCase() === value);
  hiddenId.value = match ? match.id : '';
  onMaterialChange();
}

function onMaterialTyped() {
  const picker = document.getElementById('material_picker');
  const hiddenId = document.getElementById('material_id');
  if (picker && hiddenId && picker.value.length === 0) hiddenId.value = '';
}

// Загрузка пользователей для движения
async function loadUsersForMovement(movementType, materialId) {
  const userSelect = document.getElementById('to_user_id');
  userSelect.innerHTML = '<option value="">Загрузка пользователей...</option>';
  
  try {
    let response;
    
    if (movementType === 'move') {
      // Для выдачи загружаем всех пользователей
      response = await fetch('{{ url_for("supply.api_get_all_users") }}');
    } else if (movementType === 'return') {
      // Для возврата загружаем только пользователей, у которых есть этот материал
      response = await fetch(`{{ url_for("supply.api_material_allocations") }}?material_id=${materialId}`);
    }
    
    if (!response || !response.ok) {
      throw new Error('Ошибка загрузки пользователей');
    }
    
    const users = await response.json();
    userSelect.innerHTML = '<option value="">Выберите пользователя...</option>';
    
    if (users.length === 0) {
      if (movementType === 'return') {
        userSelect.innerHTML = '<option value="">У пользователей нет этого материала</option>';
      } else {
        userSelect.innerHTML = '<option value="">Пользователи не найдены</option>';
      }
      return;
    }
    
    users.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      
      if (movementType === 'return' && user.quantity !== undefined) {
        // Для возврата показываем количество у пользователя
        option.textContent = `${user.name || user.login} (${user.quantity} ${user.material_unit || ''})`;
        option.dataset.quantity = user.quantity; // Сохраняем количество для использования
      } else {
        // Для выдачи показываем только имя
        option.textContent = user.name || user.login;
      }
      
      userSelect.appendChild(option);
    });
    
    // Добавляем обработчик изменения пользователя для возврата
    if (movementType === 'return') {
      userSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const quantityInput = document.getElementById('movement_quantity');
        const availableQuantitySpan = document.getElementById('available_quantity');
        
        if (selectedOption && selectedOption.dataset.quantity) {
          const userQuantity = parseFloat(selectedOption.dataset.quantity);
          availableQuantitySpan.textContent = userQuantity;
          quantityInput.max = userQuantity;
        } else {
          availableQuantitySpan.textContent = '0';
          quantityInput.max = '0';
        }
      });
    }
    
  } catch (error) {
    console.error('Ошибка загрузки пользователей:', error);
    userSelect.innerHTML = '<option value="">Ошибка загрузки пользователей</option>';
  }
}

// Поиск по материалам
function filterMaterials() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const rows = document.querySelectorAll('#materials-table tr');
  
  rows.forEach(row => {
    const name = row.cells[0]?.textContent.toLowerCase() || '';
    if (name.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

// Очистка поиска
function clearSearch() {
  document.getElementById('searchInput').value = '';
  filterMaterials();
}

// Отправка формы добавления материала
async function submitAddMaterial() {
  const form = document.getElementById('form-create-material');
  const formData = new FormData(form);
  
  const payload = {
    name: formData.get('name'),
    unit: formData.get('unit'),
    description: formData.get('description'),
    current_quantity: formData.get('current_quantity'),
    min_quantity: formData.get('min_quantity'),
    addition_reason: formData.get('addition_reason') || null
  };
  
  try {
    const response = await fetch('{{ url_for("supply.api_materials_create") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      const result = await response.json();
      
      // Проверяем, есть ли предупреждение о восстановлении
      if (result.warning) {
        // Показываем предупреждение пользователю
        alert(result.warning);
      } else if (result.message) {
        // Показываем сообщение о пополнении
        alert(result.message);
      }
      
      bootstrap.Modal.getInstance(document.getElementById('addMaterialModal')).hide();
      form.reset();
      hideMaterialExistsInfo(); // Скрываем информацию о существующем материале
      loadMaterials();
      // Материалы теперь загружаются динамически при выборе типа операции
    } else {
      const errorData = await response.json();
      alert(errorData.error || 'Ошибка сохранения материала');
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка сохранения материала');
  }
}

// Отправка формы перемещения
async function submitMovement() {
  const form = document.getElementById('form-movement');
  const formData = new FormData(form);
  
  // Определяем правильные поля в зависимости от типа операции
  const movementType = formData.get('movement_type');
  const userId = formData.get('to_user_id');
  
  // Проверяем обязательность файла
  const fileInput = document.getElementById('movement-file');
  if ((movementType === 'move' || movementType === 'return') && !fileInput.files || fileInput.files.length === 0) {
    alert('Для операций выдачи и возврата обязательно прикрепите файл!');
    fileInput.focus();
    return;
  }
  
  if (movementType === 'return' && userId) {
    // Для возврата используем from_user_id вместо to_user_id
    formData.delete('to_user_id');
    formData.set('from_user_id', userId);
  } else if (movementType === 'writeoff') {
    // Для списания убираем пользователя
    formData.delete('to_user_id');
  }
  
  try {
    const response = await fetch('{{ url_for("supply.api_create_movement") }}', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      const result = await response.json();
      
      // Проверяем, есть ли предупреждение о восстановлении
      if (result.warning) {
        // Показываем предупреждение пользователю
        alert(result.warning);
      }
      
      bootstrap.Modal.getInstance(document.getElementById('movementModal')).hide();
      form.reset();
      // Сбрасываем состояние формы
      document.getElementById('user-selection-container').style.display = 'none';
      document.getElementById('material_id').innerHTML = '<option value="">Сначала выберите тип операции</option>';
      loadMaterials();
    } else {
      const error = await response.json();
      alert('Ошибка проведения движения: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка проведения движения');
  }
}

// Отправка формы поступления
async function submitReceipt() {
  const form = document.getElementById('form-receipt');
  const formData = new FormData(form);
  
  try {
    const response = await fetch('{{ url_for("supply.api_create_receipt") }}', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      const result = await response.json();
      
      // Проверяем, есть ли предупреждение о восстановлении
      if (result.warning) {
        // Показываем предупреждение пользователю
        alert(result.warning);
      } else {
        alert('Поступление успешно проведено');
      }
      
      bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
      form.reset();
      hideReceiptExistsInfo(); // Скрываем информацию о существующем материале
      loadMaterials();
      // Материалы теперь загружаются динамически при выборе типа операции
    } else {
      const error = await response.json();
      alert('Ошибка проведения поступления: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка проведения поступления');
  }
}

// Простая загрузка пользователей в select
async function loadUsersToSelect() {
  const select = document.getElementById('to_user_id');
  
  try {
    const response = await fetch('{{ url_for("supply.api_get_all_users") }}');
    
    if (response.status === 403) {
      select.innerHTML = '<option value="">Недостаточно прав для просмотра пользователей</option>';
      return;
    }
    
    if (!response.ok) {
      select.innerHTML = '<option value="">Ошибка загрузки пользователей (HTTP ' + response.status + ')</option>';
      return;
    }
    
    const users = await response.json();
    
    if (users.length === 0) {
      select.innerHTML = '<option value="">Пользователи не найдены в системе</option>';
      return;
    }
    
    select.innerHTML = '<option value="">Выберите пользователя...</option>';
    
    users.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = `${user.name} (${user.login}) - ${user.role}`;
      select.appendChild(option);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки пользователей:', error);
    select.innerHTML = '<option value="">Ошибка загрузки пользователей: ' + error.message + '</option>';
  }
}

// Мягкое удаление материала (скрытие)
async function deleteMaterial(materialId) {
  if (!confirm('Вы уверены, что хотите скрыть эту позицию? Материал можно будет восстановить позже.')) {
    return;
  }
  
  try {
    const response = await fetch(`{{ url_for("supply.api_materials") }}/${materialId}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      loadMaterials(); // Перезагружаем таблицу
      alert('Позиция успешно скрыта');
    } else {
      const error = await response.json();
      alert('Ошибка скрытия позиции: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Ошибка скрытия позиции');
  }
}

// Обработчик изменения количества
function setupQuantityValidation() {
  const quantityInput = document.getElementById('movement_quantity');
  const warningSpan = document.getElementById('quantity_warning');
  
  if (quantityInput) {
    quantityInput.addEventListener('input', function() {
      const value = parseFloat(this.value) || 0;
      const max = parseFloat(this.max) || 0;
      
      if (max > 0 && value > max) {
        // Ограничиваем ввод максимальным значением
        this.value = max;
        warningSpan.style.display = 'block';
        warningSpan.textContent = `Количество ограничено доступным (${max})`;
      } else {
        warningSpan.style.display = 'none';
      }
    });
    
    quantityInput.addEventListener('blur', function() {
      const value = parseFloat(this.value) || 0;
      const max = parseFloat(this.max) || 0;
      
      if (max > 0 && value > max) {
        this.value = max;
        warningSpan.style.display = 'block';
        warningSpan.textContent = `Количество ограничено доступным (${max})`;
      }
    });
  }
}

// Функция просмотра материала
function viewMaterial(materialId) {
  console.log('=== ПЕРЕХОД К ПРОСМОТРУ МАТЕРИАЛА ===', materialId);
  window.location.href = `{{ url_for('supply.material_detail', material_id='') }}${materialId}`;
}

// Функция редактирования материала
function editMaterial(materialId) {
  // Пока что просто показываем сообщение
  alert('Функция редактирования материала будет добавлена позже');
}

// Функция восстановления материала
async function restoreMaterial(materialId) {
  if (!confirm('Вы уверены, что хотите восстановить этот материал?')) {
    return;
  }
  
  try {
    const response = await fetch(`/supply/api/supply/materials/${materialId}/restore`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    if (response.ok) {
      alert(result.message);
      loadMaterials(); // Перезагружаем список материалов
    } else {
      alert('Ошибка: ' + result.error);
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Произошла ошибка при восстановлении материала');
  }
}

// Функция полного удаления материала
async function hardDeleteMaterial(materialId) {
  const confirmMessage = 'ВНИМАНИЕ! Это действие полностью удалит материал и ВСЕ связанные с ним записи:\n\n' +
                        '• Все движения по складу\n' +
                        '• Все прикрепленные документы\n' +
                        '• Все распределения по пользователям\n' +
                        '• Все элементы заявок\n\n' +
                        'Это действие НЕОБРАТИМО!\n\n' +
                        'Вы уверены, что хотите продолжить?';
  
  if (!confirm(confirmMessage)) {
    return;
  }
  
  // Дополнительное подтверждение
  if (!confirm('Последнее предупреждение! Материал будет удален навсегда. Продолжить?')) {
    return;
  }
  
  try {
    const response = await fetch(`/supply/api/supply/materials/${materialId}/hard-delete`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    if (response.ok) {
      alert(result.message);
      loadMaterials(); // Перезагружаем список материалов
    } else {
      alert('Ошибка: ' + result.error);
    }
  } catch (error) {
    console.error('Ошибка:', error);
    alert('Произошла ошибка при полном удалении материала');
  }
}

// Функция переключения режима просмотра скрытых материалов
function toggleHiddenMaterials() {
  showHiddenMaterials = !showHiddenMaterials;
  const button = document.getElementById('toggleHiddenMaterials');
  
  if (showHiddenMaterials) {
    button.innerHTML = '<i class="bi bi-eye me-1"></i>Активные';
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-primary');
  } else {
    button.innerHTML = '<i class="bi bi-eye-slash me-1"></i>Скрытые';
    button.classList.remove('btn-primary');
    button.classList.add('btn-outline-primary');
  }
  
  loadMaterials(); // Перезагружаем список материалов
}

// Функция проверки существующего материала
async function checkExistingMaterial(name) {
  if (!name || name.length < 2) {
    hideMaterialExistsInfo();
    return;
  }
  
  try {
    const response = await fetch('{{ url_for("supply.api_materials_check") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name })
    });
    
    if (response.ok) {
      const result = await response.json();
      
      if (result.exists) {
        // Если есть точное совпадение или исправление регистра
        if (result.exact_match || result.case_corrected) {
          showMaterialExistsInfo(result.material, result.corrected_name);
        }
      } else if (result.similar_found) {
        // Если найдены похожие материалы
        showSimilarMaterials(result.similar_materials, name);
      } else {
        hideMaterialExistsInfo();
      }
    }
  } catch (error) {
    console.error('Ошибка проверки материала:', error);
  }
}

// Показать информацию о существующем материале
function showMaterialExistsInfo(material, correctedName = null) {
  const infoDiv = document.getElementById('material-exists-info');
  const unitInput = document.querySelector('input[name="unit"]');
  const minQuantityInput = document.querySelector('input[name="min_quantity"]');
  const descriptionInput = document.querySelector('textarea[name="description"]');
  const nameInput = document.getElementById('material-name-input');
  const reasonField = document.getElementById('reason-field');
  const reasonInput = document.querySelector('textarea[name="addition_reason"]');
  
  // Заполняем поля автоматически
  unitInput.value = material.unit;
  minQuantityInput.value = material.min_quantity;
  if (material.description) {
    descriptionInput.value = material.description;
  }
  
  // Если есть исправление регистра, обновляем поле названия
  if (correctedName) {
    nameInput.value = correctedName;
  }
  
  // Блокируем поля для редактирования (используем readonly вместо disabled)
  unitInput.readOnly = true;
  minQuantityInput.readOnly = true;
  descriptionInput.readOnly = true;
  
  // Показываем поле причины и делаем его обязательным
  reasonField.style.display = 'block';
  reasonInput.required = true;
  reasonInput.focus(); // Фокус на поле причины
  
  // Показываем информацию
  let message = `Материал уже существует на складе (${material.current_quantity} ${material.unit}). При сохранении количество будет пополнено. Ед. изм., мин. запас и описание заблокированы.`;
  
  if (correctedName) {
    message = `Исправлен регистр: "${correctedName}". Материал уже существует на складе (${material.current_quantity} ${material.unit}). При сохранении количество будет пополнено. Ед. изм., мин. запас и описание заблокированы.`;
  }
  
  infoDiv.innerHTML = `
    <i class="bi bi-info-circle"></i> 
    ${message}
  `;
  infoDiv.style.display = 'block';
  infoDiv.className = 'form-text text-warning';
}

// Показать похожие материалы
function showSimilarMaterials(similarMaterials, originalName) {
  const infoDiv = document.getElementById('material-exists-info');
  
  let similarList = '';
  similarMaterials.forEach((material, index) => {
    const description = (material.description || '').replace(/'/g, "\\'");
    similarList += `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span>${material.name} (${material.current_quantity} ${material.unit})</span>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectSimilarMaterial('${material.name}', '${material.unit}', ${material.min_quantity}, '${description}')">
          Выбрать
        </button>
      </div>
    `;
  });
  
  infoDiv.innerHTML = `
    <div class="alert alert-info">
      <i class="bi bi-question-circle"></i> 
      <strong>Не найдено точного совпадения для "${originalName}"</strong>
      <br>Возможно, вы имели в виду один из этих материалов:
      <div class="mt-2">
        ${similarList}
      </div>
      <div class="mt-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideMaterialExistsInfo()">
          Создать новый материал
        </button>
      </div>
    </div>
  `;
  infoDiv.style.display = 'block';
  infoDiv.className = 'form-text';
}

// Выбрать похожий материал
function selectSimilarMaterial(name, unit, minQuantity, description = '') {
  const nameInput = document.getElementById('material-name-input');
  const unitInput = document.querySelector('input[name="unit"]');
  const minQuantityInput = document.querySelector('input[name="min_quantity"]');
  const descriptionInput = document.querySelector('textarea[name="description"]');
  const reasonField = document.getElementById('reason-field');
  const reasonInput = document.querySelector('textarea[name="addition_reason"]');
  
  // Заполняем поля
  nameInput.value = name;
  unitInput.value = unit;
  minQuantityInput.value = minQuantity;
  if (description) {
    descriptionInput.value = description;
  }
  
  // Блокируем поля
  unitInput.readOnly = true;
  minQuantityInput.readOnly = true;
  descriptionInput.readOnly = true;
  
  // Показываем поле причины и делаем его обязательным
  reasonField.style.display = 'block';
  reasonInput.required = true;
  reasonInput.focus(); // Фокус на поле причины
  
  // Показываем информацию о выбранном материале
  showMaterialExistsInfo({
    name: name,
    unit: unit,
    min_quantity: minQuantity,
    description: description,
    current_quantity: 0 // Будет получено из API
  });
}

// Скрыть информацию о существующем материале
function hideMaterialExistsInfo() {
  const infoDiv = document.getElementById('material-exists-info');
  const unitInput = document.querySelector('input[name="unit"]');
  const minQuantityInput = document.querySelector('input[name="min_quantity"]');
  const descriptionInput = document.querySelector('textarea[name="description"]');
  const reasonField = document.getElementById('reason-field');
  const reasonInput = document.querySelector('textarea[name="addition_reason"]');
  
  // Разблокируем поля
  if (unitInput) {
    unitInput.readOnly = false;
  }
  if (minQuantityInput) {
    minQuantityInput.readOnly = false;
  }
  if (descriptionInput) {
    descriptionInput.readOnly = false;
  }
  
  // Скрываем поле причины и убираем обязательность
  if (reasonField) {
    reasonField.style.display = 'none';
  }
  if (reasonInput) {
    reasonInput.required = false;
    reasonInput.value = ''; // Очищаем поле
  }
  
  infoDiv.style.display = 'none';
}

// Функция проверки существующего материала для поступления
async function checkExistingMaterialForReceipt(name) {
  if (!name || name.length < 2) {
    hideReceiptExistsInfo();
    return;
  }
  
  try {
    const response = await fetch('{{ url_for("supply.api_materials_check") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name })
    });
    
    if (response.ok) {
      const result = await response.json();
      
      if (result.exists) {
        // Если есть точное совпадение или исправление регистра
        if (result.exact_match || result.case_corrected) {
          showReceiptExistsInfo(result.material, result.corrected_name);
        }
      } else if (result.similar_found) {
        // Если найдены похожие материалы
        showSimilarMaterialsForReceipt(result.similar_materials, name);
      } else {
        hideReceiptExistsInfo();
      }
    }
  } catch (error) {
    console.error('Ошибка проверки материала для поступления:', error);
  }
}

// Показать информацию о существующем материале для поступления
function showReceiptExistsInfo(material, correctedName = null) {
  const infoDiv = document.getElementById('receipt-exists-info');
  const unitInput = document.querySelector('#form-receipt input[name="unit"]');
  const nameInput = document.getElementById('receipt-name-input');
  
  // Заполняем поле единицы измерения автоматически
  unitInput.value = material.unit;
  
  // Если есть исправление регистра, обновляем поле названия
  if (correctedName) {
    nameInput.value = correctedName;
  }
  
  // Блокируем поле для редактирования (используем readonly вместо disabled)
  unitInput.readOnly = true;
  
  // Показываем информацию
  let message = `Материал уже существует на складе (${material.current_quantity} ${material.unit}). При поступлении количество будет пополнено. Ед. изм. заблокирована.`;
  
  if (correctedName) {
    message = `Исправлен регистр: "${correctedName}". Материал уже существует на складе (${material.current_quantity} ${material.unit}). При поступлении количество будет пополнено. Ед. изм. заблокирована.`;
  }
  
  infoDiv.innerHTML = `
    <i class="bi bi-info-circle"></i> 
    ${message}
  `;
  infoDiv.style.display = 'block';
  infoDiv.className = 'form-text text-warning';
}

// Показать похожие материалы для поступления
function showSimilarMaterialsForReceipt(similarMaterials, originalName) {
  const infoDiv = document.getElementById('receipt-exists-info');
  
  let similarList = '';
  similarMaterials.forEach((material, index) => {
    similarList += `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span>${material.name} (${material.current_quantity} ${material.unit})</span>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectSimilarMaterialForReceipt('${material.name}', '${material.unit}')">
          Выбрать
        </button>
      </div>
    `;
  });
  
  infoDiv.innerHTML = `
    <div class="alert alert-info">
      <i class="bi bi-question-circle"></i> 
      <strong>Не найдено точного совпадения для "${originalName}"</strong>
      <br>Возможно, вы имели в виду один из этих материалов:
      <div class="mt-2">
        ${similarList}
      </div>
      <div class="mt-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideReceiptExistsInfo()">
          Создать новый материал
        </button>
      </div>
    </div>
  `;
  infoDiv.style.display = 'block';
  infoDiv.className = 'form-text';
}

// Выбрать похожий материал для поступления
function selectSimilarMaterialForReceipt(name, unit) {
  const nameInput = document.getElementById('receipt-name-input');
  const unitInput = document.querySelector('#form-receipt input[name="unit"]');
  
  // Заполняем поля
  nameInput.value = name;
  unitInput.value = unit;
  
  // Блокируем поле
  unitInput.readOnly = true;
  
  // Показываем информацию о выбранном материале
  showReceiptExistsInfo({
    name: name,
    unit: unit,
    current_quantity: 0 // Будет получено из API
  });
}

// Скрыть информацию о существующем материале для поступления
function hideReceiptExistsInfo() {
  const infoDiv = document.getElementById('receipt-exists-info');
  const unitInput = document.querySelector('#form-receipt input[name="unit"]');
  
  // Разблокируем поле
  if (unitInput) {
    unitInput.readOnly = false;
  }
  
  infoDiv.style.display = 'none';
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== DOM ЗАГРУЖЕН, НАЧИНАЕМ ИНИЦИАЛИЗАЦИЮ ===');
  // Сначала получаем, какие материалы уже состоят в группах, чтобы корректно скрывать плюс
  refreshMaterialsInGroups().then(loadMaterials).catch(loadMaterials);
  setupQuantityValidation();
  
  // Поиск
  document.getElementById('searchInput').addEventListener('input', filterMaterials);
  
  // Кнопка переключения скрытых материалов
  const toggleButton = document.getElementById('toggleHiddenMaterials');
  if (toggleButton) {
    toggleButton.addEventListener('click', toggleHiddenMaterials);
  }
  
  // Проверка существующего материала при вводе названия
  const nameInput = document.getElementById('material-name-input');
  if (nameInput) {
    let timeoutId;
    nameInput.addEventListener('input', function() {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        checkExistingMaterial(this.value);
      }, 500); // Задержка 500мс для избежания частых запросов
    });
  }
  
  // Проверка существующего материала при вводе названия в поступлении
  const receiptNameInput = document.getElementById('receipt-name-input');
  if (receiptNameInput) {
    let receiptTimeoutId;
    receiptNameInput.addEventListener('input', function() {
      clearTimeout(receiptTimeoutId);
      receiptTimeoutId = setTimeout(() => {
        checkExistingMaterialForReceipt(this.value);
      }, 500); // Задержка 500мс для избежания частых запросов
    });
  }

  // Инициализация списка групп (доступно всем ролям на просмотр)
  loadGroups();
});
</script>

<style>
.material-name-clickable:hover {
  color: #0a58ca !important;
  text-decoration: underline !important;
}


/* Стили для скрытых материалов */
.hidden-material {
  opacity: 0.6;
  background-color: #f8f9fa !important;
}

.hidden-material td {
  color: #6c757d !important;
}

.hidden-material .material-name-clickable {
  color: #6c757d !important;
  text-decoration: line-through !important;
}

.hidden-material .badge {
  opacity: 0.7;
}

/* Адаптивные стили для мобильных устройств */
@media (max-width: 768px) {
  .table-responsive {
    font-size: 0.875rem;
  }
  
  .clickable-row td {
    padding: 0.5rem 0.25rem;
  }
  
  .btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }
  
  .badge {
    font-size: 0.7rem;
  }
}

@media (max-width: 576px) {
  .table-responsive {
    font-size: 0.8rem;
  }
  
  .clickable-row td {
    padding: 0.375rem 0.125rem;
  }
  
  .btn-group-sm .btn {
    padding: 0.2rem 0.4rem;
    font-size: 0.7rem;
  }
  
  .badge {
    font-size: 0.65rem;
  }
}
</style>
{% endblock %}