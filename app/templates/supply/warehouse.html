{% extends "main/layout.html" %}

{% block title %}Склад{% endblock %}

{% block content %}
<div class="container-fluid py-3" style="margin-top: 80px;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <svg class="bi me-2" width="24" height="24" fill="currentColor">
                        <use xlink:href="#box-seam"></use>
                    </svg>
                    Склад
                </h1>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-xl-5">
            <div class="card">
                <div class="card-header"><h6 class="mb-0">Добавить/обновить материал</h6></div>
                <div class="card-body">
                    <form id="form-create-material">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">Название</label>
                                <input class="form-control" name="name" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Ед.</label>
                                <input class="form-control" name="unit" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Количество</label>
                                <input type="number" step="0.001" class="form-control" name="current_quantity" value="0" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Мин. запас</label>
                                <input type="number" step="0.001" class="form-control" name="min_quantity" value="0">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Описание</label>
                                <textarea class="form-control" name="description"></textarea>
                            </div>
                            <div class="col-12 text-end">
                                <button class="btn btn-primary" type="submit">Сохранить</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header"><h6 class="mb-0">Движение по складу</h6></div>
                <div class="card-body">
                    <form id="form-movement" enctype="multipart/form-data">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">Материал</label>
                                <select class="form-select" name="material_id">
                                    {% for m in materials %}
                                    <option value="{{ m.id }}">{{ m.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Количество</label>
                                <input type="number" step="0.001" class="form-control" name="quantity" required>
                            </div>
                            <div class="col-3">
                                <label class="form-label">Тип</label>
                                <select class="form-select" name="movement_type">
                                    <option value="add">Поступление</option>
                                    <option value="move">Выдача</option>
                                    <option value="return">Возврат</option>
                                    <option value="writeoff">Списание</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Кому</label>
                                <div class="position-relative">
                                    <input class="form-control" id="to_user_search" placeholder="Введите имя или фамилию" autocomplete="off">
                                    <input type="hidden" name="to_user_id" id="to_user_id">
                                    <div class="dropdown-menu w-100" id="to_user_dropdown" style="display: none; max-height: 200px; overflow-y: auto;">
                                    </div>
                                </div>
                                <small class="text-muted" id="to_user_selected" style="display: none;"></small>
                                <small class="form-text">Двойной клик для очистки</small>
                            </div>
                            <div class="col-6">
                                <label class="form-label">От кого</label>
                                <div class="position-relative">
                                    <input class="form-control" id="from_user_search" placeholder="Введите имя или фамилию" autocomplete="off">
                                    <input type="hidden" name="from_user_id" id="from_user_id">
                                    <div class="dropdown-menu w-100" id="from_user_dropdown" style="display: none; max-height: 200px; overflow-y: auto;">
                                    </div>
                                </div>
                                <small class="text-muted" id="from_user_selected" style="display: none;"></small>
                                <small class="form-text">Двойной клик для очистки</small>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Примечание</label>
                                <input class="form-control" name="note">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Вложение (файл)</label>
                                <input type="file" class="form-control" name="file">
                            </div>
                            <div class="col-12 text-end">
                                <button class="btn btn-success" type="submit">Провести</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-7">
            <div class="card">
                <div class="card-header"><h6 class="mb-0">Материалы на складе</h6></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Ед.</th>
                                    <th class="text-end">Кол-во</th>
                                    <th class="text-end">Мин.</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in materials %}
                                <tr>
                                    <td>{{ m.name }}</td>
                                    <td>{{ m.unit }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-{{ 'danger' if m.current_quantity <= m.min_quantity else 'success' }}">{{ m.current_quantity }}</span>
                                    </td>
                                    <td class="text-end">{{ m.min_quantity }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header"><h6 class="mb-0">Последние движения</h6></div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Материал</th>
                                    <th>Тип</th>
                                    <th class="text-end">Кол-во</th>
                                    <th>Файл</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mv in recent_movements %}
                                <tr>
                                    <td>{{ mv.created_at }}</td>
                                    <td>{{ mv.material.name }}</td>
                                    <td>{{ mv.movement_type }}</td>
                                    <td class="text-end">{{ mv.quantity }}</td>
                                    <td>
                                        {% if mv.attachments and mv.attachments|length > 0 %}
                                            <a href="{{ url_for('supply.api_download_attachment', movement_id=mv.id, attachment_id=mv.attachments[0].id) }}" class="btn btn-sm btn-outline-secondary">Скачать</a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.dropdown-item {
    display: block;
    width: 100%;
    padding: 0.5rem 1rem;
    clear: both;
    font-weight: 400;
    color: #212529;
    text-align: inherit;
    text-decoration: none;
    white-space: nowrap;
    background-color: transparent;
    border: 0;
    cursor: pointer;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
}

.dropdown-item:focus {
    background-color: #f8f9fa;
    outline: none;
}
</style>

<script>
document.getElementById('form-create-material').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const payload = {
    name: form.name.value,
    unit: form.unit.value,
    description: form.description.value,
    current_quantity: form.current_quantity.value,
    min_quantity: form.min_quantity.value
  };
  const resp = await fetch('{{ url_for('supply.api_materials_create') }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (resp.ok) location.reload(); else alert('Ошибка сохранения материала');
});

document.getElementById('form-movement').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);
  const resp = await fetch('{{ url_for('supply.api_create_movement') }}', {
    method: 'POST',
    body: fd
  });
  if (resp.ok) location.reload(); else alert('Ошибка проведения движения');
});

// Функция для создания автокомплита пользователей
function createUserAutocomplete(inputId, hiddenId, dropdownId, selectedId) {
  const input = document.getElementById(inputId);
  const hidden = document.getElementById(hiddenId);
  const dropdown = document.getElementById(dropdownId);
  const selected = document.getElementById(selectedId);
  let searchTimeout;

  input.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length < 2) {
      dropdown.style.display = 'none';
      hidden.value = '';
      selected.style.display = 'none';
      return;
    }

    searchTimeout = setTimeout(async () => {
      try {
        const response = await fetch(`{{ url_for('supply.api_search_users') }}?q=${encodeURIComponent(query)}`);
        const users = await response.json();
        
        dropdown.innerHTML = '';
        if (users.length === 0) {
          dropdown.innerHTML = '<div class="dropdown-item text-muted">Пользователи не найдены</div>';
        } else {
          users.forEach(user => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.textContent = user.display;
            item.addEventListener('click', () => {
              input.value = user.display;
              hidden.value = user.id;
              selected.textContent = `Выбран: ${user.display}`;
              selected.style.display = 'block';
              dropdown.style.display = 'none';
            });
            dropdown.appendChild(item);
          });
        }
        dropdown.style.display = 'block';
      } catch (error) {
        console.error('Ошибка поиска пользователей:', error);
      }
    }, 300);
  });

  // Скрыть dropdown при клике вне его
  document.addEventListener('click', function(e) {
    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });

  // Очистить при фокусе
  input.addEventListener('focus', function() {
    if (this.value.length >= 2) {
      dropdown.style.display = 'block';
    }
  });

  // Очистить выбор при двойном клике
  input.addEventListener('dblclick', function() {
    this.value = '';
    hidden.value = '';
    selected.style.display = 'none';
    dropdown.style.display = 'none';
  });
}

// Инициализация автокомплитов
createUserAutocomplete('to_user_search', 'to_user_id', 'to_user_dropdown', 'to_user_selected');
createUserAutocomplete('from_user_search', 'from_user_id', 'from_user_dropdown', 'from_user_selected');
</script>
{% endblock %}


