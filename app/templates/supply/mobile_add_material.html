{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'supply' %}

{% block content %}
<div class="container-fluid px-3 py-3">
    <div class="row">
        <div class="col-12">
            <div class="mobile-card">
                <div class="mobile-card-header">
                    <h4 class="mobile-card-title">Новая позиция</h4>
                </div>
                <div class="mobile-card-body">
                    <form id="add-material-form" onsubmit="return false;">
                        <div class="mobile-form-group">
                            <label for="material-name-input" class="mobile-form-label">Название материала *</label>
                            <input type="text" 
                                   class="mobile-form-control" 
                                   id="material-name-input" 
                                   name="name" 
                                   required 
                                   maxlength="200"
                                   placeholder="Введите название материала">
                        </div>

                        <div class="mobile-form-group">
                            <label for="material-unit" class="mobile-form-label">Единица измерения *</label>
                            <input type="text" 
                                   class="mobile-form-control" 
                                   id="material-unit" 
                                   name="unit" 
                                   required 
                                   maxlength="20"
                                   placeholder="шт, м, кг и т.д.">
                        </div>

                        <div class="mobile-form-group">
                            <label for="material-quantity" class="mobile-form-label">Количество *</label>
                            <input type="number" 
                                   class="mobile-form-control" 
                                   id="material-quantity" 
                                   name="quantity" 
                                   required 
                                   min="0" 
                                   step="0.01"
                                   placeholder="0">
                        </div>

                        <div class="mobile-form-group">
                            <label for="material-min-quantity" class="mobile-form-label">Минимальный запас *</label>
                            <input type="number" 
                                   class="mobile-form-control" 
                                   id="material-min-quantity" 
                                   name="min_quantity" 
                                   required 
                                   min="0" 
                                   step="0.01"
                                   placeholder="0">
                        </div>

                        <div class="mobile-form-group">
                            <label for="material-description" class="mobile-form-label">Описание</label>
                            <textarea class="mobile-form-control" 
                                      id="material-description" 
                                      name="description" 
                                      rows="3"
                                      maxlength="500"
                                      placeholder="Дополнительная информация о материале"></textarea>
                        </div>

                        <div class="mobile-form-group">
                            <label for="material-price" class="mobile-form-label">Цена за единицу</label>
                            <input type="number" 
                                   class="mobile-form-control" 
                                   id="material-price" 
                                   name="price_per_unit" 
                                   min="0" 
                                   step="0.01"
                                   placeholder="0.00">
                        </div>

                        <div class="mobile-form-group">
                            <label for="material-file" class="mobile-form-label">Файл</label>
                            <input type="file" 
                                   class="mobile-form-control" 
                                   id="material-file" 
                                   name="file"
                                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        </div>

                        <!-- Информация о существующем материале -->
                        <div id="material-exists-info" class="form-text" style="display: none;"></div>

                        <!-- Поле причины (скрыто по умолчанию) -->
                        <div id="reason-field" class="mobile-form-group" style="display: none;">
                            <label for="addition-reason" class="mobile-form-label">Причина добавления существующей позиции *</label>
                            <textarea class="mobile-form-control" 
                                      id="addition-reason" 
                                      name="addition_reason" 
                                      rows="3"
                                      maxlength="500"
                                      placeholder="Укажите причину пополнения существующего материала..."></textarea>
                            <div class="form-text text-muted">Обязательно укажите причину пополнения существующего материала</div>
                        </div>

                        <div class="mobile-mt-4">
                            <button type="button" class="mobile-btn mobile-btn-primary w-100" id="submit-btn">Сохранить позицию</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Локальные правки для лучшей читаемости в светлой теме только на этой странице */
.mobile-card {
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.mobile-card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 20px;
    border-radius: 12px 12px 0 0;
    border-bottom: none;
}

.mobile-card-title {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.mobile-card-body {
    padding: 20px;
}

.mobile-form-group {
    margin-bottom: 16px;
}

.mobile-form-label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: #333;
    font-size: 14px;
}

.mobile-form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.mobile-form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
}

.mobile-btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.mobile-btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.mobile-btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.mobile-mt-4 {
    margin-top: 24px;
}

/* Исправление для файлового поля - предотвращение выхода за пределы */
.mobile-form-control[type="file"],
.mobile-form-control-file {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 8px 12px;
}

/* Специальные стили для группы с файлами */
.mobile-form-group-files {
    margin-bottom: 16px;
}

/* Дополнительные исправления для мобильных устройств */
@media (max-width: 768px) {
    .mobile-form-control-file {
        font-size: 14px;
        padding: 10px 12px;
    }
    
    .mobile-form-group-files {
        margin-bottom: 16px;
    }
}

/* Темная тема */
@media (prefers-color-scheme: dark) {
    .mobile-card {
        background: #2d3748;
        border-color: #4a5568;
    }
    
    .mobile-form-label {
        color: #e2e8f0;
    }
    
    .mobile-form-control {
        background: #4a5568;
        border-color: #718096;
        color: #e2e8f0;
    }
    
    .mobile-form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }
    
    .form-text.text-muted {
        color: #a0aec0 !important;
    }
}

/* Стили для предупреждений и информации */
.form-text.text-warning {
    color: #f6ad55 !important;
}

.form-text.text-info {
    color: #0dcaf0;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Копируем рабочий код с десктопной версии
async function checkExistingMaterial(name) {
  if (!name || name.length < 2) {
    hideMaterialExistsInfo();
    return;
  }
  
  try {
    const response = await fetch('{{ url_for("supply.api_materials_check") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name })
    });
    
    if (response.ok) {
      const result = await response.json();
      
      if (result.exists) {
        // Если есть точное совпадение или исправление регистра
        if (result.exact_match || result.case_corrected) {
          showMaterialExistsInfo(result.material, result.corrected_name);
        }
      } else if (result.similar_found) {
        // Если найдены похожие материалы
        showSimilarMaterials(result.similar_materials, name);
      } else {
        hideMaterialExistsInfo();
      }
    }
  } catch (error) {
    console.error('Ошибка проверки материала:', error);
  }
}

function showMaterialExistsInfo(material, correctedName = null) {
  const infoDiv = document.getElementById('material-exists-info');
  const unitInput = document.querySelector('input[name="unit"]');
  const minQuantityInput = document.querySelector('input[name="min_quantity"]');
  const descriptionInput = document.querySelector('textarea[name="description"]');
  const nameInput = document.getElementById('material-name-input');
  const reasonField = document.getElementById('reason-field');
  const reasonInput = document.querySelector('textarea[name="addition_reason"]');
  
  // Заполняем поля автоматически
  unitInput.value = material.unit;
  minQuantityInput.value = material.min_quantity;
  if (material.description) {
    descriptionInput.value = material.description;
  }
  
  // Если есть исправление регистра, обновляем поле названия
  if (correctedName) {
    nameInput.value = correctedName;
  }
  
  // Блокируем поля для редактирования (используем readonly вместо disabled)
  unitInput.readOnly = true;
  minQuantityInput.readOnly = true;
  descriptionInput.readOnly = true;
  
  // Показываем поле причины и делаем его обязательным
  reasonField.style.display = 'block';
  reasonInput.required = true;
  reasonInput.focus(); // Фокус на поле причины

  // Показываем информацию
  let message = `Материал уже существует на складе (${material.current_quantity} ${material.unit}). Поля заблокированы. Укажите причину добавления.`;
  
  if (correctedName) {
    message = `Исправлен регистр: "${correctedName}". Материал уже существует на складе (${material.current_quantity} ${material.unit}). Поля заблокированы. Укажите причину добавления.`;
  }
  
  infoDiv.innerHTML = `
    <i class="bi bi-info-circle"></i> 
    ${message}
  `;
  infoDiv.style.display = 'block';
  infoDiv.className = 'form-text text-warning';
}

function hideMaterialExistsInfo() {
  const infoDiv = document.getElementById('material-exists-info');
  const unitInput = document.querySelector('input[name="unit"]');
  const minQuantityInput = document.querySelector('input[name="min_quantity"]');
  const descriptionInput = document.querySelector('textarea[name="description"]');
  const reasonField = document.getElementById('reason-field');
  const reasonInput = document.querySelector('textarea[name="addition_reason"]');
  
  // Разблокируем поля
  if (unitInput) {
    unitInput.readOnly = false;
  }
  if (minQuantityInput) {
    minQuantityInput.readOnly = false;
  }
  if (descriptionInput) {
    descriptionInput.readOnly = false;
  }
  
  // Скрываем поле причины и убираем обязательность
  if (reasonField) {
    reasonField.style.display = 'none';
  }
  if (reasonInput) {
    reasonInput.required = false;
    reasonInput.value = ''; // Очищаем поле
  }
  
  infoDiv.style.display = 'none';
}

// Показать похожие материалы
function showSimilarMaterials(similarMaterials, originalName) {
  const infoDiv = document.getElementById('material-exists-info');
  
  let similarList = '';
  similarMaterials.forEach((material, index) => {
    similarList += `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span>${material.name} (${material.current_quantity} ${material.unit})</span>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectSimilarMaterial('${material.name}', '${material.unit}', '${material.min_quantity}', '${material.description || ''}')">
          Выбрать
        </button>
      </div>
    `;
  });
  
  infoDiv.innerHTML = `
    <div class="alert alert-info">
      <i class="bi bi-question-circle"></i> 
      <strong>Не найдено точного совпадения для "${originalName}"</strong>
      <br>Возможно, вы имели в виду один из этих материалов:
      <div class="mt-2">
        ${similarList}
      </div>
      <div class="mt-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideMaterialExistsInfo()">
          Создать новый материал
        </button>
      </div>
    </div>
  `;
  infoDiv.style.display = 'block';
  infoDiv.className = 'form-text';
}

// Выбрать похожий материал
function selectSimilarMaterial(name, unit, minQuantity, description = '') {
  const nameInput = document.getElementById('material-name-input');
  const unitInput = document.querySelector('input[name="unit"]');
  const minQuantityInput = document.querySelector('input[name="min_quantity"]');
  const descriptionInput = document.querySelector('textarea[name="description"]');
  const reasonField = document.getElementById('reason-field');
  const reasonInput = document.querySelector('textarea[name="addition_reason"]');
  
  // Заполняем поля
  nameInput.value = name;
  unitInput.value = unit;
  minQuantityInput.value = minQuantity;
  if (description) {
    descriptionInput.value = description;
  }
  
  // Блокируем поля
  unitInput.readOnly = true;
  minQuantityInput.readOnly = true;
  descriptionInput.readOnly = true;
  
  // Показываем поле причины
  reasonField.style.display = 'block';
  reasonInput.required = true;
  reasonInput.focus();
  
  // Скрываем информацию о похожих материалах
  hideMaterialExistsInfo();
}

// Валидация формы
function validateForm() {
  const name = document.getElementById('material-name-input');
  const unit = document.getElementById('material-unit');
  const quantity = document.getElementById('material-quantity');
  const minQuantity = document.getElementById('material-min-quantity');
  const reasonInput = document.querySelector('textarea[name="addition_reason"]');
  
  if (!name.value.trim()) {
    alert('Пожалуйста, введите название материала');
    name.focus();
    return false;
  }
  
  if (!unit.value.trim()) {
    alert('Пожалуйста, введите единицу измерения');
    unit.focus();
    return false;
  }
  
  if (!quantity.value || parseFloat(quantity.value) < 0) {
    alert('Пожалуйста, введите корректное количество');
    quantity.focus();
    return false;
  }
  
  if (!minQuantity.value || parseFloat(minQuantity.value) < 0) {
    alert('Пожалуйста, введите корректный минимальный запас');
    minQuantity.focus();
    return false;
  }
  
  // Проверяем поле причины, если оно видимо
  if (reasonInput && reasonInput.required && !reasonInput.value.trim()) {
    alert('Пожалуйста, укажите причину добавления существующего материала');
    reasonInput.focus();
    return false;
  }
  
  return true;
}

// Отправка формы
async function submitAddMaterial() {
  if (!validateForm()) {
    return;
  }
  
  const submitBtn = document.getElementById('submit-btn');
  const originalText = submitBtn.textContent;
  
  try {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Сохранение...';
    
    const formData = new FormData();
    formData.append('name', document.getElementById('material-name-input').value.trim());
    formData.append('unit', document.getElementById('material-unit').value.trim());
    formData.append('quantity', document.getElementById('material-quantity').value);
    formData.append('min_quantity', document.getElementById('material-min-quantity').value);
    formData.append('description', document.getElementById('material-description').value.trim());
    formData.append('price_per_unit', document.getElementById('material-price').value || '0');
    
    const reasonInput = document.querySelector('textarea[name="addition_reason"]');
    if (reasonInput && reasonInput.value.trim()) {
      formData.append('addition_reason', reasonInput.value.trim());
    }
    
    const fileInput = document.getElementById('material-file');
    if (fileInput.files[0]) {
      formData.append('file', fileInput.files[0]);
    }
    
    const response = await fetch('{{ url_for("supply.api_materials_create") }}', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        alert('Материал успешно добавлен!');
        window.location.href = '{{ url_for("supply.mobile_warehouse_view") }}';
      } else {
        alert('Ошибка: ' + (result.message || 'Неизвестная ошибка'));
      }
    } else {
      const errorData = await response.json();
      alert('Ошибка: ' + (errorData.message || 'Ошибка сервера'));
    }
  } catch (error) {
    console.error('Ошибка отправки формы:', error);
    alert('Произошла ошибка при сохранении материала');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  const nameInput = document.getElementById('material-name-input');
  const submitBtn = document.getElementById('submit-btn');
  
  // Обработчик отправки формы
  if (submitBtn) {
    submitBtn.addEventListener('click', submitAddMaterial);
  }
  
  // Проверка существующего материала при вводе названия
  if (nameInput) {
    let timeoutId;
    nameInput.addEventListener('input', function() {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        checkExistingMaterial(this.value);
      }, 500);
    });
  }
});
</script>
{% endblock %}