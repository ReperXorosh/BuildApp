{% extends "main/mobile_layout_bootstrap.html" %}
{% set active_page = 'supply' %}

{% block title %}Добавить материал{% endblock %}
{% block mobile_title %}Новая позиция{% endblock %}

{% block content %}
<div class="mobile-card add-material-card">
    <div class="mobile-card-title text-center">
        Новая позиция
    </div>

    <form id="add-material-form" novalidate>
        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="material-name-input">Название материала *</label>
            <input type="text"
                   class="mobile-form-control mobile-form-control-lg"
                   id="material-name-input"
                   name="name"
                   placeholder="Введите название материала"
                   inputmode="text"
                   autocomplete="off"
                   maxlength="200"
                   required>
            <div class="invalid-feedback" style="display:none" id="name-error">Укажите название материала.</div>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="material-unit">Единица измерения *</label>
            <input type="text"
                   class="mobile-form-control"
                   id="material-unit"
                   name="unit"
                   placeholder="шт, м, кг и т.д."
                   inputmode="text"
                   autocomplete="off"
                   maxlength="20"
                   required>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="material-quantity">Количество *</label>
            <input type="number"
                   class="mobile-form-control"
                   id="material-quantity"
                   name="quantity"
                   placeholder="0"
                   inputmode="numeric"
                   min="0"
                   step="0.01"
                   required>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="material-min-quantity">Минимальный запас *</label>
            <input type="number"
                   class="mobile-form-control"
                   id="material-min-quantity"
                   name="min_quantity"
                   placeholder="0"
                   inputmode="numeric"
                   min="0"
                   step="0.01"
                   required>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="material-description">Описание</label>
            <textarea class="mobile-form-control"
                      id="material-description"
                      name="description"
                      rows="3"
                      maxlength="500"
                      placeholder="Дополнительная информация о материале"></textarea>
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="material-price">Цена за единицу</label>
            <input type="number"
                   class="mobile-form-control"
                   id="material-price"
                   name="price_per_unit"
                   placeholder="0.00"
                   inputmode="decimal"
                   min="0"
                   step="0.01">
        </div>

        <div class="mobile-form-group" style="border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="material-file">Файл</label>
            <input type="file"
                   class="mobile-form-control"
                   id="material-file"
                   name="file"
                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
        </div>

        <!-- Информация о существующем материале -->
        <div id="material-exists-info" class="form-text" style="display: none;"></div>

        <!-- Поле причины (скрыто по умолчанию) -->
        <div id="reason-field" class="mobile-form-group" style="display: none; border:none; background:transparent; padding-left:0; padding-right:0;">
            <label class="mobile-form-label" for="addition-reason">Причина добавления существующей позиции *</label>
            <textarea class="mobile-form-control"
                      id="addition-reason"
                      name="addition_reason"
                      rows="3"
                      maxlength="500"
                      placeholder="Укажите причину пополнения существующего материала..."></textarea>
            <div class="form-text text-muted">Обязательно укажите причину пополнения существующего материала</div>
        </div>

        <div class="mobile-mt-4">
            <button type="button" class="mobile-btn mobile-btn-primary w-100" id="submit-btn">
                Сохранить позицию
            </button>
        </div>
        
    </form>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-material-form');
    const submitBtn = document.getElementById('submit-btn');
    const nameInput = document.getElementById('material-name-input');
    const nameError = document.getElementById('name-error');
    const backBtn = document.getElementById('mobileBackBtn');
    let isDirty = false;

    // На этой странице уменьшаем нижний отступ контента, чтобы не было лишней прокрутки
    try {
        const mobileContent = document.querySelector('.mobile-content');
        if (mobileContent) {
            mobileContent.style.paddingBottom = '16px';
            mobileContent.style.overflow = 'hidden';
            mobileContent.style.height = 'auto';
        }
        // Отключаем прокрутку страницы
        document.documentElement.style.overscrollBehaviorY = 'contain';
        document.body.style.overflow = 'hidden';
        window.scrollTo(0, 0);
    } catch(e) {}

    // Фокус на названии
    if (nameInput) nameInput.focus();

    // Функция проверки существующего материала
    async function checkExistingMaterial(name) {
        if (!name || name.length < 2) {
            hideMaterialExistsInfo();
            return;
        }
        
        try {
            const response = await fetch('{{ url_for("supply.api_materials_check") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.exists) {
                    if (result.exact_match || result.case_corrected) {
                        showMaterialExistsInfo(result.material, result.corrected_name);
                    }
                } else if (result.similar_found) {
                    showSimilarMaterials(result.similar_materials, name);
                } else {
                    hideMaterialExistsInfo();
                }
            }
        } catch (error) {
            console.error('Ошибка проверки материала:', error);
        }
    }

    function showMaterialExistsInfo(material, correctedName = null) {
        const infoDiv = document.getElementById('material-exists-info');
        const unitInput = document.getElementById('material-unit');
        const minQuantityInput = document.getElementById('material-min-quantity');
        const descriptionInput = document.getElementById('material-description');
        const nameInput = document.getElementById('material-name-input');
        const reasonField = document.getElementById('reason-field');
        const reasonInput = document.getElementById('addition-reason');
        
        // Заполняем поля автоматически
        unitInput.value = material.unit;
        minQuantityInput.value = material.min_quantity;
        if (material.description) {
            descriptionInput.value = material.description;
        }
        
        // Если есть исправление регистра, обновляем поле названия
        if (correctedName) {
            nameInput.value = correctedName;
        }
        
        // Блокируем поля для редактирования
        unitInput.readOnly = true;
        minQuantityInput.readOnly = true;
        descriptionInput.readOnly = true;
        
        // Показываем поле причины и делаем его обязательным
        reasonField.style.display = 'block';
        reasonInput.required = true;
        reasonInput.focus();

        // Показываем информацию
        let message = `Материал уже существует на складе (${material.current_quantity} ${material.unit}). Поля заблокированы. Укажите причину добавления.`;
        
        if (correctedName) {
            message = `Исправлен регистр: "${correctedName}". Материал уже существует на складе (${material.current_quantity} ${material.unit}). Поля заблокированы. Укажите причину добавления.`;
        }
        
        infoDiv.innerHTML = `
            <i class="bi bi-info-circle"></i> 
            ${message}
        `;
        infoDiv.style.display = 'block';
        infoDiv.className = 'form-text text-warning';
    }

    function hideMaterialExistsInfo() {
        const infoDiv = document.getElementById('material-exists-info');
        const unitInput = document.getElementById('material-unit');
        const minQuantityInput = document.getElementById('material-min-quantity');
        const descriptionInput = document.getElementById('material-description');
        const reasonField = document.getElementById('reason-field');
        const reasonInput = document.getElementById('addition-reason');
        
        // Разблокируем поля
        if (unitInput) {
            unitInput.readOnly = false;
        }
        if (minQuantityInput) {
            minQuantityInput.readOnly = false;
        }
        if (descriptionInput) {
            descriptionInput.readOnly = false;
        }
        
        // Скрываем поле причины и убираем обязательность
        if (reasonField) {
            reasonField.style.display = 'none';
        }
        if (reasonInput) {
            reasonInput.required = false;
            reasonInput.value = '';
        }
        
        infoDiv.style.display = 'none';
    }

    function showSimilarMaterials(similarMaterials, originalName) {
        const infoDiv = document.getElementById('material-exists-info');
        
        let similarList = '';
        similarMaterials.forEach((material, index) => {
            similarList += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${material.name} (${material.current_quantity} ${material.unit})</span>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectSimilarMaterial('${material.name}', '${material.unit}', '${material.min_quantity}', '${material.description || ''}')">
                        Выбрать
                    </button>
                </div>
            `;
        });
        
        infoDiv.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-question-circle"></i> 
                <strong>Не найдено точного совпадения для "${originalName}"</strong>
                <br>Возможно, вы имели в виду один из этих материалов:
                <div class="mt-2">
                    ${similarList}
                </div>
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideMaterialExistsInfo()">
                        Создать новый материал
                    </button>
                </div>
            </div>
        `;
        infoDiv.style.display = 'block';
        infoDiv.className = 'form-text';
    }

    // Выбрать похожий материал
    window.selectSimilarMaterial = function(name, unit, minQuantity, description = '') {
        const nameInput = document.getElementById('material-name-input');
        const unitInput = document.getElementById('material-unit');
        const minQuantityInput = document.getElementById('material-min-quantity');
        const descriptionInput = document.getElementById('material-description');
        const reasonField = document.getElementById('reason-field');
        const reasonInput = document.getElementById('addition-reason');
        
        // Заполняем поля
        nameInput.value = name;
        unitInput.value = unit;
        minQuantityInput.value = minQuantity;
        if (description) {
            descriptionInput.value = description;
        }
        
        // Блокируем поля
        unitInput.readOnly = true;
        minQuantityInput.readOnly = true;
        descriptionInput.readOnly = true;
        
        // Показываем поле причины
        reasonField.style.display = 'block';
        reasonInput.required = true;
        reasonInput.focus();
        
        // Скрываем информацию о похожих материалах
        hideMaterialExistsInfo();
    }

    // Проверка существующего материала при вводе названия
    if (nameInput) {
        let timeoutId;
        nameInput.addEventListener('input', function() {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                checkExistingMaterial(this.value);
            }, 500);
        });
    }

    // Обработка клика по кнопке отправки
    if (submitBtn) {
        submitBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Сохранение...';
            
            try {
                const formData = new FormData(form);
                
                const response = await fetch('{{ url_for("supply.api_materials_create") }}', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Материал успешно добавлен!');
                        window.location.href = '{{ url_for("supply.mobile_warehouse_view") }}';
                    } else {
                        alert('Ошибка: ' + (result.message || 'Неизвестная ошибка'));
                    }
                } else {
                    const errorData = await response.json();
                    alert('Ошибка: ' + (errorData.message || 'Ошибка сервера'));
                }
            } catch (error) {
                console.error('Ошибка отправки формы:', error);
                alert('Произошла ошибка при сохранении материала');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Сохранить позицию';
            }
        });
    }

    // Отслеживание изменений формы
    const inputs = form.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            isDirty = true;
        });
    });

    // Предупреждение при попытке покинуть страницу с несохраненными изменениями
    window.addEventListener('beforeunload', function(e) {
        if (isDirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Обработка кнопки "Назад"
    if (backBtn) {
        backBtn.addEventListener('click', function(e) {
            if (isDirty) {
                if (!confirm('У вас есть несохраненные изменения. Вы уверены, что хотите покинуть страницу?')) {
                    e.preventDefault();
                    return false;
                }
            }
        });
    }
});
</script>

<style>
/* Локальные правки для лучшей читаемости в светлой теме только на этой странице */
.mobile-app { background: var(--bs-body-bg); }
[data-bs-theme="light"] .add-material-card { background: #ffffff; color: #0f172a; }
[data-bs-theme="light"] .mobile-form-label { color: #111827; }
[data-bs-theme="light"] .mobile-form-control,
[data-bs-theme="light"] .mobile-form-control-lg {
    background: #ffffff;
    border-color: #d1d5db;
    color: #111827;
}
[data-bs-theme="light"] .mobile-form-control::placeholder,
[data-bs-theme="light"] .mobile-form-control-lg::placeholder { color: #6b7280; }
[data-bs-theme="light"] .mobile-btn-outline { border-color: #cbd5e1; color: #334155; }
[data-bs-theme="light"] .mobile-card-title { color: #0f172a; }
/* Контраст и читаемость в светлой теме */
.add-material-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    margin: 16px;
    padding: 0;
    overflow: hidden;
}

.mobile-card-title {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: #ffffff;
    padding: 20px;
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    border-bottom: none;
}

.mobile-form-group {
    padding: 16px 20px;
    border-bottom: 1px solid #f3f4f6;
    background: #ffffff;
}

.mobile-form-group:last-child {
    border-bottom: none;
}

.mobile-form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
    font-size: 14px;
}

.mobile-form-control,
.mobile-form-control-lg {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.2s ease;
    box-sizing: border-box;
    background: #ffffff;
    color: #111827;
}

.mobile-form-control-lg {
    font-size: 18px;
    padding: 16px;
}

.mobile-form-control:focus,
.mobile-form-control-lg:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.mobile-form-control::placeholder,
.mobile-form-control-lg::placeholder {
    color: #9ca3af;
}

.mobile-btn {
    padding: 16px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    width: 100%;
}

.mobile-btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: #ffffff;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
}

.mobile-btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

.mobile-btn-primary:active {
    transform: translateY(0);
}

.mobile-btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.mobile-mt-4 {
    margin-top: 24px;
    padding: 0 20px 20px 20px;
}

/* Исправление для файлового поля */
.mobile-form-control[type="file"] {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 12px 16px;
}

/* Темная тема */
@media (prefers-color-scheme: dark) {
    .add-material-card {
        background: #1f2937;
        border-color: #374151;
    }
    
    .mobile-form-group {
        background: #1f2937;
        border-color: #374151;
    }
    
    .mobile-form-label {
        color: #e5e7eb;
    }
    
    .mobile-form-control,
    .mobile-form-control-lg {
        background: #1f2937;
        border-color: #374151;
        color: #f9fafb;
    }
    
    .mobile-form-control:focus,
    .mobile-form-control-lg:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .mobile-card-title {
        color: #f9fafb;
    }
    
    .mobile-btn-outline {
        border-color: #4b5563;
        color: #d1d5db;
        background: #1f2937;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-btn-outline:hover {
        background: #374151;
        border-color: #6b7280;
        color: #f9fafb;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
}

/* Дополнительная поддержка темной темы через классы */
[data-bs-theme="dark"] .mobile-form-control-lg,
.dark .mobile-form-control-lg {
    background: #1f2937;
    border-color: #374151;
    color: #f9fafb;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

[data-bs-theme="dark"] .mobile-form-control-lg:focus,
.dark .mobile-form-control-lg:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(0, 0, 0, 0.3);
}

[data-bs-theme="dark"] .mobile-form-control,
.dark .mobile-form-control {
    background: #1f2937;
    border-color: #374151;
    color: #f9fafb;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

[data-bs-theme="dark"] .mobile-form-control:focus,
.dark .mobile-form-control:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2), 0 4px 12px rgba(0, 0, 0, 0.3);
}

[data-bs-theme="dark"] .mobile-form-label,
.dark .mobile-form-label {
    color: #e5e7eb;
}

[data-bs-theme="dark"] .mobile-card-title,
.dark .mobile-card-title {
    color: #f9fafb;
}

[data-bs-theme="dark"] .mobile-btn-outline,
.dark .mobile-btn-outline {
    border-color: #4b5563;
    color: #d1d5db;
    background: #1f2937;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

[data-bs-theme="dark"] .mobile-btn-outline:hover,
.dark .mobile-btn-outline:hover {
    background: #374151;
    border-color: #6b7280;
    color: #f9fafb;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}
</style>
{% endblock %}